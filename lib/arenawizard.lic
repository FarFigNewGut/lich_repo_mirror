=begin
   
     A duskruin arena script for a capped bolting wizard. Writen for my own needs 
     so modify as you like, and use at your own risk.
     
     All items in your rewards package get dumped into your lootsack.
     
     Snap your fingers to let the script know to exit while resting or after
     current run.

     Primary bolt will be used on all non fire immune critters
     Secondary bolt is used for Tsarks and Fire Elementals     
     
     The script will attempt to keep voln symbols and rapid fire (515) up at all times.
     
     Combat loop:
         413 > 519 > 501 > 917 > 910 ...
       
     Set your lootsack                          ;Vars set lootsack = <container>
     Set your book container:                   ;Vars set eventsack = <container>
     
     Rest after combat (default true):          ;vars set userest = <true|false>
     Percent mind to rest to (default 50):      ;vars set restuntil = <##>
     
     Set your primarybolt (default 910):        ;Vars set primarybolt = <spell #>
     Set your secondarybolt (default 910):      ;Vars set secondarybolt = <spell #>
     Keep up voln symbols (default true):       ;Vars set usevoln = <true|false>
     Use Rapid Fire (default true):             ;Vars set userapidfire = <true|false>
     Use Elemental saturation (default true):   ;Vars set usesaturate = <true|false> 
     Use immolation (default true):             ;Vars set useimmolate = <true|false>
     Use wizard sleep (default true):           ;Vars set usesleep = <true|false>
     Use Earthen Fury (default false):          ;Vars set useearthen = <true|false>
     Use drain mana as needed (default true):   ;Vars set usemanadrain = <true|false>
	 
         author: Elvidor
           game: Gemstone
           tags: Duskruin, Arena
        version: 0.3
        
     Change log:
     
     0.3     
         - Will now use 917 cold on fire creatures
         - Will now stance dance if rapid fire is not enabled
         - Items in left hand will be stowed before trying to get the booklet
         - Winnings packages should no longer sometimes get left in the left hand
         - Will no longer attempt to sleep Tsarks
         - Snapping fingers will properly wait until the end of the entry to terminate
         - Fixed script crash if restuntil is set as a string
	    
=end


if (variable[0])
	echo
	echo
    echo "A duskruin arena script for a capped bolting wizard. Writen for my own needs      "
	echo "so modify as you like, and use at your own risk.                                  "
	echo "                                                                                  "
	echo "All items in your rewards package get dumped into your lootsack.                  "
	echo "                                                                                  "     
	echo "Snap your fingers to let the script know to exit after while resting or after     "
	echo "current run.                                                                      "
	echo "                                                                                  "   
    echo "Primary bolt will be used on all non fire immune critters                         "
    echo "Secondary bolt is used for Tsarks and Fire Elementals                             "
	echo "                                                                                  "   
	echo "The script will attempt to keep voln symbols and rapid fire (515) up at all times."
	echo "                                                                                  "     
	echo "Combat loop:                                                                      "
	echo "    413 > 519 > 501 >  917 > 910 ...                                              "
	echo "                                                                                  "       
	echo "Set your lootsack:                         ;Vars set lootsack = <container>       "
	echo "Set your book container:                   ;Vars set eventsack = <container>      "
	echo "                                                                                  "
	echo "Rest after combat (default true):          ;vars set userest = <true|false>       "
	echo "Percent mind to rest to (default 50):      ;vars set restuntil = <##>             "
	echo "                                                                                  "
	echo "Set your primarybolt (default 910):        ;Vars set primarybolt = <spell #>      "
	echo "Set your primarybolt (default 910):        ;Vars set secondarybolt = <spell #>    "
	echo "Keep up voln symbols (default true):       ;Vars set usevoln = <true|false>       "
	echo "Use Rapid Fire (default true):             ;Vars set userapidfire = <true|false>  "
	echo "Use Elemental saturation (default true):   ;Vars set usesaturate = <true|false>   " 
	echo "Use immolation (default true):             ;Vars set useimmolate = <true|false>   "
	echo "Use wizard sleep (default true):           ;Vars set usesleep = <true|false>      "
	echo "Use Earthen Fury (default false):          ;Vars set useearthen = <true|false>    "
	echo "Use drain mana as needed (default true):   ;Vars set usemanadrain = <true|false>  "
	echo
	echo
	kill_script ('arenawizard')
end


$primaryBolt = (!Vars.primarybolt.nil?)  ? Vars.primarybolt : 910
$secondaryBolt = (!Vars.secondarybolt.nil?)  ? Vars.secondarybolt : 910
$useRapidFire = (!Vars.userapidfire.nil?)  ? Vars.userapidfire : true
$useImmolate = (!Vars.useimmolate.nil?)  ? Vars.useimmolate : true
$useSleep = (!Vars.usesleep.nil?)  ? Vars.useSleep : true
$useEarthen = (!Vars.useearthen.nil?)  ? Vars.useearthen : false
$useVoln = (!Vars.usevoln.nil?)  ? Vars.usevoln : true
$useSaturate = (!Vars.usesaturate.nil?)  ? Vars.usesaturate : true
$useDrain = (!Vars.usemanadrain.nil?)  ? Vars.usemanadrain : true
$useRest = (!Vars.userest.nil?)  ? Vars.userest : true
$useRestPct = (!Vars.restuntil.nil?)  ? Vars.restuntil : 50


$exitScript = nil
$combatBegin = nil
$praycounter = nil


echo "lootsack:         #{Vars.lootsack}"
echo "eventsack:        #{Vars.eventsack}"
echo "primarybolt:      #{$primaryBolt}"
echo "secondarybolt:    #{$secondaryBolt}"
echo "userapidfire:     #{$useRapidFire}"
echo "usevoln:          #{$useVoln}"
echo "usesaturate:      #{$useSaturate}"
echo "useimmolate:      #{$useImmolate}"
echo "usesleep:         #{$useSleep}"
echo "useearthen:       #{$useEarthen}"
echo "usedrainmana:     #{$useDrain}"
echo "userest:          #{$useRest}"
echo "restuntil:        #{$useRestPct}"         
echo 
echo "Unpause script to begin with current settings"
echo

pause_script ('arenawizard')


# End script hook

action = proc { |client_string|
	if client_string =~ /You snap your fingers/
		$exitScript = 1
	end
	client_string
}



# Begin the arena

def start
	if percentencumbrance > 50
		echo "You're carrying too much stuff. Exiting Script."
		kill_script ('arenawizard')
	end
	
	if (percentmind <= $useRestPct.to_i) || !$useRest
		result = dothistimeout("get my booklet from my #{Vars.eventsack}", 5, /You (?:discreetly|remove|reach)|Get what\?/)
		if result =~ /Get what\?/
			echo 'Out of booklets!'
			kill_script ('arenawizard')
		elsif
			move 'go entrance'
			fput "put my booklet in my #{Vars.eventsack}"
			fput "shout"
		end
	else
		echo "*** Waiting for mind to clear  ***"
		pause '15s'
	end
end



# Kill the mobs

def startcombat
	
	target_npc = GameObj.npcs.find { |npc| npc.id }

	if (target_npc != nil)
		until (!muckled? && !waitrt? && !waitcastrt?)
			pause '1s'
		end
		
		$combatbegin = 1
		
		until (GameObj.npcs.find { |npc| npc.id == target_npc.id } == nil)
			waitcastrt?
			waitrt?

			fput "stand" if (!standing?)
			
			if (!checkspell("Rapid Fire")  && Spell[515].affordable? && $useRapidFire)
				fput "incant 515"
			end
			
			if (!checkspell("Symbol of courage")  && $useVoln)
				fput "sym courage"
			end
			
			if (!checkspell("Symbol of protection")  && $useVoln)
				fput "sym prot"
			end 
						
			if $combatbegin == 1 
				if (percentmana <= 35 && $praycounter < 3)
					fput "pray"
					$praycounter = $praycounter + 1
				end
				if (Spell[413].affordable? && $useSaturate)
					fput "incant 413"
					waitcastrt?
				end
				if (Spell[516].affordable? && percentmana <= 35 && $useDrain)
					fput "incant 516";;
					waitcastrt?
				end
				if (Spell[519].affordable? && $useImmolate && !(target_npc.name =~ /tsark|elemental|fire giant/))
					fput "incant 519"
					waitcastrt?
				end
				if (Spell[501].affordable? && $useSleep && !(target_npc.name =~ /tsark/))
					fput "incant 501"
					waitcastrt?
				end
				if (Spell[917].affordable? && $useEarthen)
					if (target_npc.name =~ /tsark|elemental|fire giant/)
						fput "incant 917 COLD"
						waitcastrt?
					else 
						fput "incant 917"
						waitcastrt?			
					end
				end
				$combatbegin = 0
				fput "Stance off"
			
			elsif (percentmana <= 35 && (!checkspell "symbol of mana cooldown") && $useVoln)
				fput "sym mana"
			
			elsif target_npc.name =~ /tsark|elemental|fire giant/ 
				if(Spell[$secondaryBolt].affordable?)
					fput "incant #{$secondaryBolt}"
				end
				
			elsif (Spell[$primaryBolt].affordable?)
				fput "stance off" if !($useRapidFire)
				fput "incant #{$primaryBolt}"
				fput "stance guard" if !($useRapidFire)
	
			elsif	
				fput "mana pulse"
	
			end	
			
			if (target_npc.status =~ /dead/)
				fput "dismiss"
			end
		
		end		
		fput "Stance def"
		
	end	
	pause '1s'
	
end



# Collect loot and return to Sands Approach

def collectloot
	
	fput "open my package"
	fput "empty my package into my #{Vars.lootsack}"
	waitrt?
	fput "drop package"
	pause '1s'

end



# Hook to check for user input to end script

DownstreamHook.add('arenaExit', action)
before_dying { 
	DownstreamHook.remove('arenaExit');
}



# Main Loop

fput "tell familiar to leave"
if checkroom =~ /Duskruin Arena, Sands Approach/
	
else
	echo 'Walking to Duskruin Arena, Sands Approach'
	start_script 'go2', ['23780']
	wait_while { running? 'go2' }
end

loop {
	
	if checkroom =~ /Duskruin Arena, Niveous Chamber/
		until (!muckled? && !waitrt? && !waitcastrt?)
			pause '1s'
		end
		fput "stand" if (!standing?)
		
	elsif checkleft =~ /package/
		collectloot
	
	elsif checkroom =~ /Duskruin Arena, Dueling Sands/
		startcombat
		
	elsif $exitScript == 1
		kill_script ('arenawizard')
			
	elsif !(checkroom =~ /Duskruin Arena, Sands Approach/)
		start_script 'go2', ['23780']
		wait_while { running? 'go2' }

	elsif checkleft
		fput "stow left"
		until !checkleft
		end

	elsif checkroom =~ /Duskruin Arena, Sands Approach/
		$praycounter = 0
		start
				
	else
		echo "*** Something went so very wrong! ***"
		kill_script ('arenawizard')
	
	end

}