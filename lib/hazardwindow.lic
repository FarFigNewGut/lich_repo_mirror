=begin
  This script creates a dedicated window to display hazards in real time.
  Features:
  - Continuously updates with hazards found in the room.
  - Displays hazards (black voids, clouds, ghostly rifts, vines, webs) in a standardized format.
  - Automatically removes hazards that disappear.
  - Allows players to click on clouds to cast spells 912 or 612.
  - Allows players to click on webs to cast spells 209.
  - Allows players that know SPELL CLEAVE to click on clouds, webs, and vines and cleave them.
  - Uses consistent window formatting.

author: Phocosoen, ChatGPT
tags: wrayth, frontend, mod, window, hazards, apparatus, voids, rifts, clouds, vines, webs, spell cleave, point, click
  
=end

hide_me

# Open the hazard window using Wrayth's dynamic dialog.
puts("<closeDialog id='HazardWindow'/><openDialog type='dynamic' id='HazardWindow' title='Hazards' target='HazardWindow' scroll='manual' location='main' justify='3' height='100' resident='true'><dialogData id='HazardWindow'></dialogData></openDialog>")

@last_hazards = []

# Build and push the hazard list to the window.
def push_hazards_to_window(hazards)
  output = "<dialogData id='HazardWindow' clear='t'>"
  output += "<label id='total' value='Hazards: #{hazards.size}' fontSize='32' />"
  hazards.each_with_index do |hazard, index|
    hazard_name = hazard.name
	if hazard_name =~ /apparatus/i
      output += "<link id='hazard_#{index}' value='#{hazard_name}' justify='bottom' left='0' top='#{20 * (index + 1)}' fontSize='32' cmd=\";e  
	  if Char.prof =~ /Empath/i && Spell[230].affordable? && Spell[230].known?; fput('release') if checkprep != 'None'; fput('prep 230'); fput('cast ##{hazard.id}'); elsif Char.prof =~ /Wizard|Sorcerer/i && Spell[408].affordable? && Spell[408].known?; fput('release') if checkprep != 'None'; fput('prep 408'); fput('cast ##{hazard.id}'); elsif Char.prof =~ /Bard/i && Spell[1013].affordable? && Spell[1013].known?; fput('release') if checkprep != 'None'; fput('prep 1013'); fput('cast ##{hazard.id}'); elsif Char.prof =~ /Rogue/i; fput('disarm ##{hazard.id}'); end\" />"
    elsif hazard_name =~ /cloud/i
      output += "<link id='hazard_#{index}' value='#{hazard_name}' justify='bottom' left='0' top='#{20 * (index + 1)}' fontSize='32' cmd=\";e if Spell[912].affordable? && Spell[912].known?; fput('release') if checkprep != 'None'; fput('prep 912'); fput('cast ##{hazard.id}'); elsif Spell[612].affordable? && Spell[612].known?; fput('release') if checkprep != 'None'; fput('prep 612'); fput('cast ##{hazard.id}'); elsif CMan.known?('Spell Cleave'); fput('cman scleave ##{hazard.id}'); end\" />"
	elsif hazard_name =~ /vine/i
	  output += "<link id='hazard_#{index}' value='#{hazard_name}' justify='bottom' left='0' top='#{20 * (index + 1)}' fontSize='32' cmd=\";e if CMan.known?('Spell Cleave'); fput('cman scleave ##{hazard.id}'); end\" />"
	elsif hazard_name =~ /web/i
      output += "<link id='hazard_#{index}' value='#{hazard_name}' justify='bottom' left='0' top='#{20 * (index + 1)}' fontSize='32' cmd=\";e if Spell[209].affordable? && Spell[209].known?; fput('release') if checkprep != 'None'; fput('prep 209'); fput('cast ##{hazard.id}'); elsif CMan.known?('Spell Cleave'); fput('cman scleave ##{hazard.id}'); end\" />"
    elsif hazard_name =~ /acidic cloud of mist|unearthly silvery blue globe|spiraling ghostly rift/i
      output += "<link id='hazard_#{index}' value='#{hazard_name}' justify='bottom' left='0' top='#{20 * (index + 1)}' fontSize='32' cmd=\";e if Char.prof =~ /Empath/i && Spell[119].affordable? && Spell[119].known?; fput('release') if checkprep != 'None'; fput('prep 119'); fput('cast ##{hazard.id}'); elsif Char.prof =~ /Rogue|Warrior|Wizard|Sorcerer/i && Spell[417].affordable? && Spell[417].known?; fput('release') if checkprep != 'None'; fput('prep 408'); fput('cast ##{hazard.id}'); elsif Char.prof =~ /Bard/i && Spell[1013].affordable? && Spell[1013].known?; fput('release') if checkprep != 'None'; fput('prep 1013'); fput('cast ##{hazard.id}'); elsif Char.prof =~ /Monk/i && Spell[1218].affordable? && Spell[1218].known?; fput('release') if checkprep != 'None'; fput('prep 1218'); fput('cast ##{hazard.id}'); end\" />"	
	else
      output += "<label id='hazard_#{index}' value='#{hazard_name}' justify='bottom' left='0' top='#{20 * (index + 1)}' fontSize='32' />"
    end
  end
  output += "</dialogData>"
  puts(output)
end

# Main update loop.
loop do
  current_hazards = GameObj.loot.reject { |obj| obj.name !~ /(acidic cloud of mist|glimmering boltstone apparatus|cloud|unearthly silvery blue globe|spiraling ghostly rift|sticky web|vine|black void|windy vortex)/i }
  if current_hazards != @last_hazards
    @last_hazards = current_hazards
    push_hazards_to_window(current_hazards)
  end
  sleep 0.025
end

echo "Dedicated Hazard Window is active."
