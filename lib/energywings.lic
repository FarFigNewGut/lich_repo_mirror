=begin
  Energy Wings

  This script automates Wing Pin combat abilities based on room context,
  NPC status, cooldown availability, and target count. It is designed for
  sustained combat situations such as claims or the Dueling Sands while
  minimizing redundant commands and respecting ability cooldowns.

  The script runs continuously and evaluates conditions approximately
  twice per second.

  Features:
  - Only activates while inside your own Lich claim or the Dueling Sands.
  - Supports selecting which wings to use at launch:
      * ;energywings dark   (default)
      * ;energywings light
  - Dark wings mode:
      * Uses Wing Pin abilities based on combat conditions:
          - Shadow Barb: single target when prone or stunned.
          - Barbed Sweep: multiple targets (3+) when prone or stunned.
          - Rain of Thorns: AOE when 6+ targets are present.
          - Carrion Guard: defensive AOE when muckled and 6+ targets are present.
  - Light wings mode:
      * Uses Wing Pin abilities based on combat conditions:
          - Radiant Pulse: single target when prone or stunned.
          - Blast of Brilliance: multiple targets (3+) when prone or stunned.
          - Blinding Reprisal: AOE when 6+ targets are present.
          - Wings of Warding: defensive AOE when muckled and 6+ targets are present.

  Safety and Performance:
  - Cooldown-driven loops ensure abilities are only sent until activation.
  - Status checks prevent wasted commands on invalid targets.
  - Lightweight polling interval minimizes performance impact.

  Notes:
  - This script assumes proper cooldown tracking via Effects::Cooldowns.
  - The muckled? helper must be defined elsewhere or available in scope.
  - Thresholds and priorities can be adjusted to suit different tactics.

  Author: ChatGPT
  Tags: combat, automation, wing pin, lich, cooldowns, aoe, claim, dueling sands, energywings
  Version: 1.2.0
=end

# UTF-8 safe. Uses only ASCII characters in strings and comments.

# Argument parsing (Lich-style) + confirmation banner
mode = (script.vars[1] || "dark").to_s.strip.downcase

unless %w[dark light].include?(mode)
  echo "Usage: ;energywings [dark|light]"
  echo "Example: ;energywings dark"
  echo "Example: ;energywings light"
  exit
end

echo "==============================================="
echo "  ENERGYWINGS MODE CONFIRMED: #{mode.upcase}"
echo "==============================================="


def in_allowed_room?
  Lich::Claim.mine? || Room.current.location =~ /Dueling Sands/
end

def living_npc
  GameObj.npcs.find { |n| n.status !~ /dead|gone/ }
end

def run_darkwings_loop
  loop do
    sleep 0.5

    next unless in_allowed_room?

    npc = living_npc
    next unless npc

    # Shadow Barb - single target when prone/stunned
    if !Effects::Cooldowns.active?("Shadow Barb") && npc.status =~ /prone|stunned/
      until Effects::Cooldowns.active?("Shadow Barb")
        break if npc.status =~ /dead|gone/
        fput "turn my wing pin"
      end
      echo "Shadow Barb {!}".upcase.center(45)
    end

    # Barbed Sweep - multi-target (2+) when prone/stunned
    if GameObj.npcs.count > 2 && !Effects::Cooldowns.active?("Barbed Sweep") && npc.status =~ /prone|stunned/
      until Effects::Cooldowns.active?("Barbed Sweep")
        break if npc.status =~ /dead|gone/
        fput "knock my wing pin"
      end
      echo "Barbed Sweep {!}".upcase.center(45)
    end

    # Rain of Thorns - AOE (5+ targets)
    if GameObj.npcs.count > 5 && !Effects::Cooldowns.active?("Rain of Thorns")
      until Effects::Cooldowns.active?("Rain of Thorns")
        break if npc.status =~ /dead|gone/
        fput "fold my wing pin"
      end
      echo "Rain of Thorns {!}".upcase.center(45)
    end

    # Carrion Guard - defensive AOE (5+ targets, muckled)
    if GameObj.npcs.count > 5 && muckled? && !Effects::Cooldowns.active?("Carrion Guard")
      until Effects::Cooldowns.active?("Carrion Guard")
        break if npc.status =~ /dead|gone/
        fput "push my wing pin"
      end
      echo "Carrion Guard {!}".upcase.center(45)
    end
  end
end

def run_lightwings_loop
  loop do
    sleep 0.5

    next unless in_allowed_room?

    npc = living_npc
    next unless npc

    # Radiant Pulse - single target when prone/stunned
    if !Effects::Cooldowns.active?("Radiant Pulse") && npc.status =~ /prone|stunned/
      until Effects::Cooldowns.active?("Radiant Pulse")
        break if npc.status =~ /dead|gone/
        fput "turn my wing pin"
      end
      echo "Radiant Pulse {!}".upcase.center(45)
    end

    # Blast of Brilliance - multi-target (2+) when prone/stunned
    if GameObj.npcs.count > 2 && !Effects::Cooldowns.active?("Blast of Brilliance") && npc.status =~ /prone|stunned/
      until Effects::Cooldowns.active?("Blast of Brilliance")
        break if npc.status =~ /dead|gone/
        fput "knock my wing pin"
      end
      echo "Blast of Brilliance {!}".upcase.center(45)
    end

    # Blinding Reprisal - AOE (5+ targets)
    if GameObj.npcs.count > 5 && !Effects::Cooldowns.active?("Blinding Reprisal")
      until Effects::Cooldowns.active?("Blinding Reprisal")
        break if npc.status =~ /dead|gone/
        fput "fold my wing pin"
      end
      echo "Blinding Reprisal {!}".upcase.center(45)
    end

    # Wings of Warding - defensive AOE (5+ targets, muckled)
    if GameObj.npcs.count > 5 && muckled? && !Effects::Cooldowns.active?("Wings of Warding")
      until Effects::Cooldowns.active?("Wings of Warding")
        break if npc.status =~ /dead|gone/
        fput "push my wing pin"
      end
      echo "Wings of Warding {!}".upcase.center(45)
    end
  end
end

if mode == "dark"
  run_darkwings_loop
else
  run_lightwings_loop
end
