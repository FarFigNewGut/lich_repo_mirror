=begin
  Energy Wings

  This script automates Wing Pin combat abilities based on room context,
  NPC status, cooldown availability, target count, and enemy spell prep
  detection. It is designed for sustained combat situations such as
  claims or the Dueling Sands while minimizing redundant commands and
  respecting ability cooldowns.

  The script runs continuously and evaluates combat conditions
  approximately twice per second. It also listens for enemy spell prep
  messaging in real time and reacts with a wing pin defensive ability.

  Features:
  - Only activates while inside your own Lich claim or the Dueling Sands.
  - Automatically detects which wings to use based on the worn wing pin:
      * dark wing-shaped pin  => dark mode
      * pale wing-shaped pin  => light mode
  - Automatically switches mode if you change pins while running.
  - Reacts to enemy spell preparation messaging (KSwole-style):
      * Dark:  pull my wing pin  (Crawling Shadow)
      * Light: pull my wing pin  (Prismatic Aegis)

  Dark wings mode combat abilities:
    - Shadow Barb: single target when prone or stunned.
    - Barbed Sweep: multiple targets (3+) when prone or stunned.
    - Rain of Thorns: AOE when 6+ targets are present.
    - Carrion Guard: defensive AOE when bleeding and 6+ targets are present.

  Light wings mode combat abilities:
    - Radiant Pulse: single target when prone or stunned.
    - Blast of Brilliance: multiple targets (3+) when prone or stunned.
    - Blinding Reprisal: AOE when 6+ targets are present.
    - Wings of Warding: defensive AOE when bleeding and 6+ targets are present.

  Changelog:
    1.4.5 (2026-02-19)
      - Simplified spell gating to use `Spell[num].available?` for precast spell commands.
      - Removed name-based ability-known checks.
    1.4.4 (2026-02-19)
      - Simplified hidden guards to direct `return if hidden?` checks.
    1.4.3 (2026-02-19)
      - Switched hidden-state guards to use `hiding?` semantics in core action paths.
      - Added safe fallback to `hidden?` if `hiding?` is unavailable.
    1.4.2 (2026-02-19)
      - Added hidden-state guard so wing actions are skipped while hidden.
      - Added known-ability guard so wing actions only fire when the ability/spell is known.
    1.4.1 (2026-02-13)
      - Wrapped script in `EnergyWings` module to avoid global name collisions.
      - Changed defensive wing trigger from `muckled?` to `bleeding?`.
    1.4.0 (2026-02-12)
      - Added KSwole-style enemy spell prep detection and reaction:
          * Dark reaction: Crawling Shadow via "pull my wing pin"
          * Light reaction: Prismatic Aegis via "pull my wing pin"
      - Removed all "tap" logic (not required).
      - Runs listener and combat evaluation in separate loops to avoid
        missing prep lines while still checking combat state twice per second.
    1.3.0 (2026-02-12)
      - Detects worn wing pin:
          dark wing-shaped pin  => dark mode
          pale wing-shaped pin  => light mode
      - Automatically switches mode if you change pins while running.
    1.2.1 (2026-02-12)
      - GameObj.npcs changed to GameObj.targets. Should fix issue with
        using wing actions in town.

  Author: ChatGPT
  Tags: combat, automation, wing pin, lich, cooldowns, aoe, claim, dueling sands, energywings
  Version: 1.4.5
=end

# UTF-8 safe. Uses only ASCII characters in strings and comments.

module EnergyWings
module_function

SCRIPTS_TO_PAUSE = %w[bigshot hunt3].freeze unless defined?(SCRIPTS_TO_PAUSE)

# ----------------------------
# Helpers
# ----------------------------

def in_allowed_room?
  Lich::Claim.mine? || Room.current.location =~ /Dueling Sands/
end

def living_npc
  GameObj.targets.find { |n| n && n.status !~ /dead|gone/ }
end

def find_wing_pin
  # Your inventory showed: "dark wing-shaped pin" (no "a/an")
  GameObj.inv.find { |i| i && i.name =~ /\A(?:dark|pale)\s+wing-shaped\s+pin\z/i }
end

def wing_pin_mode(pin)
  return nil unless pin
  return "dark"  if pin.name =~ /\Adark\s+wing-shaped\s+pin\z/i
  return "light" if pin.name =~ /\Apale\s+wing-shaped\s+pin\z/i
  nil
end

def ability_ready?(name)
  !Effects::Cooldowns.active?(name)
end

# ----------------------------
# Spell prep detection (from KSwole)
# Paste/expand as needed. This is the key wiring point.
# ----------------------------

CREATURE_SPELL_PREPS_WING_PIN = Regexp.union(
    # Atoll and Nelemar
    /^An? (?:.*)\belemental utters an incantation in an unfamiliar, bubbling language\./,
    /^An? (?:.*)\b(?:fanatic|radical) steeples (?:his|her) clawed fingers together, murmuring a quick incantation\./,
    /^An? (?:.*)\bsiren begins singing a sweet song\./,
    /^An? (?:.*)\b(?:magus|warden) makes a subtle gesture, drawing traces of faint blue-green light into (?:his|her) webbed hands\./,
    /^An? (?:.*)\b(?:warlock|dissembler|sentry|psionicist) chants in an incomprehensible language, causing streams of dim grey energy to lash about (?:his|her) (?:hands|golden claws)\./,

    # Bonespear
    /^(?:.*) draws an ancient sigil in the air\./,

    # Bowels
    /^An? (?:.*)\belder invokes the power of (?:his|her) god, the symbol on (?:his|her) forehead glowing brightly\./,
    /^An? (?:.*)\bjarl traces a simple symbol as (?:he|she) reverently calls upon the power of (?:his|her) god\./,

    # Citadel
    /^An? (?:.*)\bapprentice whispers a magical incantation, bending the elements to (?:his|her) whim\./,
    /^An? (?:.*)\bherald seethes a forceful chant, commanding the spirits to do (?:his|her) bidding\./,

    # Confluence
    /^(?:.*) glows with a bright blue light\./,
    /^(?:.*) rumbles with an inner power\./,
    /^(?:.*) utters an incantation in an unfamiliar, bubbling language\./,
    /^(?:.*) whispers an incantation into the wind\./,
    /^(?:.*) raises a molten appendage/,
    /^(?:.*) sparks wildly/,
    /^(?:.*) sizzles with power\./,
    /^(?:.*) releases a burst of fiery energy/,

    # Crawling Shore
    /^(?:.*) groans out a malevolent series of mystical syllables, causing the surrounding shadows to burn crimson\./,
    /^(?:.*) mutters an old, guttural chant as the surroundings grow terribly silent\./,

    # Den of Rot
    /^An? (?:.*)\bincubus begins singing a softly melodic melody, his lips quirking with cruel amusement\./,
    /^An? (?:.*)\binciter raises (?:his|her) voice in a ululating chant, surrounding (?:himself|herself) with wisps of sickly green energy\./,
    /^An? (?:.*)\bvereri sets her lips in a petulant pout\./,
    /^An? (?:.*)\bvision begins buzzing loudly, its corrupt aura turning a deeper shade of bile green\./,

    # Duskruin Arena
    /^(?:.*) utters a guttural, primitive prayer\./,
    /^(?:.*) raises (?:his|her) fists to the sky\./,
    /^(?:.*) begins to shiver\./,
    /^(?:.*) shouts out an arcane phrase of magic\./,
    /^(?:.*) whispers a string of delicate words\./,
    /^(?:.*) rubs (?:his|her) magical horn\./,
    /^(?:.*) barks some odd sounds\./,

    # Graveyard, Shadow Valley
    /^An? (?:.*)\bshadow mare fades visibly, flicking (?:his|her) tail\.\.\./,
    /^An? (?:.*)\bshadow steed shakes (?:his|her) mane\./,
    /^An? (?:.*)\bnight mare flares (?:his|her) nostrils\./,

    # Grimswarm
    /^An? (?:.*)\b(?:witch|sorcerer|sorceress) gestures and utters a phrase of magic\./,

    # Hidden Plateau
    /^An? (?:.*)\bmagus begins rumbling while making mystic gestures through the air\./,

    # Hinterwilds
    /^An? (?:.*)\bbloodspeaker utters a garbled, sibilant phrase as globules of crimson light spin around (?:his|her) gnarled hands\./,
    /^An? (?:.*)\bgolem glows with shimmering incarnadine light that suffuses its monstrous form with power\./,
    /^An? (?:.*)\bwendigo rasps out a dissonant, sing-song phrase\./,
    /^An? (?:.*)\bskald raises (?:his|her) voice into a reverberating dirge, the surrounding shadows dancing in time with the tune\./,
    /^An? (?:.*)\bshield-maiden raises a fist to the heavens as her eyes begin to glow like molten gold\./,
    /^An? (?:.*)\bdisir raises a hand skyward, suffusing herself with scintillating power\./,
    /^An? (?:.*)\bmutant twitches, (?:his|her) distended cranium pulsing as a look of intense focus stills (?:his|her) face\./,
    /^An? (?:.*)\bdisir silently mouths an incantation that does not seem to be in any language you know\./,
    /^An? (?:.*)\bdisir focuses her luminous gaze upon you!/,
    /^An? (?:.*)\bdisciple gestures with one bloody hand, chanting a sibilant prayer\./,
    /^An? (?:.*)\bangargeist lights from within, energy crackling within its chaotic core\./,

    # Icemule Trace
    /^An? (?:.*)\bvine twirls an appendage in a complex circle\./,
    /^An? (?:.*)\bglacei flares with a deep blue glow\./,
    /^An? (?:.*)\bdirge begins to wail loudly\!/,
    /^An? (?:.*)\bapparition draws slowly inward\!/,
    /^An? (?:.*)\bwraith draws inward for a moment\!/,
    /^(?:.*) begins to moan an incantation\!/,
    /^(?:.*) chants an evil incantation\./,
    /^(?:.*) begins to shiver violently\!/,
    /^(?:.*) begins to shiver\./,
    /^(?:.*) mutters an incantation\./,
    /^(?:.*) utters a phrase of arcane magic\./,
    /^An? (?:.*)\bcrone mutters a frosty incantation\./,
    /^(?:.*) raises its fists to the sky\./,
    /^An? (?:.*)\bplant opens and closes one of its flowers\./,

    # Moonsedge
    /^An? (?:.*)\bbanshee raises her voice in a shrill, eerie song that makes the surrounding mists dance\./,
    /^An? (?:.*)\bgrotesque rumbles out a basso incantation, clenching one carved claw as its eyes glow viridian\./,
    /^An? (?:.*)\bknight twists a skeletal hand, uttering a blasphemous chant\./,
    /^An? (?:.*)\bvampire slices a shadowy sigil in the air as (?:he|she) utters an old chant\./,
    /^An? (?:.*)\bconjurer gives a flourish of (?:his|her) spectral arms as (?:he|she) raises (?:his|her) voice in a theatrical chant\./,

    # OSA
    /^(?:.*) snarls as (?:he|she) chants a few words of magic\./,

    # OTF (incl. Aqueducts)
    /^An? (?:.*)\bbeing rumbles a series of arcane phrases\./,
    /^An? (?:.*)\binitiate closes (?:his|her) eyes while uttering a hollow, alien chant\./,
    /^An? (?:.*)\bherald starts singing an alien song in a reverberating, sonorous voice\./,
    /^An? (?:.*)\badept closes (?:his|her) eyes while incanting an alien phrase\./,
    /^An? (?:.*)\bseer closes (?:his|her) eyes and bows (?:his|her) head slightly./,
    /^(?:.*) mutters a phrase of magic\./,

    # Red Forest
    /^An? (?:.*)\bviper hisses an arcane phrase in an unfamiliar sibilant language\./,
    /^An? (?:.*)\bspirit whistles a soft, malicious tune\./,
    /^An? (?:.*)\bpixie hands begin to glow\./,
    /^An? (?:.*)\bsprite raises a finger to (?:his|her) lips\./,
    /^An? (?:.*)\bdruid groans an incantation\./,

    # Reim
    /^(?:.*) glows as (?:he|she) chants a few words of magic\./,

    # Rift and Scatter
    /^An? (?:.*)\bwitch whispers with an ominously soft voice\./,
    /^An? (?:.*)\bseraceris begins to hum\./,
    /^An? (?:.*)\bnaisirc glows with an eerie green light\./,
    /^An? (?:.*)\bcsetairi waves her four arms in a triangular motion\./,
    /^An? (?:.*)\bwarlock pauses a moment as his eyes swim black with anti-mana\./,
    /^An? (?:.*)\b(?:avenger|crusader) traces a twisted symbol as (?:he|she) calls upon (?:his|her) inner power\./,
    /^An? (?:.*)\bvaespilon draws an ancient sigil in the air\./,
    /^An? (?:.*)\bsoul gestures and utters a phrase of arcane magic\./,
    /^An? (?:.*)\bcerebralite twists and coils its tentacles, sending tendrils of electricity crawling along the surface of its brain-like form\./,
    /^An? (?:.*)\bsiphon scythes its bladed arms together, creating a strident grating sound\./,
    /^An? (?:.*)\bmaster raises its hands while emitting a dissonant sing-song rhythm, causing the tattoos along its forearms and hands to flare to life with a dark light\./,
    /^An? (?:.*)\blich hisses out an incantation, (?:his|her) raspy breath (?:distorting|marking) the air with (?:a shimmer|hazy clouds)\./,

    # Sanctum
    /^An? (?:.*)\blurk moans out a garbled spell\./,
    /^An? (?:.*)\bsentinel mumbles a silent and sibilant prayer, channeling blue-green energy down (?:his|her) arms\./,
    /^An? (?:.*)\bfanatic throws back (?:his|her) head, quickening the air around (?:him|her) with motes of virescent light\./,
    /^An? (?:.*)\bshaper whispers an inhuman entreaty, and the shadows grow frenized and green-tinged around (?:him|her)\./,

    # The Hive, Zul Logoth
    /^An? (?:.*)\bthrall clumsily twists (?:her|his) palsied hands into a spell form, (?:her|his) fingers trailing waves of psionic energy\./,
    /^An? (?:.*)\bstrandweaver weaves complex threads of raw mana with (?:her|his) pale legs\./,

    # Stormpeak, Titan's Deluge
    /^An? (?:.*)\bherald chants in a low, guttural voice\./,
    /^An? (?:.*)\bfiend thrums with an upswelling of elemental energy\./,
    /^An? (?:.*)\bstormcaller mutters a thunderous chant as she lifts her eyes skyward\./,

    # Forgotten Vineyard
    /^An? (?:.*)\b(?:sorcerer|sorceress) draws a glowing sigil in the air\./,
    /^An? (?:.*)\b(?:sorcerer|sorceress) extends (?:her|his) finger toward you\!/,
    /^An? (?:.*)\b(?:bard|bardesss) begins to growl a guttural melody\./,
    /^An? (?:.*)\b(?:bard|bardesss) directs (?:her|his) guttural voice at you\!/,
    /^An? (?:.*)\bempath quietly growls a phrase of magic\./,
    /^An? (?:.*)\bempath snarls and gestures sharply at you\!/,
    /^An? (?:.*)\bempath draws a large sign in the air before (?:her|his)..\./,
    /^An? (?:.*)\bshaman utters an ancient prayer\./,
    /^An? (?:.*)\bshaman waves a hand dismissively at you\!/,

    # Sailor's Grief
    /^An? (?:.*)\boracle gurgles in a lost tongue, crackles of blue-green energy tangling over (?:his|her) misshapen limbs\./,
    /^An? (?:.*)\bmerrow croaks deep in (?:his|her) throat, channeling a torrent of shimmering energy down one squamous arm\./,
    /^An? (?:.*)\bbuccaneer lifts a rattling voice in an old nautical chanty\./,
    /^An? (?:.*)\bmass pulses grotesquely, sprouting mouths that chant in an ugly arcane tongue\./,
    /^An? (?:.*)\bkelpie emits a strange bluish light as the music of rushing water echoes around (?:him|her)\./,

    # Ta'Vaalor
    /^The (?:.*)\bsiren whispers a seductive song\./, # Mistydeep Siren, Toadwort

    # Moaning Phantom, Glaise Cnoc, Cemetery - covered by IMT entry
    /^An? (?:.*)\brevenant draws slowly inward!/, # Revenant, Glaise Cnoc, Cemetery
    /^The (?:.*)\bapparition wails with an unearthly cry!/, # Dark Apparition, Crypt
    /^The (?:.*)\bdirge wails a sad, eerie song!/, # Death Dirge, Plains of Bone
    /^The (?:.*)\bdarkwoode whispers with a sinister voice carried on the wind!/, # Darkwoode, Toadwort

    # Shadowy Spectre, Plains of Bone - covered by IMT entry
    /^An? (?:.*)\bgrey orc utters a harsh phrase of magic\./, # Grey Orc, Yander's Farm, Corn Field
    /^An? (?:.*)\bghoul master mutters a chant!/, # Ghoul Master, Plains of Bone
    /^An? (?:.*)\barch wight chants an evil incantation\./, # Arch Wight, Plains of Bone
    /^An? (?:.*)\bniirsha draws a fiery symbol in the air\./, # Niirsha, Lunule Weald
    /^An? (?:.*)\bcentaur ranger intones a low-pitched chant\./, # Centaur Ranger, Rambling Meadows, Hilltop
    /^An? (?:.*)\bsacristan spirit utters an arcane incantation\./, # Sacristan Spirit, Lunule Weald

    # Tree Spirit, Lunule Weald - covered by Red Forest's spirit pattern
    /^An? (?:.*)\bmonk utters an arcane incantation\./, # Frenzied Monk, Lunule Weald
    /^An? (?:.*)\bwood sprite utters an eerie sound\./, # Lesser Wood Sprite, Sorcerer's Isle
    /^An? (?:.*)\bspectre glows faintly as a spectral mist begins to swirl around (?:her|him)\./, # Bog Spectre, Faethyl Bog
  )

# ----------------------------
# Prep reaction (pull my wing pin)
# ----------------------------

def with_paused_scripts
  SCRIPTS_TO_PAUSE.each { |script| Script.pause(script) if Script.running?(script) }
  yield
ensure
  SCRIPTS_TO_PAUSE.each { |script| Script.unpause(script) if Script.running?(script) }
end

def react_to_enemy_prep(mode)
  return unless in_allowed_room?
  return if hidden?
  return if checkstunned
  npc = living_npc
  return unless npc
  # return Feat.available?('Absorb Magic')

  if mode == "dark"
    return unless ability_ready?("Crawling Shadow")
    result = nil
    with_paused_scripts do
      waitrt?
      waitcastrt?
      sleep 0.25
      result = dothistimeout("pull my wing pin", 2, /You draw your umbrous wings close as shadows seep outward/)
      sleep 0.5
    end
    echo "CRAWLING SHADOW {!}".center(45) if result.is_a?(String)
  else
    return unless ability_ready?("Prismatic Aegis")
    # We do not hard-require a specific success line; cooldown gating is the primary guard.
    with_paused_scripts do
      waitrt?
      waitcastrt?
      sleep 0.25
      dothistimeout("pull my wing pin", 2, /You draw your luminous wings inward and then snap them wide/)
      sleep 0.5
    end
    echo "PRISMATIC AEGIS {!}".center(45)
  end
end

# ----------------------------
# Combat abilities (your original logic)
# ----------------------------

# Optional: commands to run before each wing ability fires.
# Each value can be:
#   nil                => do nothing
#   "some command"     => run one command
#   ["cmd1", "cmd2"]   => run multiple commands in order
#
# You can change these to whatever you want.
PRECAST_FOR_ABILITY = {
  # Dark
  "Shadow Barb"     => ["incant 118"],
  "Barbed Sweep"    => ["incant 110"],
  "Rain of Thorns"  => ["invoke 1714 tat", "cast"],
  "Carrion Guard"   => nil,
  "Crawling Shadow" => nil,

  # Light
  "Radiant Pulse"        => nil,
  "Blast of Brilliance"  => nil,
  "Blinding Reprisal"    => nil,
  "Wings of Warding"     => nil,
  "Prismatic Aegis"      => nil,
}.freeze unless defined?(PRECAST_FOR_ABILITY)

def run_precast_for(ability_name)
  return if hidden?

  cmds = PRECAST_FOR_ABILITY[ability_name]
  return if cmds.nil?

  cmds = [cmds] if cmds.is_a?(String)

  cmds.each do |cmd|
    next if cmd.nil? || cmd.strip.empty?
    if cmd =~ /\A(?:incant|prep)\s+(\d+)\b/i
      spell_num = Regexp.last_match(1).to_i
      next unless Spell[spell_num].available?
    end

    waitrt?
    waitcastrt?

    # Use dothistimeout and treat "You gesture" as success
    dothistimeout(cmd, 5, /^You gesture/i)

    waitrt?
    waitcastrt?
    sleep 0.25
  end
end

def fire_wing_ability(command, ability_name)
  return if hidden?

  with_paused_scripts do
    waitrt?
    waitcastrt?
    run_precast_for(ability_name)
    fput command
    sleep 0.5
  end
end


def do_combat_actions(mode, npc)
  return if hidden?

  if mode == "dark"
    single = "Shadow Barb"
    multi  = "Barbed Sweep"
    aoe    = "Rain of Thorns"
    guard  = "Carrion Guard"
  else
    single = "Radiant Pulse"
    multi  = "Blast of Brilliance"
    aoe    = "Blinding Reprisal"
    guard  = "Wings of Warding"
  end

  # Single target when prone/stunned
  if ability_ready?(single)
    until Effects::Cooldowns.active?(single)
      break if npc.status =~ /dead|gone/

      fire_wing_ability("turn my wing pin", single)
    end
    echo "#{single} {!}".upcase.center(45)
  end

  # Multi-target (3+) when prone/stunned
  if GameObj.targets.count > 2 && ability_ready?(multi)
    until Effects::Cooldowns.active?(multi)
      break if npc.status =~ /dead|gone/

      fire_wing_ability("knock my wing pin", multi)
    end
    echo "#{multi} {!}".upcase.center(45)
  end

  # AOE (6+ targets)
  if GameObj.targets.count > 5 && ability_ready?(aoe)
    until Effects::Cooldowns.active?(aoe)
      break if npc.status =~ /dead|gone/

      fire_wing_ability("fold my wing pin", aoe)
    end
    echo "#{aoe} {!}".upcase.center(45)
  end

  # Defensive AOE (6+ targets, bleeding)
  if bleeding? && ability_ready?(guard)
    until Effects::Cooldowns.active?(guard)
      break if npc.status =~ /dead|gone/

      fire_wing_ability("push my wing pin", guard)
    end
    echo "#{guard} {!}".upcase.center(45)
  end

end

def run
  # ----------------------------
  # Startup: auto-detect mode
  # ----------------------------
  pin  = find_wing_pin
  mode = wing_pin_mode(pin)

  unless pin && mode
    echo "Usage: Wear a dark or pale wing-shaped pin, then run ;energywings"
    echo "No dark/pale wing-shaped pin found in inventory."
    GameObj.inv.each { |i| echo "INV: #{i.name} ##{i.id}" if i && i.name =~ /pin/i }
    return
  end

  echo "==============================================="
  echo "  ENERGYWINGS AUTO MODE: #{mode.upcase}"
  echo "  PIN: #{pin.name} ##{pin.id}"
  echo "==============================================="

  # ----------------------------
  # Thread A: line-driven prep detection (KSwole style)
  # ----------------------------
  listener = Thread.new do
    while (line = get)
      exit if checkdead

      # Auto-switch if you swap pins while running
      new_pin = find_wing_pin
      new_mode = wing_pin_mode(new_pin)
      if new_pin && new_mode && (new_mode != mode || new_pin.id != pin.id)
        mode = new_mode
        pin = new_pin
        echo "==============================================="
        echo "  ENERGYWINGS MODE SWITCHED: #{mode.upcase}"
        echo "  PIN: #{pin.name} ##{pin.id}"
        echo "==============================================="
      end

      react_to_enemy_prep(mode) if line =~ CREATURE_SPELL_PREPS_WING_PIN
    end
  end

  # ----------------------------
  # Thread B: periodic combat loop
  # ----------------------------
  combat = Thread.new do
    loop do
      sleep 0.5
      next unless in_allowed_room?

      npc = living_npc
      next unless npc

      do_combat_actions(mode, npc)
    end
  end

  listener.join
  combat.join
end
end

EnergyWings.run
