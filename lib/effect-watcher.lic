module Effects
  Defined = []

  class Watcher
    class Effect
      
      attr_reader :name, :start_msg, :stop_msg, :duration, :kind
      def initialize(name:, start:, stop: nil, duration: nil, kind: :debuff)
        @name = name
        @start_msg = start
        @stop_msg = stop
        @duration = duration || 120
        @kind = kind
        Effects::Defined << self
      end

      def store
        case self.kind
        when :debuff
          Effects::Debuffs
        when :buff
          Effects::Buffs
        end
      end

      def start
        Log.out("starting %s for %s seconds" % [self.name, self.duration])
        self.store.to_h[self.name] = Time.now + self.duration
      end

      def stop
        Log.out("ending %s" % [self.name])
        self.store.to_h.delete(self.name)
      end
    end

    # these effects are slow to populate in the game feed, but incredibly deadly
    # reaction time is paramount to success/survival
    Effect.new(
      name:   "Condemn", 
      start:  %r(The pungent stench of decay fills the air as mist rises from the floor around you!),
      stop: %r(The burden of condemnation lifts from your spirit.)
    )

    Effect.new(name: "Jaws",
      start:  %r[Suddenly, you hear a loud \*clink\* as a large pair of carefully concealed metal jaws slam shut on your (right|left) leg!],
      stop:  %r(The metal jaws restraining your movement snap apart.)
    )

    Effect.new(name: "Net",
      start:  %r(Suddenly, a carefully concealed net springs up from the ground, completely entangling you!),
      stop: %r(The net entangling you rips and falls apart.)
    )

    Effect.new(name: "SunderShield",
      start:  %r(You feel your left arm go numb!),
      stop: %r(The numbness in your left arm fades away.)
    )

    Effect.new(name: "Burrowed",
      start:  %r(The ground seems to distort and shudder beneath your feet.)
    )

    Effect.new(name: "Bounty Waiver",
      start: %r[You have redeemed a Bounty Task Waiver],
      duration: 60 * 15,
      kind: :buff)

    Effect.new(name: "Stamina Second Wind",
      start: %r{All thoughts of exhaustion vanish as your body and mind are as one.},
      stop: %r{Your skin tingles as the last of your second wind fades away.},
      duration: 60 * 60)

    Effect.new(name: "RiftSlow",
      start:  %r(The cold seeps into your flesh, burrowing down into your bones.  The sensation leaves your muscles feeling rigid and unresponsive.)
    )

    def self.main()
      while line=get
        Effects::Defined.each {|effect|
          effect.start if line =~ effect.start_msg
          effect.stop if effect.stop_msg && line =~ effect.stop_msg
        }
      end
    end

    Watcher.main()
  end
end