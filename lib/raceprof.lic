=begin

  Utility to display a character's race and profession in the Also Here: section when you LOOK
  or enter a room.  The display will appear like Parwyn (Sylvan-Ranger), or using short versions
  Parywn (Syl-Rgr).
  
  This is based off of Dreaven's title.lic and Jennora's race.lic.  It's my first GS script
  and first Ruby script.  Any suggestions are welcome.

  SYNTAX:
		;raceprof						= To start the script
		;raceprof race <name> <race> 	= To add/update someone with a race
		;raceprof prof <name> <prof> 	= To add/update someone with a profession
		;raceprof remove <name> 		= To remove someone
		;raceprof scan 					= To scan WHO list for new people needing data
		;raceprof reset all 			= To remove all data from everyone and start with a clean slate
		;raceprof short 				= To show shortened data
		;raceprof long 					= To show full data
		;raceprof short race 			= To show shortened races
		;raceprof long	race			= To show full races
		;raceprof short prof			= To show shortened professions
		;raceprof long prof				= To show full professions

       author: Parwyn
         game: gs
      version: 1.0.0

  changelog:
    1.0.0 (2026-02-05):
      * Initial release
=end

module RaceProfession
	SEARCHABLE_RACES = [ "Aelotoi", "Burghal Gnome", "Dark Elf", "Dwarf", "Elf", "Erithian", "Forest Gnome", "Giantman", "Half-Elf", "Half-Krolvin", "Halfling", "Human", "Sylvankind" ]
	DISPLAYABLE_RACES = [ "Aelotoi", "Burghal Gnome", "Dark Elf", "Dwarf", "Elf", "Erithian", "Forest Gnome", "Giantman", "Half-Elf", "Half-Krolvin", "Halfling", "Human", "Sylvankind", "Half-Sylvan" ]
	SHORT_RACES = [ "Ael", "BGn", "DkEf", "Dw", "Elf", "Er", "FGn", "G", "H/E", "H/K", "Hf", "H", "Syl", "H/Syl" ]

	SEARCHABLE_PROFESSIONS = [ "Bard", "Cleric", "Empath", "Monk", "Paladin", "Ranger", "Rogue", "Sorcerer", "Warrior", "Wizard" ]
	SHORT_PROFESSIONS = [ "Brd", "Clr", "Emp", "Mnk", "Pal", "Rgr", "Rog", "Sor", "War", "Wiz" ]

	SETTING_RACES = "player_races"
	SETTING_PROFESSIONS = "player_professions"
	SETTING_SHORT_RACE = "use_shortened_race_names"
	SETTING_SHORT_PROFESSION = "use_shortened_profession_names"

	@who_results = nil
	
	@use_shortened_race_names = CharSettings[SETTING_SHORT_RACE]
	@use_shortened_profession_names = CharSettings[SETTING_SHORT_PROFESSION]
	@script_races = Hash.new
	@script_professions = Hash.new
	
	def self.squelch_who = proc{
		started = false
		hook_proc = proc { |s|
			if started
				if s =~ /<prompt/
					DownstreamHook.remove('squelch-who')
					nil
				elsif s =~ /<output/
					s
				else
					nil
				end
			elsif s =~ /^Brave Adventurers Questing:/
				started = true
				nil
			else
				s
			end
		}
		DownstreamHook.add('squelch-who', hook_proc)
	}

	def self.gather_who_info = proc{|type,item|
		squelch_who.call
		silence_me
		fput "who #{type} #{item}"
		silence_me
		@who_results = nil
		while (line = get)
			if (line =~ /Brave Adventurers Questing\:/)
				while (line = get)
					@who_results += "#{line} " unless (line =~ /Total\:|^\[.*?\]\-[A-z]+\:|^\[server\]\: "/)
					break if (line =~ /Total\:/)
				end
				break
			end
		end
	}

	def self.run_scan = proc{|type,list,setting|
		players_added = nil
		number_of_players_added = 0
		respond "##########################################################################"
		respond "I am scanning players #{type} currently online, this might take a few seconds."
		respond "##########################################################################"
		list.each {|item|
			echo "Looking for #{item}..."
			gather_who_info.call(type,item)
			@who_results = @who_results.split(" ")
			@who_results.each { |name|
				unless CharSettings[setting].include?(name)
					players_added += "#{name} #{item}\n"
					CharSettings[setting].store(name, "#{item}")
					number_of_players_added += 1	
				end
			}
		}
		if players_added == nil
			respond "######################"
			respond "No players were added."
			respond "######################"
		else
			respond "##################################################"
			respond "The following players and their #{type}(s) were added:"
			respond "#{players_added}"
			respond "#{number_of_players_added} player #{type}(s) added."
			respond "##################################################"
		end
	}

	
	def self.display_info = proc{
		action = proc { |server_string|
			if server_string =~ /^Also here\:|^\<component id\=\'room players\'\>Also here\:/
				pc_name = nil
				characters = server_string.split(", ")
				characters.each{ |pc|
					if pc =~ /(.*)(\<a exist\=\".*\" noun\=\"(.*)\"\>.*\<\/a\>)(.*)/
						pre_status = $1
						full_name = $2
						name = $3
						post_status = $4
						race = nil
						profession = nil
						race = @script_races.fetch("#{name}") unless !@script_races.include?("#{name}")
						if (race && @use_shortened_race_names)
							race = SHORT_RACES[DISPLAYABLE_RACES.index(race)]
						end
						profession = @script_professions.fetch("#{name}") unless !@script_professions.include?("#{name}")
						if (profession && @use_shortened_profession_names)
							profession = SHORT_PROFESSIONS[SEARCHABLE_PROFESSIONS.index(profession)]
						end
						if(race || profession)
							race = race ? race : "?"
							profession = profession ? profession : "?"
							pc_name += "#{pre_status}#{full_name} (#{race}-#{profession})#{post_status}, "
						else
							pc_name += "#{pc}, "
						end
					end
				}
				server_string = "#{pc_name}".chop.chop + "\n"
			else
				server_string
			end
		}
		DownstreamHook.add("#{Script.current.name}_display_info", action)
		@script_races = CharSettings[SETTING_RACES]
		@script_professions = CharSettings[SETTING_PROFESSIONS]
	}
	
	def self.update_character(name,type,item,valid_items,setting)
		name = name.capitalize
		if valid_items.include?(item)
			CharSettings[setting].store("#{name}", "#{item}")
			DownstreamHook.remove("#{Script.current.name}_display_info")
			display_info.call
			echo "#{name} has been added with the #{type} of #{item}"
		else
			echo "#{type} must be one of #{valid_items}"
		end
	end
	
	def self.main
		Script.current.want_upstream = true
		script_name = Script.current.name
		CharSettings[SETTING_RACES] = Hash.new unless CharSettings[SETTING_RACES]
		CharSettings[SETTING_SHORT_RACE] = nil unless CharSettings[SETTING_SHORT_RACE]
		@use_shortened_race_names = CharSettings[SETTING_SHORT_RACE]

		CharSettings[SETTING_PROFESSIONS] = Hash.new unless CharSettings[SETTING_PROFESSIONS]
		CharSettings[SETTING_SHORT_PROFESSION] = nil unless CharSettings[SETTING_SHORT_PROFESSION]
		@use_shortened_profession_names = CharSettings[SETTING_SHORT_PROFESSION]
		
		display_info.call
		before_dying { DownstreamHook.remove("#{script_name}_display_info") }		
	
		loop{
			command = upstream_get
			if (command =~ /#{$lich_char}#{script_name} race ([a-zA-Z]+) (.*)/)
				update_character($1,"race",$2,DISPLAYABLE_RACES,SETTING_RACES)
			elsif (command =~ /#{$lich_char}#{script_name} prof ([a-zA-Z]+) (.*)/)
				update_character($1,"profession",$2,SEARCHABLE_PROFESSIONS,SETTING_PROFESSIONS)
			elsif (command =~ /#{$lich_char}#{script_name} remove ([a-zA-Z]+)/)
				name = $1.capitalize
				CharSettings[SETTING_RACES].delete("#{name}")
				CharSettings[SETTING_PROFESSIONS].delete("#{name}")
				DownstreamHook.remove("#{script_name}_display_info")
				display_info.call
				echo "#{name} has been removed from the list."
			elsif (command =~ /#{$lich_char}#{script_name} reset all/)
				CharSettings[SETTING_RACES] = Hash.new
				CharSettings[SETTING_PROFESSIONS] = Hash.new
				DownstreamHook.remove("#{script_name}_display_info")
				display_info.call
				echo "All data has been removed."
			elsif (command =~ /#{$lich_char}#{script_name} scan/)
				run_scan.call("race",SEARCHABLE_RACES,SETTING_RACES)
				run_scan.call("profession",SEARCHABLE_PROFESSIONS,SETTING_PROFESSIONS)
				DownstreamHook.remove("#{script_name}_display_info")
				display_info.call
			elsif (command =~ /#{$lich_char}#{script_name} short race/)
				CharSettings[SETTING_SHORT_RACE] = true
				@use_shortened_race_names = CharSettings[SETTING_SHORT_RACE]
				echo "races will now be shortened."
			elsif (command =~ /#{$lich_char}#{script_name} long race/)
				CharSettings[SETTING_SHORT_RACE] = nil
				@use_shortened_race_names = CharSettings[SETTING_SHORT_RACE]
				echo "races will now be full length."
			elsif (command =~ /#{$lich_char}#{script_name} short prof/)
				CharSettings[SETTING_SHORT_PROFESSION] = true
				@use_shortened_profession_names = CharSettings[SETTING_SHORT_PROFESSION]
				echo "professions will now be shortened."
			elsif (command =~ /#{$lich_char}#{script_name} long prof/)
				CharSettings[SETTING_SHORT_PROFESSION] = nil
				@use_shortened_profession_names = CharSettings[SETTING_SHORT_PROFESSION]
				echo "professions will now be full length."
			elsif (command =~ /#{$lich_char}#{script_name} short/)
				CharSettings[SETTING_SHORT_RACE] = true
				@use_shortened_race_names = CharSettings[SETTING_SHORT_RACE]
				CharSettings[SETTING_SHORT_PROFESSION] = true
				@use_shortened_profession_names = CharSettings[SETTING_SHORT_PROFESSION]
				echo "data will now be shortened."
			elsif (command =~ /#{$lich_char}#{script_name} long/)
				CharSettings[SETTING_SHORT_RACE] = nil
				@use_shortened_race_names = CharSettings[SETTING_SHORT_RACE]
				CharSettings[SETTING_SHORT_PROFESSION] = nil
				@use_shortened_profession_names = CharSettings[SETTING_SHORT_PROFESSION]
				echo "data will now be full length."
			elsif (command =~ /#{$lich_char}#{script_name}/) || (command =~ /#{$lich_char}#{script_name} help/)
				respond "\n"
				respond ";raceprof race <name> <race> 	= To add/update someone with a race"
				respond ";raceprof prof <name> <prof> 	= To add/update someone with a profession"
				respond ";raceprof remove <name> 		= To remove someone"
				respond ";raceprof scan 				= To scan WHO list for new people needing data"
				respond ";raceprof reset all 			= To remove all data from everyone and start with a clean slate"
				respond ";raceprof short 				= To show shortened data"
				respond ";raceprof long 				= To show full data"
				respond ";raceprof short race 			= To show shortened races"
				respond ";raceprof long	race			= To show full races"
				respond ";raceprof short prof			= To show shortened professions"
				respond ";raceprof long prof			= To show full professions"
			end
		}
	end
end

RaceProfession.main
