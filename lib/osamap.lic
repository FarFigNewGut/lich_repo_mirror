osaRooms = Hash.new

class Map
    def Map.set_osa_room_id(id)
        @@current_room_mutex.synchronize do
            if id
                $room_count += 1
                @@current_room_id = id.to_i
                @@current_room_count = XMLData.room_count
            else
                @@current_room_id = nil
                @@current_room_count = -1
            end
        end
    end
end

#Sloop
osaRooms[-7117010] = 29038
osaRooms[-7117011] = 29041
osaRooms[-7117012] = 29039
osaRooms[-7117013] = 29042
osaRooms[-7117014] = 29040

#Brigantine    
osaRooms[-7117020] = 30142
osaRooms[-7117021] = 30141
osaRooms[-7117022] = 30145
osaRooms[-7117023] = 30140
osaRooms[-7117024] = 30143
osaRooms[-7117025] = 30147
osaRooms[-7117026] = 30144
osaRooms[-7117027] = 30146

#Carrack
osaRooms[-7117030] = 30119
osaRooms[-7117031] = 30120
osaRooms[-7117032] = 30125
osaRooms[-7117033] = 30124
osaRooms[-7117034] = 30123
osaRooms[-7117035] = 30127
osaRooms[-7117036] = 30121
osaRooms[-7117037] = 30126
osaRooms[-7117038] = 30122

#Galleon
osaRooms[-7117040] = 30148
osaRooms[-7117041] = 30152
osaRooms[-7117042] = 30154
osaRooms[-7117043] = 30153
osaRooms[-7117044] = 30151
osaRooms[-7117045] = 30156
osaRooms[-7117046] = 30149
osaRooms[-7117047] = 30155
osaRooms[-7117048] = 30150
osaRooms[-7117049] = 30157

#Man o'war
osaRooms[-7117100] = 30130
osaRooms[-7117101] = 30128
osaRooms[-7117102] = 30136
osaRooms[-7117103] = 30129
osaRooms[-7117104] = 30135
osaRooms[-7117105] = 30138
osaRooms[-7117106] = 30131
osaRooms[-7117107] = 30137
osaRooms[-7117108] = 30132
osaRooms[-7117109] = 30139
osaRooms[-7117110] = 30133
osaRooms[-7117111] = 30134

action = proc {|server_string|	
	if server_string =~ /<nav rm='(-?[0-9]+)'\/>/
		if osaRooms.key?($1.to_i)
			Map.set_osa_room_id(osaRooms[$1.to_i])
		end
	end
	server_string
}

before_dying{DownstreamHook.remove(script.name);}

DownstreamHook.add(script.name, action)

mutex = Mutex.new
resource = ConditionVariable.new

mutex.synchronize {
    resource.wait(mutex)
}
