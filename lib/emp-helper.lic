=begin
  Handles empath things, runs as an autostart.

  Author: Felang Goredrinker
  Currently handles:
    - Removing Poison (Self)
    - Removing Disease (Self)
    - Casting adrenaline, based on stamina threshold
    - Casting cure, based on health threshold
    - Unstunning people in the room, will not unstun if running bigshot unless set to do so
      * Incorporates unstun.lic by Darkcipher
  Requirements:
    - 1107 - Adrenaline Surge >15 Blessing lore
    - 108  - Stun Relief
    - 113  - Undisease
    - 114  - Unpoison
  Releases:
    - v1.0 - Initial Release
    - v1.1 - Added player-defined thresholds and reuse timer
    - v1.2 - Incorporated unstun.lic by Darkcipher
    - v1.3 - Added debugging setting
    - v1.4 - Enabled array of checks based on spells known, removing specific requirements.
    - v1.5 - Enables turning on/off unstunning pcs
    - v1.6 - Modified from PaladinHelper to Empath for auto adrenaline surge stamina upkeep
=end

class PaladinHelper
  def initialize
    @last_rejuv_snap = Time.now
    @prev_stance = ''

    # PLayer Settings, CHANGE THESE
    @debug_mode_ph = false
    @scripts_to_pause = ['bigshot', 'sbounty', 'treim', 'useherbs', '1604', 'unstun', 'sigilz']
    @rejuv_reuse_timer = 5 
    @stamina_threshold = 50
    @health_threshold = 70
    @unstun_pcs = true
    @unstun_during_bigshot = true
    
    run(setup_checks)
  end

  def setup_checks
    checks = []
    if Spell[1107].known?
      checks << 'check_stamina' 
      checks << 'check_health'
    end
    checks << 'check_disease' if Spell[113].known?
    checks << 'check_poison' if Spell[114].known?
    checks << 'check_unstun' if Spell[108].known? && @unstun_pcs
    checks
  end

  def run(checks)
    echo "run()::checks:: #{checks}" if @debug_mode_ph
    loop do
      checks.each { |check| send(check) }
      pause 0.5
    end
  end

  def check_unstun
    return if checkstunned || checkdead
    return if Script.running?('bigshot') && !@unstun_during_bigshot
    echo 'check_unstun()' if @debug_mode_ph

    if (players = GameObj.pcs)
      players.each do |p|
        waitcastrt?
        if p.status =~ /stun/i
          wait_until{ checkmana >= 8 }
          waitrt?
          waitcastrt?
          fput "prep 108"
          fput "cast " + p.name
          pause 3
        end
      end
    end
  end

  def check_disease
    return unless checkdisease
    echo 'check_disease()' if @debug_mode_ph

    pause_scripts
    stance_def
    
    Spell[113].cast
    
    return_stance
    unpause_scripts
  end

  def check_poison
    return unless checkpoison    
    echo 'check_poison()' if @debug_mode_ph

    pause_scripts
    stance_def
    
    Spell[114].cast
    
    return_stance
    unpause_scripts
  end

  def check_stamina
    return if Spell[1107].active?
    return unless (Time.now - @last_rejuv_snap) > @rejuv_reuse_timer
    return unless percentstamina < @stamina_threshold
    return unless Spell[1107].affordable?
    echo 'check_stamina()' if @debug_mode_ph

    pause_scripts
    stance_def

    fput 'prep 1107'
    fput 'cast'
    
    @last_rejuv_snap = Time.now
    return_stance
    unpause_scripts
  end

  def check_health
    return unless (Time.now - @last_rejuv_snap) > @rejuv_reuse_timer
    return unless percenthealth < @health_threshold
    return unless Spell[1101].affordable?
    echo 'check_health()' if @debug_mode_ph

    pause_scripts
    stance_def

    fput 'cure'
    @last_rejuv_snap = Time.now

    return_stance
    unpause_scripts
  end

  def pause_scripts
    @scripts_to_pause.each { |script| Script.pause(script) if Script.running?(script) }
  end

  def unpause_scripts
    @scripts_to_pause.each { |script| Script.unpause(script) if Script.paused?(script) }
  end

  def stance_def
    @prev_stance = checkstance
    fput 'stance def'
  end

  def return_stance
    fput "stance #{@prev_stance}"
  end
end

PaladinHelper.new