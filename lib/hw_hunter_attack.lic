#hw_hunter_attack.lic
=begin

Author: Alastir

Variables used:
Vars.groupleader

=end

if $frontend == 'stormfront'
	fam_window_begin = "<pushStream id=\"announcements\" ifClosedStyle=\"watching\"/>"
	fam_window_end   = "<popStream/>\r\n"
end

def manacheck
	if checkmana < 150
		Spell[516].cast if !Spell[1708].active? and (Spell[9516].timeleft < 15) and (Spell[516].affordable?)
	end
end

def spellcheck
	if Char.prof == 'Bard'
		spells = [ 401, 406, 414, 425, 430, 1003, 1006, 1007, 1010, 1019 ]	
	elsif Char.prof == 'Cleric'
		spells = [ 101, 102, 103, 107, 120, 202, 211, 215, 219, 303, 307, 310, 313, 319 ]
	elsif Char.prof == 'Wizard'
		spells = [ 401, 406, 414, 425, 430, 503, 507, 508, 509, 513, 520, 905, 911, 913 ]
	end
	
	spells.each{ |i|
		Spell[i].cast if !Spell[i].active? && Spell[i].affordable?
	}
end

def stand
	if not standing?
		while not checkstance 'offensive'
			waitrt?
			fput 'stance offensive'
			sleep 0.10
		end

		waitrt?
		fput 'stand' until standing?
	end
end

def haste
	Spell[506].cast if Spell[506].known? and Spell[506].affordable? and Spell[506].timeleft < 0.1
end

def disable
	if $hw_hunter_attack_disabled == false		
		if Char.prof == 'Bard'
			Spell[1001].cast if Spell[1001].affordable?
		elsif Char.prof == 'Cleric'
			fput 'incant 316' if Spell[316].affordable?
		elsif Char.prof == 'Warrior'
			if checkstamina 30
				fput 'warcry cry all'
			end
		elsif Char.prof == 'Wizard'
			Spell[410].cast if Spell[410].affordable?
		end
		$hw_hunter_attack_disabled = true
	else
		sleep 0.5
	end
end

def attack(npc)
	loop {
		haste
		if npc.status =~ /dead|gone/
			break
		else
			waitrt?
			result = dothistimeout "attack ##{npc.id}", 5, /You (?:fire|swing|thrust)/
			#|What were you referring to?|A little bit late for that don't you think?|is already dead.
			if result =~ /You (?:fire|swing|thrust)/
				sleep 0.3
			else
				break
			end
		end
	}
end

def loot
	dead = GameObj.npcs.to_a.find_all { npc.status == 'dead' }
	if not dead.empty?
		Script.run('lootscript')
	end
end

$hw_hunter_attack_spells = [ '302', '306', '309', '312', '317', '111', '118' ]

##### MAIN LOOP

while GameObj.targets.any? {|npc| npc.status !~ /dead|gone/}
	GameObj.targets
	.reject {|npc| npc.status =~ /dead|gone/}
	.sample
	.tap { |npc|

		if not standing?
			stand
		end

		waitrt?
		waitcastrt?
		if Char.prof == 'Bard'
			if $hw_quantity == 0
				disable
			else
				sleep 0.2
				if npc.name =~ /bloodspeaker|cannibal|shield-maiden|berserker|skald/
					fput "incant 1002 ##{npc.id}" if Spell[1002].affordable? and npc.status !~ /dead|gone/
				else
					fput "incant 1030 ##{npc.id}" if Spell[1030].affordable? and npc.status !~ /dead|gone/
				end
				sleep 0.5
				break
			end
		elsif Char.prof == 'Cleric'
			if $hw_quantity == 0
				disable
			else
				if not Effects::Cooldowns.to_h.include?('Ethereal Censer') and !Spell[320].active?
					sleep 3
					fput "incant 320 ##{npc.id}" if Spell[320].affordable?
				end

=begin
				while !$hw_hunter_attack_spells.empty? && GameObj.targets.any? {|npc| npc.status !~ /dead|gone/ and npc.type =~ /bandit/}
					spell = $hw_hunter_attack_spells.sample
					Spell[spell].cast(npc) if Spell[spell].affordable? && npc.status !~ /dead|gone/
					$hw_hunter_attack_spells.delete(spell)
				end
=end
				spell = $hw_hunter_attack_spells.sample
				if spell =~ /306|111|118/
					while not checkstance 'offensive'
						fput 'stance offensive'
						sleep 0.3
					end
				end
				fput "incant #{spell} ##{npc.id}" if Spell[spell].affordable? && npc.status !~ /dead|gone/
				$hw_hunter_attack_spells.delete(spell)
				if $hw_hunter_attack_spells.empty?
					$hw_hunter_attack_spells = [ '302', '306', '309', '312', '317', '111', '118' ]
				end
			end
		elsif Char.prof == 'Warrior'
			if $hw_quantity == 0
				disable
			else
				while not checkstance 'offensive'
					fput 'cman stance 0'
					sleep 0.3
				end
				waitrt?
				if Shield.available?('Shield Throw')
#					Shield.use('Shield Throw')
					result = dothistimeout 'shield throw', 5, /You snap your arm forward, hurling your (.*) at (.*) with all your might!/
					if result =~ /You snap your arm forward, hurling your (.*) at (.*) with all your might!/
						waitrt?
					elsif result =~ /You currently have no valid target./
					end
				else
					attack(npc)
					break
				end
			end
		elsif Char.prof == 'Wizard'		
			if $hw_hunter_attack_disabled == false
				disable
				sleep 1
			end
			
			if !Spell[515].active?
				Spell[515].cast if Spell[515].affordable?
			end
			if !Spell[506].active?
				Spell[506].cast if Spell[506].affordable?
			end

			while not checkstance 'offensive'
				fput 'stance offensive'
				sleep 0.1
			end
			
			if percentencumbrance <= 10
				if npc.status =~ /dead|gone/
					break
				else
					attack(npc)
					break
				end
			else
				Spell[518].cast if Spell[518].affordable?
			end
		end
	}
end

if Script.running?('hw_hunter_leader')
	loot
end

waitrt?
if not standing?
	stand
end

spellcheck

if Char.prof == 'Warrior'
	fput 'cman stance 45'
else
	fput 'stance defensive'
end

$hw_hunter_attack_disabled = false

if Script.running?('hw_hunter_leader')
	result = checkbounty
	if result =~ /You need to kill (.*) more of them to complete your task./
		$hw_quantity = $1
		if $frontend == 'stormfront'
			puts("#{fam_window_begin}I need to kill #{$hw_quantity} more.\r\n#{fam_window_end}")	
		else
			respond("You hear the faint thoughts of HinterHunter echo in your mind:\r\nI need to kill #{$hw_quantity} more.\r\n")
		end
		$hw_hunter_leader_complete = false
	elsif result =~ /You succeeded in your task and should report back to the tavernkeeper at Rawknuckle's Common House./
		$hw_quantity = 0
		if $frontend == 'stormfront'
			puts("#{fam_window_begin}I have finished this bandit task.\r\n#{fam_window_end}")	
		else
			respond("You hear the faint thoughts of HinterHunter echo in your mind:\r\nI have finished this bandit task.\r\n")
		end
		$hw_hunter_leader_complete = true
	end
else
	if Char.name == "#{Vars.groupleader}"
	else
		result = checkbounty
		if result =~ /You need to kill ([\d,]+) of them to complete your task./
			$hw_quantity = $1
			fput "whisper #{Vars.groupleader} I need #{$hw_quantity} more."
			if $frontend == 'stormfront'
				puts("#{fam_window_begin}I need to kill #{$hw_quantity} more.\r\n#{fam_window_end}")	
			else
				respond("You hear the faint thoughts of HinterHunter echo in your mind:\r\nI need to kill #{$hw_quantity} more.\r\n")
			end
		elsif result =~ /You need to kill (.*) more of them to complete your task./
			$hw_quantity = $1
			fput "whisper #{Vars.groupleader} I need #{$hw_quantity} more."
			if $frontend == 'stormfront'
				puts("#{fam_window_begin}I need to kill #{$hw_quantity} more.\r\n#{fam_window_end}")	
			else
				respond("You hear the faint thoughts of HinterHunter echo in your mind:\r\nI need to kill #{$hw_quantity} more.\r\n")
			end
		elsif result =~ /You succeeded in your task and should report back to the tavernkeeper at Rawknuckle's Common House./
			$hw_quantity = 0
			fput "whisper #{Vars.groupleader} finished"
			if $frontend == 'stormfront'
				puts("#{fam_window_begin}I have finished this bandit task.\r\n#{fam_window_end}")	
			else
				respond("You hear the faint thoughts of HinterHunter echo in your mind:\r\nI have finished this bandit task.\r\n")
			end
		end
	end
end

sleep 5

fput 'target random'
exit
















def check_status

	if $frontend == 'stormfront'
		fam_window_begin = "<pushStream id=\"speech\" ifClosedStyle=\"watching\"/>"
		fam_window_end   = "<popStream/>\r\n"
	else
		fam_window_begin = "\034GSe\r\n"
		fam_window_end   = "\034GSf\r\n"
	end

	result = LNet.get_data("Rylohk", "bounty")
	if result =~ /^You have been tasked to suppress bandit activity/
		$rylohk_complete = false
		puts("#{fam_window_begin}Waiting for Rylohk.\r\n#{fam_window_end}")
	elsif result =~ /You have been tasked to help Alastir kill/
		$rylohk_complete = false		
		puts("#{fam_window_begin}Waiting for Rylohk.\r\n#{fam_window_end}")
	elsif result =~ /You succeeded in your task and should report back to the tavernkeeper at Rawknuckle's Common House./
		$rylohk_complete = true
		puts("#{fam_window_begin}Rylohk is finished.\r\n#{fam_window_end}")
	end
	result = LNet.get_data("Erykk", "bounty")
	if result =~ /^You have been tasked to suppress bandit activity/
		$erykk_complete = false
		puts("#{fam_window_begin}Waiting for Erykk.\r\n#{fam_window_end}")
	elsif result =~ /You have been tasked to help Alastir kill/
		$erykk_complete = false		
		puts("#{fam_window_begin}Waiting for Erykk.\r\n#{fam_window_end}")
	elsif result =~ /You succeeded in your task and should report back to the tavernkeeper at Rawknuckle's Common House./
		$erykk_complete = true
		puts("#{fam_window_begin}Erykk is finished.\r\n#{fam_window_end}")
	end
	result = LNet.get_data("Devereux", "bounty")
	if result =~ /^You have been tasked to suppress bandit activity/
		$devereux_complete = false
		puts("#{fam_window_begin}Waiting for Devereux.\r\n#{fam_window_end}")
	elsif result =~ /You have been tasked to help Alastir kill/
		$devereux_complete = false		
		puts("#{fam_window_begin}Waiting for Devereux.\r\n#{fam_window_end}")
	elsif result =~ /You succeeded in your task and should report back to the tavernkeeper at Rawknuckle's Common House./
		$devereux_complete = true
		puts("#{fam_window_begin}Erykk is finished.\r\n#{fam_window_end}")
	end
	result = LNet.get_data("Alastir", "bounty")
	if result =~ /^You have been tasked to suppress bandit activity/
		$hw_hunter_leader_complete = false
		puts("#{fam_window_begin}Waiting for Alastir.\r\n#{fam_window_end}")
	elsif result =~ /You have been tasked to help Alastir kill/
		$hw_hunter_leader_complete = false		
		puts("#{fam_window_begin}Waiting for Alastir.\r\n#{fam_window_end}")
	elsif result =~ /You succeeded in your task and should report back to the tavernkeeper at Rawknuckle's Common House./
		$hw_hunter_leader_complete = true
		puts("#{fam_window_begin}Alastir is finished.\r\n#{fam_window_end}")
	end	
end
