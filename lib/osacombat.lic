version = '4.1.0 (Febuary 16, 2026)'
=begin
	                             ud$$$**$$$$$$$bc.
                          u@**"        4$$$$$$$Nu
                        J                ""#$$$$$$r
                       @                       $$$$b
                     .F                        ^*3$$$
                    :% 4                         J$$$N
                    $  :F                       :$$$$$
                   4F  9                       J$$$$$$$
                   4$   k             4$$$$bed$$$$$$$$$
                   $$r  'F            $$$$$$$$$$$$$$$$$r
                   $$$   b.           $$$$$$$$$$$$$$$$$N
                   $$$$$k 3eeed$$b    $$$Euec."$$$$$$$$$
    .@$**N.        $$$$$" $$$$$$F'L $$$$$$$$$$$  $$$$$$$
    :$$L  'L       $$$$$ 4$$$$$$  * $$$$$$$$$$F  $$$$$$F         edNc
   @$$$$N  ^k      $$$$$  3$$$$*%   $F4$$$$$$$   $$$$$"        d"  z$N
   $$$$$$   ^k     '$$$"   #$$$F   .$  $$$$$c.u@$$$          J"  @$$$$r
   $$$$$$$b   *u    ^$L            $$  $$$$$$$$$$$$u@       $$  d$$$$$$
    ^$$$$$$.    "NL   "N. z@*     $$$  $$$$$$$$$$$$$P      $P  d$$$$$$$
       ^"*$$$$b   '*L   9$E      4$$$  d$$$$$$$$$$$"     d*   J$$$$$r
            ^$$$$u  '$.  $$$L     "#" d$$$$$$".@$$    .@$"  z$$$$*"
              ^$$$$. ^$N.3$$$       4u$$$$$$$ 4$$$  u$*" z$$$"
                '*$$$$$$$$ *$b      J$$$$$$$b u$$P $"  d$$P
                   #$$$$$$ 4$ 3*$"$*$ $"$'c@@$$$$ .u@$$$P
                     "$$$$  ""F~$ $uNr$$$^&J$$$$F $$$$#
                       "$$    "$$$bd$.$W$$$$$$$$F $$"
                         ?k         ?$$$$$$$$$$$F'*
                          9$$bL     z$$$$$$$$$$$F
                           $$$$    $$$$$$$$$$$$$
                            '#$$c  '$$$$$$$$$"
                             .@"#$$$$$$$$$$$$b
                           z*      $$$$$$$$$$$$N.
                         e"      z$$"  #$$$k  '*$$.
                     .u*      u@$P"      '#$$c   "$$c
              u@$*"""       d$$"            "$$$u  ^*$$b.
            :$F           J$P"                ^$$$c   '"$$$$$$bL
           d$$  ..      @$#                      #$$b         '#$
           9$$$$$$b   4$$                          ^$$k         '$
            "$$6""$b u$$                             '$    d$$$$$P
              '$F $$$$$"                              ^b  ^$$$$b$
               '$W$$$$"                                'b@$$$$"
                                                        ^$$$* 


-----------------------------------------------------------------------
	   OSACombat Version: 4.1.0 (Febuary 16, 2026)
	
	   Usage:
	   
	   ;osacombat setup                       Opens the setup window to configure combat routines
	   
	   OSACombat is an automated combat script for OSA but it will work in other hunting grounds as well
	   Enjoy 
		
	   ~Peggyanne 
	 PS: feel free to send me any bugs via discord Bait#4376 and I'll try my best to fix them.
	 
	 Change Log:
	 
                 May 24, 2025 - Improved Targeting Logic, Removed Attack Types and Added Use Archery and Use UAC W/O Weapons Checkboxs
                 June 7, 2025 - Removed Anti Effect methods, Ecleanse does this much better. Also fixed logic for assaults.
                June 19, 2025 - Resolved Lag and Redundancy Issues. Also Added Support for Paladin Feat Excoriate.
                June 22, 2025 - Adjusted Opener Spell Logic, Added Opener Support For Cold Snap And Added A Second Opener Spell.
                June 23, 2025 - Fixed Targeting Error In Second Spell Opener.
                July 19, 2025 - Fixed Issue With Unstun Method That Was Causing Lag.
                July 20, 2025 - Fixed Issue With Mob Count If Statements.
                July 26, 2025 - Adjusted Assaults And Removed Spell Active Check.
                July 30, 2025 - Added 611 To Openers Check.
               August 3, 2025 - Added 1650 Armor For Emergency Use And 1650 Zeal To Support Tab.
              August 18, 2025 - Added Second AOE And Assaults, Added Support For Flare Gloves Pound Feature And Added Auto Looting 
                                Depending On Weekly\Monthly Gemstone Finds (Uses Killtracker).
              August 23, 2025 - Added Self Cast Versions Of Barkskin And Added Self And Group Celerity To Buffs.
              August 31, 2025 - Added Checkbox For 330 Evoke For Both Hands And Improved Anti-Poaching Logic.
            September 6, 2025 - Fixed Minor Error In Anti-Poaching Logic.
           September 21, 2025 - Yet Again More Changes To Anti-Poaching and Hiding Group Member Logic.
           September 25, 2025 - Even More Anti-Poaching Fixes.
           September 26, 2025 - Removed Unnecessary Targeting, Changed Default Healing Room and Added Stance Dancing Toggle.
             December 6, 2025 - Added Gemstone Support, Removed Vars Dependancy, Added Yaml Support, Added Tooltips and Added Default Values.
             December 8, 2025 - Bug Fixes On Surge Of Strength and Warcry Targeting.
            December 13, 2025 - Fixed Upstream Toggle and Error Message.
            December 28, 2025 - Fixed Targeting Issue With Unearthly Chains and Evanescent Possession.
              January 2, 2026 - Fixed Minor Error In RT Management For Some Cmans.
             January 12, 2026 - Fixed Minor Logic Error In Buff Startup.
             January 17, 2026 - Added Stomp and Pound Options For 909.
             January 25, 2026 - Added Anti-Poaching Command For Toggle and Changed Name of Setup Method To Prevent Cross Script Errors.
              Febuary 1, 2026 - Update Yaml Read/Write Methods To Include FLOCK Operations To Prevent Data Corruption.
             Febuary 13, 2026 - Gave In To The Hype And Rewrote YAML config and GTK3 Using AI. Also Added Min Stamina And Mana As Well As Maximum Enemy Count Thresholds. Please Be Sure To Set These.
             Febuary 16, 2026 - Added Support For Energy Wings Offensive Abilities.
=end

def osacombat_help_display
	respond ""
	respond "
	                             ud$$$**$$$$$$$bc.
                          u@**\"        4$$$$$$$Nu
                        J                \"\"#$$$$$$r
                       @                       $$$$b
                     .F                        ^*3$$$
                    :% 4                         J$$$N
                    $  :F                       :$$$$$
                   4F  9                       J$$$$$$$
                   4$   k             4$$$$bed$$$$$$$$$
                   $$r  'F            $$$$$$$$$$$$$$$$$r
                   $$$   b.           $$$$$$$$$$$$$$$$$N
                   $$$$$k 3eeed$$b    $$$Euec.\"$$$$$$$$$
    .@$**N.        $$$$$\" $$$$$$F'L $$$$$$$$$$$  $$$$$$$
    :$$L  'L       $$$$$ 4$$$$$$  * $$$$$$$$$$F  $$$$$$F         edNc
   @$$$$N  ^k      $$$$$  3$$$$*%   $F4$$$$$$$   $$$$$\"        d\"  z$N
   $$$$$$   ^k     '$$$\"   #$$$F   .$  $$$$$c.u@$$$          J\"  @$$$$r
   $$$$$$$b   *u    ^$L            $$  $$$$$$$$$$$$u@       $$  d$$$$$$
    ^$$$$$$.    \"NL   \"N. z@*     $$$  $$$$$$$$$$$$$P      $P  d$$$$$$$
       ^\"*$$$$b   '*L   9$E      4$$$  d$$$$$$$$$$$\"     d*   J$$$$$r
            ^$$$$u  '$.  $$$L     \"#\" d$$$$$$\".@$$    .@$\"  z$$$$*\"
              ^$$$$. ^$N.3$$$       4u$$$$$$$ 4$$$  u$*\" z$$$\"
                '*$$$$$$$$ *$b      J$$$$$$$b u$$P $\"  d$$P
                   #$$$$$$ 4$ 3*$\"$*$ $\"$'c@@$$$$ .u@$$$P
                     \"$$$$  \"\"F~$ $uNr$$$^&J$$$$F $$$$#
                       \"$$    \"$$$bd$.$W$$$$$$$$F $$\"
                         ?k         ?$$$$$$$$$$$F'*
                          9$$bL     z$$$$$$$$$$$F
                           $$$$    $$$$$$$$$$$$$
                            '#$$c  '$$$$$$$$$\"
                             .@\"#$$$$$$$$$$$$b
                           z*      $$$$$$$$$$$$N.
                         e\"      z$$\"  #$$$k  '*$$.
                     .u*      u@$P\"      '#$$c   \"$$c
              u@$*\"\"\"       d$$\"            \"$$$u  ^*$$b.
            :$F           J$P\"                ^$$$c   '\"$$$$$$bL
           d$$  ..      @$#                      #$$b         '#$
           9$$$$$$b   4$$                          ^$$k         '$
            \"$$6\"\"$b u$$                             '$    d$$$$$P
              '$F $$$$$\"                              ^b  ^$$$$b$
               '$W$$$$\"                                'b@$$$$\"
                                                        ^$$$* 


-----------------------------------------------------------------------"
	respond "   OSACombat Version: #{version}"
	respond ""
	respond "Usage:"
	respond ""
	respond ";osacombat setup                       Opens the setup window to configure combat routines"
	respond ""
	respond "   OSACombat is an automated combat script for OSA but it will work in other hunting grounds as well"
	respond "   Enjoy "
	respond ""
	respond "   ~Peggyanne "
	respond " PS: feel free to send me any bugs via discord Bait#4376 and I'll try my best to fix them. "
	respond ""
	respond "Change Log:"
	respond ""
	respond "            May 24, 2025 - Improved Targeting Logic, Removed Attack Types and Added Use Archery and Use UAC W/O Weapons Checkboxs"
	respond	"            June 7, 2025 - Removed Anti Effect methods, Ecleanse does this much better. Also fixed logic for assaults."
	respond "           June 19, 2025 - Resolved Lag and Redundancy Issues. Also Added Support for Paladin Feat Excoriate."
	respond "           June 22, 2025 - Adjusted Opener Spell Logic, Added Opener Support For Cold Snap And Added A Second Opener Spell."
	respond "           June 23, 2025 - Fixed Targeting Error In Second Spell Opener."
	respond "           July 19, 2025 - Fixed Issue With Unstun Method That Was Causing Lag."
	respond "           July 20, 2025 - Fixed Issue With Mob Count If Statements."
	respond "           July 26, 2025 - Adjusted Assaults And Removed Spell Active Check."
	respond "           July 30, 2025 - Added 611 To Openers Check"
	respond "          August 3, 2025 - Added 1650 Armor For Emergency Use And 1650 Zeal To Support Tab."
	respond "         August 18, 2025 - Added Second AOE And Assaults, Support For Flare Gloves Pound Feature And Added Auto Looting"
	respond "                           Depending On Weekly\\Monthly Gemstone Finds (Uses Killtracker)."
	respond "         August 23, 2025 - Added Self Cast Versions Of Barkskin And Added Self And Group Celerity To Buffs."
	respond "         August 31, 2025 - Added Checkbox For 330 Evoke For Both Hands And Improved Anti-Poaching Logic."
	respond "       September 6, 2025 - Fixed Minor Error In Anti-Poaching Logic."
	respond "      September 21, 2025 - Yet Again More Changes To Anti-Poaching and Hiding Group Member Logic."
	respond "      September 25, 2025 - Even More Anti-Poaching Fixes."
	respond "      September 26, 2025 - Removed Unnecessary Targeting, Changed Default Healing Room and Added Stance Dancing Toggle."
	respond "        December 6, 2025 - Added Gemstone Support, Removed Vars Dependancy, Added Yaml Support, Added Tooltips and Added Default Values."
	respond "        December 8, 2025 - Bug Fixes On Surge Of Strength and Warcry Targeting."
	respond "       December 13, 2025 - Fixed Upstream Toggle and Error Message."
	respond "       December 28, 2025 - Fixed Targeting Issue With Unearthly Chains and Evanescent Possession."
	respond "         January 2, 2026 - Fixed Minor Error In RT Management For Some Cmans."
	respond "        January 12, 2026 - Fixed Minor Logic Error In Buff Startup."
	respond "        January 17, 2026 - Added Stomp and Pound Options For 909."
	respond "        January 25, 2026 - Added Anti-Poaching Command For Toggle and Changed Name of Setup Method To Prevent Cross Script Errors."
	respond "         Febuary 1, 2026 - Update Yaml Read/Write Methods To Include FLOCK Operations To Prevent Data Corruption."
	respond "        Febuary 13, 2026 - Gave In To The Hype And Rewrote YAML config and GTK3 Using AI. Also Added Min Stamina And Mana As Well As Maximum Enemy Count Thresholds. Please Be Sure To Set These."
	respond "        Febuary 16, 2026 - Added Support For Energy Wings Offensive Abilities."
	respond ""
end

def wait_rt
	#pause 0.1
	waitrt?
end

def wait_castrt
	#pause 0.1
	waitrt?
	#pause 0.1
	waitcastrt?
end

def ship_type
	case Room.current.id
	when (29038..29042)
			@ship_type = "sloop"
			@cargo_hold = 29039
			@main_deck = 29038
			@mid_deck = nil
			@forward_deck = nil
			@bow = nil
			@crows_nest = 29040
			@forward_crows_nest = nil
			@social_room = nil
			@mess_hall = nil
			@crew_quarters = nil
			@helm = 29041
			@cannons1 = 29038
			@cannons2 = nil
			@cannons3 = nil
			@captains_quarters = 29042
			@ship_map = [29038, 29039, 29040, 29041, 29042]
			@Slooptimes = UserVars.osacrew["Slooptimes"].last(50)
			if @Slooptimes.nil? or @Slooptimes.empty?
				@Slooptimes = [0.315]
			end
			@Sailtimes = @Slooptimes
	when (30140..30147)
			@ship_type = "brigantine"
			@cargo_hold = 30145
			@main_deck = 30142
			@mid_deck = nil
			@forward_deck = 30144
			@bow = nil
			@crows_nest = 30143
			@forward_crows_nest = nil
			@social_room = nil
			@mess_hall = 30147
			@crew_quarters = 30146
			@helm = 30141
			@captains_quarters = 30140
			@cannons1 = 30142
			@cannons2 = 30144
			@cannons3 = nil
			@ship_map = [30144, 30142, 30143, 30145, 30147, 30146, 30141, 30140]
			@Brigtimes = UserVars.osacrew["Brigtimes"].last(50)
			if @Brigtimes.nil? or @Brigtimes.empty?
				@Brigtimes = [0.30000000000000000]
			end
			@Sailtimes = @Brigtimes
	when (30119..30127)
			@ship_type = "carrack"
			@cargo_hold = 30125
			@main_deck = 30119
			@mid_deck = nil
			@forward_deck = 30121
			@social_room = nil
			@bow = 30122
			@crows_nest = 30123
			@forward_crows_nest = nil
			@mess_hall = 30127
			@crew_quarters = 30126
			@helm = 30120
			@captains_quarters = 30124
			@cannons1 = 30119
			@cannons2 = 30121
			@cannons3 = nil
			@ship_map = [30122, 30121, 30123, 30119, 30127, 30125, 30126, 30120, 30124]
			@Cartimes = UserVars.osacrew["Cartimes"].last(50)
			if @Cartimes.nil? or @Cartimes.empty?
				@Cartimes = [0.30000000000000000]
			end
			@Sailtimes = @Cartimes
	when (30176..30186)
			@ship_type = "galleon"
			@cargo_hold = 30182
			@main_deck = 30176
			@mid_deck = nil
			@forward_deck = 30177
			@bow = 30178
			@crows_nest = 30181
			@forward_crows_nest = nil
			@social_room = 30185
			@mess_hall = 30184
			@crew_quarters = 30183
			@helm = 30179
			@captains_quarters = 30180
			@cannons1 = 30176
			@cannons2 = 30177
			@cannons3 = nil
			@ship_map = [30178, 30177, 30181, 30176, 30185, 30184, 30182, 30183, 30179, 30180]
			@Galtimes = UserVars.osacrew["Galtimes"].last(50)
			if @Galtimes.nil? or @Galtimes.empty?
				@Galtimes = [0.30000000000000000]
			end
			@Sailtimes = @Galtimes
	when (30166..30175)
			@ship_type = "frigate"
			@cargo_hold = 30167
			@main_deck = 30166
			@mid_deck = nil
			@forward_deck = 30171
			@bow = 30172
			@crows_nest = 30173
			@forward_crows_nest = nil
			@social_room = 30170
			@mess_hall = 30169
			@crew_quarters = 30168
			@helm = 30174
			@captains_quarters = 30175
			@cannons1 = 30166
			@cannons2 = 30171
			@cannons3 = nil
			@ship_map = [30172, 30171, 30173, 30166, 30170, 30169, 30167, 30168, 30174, 30175]
			@Fritimes = UserVars.osacrew["Fritimes"].last(50)
			if @Fritimes.nil? or @Fritimes.empty?
				@Fritimes = [0.30000000000000000]
			end
			@Sailtimes = @Fritimes
	when (30128..30139)
			@ship_type = "man o' war"
			@cargo_hold = 30136
			@main_deck = 30130
			@mid_deck = 30131
			@forward_deck = 30132
			@bow = 30133
			@crows_nest = 30135
			@forward_crows_nest = 30134
			@social_room = 30139
			@mess_hall = 30138
			@crew_quarters = 30137
			@helm = 30128
			@captains_quarters = 30129
			@cannons1 = 30130
			@cannons2 = 30131
			@cannons3 = 30132
			@ship_map = [30133, 30134, 30132, 30131, 30135, 30130, 30139, 30138, 30136, 30137, 30128, 30129]
			@Mantimes = UserVars.osacrew["Mantimes"].last(50)
			if @Mantimes.nil? or @Mantimes.empty?
				@Mantimes = [0.35000000000000000]
			end
			@Sailtimes = @Mantimes
	end
	if (30787..30791).include? Room.current.id || (@enemy_main_deck == 30787)
			@enemy_ship_type = "Sloop"
			@enemy_bow = nil
			@enemy_forward_deck = nil
			@enemy_forward_crows_nest = nil
			@enemy_mid_deck = nil
			@enemy_main_deck = 30787
			@enemy_crows_nest = 30791
			@enemy_cargo_hold = 30790
			@enemy_helm = 30788
			@enemy_quarters = 30789
			@enemy_ship_map = [30787, 30791, 30788, 30790]
	end
	if (30792..30797).include? Room.current.id || (@enemy_main_deck == 30792)
			@enemy_ship_type = "Brigantine"
			@enemy_bow = nil
			@enemy_forward_deck = 30797
			@enemy_forward_crows_nest = nil
			@enemy_mid_deck = nil
			@enemy_main_deck = 30792
			@enemy_crows_nest = 30796
			@enemy_cargo_hold = 30795
			@enemy_helm = 30793
			@enemy_quarters = 30794
			@enemy_ship_map = [30797, 30792, 30796, 30793, 30795]
	end
	if (30266..30272).include? Room.current.id || (@enemy_main_deck == 30266)
			@enemy_ship_type = "Carrack"
			@enemy_bow = 30272
			@enemy_forward_deck = 30271
			@enemy_forward_crows_nest = nil
			@enemy_mid_deck = nil
			@enemy_main_deck = 30266
			@enemy_crows_nest = 30270
			@enemy_cargo_hold = 30269
			@enemy_helm = 30267
			@enemy_quarters = 30268
			@enemy_ship_map = [30272, 30271, 30266, 30270, 30267, 30269]
	end
	if (30798..30804).include? Room.current.id || (@enemy_main_deck == 30798)
			@enemy_ship_type = "Galleon"
			@enemy_bow = 30804
			@enemy_forward_deck = 30803
			@enemy_forward_crows_nest = nil
			@enemy_mid_deck = nil
			@enemy_main_deck = 30798
			@enemy_crows_nest = 30802
			@enemy_cargo_hold = 30801
			@enemy_helm = 30799
			@enemy_quarters = 30800
			@enemy_ship_map = [30804, 30803, 30798, 30802, 30799, 30801]
	end
	if (30805..30810).include? Room.current.id || (@enemy_main_deck == 30805)
			@enemy_ship_type = "Frigate"
			@enemy_bow = nil
			@enemy_forward_deck = 30810
			@enemy_forward_crows_nest = nil
			@enemy_mid_deck = nil
			@enemy_main_deck = 30805
			@enemy_crows_nest = 30809
			@enemy_cargo_hold = 30808
			@enemy_helm = 30806
			@enemy_quarters = 30807
			@enemy_ship_map = [30810, 30805, 30809, 30806, 30808]
	end
	if (30778..30786).include? Room.current.id || (@enemy_main_deck == 30778)
			@enemy_ship_type = "Man O' War"
			@enemy_bow = 30784
			@enemy_forward_deck = 30786
			@enemy_forward_crows_nest = 30785
			@enemy_mid_deck = 30783
			@enemy_main_deck = 30778
			@enemy_crows_nest = 30782
			@enemy_cargo_hold = 30781
			@enemy_helm = 30779
			@enemy_quarters = 30780
			@enemy_ship_map = [30784, 30786, 30785, 30783, 30778, 30782, 30779, 30781]
	end
end

####### Miscelleanous Combat Actions
def osa_put(message)
    unless (script = Script.self) then
      respond('--- waitfor: Unable to identify calling script.')
      return false
    end
    clear
    put(message)

    while (string = get)
      if string.to_s =~ /(?:\.\.\.wait |Wait )[0-9]+/
        hold_up = string.slice(/[0-9]+/).to_i
        sleep(hold_up - 1) unless hold_up.nil? || hold_up == 1
        clear
        put(message)
        next
      elsif string.to_s =~ /struggle.+stand/
        clear
        osa_put("stand")
        next
      elsif string.to_s =~ /stunned|can't do that while|cannot seem|can't seem|don't seem|Sorry, you may only type ahead/
        if dead?
          echo("You're dead...! You can't do that!")
          sleep(0.25)
          script.downstream_buffer.unshift(string)
          return false
        elsif checkstunned
          while checkstunned
            sleep(0.25)
          end
        elsif checkwebbed
          while checkwebbed
            sleep(0.25)
          end
        else
          sleep(0.25)
        end
        clear
        put(message)
        next
      else
        script.downstream_buffer.unshift(string)
        return string
      end
    end
end

def change_stance(new_stance, force = true)
	#health_monitor
    return if Spell[216].active? || dead?
    perfect_stance = nil
    if new_stance =~ /10|20|30|40|50|60|70|80|90|100/i
      perfect_stance = new_stance
      new_stance = "advance" if perfect_stance =~ /10|20/i
      new_stance = "forward" if perfect_stance =~ /30|40/i
      new_stance = "neutral" if perfect_stance =~ /50|60/i
      new_stance = "guarded" if perfect_stance =~ /70|80/i
      new_stance = "defensive" if perfect_stance =~ /90|100/i
    end
    if (stance() =~ /#{new_stance}/)
      return
    elsif (checkcastrt() > 0 && new_stance =~ /def/)
      return if stance() == 'guarded'
    end

    if ((force) && (perfect_stance != nil) && (CMan.known?("Stance Perfection")))
      dothistimeout("cman stance #{perfect_stance}", 3, /You are now in an?|You move into an?|You fall back into a|Cast Roundtime in effect|You are unable to change/)
    elsif (force)
      dothistimeout("stance #{new_stance}", 3, /You are now in an?|You move into an?|You fall back into a|Cast Roundtime in effect|You are unable to change/)
    else
      fput "stance #{new_stance}"
    end
end

def get_target
	if GameObj.target.nil?
		fput "target random"
	end
end

def flavor_messaging
	$percent_chance = rand(0-100)
	$flavor_message = rand(1-20)
	if $percent_chance.to_i <= $osa_data["$osa_cheeseball"].to_i && (GameObj.target.status != "dead")
		if $flavor_message == 1
			fput "recite Feel The Wrath of Lorminstra!"
		end
		if $flavor_message == 2
			fput "recite Feel The Undying Cold Of Lady Winter's Justice!"
		end
		if $flavor_message == 3
			fput "recite Behold The Awesome Power Of Lorminstra!"
		end
		if $flavor_message == 4
			fput "recite Fear The Cold Embrace Of The Gatekeeper!"
		end
		if $flavor_message == 5
			fput "recite I Send Thee To Lady Winter, May You Be Judged Favorably!"
		end
		if $flavor_message == 6
			fput "recite Begone Foul Abomination;Luukos Be Damned, All Praise Lorminstra!"
		end
		if $flavor_message == 7
			fput "recite All Praise Lady Winter!"
		end
		if $flavor_message == 8
			fput "recite Behold The Might Of The Gatekeeper!"
		end
		if $flavor_message == 9
			fput "recite In The Name Of Lorminstra!;I Release You From The Evil Binds Of The Serpent!"
		end
		if $flavor_message == 10
			fput "recite Lady Winter, I Pray You Set This Tortured Soul Free!"
		end
		if $flavor_message == 11
			fput "recite For Lorminstra!"
		end
		if $flavor_message == 12
			fput "recite For Lady Winter!"
		end
		if $flavor_message == 13
			fput "recite For The Gatekeeper!"
		end
		if $flavor_message == 14
			fput "recite For The Glory Of Lorminstra!"
		end
		if $flavor_message == 15
			fput "recite For The Glory Of Lady Winter!"
		end
		if $flavor_message == 16
			fput "recite For The Glory Of The Gatekeeper!"
		end
		if $flavor_message == 17
			fput "recite Behold The Might Of Lorminstra!"
		end
		if $flavor_message == 18
			fput "recite Behold The Might Of Lady Winter!"
		end
		if $flavor_message == 19
			fput "recite All Praise Lorminstra!"
		end
		if $flavor_message == 20
			fput "recite All Praise The Gatekeeper!"
		end
	end
end

def check_for_gemstones
	$no_asc_loot = false
	if $killtracker[:monthly_gemstones] == nil
		$monthlygemstones = 0
	else
		$monthlygemstones = $killtracker[:monthly_gemstones]
	end
	if $killtracker[:weekly_gemstone] == nil
		$weeklygemstone = 0
	else
		$weeklygemstone = $killtracker[:weekly_gemstone]
	end
	if $monthlygemstones > 2
		$no_asc_loot = true
	end
	if $weeklygemstone > 0
		$no_asc_loot = true
	end
end

def looter
	health_monitor
	checkfordead
	if @deadnpcs.count > 0 && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		check_for_poaching if $osa_data["$osa_check_for_group"]
		check_for_gemstones
		if ($osa_data["$osa_osalooter"] or $osa_data["$osa_skin_only"])  && !$poaching
			if $osa_data["$osa_usekilltracker"] && $no_asc_loot
				if $osa_data["$osa_skin_only"]
					start_script("eloot", ["skin"])
				end
				nil
			else
				stance_defensive
				if $osa_data["$osa_skin_only"]
					start_script("eloot", ["skin"])
				else
					start_script "eloot"
				end
				wait_while { running?("eloot") }
				if checkname == "Peggyanne"
					if $daybringer.nil?
						check_daybringer
					end
					if $daybringer
						daybringer_light
					end
					if !$daybringer
						daybringer_darkness
					end
					wait_rt
				end
			end
		end
	end
end

def cast_at_bad_thing
	if (Spell[612].known? and Spell[612].affordable?) && (($potential_bad_thing.noun == "cloud") or ($potential_bad_thing.noun == "cyclone") or ($potential_bad_thing.noun == "whirlwind") or ($potential_bad_thing.noun == "sandstorm") or ($potential_bad_thing.noun == "vortex")) && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		wait_rt
		Spell[612].cast
		return
	end
	if (Spell[417].known? and Spell[417].affordable?) && (!$osa_data["$osa_myweapon"].nil?) && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		wait_rt
		Spell[417].cast $osa_data["$osa_myweapon"]
	end
	if (Spell[417].known? and Spell[417].affordable?) && (($potential_bad_thing.noun == "vine") or ($potential_bad_thing.noun == "cyclone") or ($potential_bad_thing.noun == "whirlwind") or ($potential_bad_thing.noun == "sandstorm") or ($potential_bad_thing.noun == "swarm") or ($potential_bad_thing.noun == "tempest") or ($potential_bad_thing.noun == "void") or ($potential_bad_thing.noun == "web") or ($potential_bad_thing.noun == "cloud") or ($potential_bad_thing.noun == "vortex") or ($potential_bad_thing.noun == "globe")or ($potential_bad_thing.noun == "rift")) && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		wait_rt
		Spell[417].cast "##{$potential_bad_thing.id}"
		return
	end
	if (Spell[505].known? and Spell[505].affordable?) && (($potential_bad_thing.noun == "cloud") or ($potential_bad_thing.noun == "cyclone") or ($potential_bad_thing.noun == "whirlwind") or ($potential_bad_thing.noun == "sandstorm") or ($potential_bad_thing.noun == "vortex")) && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		wait_rt
		Spell[505].cast "##{$potential_bad_thing.id}"
		return
	end
	if (Spell[119].known? and Spell[119].affordable?) && (!$osa_data["$osa_myweapon"].nil?) && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		wait_rt
		Spell[119].cast $osa_data["$osa_myweapon"]
	end
	if (Spell[119].known? and Spell[119].affordable?) && (($potential_bad_thing.noun == "vine") or ($potential_bad_thing.noun == "cyclone") or ($potential_bad_thing.noun == "whirlwind") or ($potential_bad_thing.noun == "sandstorm") or ($potential_bad_thing.noun == "swarm") or ($potential_bad_thing.noun == "tempest") or ($potential_bad_thing.noun == "void") or ($potential_bad_thing.noun == "web") or ($potential_bad_thing.noun == "cloud") or ($potential_bad_thing.noun == "vortex")or ($potential_bad_thing.noun == "globe")or ($potential_bad_thing.noun == "rift")) && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		wait_rt
		Spell[119].cast "##{$potential_bad_thing.id}"
		return
	end
	if (Spell[1218].known? and Spell[1218].affordable?) && (($potential_bad_thing.noun == "cloud") or ($potential_bad_thing.noun == "cyclone")) && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
        wait_rt
        Spell[1218].cast "##{$potential_bad_thing.id}"
        return
    end
end

def creature_type
	if !GameObj.targets.empty? && GameObj.target.nil?
		fput "target random"
	end
	if GameObj.target.type.include? "undead"
		@creature_type = "undead"
	end
	if !GameObj.target.type.include? "undead"
		@creature_type = "living"
	end
	if @creature_type == "living"
		@attack_stance = $osa_data["$osa_attack_stance"].to_i
		@defending_stance = $osa_data["$osa_defending_stance"].to_i
		@setup_attack = $osa_data["$osa_setup_attack"].to_i
		@setup_attack_stamina_min = $osa_data["$osa_setup_attack_stam_min"].to_i
		@setup_attack_mana_min = $osa_data["$osa_setup_attack_man_min"].to_i
		@setup_attack_enemy_min = $osa_data["$osa_setup_attack_enemy_min"].to_i
		@setup_attack_enemy_max = $osa_data["$osa_setup_attack_enemy_max"].to_i
		@setup_attack2 = $osa_data["$osa_setup_attack2"].to_i
		@setup_attack2_stam_min = $osa_data["$osa_setup_attack2_stam_min"].to_i
		@setup_attack2_mana_min = $osa_data["$osa_setup_attack2_man_min"].to_i
		@setup_attack2_enemy_min = $osa_data["$osa_setup_attack2_enemy_min"].to_i
		@setup_attack2_enemy_max = $osa_data["$osa_setup_attack2_enemy_max"].to_i
		@special_attack = $osa_data["$osa_special_attack"].to_i
		@special_attack_stam_min = $osa_data["$osa_special_attack_stam_min"].to_i
		@special_attack_mana_min = $osa_data["$osa_special_attack_man_min"].to_i
		@special_attack_enemy_min = $osa_data["$osa_special_attack_enemy_min"].to_i
		@special_attack_enemy_max = $osa_data["$osa_special_attack_enemy_max"].to_i
		@special_attack2 = $osa_data["$osa_special_attack"].to_i
		@special_attack2_stam_min = $osa_data["$osa_special_attack2_stam_min"].to_i
		@special_attack2_mana_min = $osa_data["$osa_special_attack2_man_min"].to_i
		@special_attack2_enemy_min = $osa_data["$osa_special_attack2_enemy_min"].to_i
		@special_attack2_enemy_max = $osa_data["$osa_special_attack2_enemy_max"].to_i
		@aoe_attack = $osa_data["$osa_aoe_attack"].to_i
		@aoe_attack_stam_min = $osa_data["$osa_aoe_attack_stam_min"].to_i
		@aoe_attack_mana_min = $osa_data["$osa_aoe_attack_man_min"].to_i
		@aoe_attack_enemy_min = $osa_data["$osa_aoe_attack_enemy_min"].to_i
		@aoe_attack_enemy_max = $osa_data["$osa_aoe_attack_enemy_max"].to_i
		@aoe_attack2 = $osa_data["$osa_aoe_attack2"].to_i
		@aoe_attack2_stam_min = $osa_data["$osa_aoe_attack2_stam_min"].to_i
		@aoe_attack2_mana_min = $osa_data["$osa_aoe_attack2_man_min"].to_i
		@aoe_attack2_enemy_min = $osa_data["$osa_aoe_attack2_enemy_min"].to_i
		@aoe_attack2_enemy_max = $osa_data["$osa_aoe_attack2_enemy_max"].to_i
		@assault = $osa_data["$osa_assault"].to_i
		@assault_stam_min = $osa_data["$osa_assault_stam_min"].to_i
		@assault_mana_min = $osa_data["$osa_assault_man_min"].to_i
		@assault_enemy_min = $osa_data["$osa_assault_enemy_min"].to_i
		@assault_enemy_max = $osa_data["$osa_assault_enemy_max"].to_i
		@assault2 = $osa_data["$osa_assault2"].to_i
		@assault2_stam_min = $osa_data["$osa_assault2_stam_min"].to_i
		@assault2_mana_min = $osa_data["$osa_assault2_man_min"].to_i
		@assault2_enemy_min = $osa_data["$osa_assault2_enemy_min"].to_i
		@assault2_enemy_max = $osa_data["$osa_assault2_enemy_max"].to_i
		@attack_spell_opener = "#{$osa_data["$osa_spell_opener"]}"
		@attack_spell_opener_stam_min = $osa_data["$osa_spell_opener_stam_min"].to_i
		@attack_spell_opener_mana_min = $osa_data["$osa_spell_opener_man_min"].to_i
		@attack_spell_opener_enemy_min = $osa_data["$osa_spell_opener_enemy_min"].to_i
		@attack_spell_opener_enemy_max = $osa_data["$osa_spell_opener_enemy_max"].to_i
		@attack_spell_opener_warding = $osa_data["$osa_spell_opener_warding"]
		@attack_spell_opener_channel = $osa_data["$osa_spell_opener_channel"]
		@attack_spell_opener_evoke = $osa_data["$osa_spell_opener_evoke"]
		@attack_spell_opener_open_cast = $osa_data["$osa_spell_opener_open_cast"]
		@attack_spell_opener2 = "#{$osa_data["$osa_spell_opener2"]}"
		@attack_spell_opener2_stam_min = $osa_data["$osa_spell_opener2_stam_min"].to_i
		@attack_spell_opener2_mana_min = $osa_data["$osa_spell_opener2_man_min"].to_i
		@attack_spell_opener2_enemy_min = $osa_data["$osa_spell_opener2_enemy_min"].to_i
		@attack_spell_opener2_enemy_max = $osa_data["$osa_spell_opener2_enemy_max"].to_i
		@attack_spell_opener2_warding = $osa_data["$osa_spell_opener2_warding"]
		@attack_spell_opener2_channel = $osa_data["$osa_spell_opener2_channel"]
		@attack_spell_opener2_evoke = $osa_data["$osa_spell_opener2_evoke"]
		@attack_spell_opener2_open_cast = $osa_data["$osa_spell_opener2_open_cast"]
		@attack_spell = "#{$osa_data["$osa_attack_spell"]}"
		@attack_spell_stam_min = $osa_data["$osa_attack_spell_stam_min"].to_i
		@attack_spell_mana_min = $osa_data["$osa_attack_spell_man_min"].to_i
		@attack_spell_enemy_min = $osa_data["$osa_attack_spell_enemy_min"].to_i
		@attack_spell_enemy_max = $osa_data["$osa_attack_spell_enemy_max"].to_i
		@attack_spell_warding = $osa_data["$osa_spell_warding"]
		@attack_spell_channel = $osa_data["$osa_spell_channel"]
		@attack_spell_evoke = $osa_data["$osa_spell_evoke"]
		@attack_spell_open = $osa_data["$osa_spell_open_cast"]
		if @attack_spell_evoke && !@attack_spell_channel
			@cast_type = "evoke"
		elsif @attack_spell_channel && !@attack_spell_evoke
			@cast_type = "channel"
		elsif @attack_spell_channel && @attack_spell_evoke
			@cast_type = "evoke channel"
		else
			@cast_type = ""
		end
		@attack_spell2 = "#{$osa_data["$osa_attack_spell2"]}"
		@attack_spell2_stam_min = $osa_data["$osa_attack_spell2_stam_min"].to_i
		@attack_spell2_mana_min = $osa_data["$osa_attack_spell2_man_min"].to_i
		@attack_spell2_enemy_min = $osa_data["$osa_attack_spell2_enemy_min"].to_i
		@attack_spell2_enemy_max = $osa_data["$osa_attack_spell2_enemy_max"].to_i
		@attack_spell2_warding = $osa_data["$osa_spell2_warding"]
		@attack_spell2_channel = $osa_data["$osa_spell2_channel"]
		@attack_spell2_evoke = $osa_data["$osa_spell2_evoke"]
		@attack_spell2_open = $osa_data["$osa_spell2_open_cast"]
		if @attack_spell2_evoke && !@attack_spell2_channel
			@cast_type2 = "evoke"
		elsif @attack_spell2_channel && !@attack_spell2_evoke
			@cast_type2 = "channel"
		elsif @attack_spell2_channel && @attack_spell2_evoke
			@cast_type2 = "evoke channel"
		else
			@cast_type2 = ""
		end
		@attack_spell3 = "#{$osa_data["$osa_attack_spell3"]}"
		@attack_spell3_stam_min = $osa_data["$osa_attack_spell3_stam_min"].to_i
		@attack_spell3_mana_min = $osa_data["$osa_attack_spell3_man_min"].to_i
		@attack_spell3_enemy_min = $osa_data["$osa_attack_spell3_enemy_min"].to_i
		@attack_spell3_enemy_max = $osa_data["$osa_attack_spell3_enemy_max"].to_i
		@attack_spell3_warding = $osa_data["$osa_spell3_warding"]
		@attack_spell3_channel = $osa_data["$osa_spell3_channel"]
		@attack_spell3_evoke = $osa_data["$osa_spell3_evoke"]
		@attack_spell3_open = $osa_data["$osa_spell3_open_cast"]
		if @attack_spell3_evoke && !@attack_spell3_channel
			@cast_type3 = "evoke"
		elsif @attack_spell3_channel && !@attack_spell3_evoke
			@cast_type3 = "channel"
		elsif @attack_spell3_channel && @attack_spell3_evoke
			@cast_type3 = "evoke channel"
		else
			@cast_type3 = ""
		end
		@attack_spell4 = "#{$osa_data["$osa_attack_spell4"]}"
		@attack_spell4_stam_min = $osa_data["$osa_attack_spell4_stam_min"].to_i
		@attack_spell4_mana_min = $osa_data["$osa_attack_spell4_man_min"].to_i
		@attack_spell4_enemy_min = $osa_data["$osa_attack_spell4_enemy_min"].to_i
		@attack_spell4_enemy_max = $osa_data["$osa_attack_spell4_enemy_max"].to_i
		@attack_spell4_warding = $osa_data["$osa_spell4_warding"]
		@attack_spell4_channel = $osa_data["$osa_spell4_channel"]
		@attack_spell4_evoke = $osa_data["$osa_spell4_evoke"]
		@attack_spell4_open = $osa_data["$osa_spell4_open_cast"]
		if @attack_spell4_evoke && !@attack_spell4_channel
			@cast_type4 = "evoke"
		elsif @attack_spell4_channel && !@attack_spell4_evoke
			@cast_type4 = "channel"
		elsif @attack_spell4_channel && @attack_spell4_evoke
			@cast_type4 = "evoke channel"
		else
			@cast_type4 = ""
		end
		@attack_spell5 = "#{$osa_data["$osa_attack_spell5"]}"
		@attack_spell5_stam_min = $osa_data["$osa_attack_spell5_stam_min"].to_i
		@attack_spell5_mana_min = $osa_data["$osa_attack_spell5_man_min"].to_i
		@attack_spell5_enemy_min = $osa_data["$osa_attack_spell5_enemy_min"].to_i
		@attack_spell5_enemy_max = $osa_data["$osa_attack_spell5_enemy_max"].to_i
		@attack_spell5_warding = $osa_data["$osa_spell5_warding"]
		@attack_spell5_channel = $osa_data["$osa_spell5_channel"]
		@attack_spell5_evoke = $osa_data["$osa_spell5_evoke"]
		@attack_spell5_open = $osa_data["$osa_spell5_open_cast"]
		if @attack_spell5_evoke && !@attack_spell5_channel
			@cast_type5 = "evoke"
		elsif @attack_spell5_channel && !@attack_spell5_evoke
			@cast_type5 = "channel"
		elsif @attack_spell5_channel && @attack_spell5_evoke
			@cast_type5 = "evoke channel"
		else
			@cast_type5 = ""
		end
	elsif @creature_type == "undead"
		@attack_stance = $osa_data["$osa_undead_attack_stance"].to_i
		@defending_stance = $osa_data["$osa_undead_defending_stance"].to_i
		@setup_attack = $osa_data["$osa_undead_setup_attack"].to_i
		@setup_attack_stamina_min = $osa_data["$osa_undead_setup_attack_stam_min"].to_i
		@setup_attack_mana_min = $osa_data["$osa_undead_setup_attack_man_min"].to_i
		@setup_attack_enemy_min = $osa_data["$osa_undead_setup_attack_enemy_min"].to_i
		@setup_attack_enemy_max = $osa_data["$osa_undead_setup_attack_enemy_max"].to_i
		@setup_attack2 = $osa_data["$osa_undead_setup_attack2"].to_i
		@setup_attack2_stam_min = $osa_data["$osa_undead_setup_attack2_stam_min"].to_i
		@setup_attack2_mana_min = $osa_data["$osa_undead_setup_attack2_man_min"].to_i
		@setup_attack2_enemy_min = $osa_data["$osa_undead_setup_attack2_enemy_min"].to_i
		@setup_attack2_enemy_max = $osa_data["$osa_undead_setup_attack2_enemy_max"].to_i
		@special_attack = $osa_data["$osa_undead_special_attack"].to_i
		@special_attack_stam_min = $osa_data["$osa_undead_special_attack_stam_min"].to_i
		@special_attack_mana_min = $osa_data["$osa_undead_special_attack_man_min"].to_i
		@special_attack_enemy_min = $osa_data["$osa_undead_special_attack_enemy_min"].to_i
		@special_attack_enemy_max = $osa_data["$osa_undead_special_attack_enemy_max"].to_i
		@special_attack2 = $osa_data["$osa_undead_special_attack"].to_i
		@special_attack2_stam_min = $osa_data["$osa_undead_special_attack2_stam_min"].to_i
		@special_attack2_mana_min = $osa_data["$osa_undead_special_attack2_man_min"].to_i
		@special_attack2_enemy_min = $osa_data["$osa_undead_special_attack2_enemy_min"].to_i
		@special_attack2_enemy_max = $osa_data["$osa_undead_special_attack2_enemy_max"].to_i
		@aoe_attack = $osa_data["$osa_undead_aoe_attack"].to_i
		@aoe_attack_stam_min = $osa_data["$osa_undead_aoe_attack_stam_min"].to_i
		@aoe_attack_mana_min = $osa_data["$osa_undead_aoe_attack_man_min"].to_i
		@aoe_attack_enemy_min = $osa_data["$osa_undead_aoe_attack_enemy_min"].to_i
		@aoe_attack_enemy_max = $osa_data["$osa_undead_aoe_attack_enemy_max"].to_i
		@aoe_attack2 = $osa_data["$osa_undead_aoe_attack2"].to_i
		@aoe_attack2_stam_min = $osa_data["$osa_undead_aoe_attack2_stam_min"].to_i
		@aoe_attack2_mana_min = $osa_data["$osa_undead_aoe_attack2_man_min"].to_i
		@aoe_attack2_enemy_min = $osa_data["$osa_undead_aoe_attack2_enemy_min"].to_i
		@aoe_attack2_enemy_max = $osa_data["$osa_undead_aoe_attack2_enemy_max"].to_i
		@assault = $osa_data["$osa_undead_assault"].to_i
		@assault_stam_min = $osa_data["$osa_undead_assault_stam_min"].to_i
		@assault_mana_min = $osa_data["$osa_undead_assault_man_min"].to_i
		@assault_enemy_min = $osa_data["$osa_undead_assault_enemy_min"].to_i
		@assault_enemy_max = $osa_data["$osa_undead_assault_enemy_max"].to_i
		@assault2 = $osa_data["$osa_undead_assault2"].to_i
		@assault2_stam_min = $osa_data["$osa_undead_assault2_stam_min"].to_i
		@assault2_mana_min = $osa_data["$osa_undead_assault2_man_min"].to_i
		@assault2_enemy_min = $osa_data["$osa_undead_assault2_enemy_min"].to_i
		@assault2_enemy_max = $osa_data["$osa_undead_assault2_enemy_max"].to_i
		@attack_spell_opener = "#{$osa_data["$osa_undead_spell_opener"]}"
		@attack_spell_opener_stam_min = $osa_data["$osa_undead_spell_opener_stam_min"].to_i
		@attack_spell_opener_mana_min = $osa_data["$osa_undead_spell_opener_man_min"].to_i
		@attack_spell_opener_enemy_min = $osa_data["$osa_undead_spell_opener_enemy_min"].to_i
		@attack_spell_opener_enemy_max = $osa_data["$osa_undead_spell_opener_enemy_max"].to_i
		@attack_spell_opener_warding = $osa_data["$osa_undead_spell_opener_warding"]
		@attack_spell_opener_channel = $osa_data["$osa_undead_spell_opener_channel"]
		@attack_spell_opener_evoke = $osa_data["$osa_undead_spell_opener_evoke"]
		@attack_spell_opener_open_cast = $osa_data["$osa_undead_spell_opener_open_cast"]
		@attack_spell_opener2 = "#{$osa_data["$osa_undead_spell_opener2"]}"
		@attack_spell_opener2_stam_min = $osa_data["$osa_undead_spell_opener2_stam_min"].to_i
		@attack_spell_opener2_mana_min = $osa_data["$osa_undead_spell_opener2_man_min"].to_i
		@attack_spell_opener2_enemy_min = $osa_data["$osa_undead_spell_opener2_enemy_min"].to_i
		@attack_spell_opener2_enemy_max = $osa_data["$osa_undead_spell_opener2_enemy_max"].to_i
		@attack_spell_opener2_warding = $osa_data["$osa_undead_spell_opener2_warding"]
		@attack_spell_opener2_channel = $osa_data["$osa_undead_spell_opener2_channel"]
		@attack_spell_opener2_evoke = $osa_data["$osa_undead_spell_opener2_evoke"]
		@attack_spell_opener2_open_cast = $osa_data["$osa_undead_spell_opener2_open_cast"]
		@attack_spell = "#{$osa_data["$osa_undead_attack_spell"]}"
		@attack_spell_stam_min = $osa_data["$osa_undead_attack_spell_stam_min"].to_i
		@attack_spell_mana_min = $osa_data["$osa_undead_attack_spell_man_min"].to_i
		@attack_spell_enemy_min = $osa_data["$osa_undead_attack_spell_enemy_min"].to_i
		@attack_spell_enemy_max = $osa_data["$osa_undead_attack_spell_enemy_max"].to_i
		@attack_spell_warding = $osa_data["$osa_undead_spell_warding"]
		@attack_spell_channel = $osa_data["$osa_undead_spell_channel"]
		@attack_spell_evoke = $osa_data["$osa_undead_spell_evoke"]
		@attack_spell_open = $osa_data["$osa_undead_spell_open_cast"]
		if @attack_spell_evoke && !@attack_spell_channel
			@cast_type = "evoke"
		elsif @attack_spell_channel && !@attack_spell_evoke
			@cast_type = "channel"
		elsif @attack_spell_channel && @attack_spell_evoke
			@cast_type = "evoke channel"
		else
			@cast_type = ""
		end
		@attack_spell2 = "#{$osa_data["$osa_undead_attack_spell2"]}"
		@attack_spell2_stam_min = $osa_data["$osa_undead_attack_spell2_stam_min"].to_i
		@attack_spell2_mana_min = $osa_data["$osa_undead_attack_spell2_man_min"].to_i
		@attack_spell2_enemy_min = $osa_data["$osa_undead_attack_spell2_enemy_min"].to_i
		@attack_spell2_enemy_max = $osa_data["$osa_undead_attack_spell2_enemy_max"].to_i
		@attack_spell2_warding = $osa_data["$osa_undead_spell2_warding"]
		@attack_spell2_channel = $osa_data["$osa_undead_spell2_channel"]
		@attack_spell2_evoke = $osa_data["$osa_undead_spell2_evoke"]
		@attack_spell2_open = $osa_data["$osa_undead_spell2_open_cast"]
		if @attack_spell2_evoke && !@attack_spell2_channel
			@cast_type2 = "evoke"
		elsif @attack_spell2_channel && !@attack_spell2_evoke
			@cast_type2 = "channel"
		elsif @attack_spell2_channel && @attack_spell2_evoke
			@cast_type2 = "evoke channel"
		else
			@cast_type2 = ""
		end
		@attack_spell3 = "#{$osa_data["$osa_undead_attack_spell3"]}"
		@attack_spell3_stam_min = $osa_data["$osa_undead_attack_spell3_stam_min"].to_i
		@attack_spell3_mana_min = $osa_data["$osa_undead_attack_spell3_man_min"].to_i
		@attack_spell3_enemy_min = $osa_data["$osa_undead_attack_spell3_enemy_min"].to_i
		@attack_spell3_enemy_max = $osa_data["$osa_undead_attack_spell3_enemy_max"].to_i
		@attack_spell3_warding = $osa_data["$osa_undead_spell3_warding"]
		@attack_spell3_channel = $osa_data["$osa_undead_spell3_channel"]
		@attack_spell3_evoke = $osa_data["$osa_undead_spell3_evoke"]
		@attack_spell3_open = $osa_data["$osa_undead_spell3_open_cast"]
		if @attack_spell3_evoke && !@attack_spell3_channel
			@cast_type3 = "evoke"
		elsif @attack_spell3_channel && !@attack_spell3_evoke
			@cast_type3 = "channel"
		elsif @attack_spell3_channel && @attack_spell3_evoke
			@cast_type3 = "evoke channel"
		else
			@cast_type3 = ""
		end
		@attack_spell4 = "#{$osa_data["$osa_undead_attack_spell4"]}"
		@attack_spell4_stam_min = $osa_data["$osa_undead_attack_spell4_stam_min"].to_i
		@attack_spell4_mana_min = $osa_data["$osa_undead_attack_spell4_man_min"].to_i
		@attack_spell4_enemy_min = $osa_data["$osa_undead_attack_spell4_enemy_min"].to_i
		@attack_spell4_enemy_max = $osa_data["$osa_undead_attack_spell4_enemy_max"].to_i
		@attack_spell4_warding = $osa_data["$osa_undead_spell4_warding"]
		@attack_spell4_channel = $osa_data["$osa_undead_spell4_channel"]
		@attack_spell4_evoke = $osa_data["$osa_undead_spell4_evoke"]
		@attack_spell4_open = $osa_data["$osa_undead_spell4_open_cast"]
		if @attack_spell4_evoke && !@attack_spell4_channel
			@cast_type4 = "evoke"
		elsif @attack_spell4_channel && !@attack_spell4_evoke
			@cast_type4 = "channel"
		elsif @attack_spell4_channel && @attack_spell4_evoke
			@cast_type4 = "evoke channel"
		else
			@cast_type4 = ""
		end
		@attack_spell5 = "#{$osa_data["$osa_undead_attack_spell5"]}"
		@attack_spell5_stam_min = $osa_data["$osa_undead_attack_spell5_stam_min"].to_i
		@attack_spell5_mana_min = $osa_data["$osa_undead_attack_spell5_man_min"].to_i
		@attack_spell5_enemy_min = $osa_data["$osa_undead_attack_spell5_enemy_min"].to_i
		@attack_spell5_enemy_max = $osa_data["$osa_undead_attack_spell5_enemy_max"].to_i
		@attack_spell5_warding = $osa_data["$osa_undead_spell5_warding"]
		@attack_spell5_channel = $osa_data["$osa_undead_spell5_channel"]
		@attack_spell5_evoke = $osa_data["$osa_undead_spell5_evoke"]
		@attack_spell5_open = $osa_data["$osa_undead_spell5_open_cast"]
		if @attack_spell5_evoke && !@attack_spell5_channel
			@cast_type5 = "evoke"
		elsif @attack_spell5_channel && !@attack_spell5_evoke
			@cast_type5 = "channel"
		elsif @attack_spell5_channel && @attack_spell5_evoke
			@cast_type5 = "evoke channel"
		else
			@cast_type5 = ""
		end
	end
end

def prep_reset
	if checkprep == "None"
		return
	else
		fput "release"
	end
	
end

def stand(stand_command = nil)
    return if ($osa_data["$osa_use_kneel"])
		if ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
			until (standing?)
			osa_put 'stand'
		end
	end
end

def healing_stance
	change_stance('defensive')
end

def stance_defensive
	if $osa_data["$osa_stance_dance"]
		health_monitor
		wait_rt
		if ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
			if  @defending_stance == 0
				change_stance('defensive')
			elsif @defending_stance == 1
				change_stance('guarded')
			elsif @defending_stance == 2
				change_stance('neutral')
			elsif @defending_stance == 3
				change_stance('forward')
			elsif @defending_stance == 4
				change_stance('advance')
			elsif @defending_stance == 5
				change_stance('offensive')
			end
		end
	end
end

def stance_offensive
	if $osa_data["$osa_stance_dance"]
		health_monitor
		wait_rt
		if ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
			if @attack_stance == 0
				change_stance('offensive')
			elsif @attack_stance == 1
				change_stance('advance')
			elsif @attack_stance == 2
				change_stance('forward')
			elsif @attack_stance == 3
				change_stance('neutral')
			elsif @attack_stance == 4
				change_stance('guarded')
			elsif @attack_stance == 5
				change_stance('defensive')
			end
		end
	end
end
    
def stance_guarded
	if $osa_data["$osa_stance_dance"]
		health_monitor
		change_stance('guarded')
	end
end

def stand_check
	if !standing? && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		stand()
	end
end
	
def kneel_check
	health_monitor
	if !checkkneeling && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		wait_rt
		fput "kneel"
		pause 0.25
		wait_rt
	end
end

def hide_time
	health_monitor
	if GameObj.targets.count >= 1 && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		if checkhidden
			return
		else
			result = dothistimeout "hide", 3, /fail to slip|that no one has noticed|but can't see anywhere/
			if result.to_s =~ /fail to slip/
				wait_rt
				fput "hide"
			elsif result.to_s =~ /that no one has noticed/
				return
			elsif result.to_s =~ /but can't see anywhere/
				return
			end
		end
	else
		return
	end
end

def reactive
	health_monitor
	if $osa_data["$osa_use_reactive"] && $osa_data["$osa_reactive"] && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		@reactive_creatures = Array.new
		GameObj.targets.each do |target|
			@reactive_creatures.push(target.id)
		end
		@do_reactive = (@reactive_creatures & $osa_data['$osa_reactive_creatures']).any?
		if @do_reactive
			wait_rt
			stance_offensive
			fput "weapon #{$osa_data["$osa_reactivetype"]}"
			self.save_script_data(:$osa_reactive, false, push: false)
			stance_defensive
		end
	end
end

###### Basic Attack Function
			
def chicken_attack
	if GameObj.targets.count > 0 && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		if $osa_data["$osa_noattack"]
			stance_offensive
			if $osa_data["$osa_use_waylay"]
				fput "waylay"
			else
				fput "attack"
			end
		end
		stance_defensive
	end
end

def chicken_fire
	if GameObj.targets.count > 0 && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		if $osa_data["$osa_noattack"]
			stance_offensive
			fput "fire"
		end
		stance_defensive
	end
end

def uac_round
	if GameObj.targets.count >= 1 && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		if $osacombat_uac_current_attack == 0
			$osacombat_uac_current_attack = "jab"
		elsif $osacombat_uac_current_attack == nil
			$osacombat_uac_current_attack = "jab"
		end
		stance_offensive
		result = dothistimeout "#{$osacombat_uac_current_attack}", 3, /excellent positioning|followup jab|followup punch|followup grapple|followup kick|Roundtime/
		if result.to_s =~ /excellent positioning/
			$osacombat_uac_current_attack = "kick"
			wait_rt
			stance_defensive
		elsif result.to_s =~ /followup jab/
			$osacombat_uac_current_attack = "jab"
			wait_rt
			stance_defensive
		elsif result.to_s =~ /followup punch/
			$osacombat_uac_current_attack = "punch"
			wait_rt
			stance_defensive
		elsif result.to_s =~ /followup grapple/
			$osacombat_uac_current_attack = "grapple"
			wait_rt
			stance_defensive
		elsif result.to_s =~ /followup kick/
			$osacombat_uac_current_attack = "kick"
			wait_rt
			stance_defensive	
		elsif result.to_s =~ /Roundtime/
			$osacombat_uac_current_attack = "jab"
			wait_rt
			stance_defensive
		end
	else
		wait_rt
		stance_defensive
	end
end

####### Mstrike Setup

def mstrike_setup
	if $osa_data["$osa_use_mstrike"]
		if $osa_data["$osa_nouacweapons"]
			fput "mstrike set recovery off"	
			fput "mstrike set default grapple"

		elsif $osa_data["$osa_osaarcher"]
			fput "mstrike set recovery off"
			fput "mstrike set default fire"
		else
			fput "mstrike set recovery off"
			fput "mstrike set default attack"
		end
	end
	if $osa_data["$osa_use_mstrike"]
		if Skills.multiopponentcombat >= 190
			$osacombat_my_mstrike_focus = 6
			$osacombat_my_mstrike_open = 7
			fput "mstrike set focus #{$osacombat_my_mstrike_focus}"
			fput "mstrike set open  #{$osacombat_my_mstrike_open}"
		elsif Skills.multiopponentcombat >= 155
			$osacombat_my_mstrike_focus = 5
			$osacombat_my_mstrike_open = 7
			fput "mstrike set focus #{$osacombat_my_mstrike_focus}"
			fput "mstrike set open  #{$osacombat_my_mstrike_open}"
		elsif Skills.multiopponentcombat >= 135
			$osacombat_my_mstrike_focus = 5
			$osacombat_my_mstrike_open = 6
			fput "mstrike set focus #{$osacombat_my_mstrike_focus}"
			fput "mstrike set open  #{$osacombat_my_mstrike_open}"
		elsif Skills.multiopponentcombat >= 100
			$osacombat_my_mstrike_focus = 4
			$osacombat_my_mstrike_open = 6
			fput "mstrike set focus #{$osacombat_my_mstrike_focus}"
			fput "mstrike set open  #{$osacombat_my_mstrike_open}"
		elsif Skills.multiopponentcombat >= 90
			$osacombat_my_mstrike_focus = 4
			$osacombat_my_mstrike_open = 5
			fput "mstrike set focus #{$osacombat_my_mstrike_focus}"
			fput "mstrike set open  #{$osacombat_my_mstrike_open}"
		elsif Skills.multiopponentcombat >= 60
			$osacombat_my_mstrike_focus = 3
			$osacombat_my_mstrike_open = 5
			fput "mstrike set focus #{$osacombat_my_mstrike_focus}"
			fput "mstrike set open  #{$osacombat_my_mstrike_open}"
		elsif Skills.multiopponentcombat >= 55
			$osacombat_my_mstrike_focus = 3
			$osacombat_my_mstrike_open = 4	
			fput "mstrike set focus #{$osacombat_my_mstrike_focus}"
			fput "mstrike set open  #{$osacombat_my_mstrike_open}"
		elsif Skills.multiopponentcombat >= 35
			$osacombat_my_mstrike_focus = 2
			$osacombat_my_mstrike_open = 4	
			fput "mstrike set focus #{$osacombat_my_mstrike_focus}"
			fput "mstrike set open  #{$osacombat_my_mstrike_open}"
		elsif Skills.multiopponentcombat >= 30
			$osacombat_my_mstrike_focus = 2
			$osacombat_my_mstrike_open = 3	
			fput "mstrike set focus #{$osacombat_my_mstrike_focus}"
			fput "mstrike set open  #{$osacombat_my_mstrike_open}"
		elsif Skills.multiopponentcombat >= 15
			$osacombat_my_mstrike_focus = 0
			$osacombat_my_mstrike_open = 3	
			fput "mstrike set focus #{$osacombat_my_mstrike_focus}"
			fput "mstrike set open  #{$osacombat_my_mstrike_open}"
		elsif Skills.multiopponentcombat >= 5
			$osacombat_my_mstrike_focus = 0
			$osacombat_my_mstrike_open = 2
			fput "mstrike set focus #{$osacombat_my_mstrike_focus}"
			fput "mstrike set open  #{$osacombat_my_mstrike_open}"			
		end
	end
end

################ Spell Checks to Cast
def symbol_of_mana
	if Spell["Symbol of Mana"].known? && $osa_data["$osa_symbol_of_mana"] && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		if Effects::Cooldowns.active? "Symbol of Mana"
			nil
		else
			Spell["Symbol of Mana"].cast
		end
	end
end

def mana_leech
	if (Spell[516].known? && (Spell[9516].timeleft < 15) && Spell[516].affordable? && (percentmana < $osa_data["$osa_percentleech"].to_i) && $osa_data["$osa_use_mana_leech"]) && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		if GameObj.targets.count > 0	
			get_target
			Spell[516].cast "target"
		end
	end
end

def sigil_of_power
	Spell["Sigil of Power"].cast if Spell["Sigil of Power"].known? && Spell["Sigil of Power"].affordable? && $osa_data["$osa_sigil_of_mana"] && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
end

def prep_reset
	if checkprep == "None"
		return
	else
		fput "release"
	end
end

def infuse_weapon
	if !$osa_data["$osa_infusespell"].empty?
		if Spell[$osa_data["$osa_infusespell"]].affordable?
			fput "prep #{$osa_data["$osa_infusespell"]}"
			fput "infuse ##{GameObj.right_hand.id}"
			pause 5
		else
			echo "------==== Out Of Mana ==== ------"
		end
	else
		echo "------==== No Insufion Spell Designated ==== ------"
	end
end

def infuse_shield
	check_shield_fire = Lich::Util.quiet_command("look ##{GameObj.left_hand.id}", //, end_pattern = //, include_end = true ,timeout = 3, silent = true)
	if check_shield_fire.to_s =~ /Heatless violet flames burn across the (.*)./
		return
	else
		if Spell[1604].affordable?
			multifput "prep 1604", "evoke ##{GameObj.left_hand.id}"
			wait_rt	
		else
			echo "------==== Out Of Mana ==== ------"
		end
	end
end

def mana_share
	$mana_type = Array.new
	$mana_type.clear
	$my_mana_type = Array.new
	$my_mana_type.clear
	if (Skills.smc >= 24)
		$mana_type.push ("Spiritual")
		$my_mana_type.push ("Spiritual")
	end
	if (Skills.mmc >= 24)
		$mana_type.push ("Mental")
		$my_mana_type.push ("Mental")
	end
	if (Skills.emc >= 24)
		$mana_type.push ("Elemental")
		$my_mana_type.push ("Elemental")
	end
	if $mana_type.count > 1
		$new_mana_type = $mana_type.last()
		$mana_type.delete "#{$mana_type.last()}"
		$mana_type.push ("or #{$new_mana_type}")
	end
	if $mana_type.count.to_i == 3
		$mana_message = "I Need #{$mana_type[0]}, #{$mana_type[1]} #{$mana_type[2]} Mana!"
	end
	if $mana_type.count.to_i == 2
		$mana_message = "I Need #{$mana_type[0]} #{$mana_type[1]} Mana!"
	end
	if $mana_type.count.to_i == 1
		$mana_message = "I Need #{$mana_type[0]} Mana!"
	end
end

def can_cast
	if !Spell[@attack_spell].known?
		echo "------==== You Do Not Know That Spell. Select A Valid Attack Spell And Restart OSACombat ==== ------"
		exit
	end
	if (!Effects::Debuffs.active? "Mystic Impedance") && (!Effects::Debuffs.active? "Silenced") && !stunned? && !webbed? or !bound? && !checkdead && !@attack_spell.nil? && !GameObj.targets.empty? && (Char.stamina.to_i >= @attack_spell_stam_min.to_i) && (Char.mana.to_i > @attack_spell_mana_min) && (GameObj.targets.count >= @attack_spell_enemy_min) && (GameObj.targets.count <= @attack_spell_enemy_max)
		if !Spell[@attack_spell].affordable?
			mana_leech
			symbol_of_mana
			sigil_of_power
			LNet.send_message(attr = { 'type' => 'channel', 'channel' => $osa_data["$osa_crew"] }, $mana_message)
			wait_until {Spell[@attack_spell].affordable?}
		end
		get_target
		if !@attack_spell_warding
			stance_offensive
		end
		if !@attack_spell_open
				fput "incant #{@attack_spell} #{@cast_type} target"
		else
				fput "incant #{@attack_spell} #{@cast_type} open"
		end
		stance_guarded
		health_monitor
		wait_castrt
		stance_defensive
	else
		return
	end
end

def can_cast2
	if !Spell[@attack_spell2].known?
		echo "------==== You Do Not Know That Spell. Select A Valid Attack Spell #2 And Restart OSACombat ==== ------"
		exit
	end
	if (!Effects::Debuffs.active? "Mystic Impedance") && (!Effects::Debuffs.active? "Silenced") && !stunned? && !webbed? or !bound? && !checkdead && !@attack_spell2.nil? && !GameObj.targets.empty? && (Char.stamina.to_i >= @attack_spell2_stam_min.to_i) && (Char.mana.to_i > @attack_spell2_mana_min) && (GameObj.targets.count >= @attack_spell2_enemy_min) && (GameObj.targets.count <= @attack_spell2_enemy_max)
		if !Spell[@attack_spell2].affordable?
			mana_leech
			symbol_of_mana
			sigil_of_power
			LNet.send_message(attr = { 'type' => 'channel', 'channel' => $osa_data["$osa_crew"] }, $mana_message)
			wait_until {Spell[@attack_spell2].affordable?}
		end
		get_target
		if !@attack_spell2_warding
			stance_offensive
		end
		if !@attack_spell2_open
				fput "incant #{@attack_spell2} #{@cast_type2} target"
		else
				fput "incant #{@attack_spell2} #{@cast_type2} open"
		end
		stance_guarded
		health_monitor
		wait_castrt
		stance_defensive
	else
		return
	end
end

def can_cast3
	if !Spell[@attack_spell3].known?
		echo "------==== You Do Not Know That Spell. Select A Valid Attack Spell #3 And Restart OSACombat ==== ------"
		exit
	end
	if (!Effects::Debuffs.active? "Mystic Impedance") && (!Effects::Debuffs.active? "Silenced") && !stunned? && !webbed? or !bound? && !checkdead && !@attack_spell3.nil? && !GameObj.targets.empty? && (Char.stamina.to_i >= @attack_spell3_stam_min.to_i) && (Char.mana.to_i > @attack_spell3_mana_min) && (GameObj.targets.count >= @attack_spell3_enemy_min) && (GameObj.targets.count <= @attack_spell3_enemy_max)
		if !Spell[@attack_spell3].affordable?
			mana_leech
			symbol_of_mana
			sigil_of_power
			LNet.send_message(attr = { 'type' => 'channel', 'channel' => $osa_data["$osa_crew"] }, $mana_message)
			wait_until {Spell[@attack_spell3].affordable?}
		end
		get_target
		if !@attack_spell3_warding
			stance_offensive
		end
		if !@attack_spell3_open
				fput "incant #{@attack_spell3} #{@cast_type3} target"
		else
				fput "incant #{@attack_spell3} #{@cast_type3} open"
		end
		stance_guarded
		health_monitor
		wait_castrt
		stance_defensive
	else
		return
	end
end

def can_cast4
	if !Spell[@attack_spell4].known?
		echo "------==== You Do Not Know That Spell. Select A Valid Attack Spell #4 And Restart OSACombat ==== ------"
		exit
	end
	if (!Effects::Debuffs.active? "Mystic Impedance") && (!Effects::Debuffs.active? "Silenced") && !stunned? && !webbed? or !bound? && !checkdead && !@attack_spell4.nil? && !GameObj.targets.empty? && (Char.stamina.to_i >= @attack_spell4_stam_min.to_i) && (Char.mana.to_i > @attack_spell4_mana_min) && (GameObj.targets.count >= @attack_spell4_enemy_min) && (GameObj.targets.count <= @attack_spell4_enemy_max)
		if !Spell[@attack_spell4].affordable?
			mana_leech
			symbol_of_mana
			sigil_of_power
			LNet.send_message(attr = { 'type' => 'channel', 'channel' => $osa_data["$osa_crew"] }, $mana_message)
			wait_until {Spell[@attack_spell4].affordable?}
		end
		get_target
		if !@attack_spell4_warding
			stance_offensive
		end
		if !@attack_spell4_open
				fput "incant #{@attack_spell4} #{@cast_type4} target"
		else
				fput "incant #{@attack_spell4} #{@cast_type4} open"
		end
		stance_guarded
		health_monitor
		wait_castrt
		stance_defensive
	else
		return
	end
end

def can_cast5
	if !Spell[@attack_spell5].known?
		echo "------==== You Do Not Know That Spell. Select A Valid Attack Spell #5 And Restart OSACombat ==== ------"
		exit
	end
	if (!Effects::Debuffs.active? "Mystic Impedance") && (!Effects::Debuffs.active? "Silenced") && !stunned? && !webbed? or !bound? && !checkdead && !@attack_spell5.nil? && !GameObj.targets.empty? && (Char.stamina.to_i >= @attack_spell5_stam_min.to_i) && (Char.mana.to_i > @attack_spell5_mana_min) && (GameObj.targets.count >= @attack_spell5_enemy_min) && (GameObj.targets.count <= @attack_spell5_enemy_max)
		if !Spell[@attack_spell5].affordable?
			mana_leech
			symbol_of_mana
			sigil_of_power
			LNet.send_message(attr = { 'type' => 'channel', 'channel' => $osa_data["$osa_crew"] }, $mana_message)
			wait_until {Spell[@attack_spell5].affordable?}
		end
		get_target
		if !@attack_spell5_warding
			stance_offensive
		end
		if !@attack_spell5_open
				fput "incant #{@attack_spell5} #{@cast_type5} target"
		else
				fput "incant #{@attack_spell5} #{@cast_type5} open"
		end
		stance_guarded
		health_monitor
		wait_castrt
		stance_defensive
	else
		return
	end
end

def can_cast_opener
	if !Spell[@attack_spell_opener].known?
		echo "------==== You Do Not Know That Spell. Select A Valid Opener Spell And Restart OSACombat ==== ------"
		exit
	end
	if (!Effects::Debuffs.active? "Mystic Impedance") && (!Effects::Debuffs.active? "Silenced") && !stunned? && !webbed? or !bound? && !checkdead && !@attack_spell_opener.nil? && !GameObj.targets.empty? && (Char.stamina.to_i >= @attack_spell_opener_stam_min.to_i) && (Char.mana.to_i > @attack_spell_opener_mana_min) && (GameObj.targets.count >= @attack_spell_opener_enemy_min) && (GameObj.targets.count <= @attack_spell_opener_enemy_max)	
		if !Spell[@attack_spell_opener].affordable?
			mana_leech
			symbol_of_mana
			sigil_of_power
			LNet.send_message(attr = { 'type' => 'channel', 'channel' => $osa_data["$osa_crew"] }, $mana_message)
			wait_until {Spell[@attack_spell_opener].affordable?}
		end
		if GameObj.loot.find { |loot| loot.name =~ /miniature storm of faintly glowing snowflakes/ }
			if @attack_spell_opener == "335"
				return
			end
		end
		if GameObj.loot.find { |loot| loot.name =~ /vine|bramble|widgeonweed|vathor club|swallowwort|smilax|creeper|creepers|briar|ivy|tumbleweed/ }
			if @attack_spell_opener == "610"
				return
			end
		end
		if GameObj.loot.find { |loot| loot.name =~ / arm|arms|pincer|pincers|tentacle|tentacles/ }
			if @attack_spell_opener == "709"
				return
			end
		end
		if GameObj.loot.find { |loot| loot.name =~ /tempest/ }
			if @attack_spell_opener == "710"
				return
			end
		end
		if GameObj.loot.find { |loot| loot.name =~ /void/ }
			if @attack_spell_opener == "720"
				return
			end
		end	
		if GameObj.loot.find { |loot| loot.name =~ /web/ }
			if @attack_spell_opener == "118"
				return
			end
		end
		if (@attack_spell_opener == "1117") or (@attack_spell_opener == "1614") or (@attack_spell_opener == "217") or (@attack_spell_opener == "512") or (@attack_spell_opener == "611") or (@attack_spell_opener == "603")
			@room_creatures.clear
			GameObj.targets.each do |i|
				@room_creatures.push (i.id)
			end
			if @room_creatures.all? { |e| @empathic_link.include?(e) }
				return
			else
				@empathic_link.clear
				GameObj.targets.each do |i|
					@empathic_link.push (i.id)
				end
				if !@attack_spell_opener_warding
					stance_offensive
				end
				if @attack_spell_opener_open_cast
					fput "incant #{@attack_spell_opener} open"
				else
					if GameObj.target.nil?
						fput "target random"
					end
					fput "incant #{@attack_spell_opener} target"
				end
				stance_guarded
			end
		
		elsif (@attack_spell_opener == "909")
			@not_prone = GameObj.targets.find_all { |i| i.status !~ /dead|gone/ }
			@not_prone.delete_if { |npc| (npc.status =~ /lying/) }
			if @not_prone.count > 0
				if (!Spell[909].active?) and (Spell[909].available?)
					fput "incant 909 channel"
					wait_rt
					pause 0.1
					if $osa_data["$osa_stomp"]
						fput "stomp"
					end
					if $osa_data["$osa_pound"]
						fput "pound"
					end
					if $osa_data["$osa_tap"]
						fput "tap"
					end
				else
					wait_rt
					pause 0.1
					if $osa_data["$osa_stomp"]
						fput "stomp"
					end
					if $osa_data["$osa_pound"]
						fput "pound"
					end
					if $osa_data["$osa_tap"]
						fput "tap"
					end
				end
			end
		else
			if !@attack_spell_opener_warding
				stance_offensive
			end
			if @attack_spell_opener_open_cast
				fput "incant #{@attack_spell_opener} open"
			else
				get_target
				fput "incant #{@attack_spell_opener} target"
			end
			stance_guarded
		end
	end
end

def can_cast_opener2
	if !Spell[@attack_spell_opener2].known?
		echo "------==== You Do Not Know That Spell. Select A Valid Opener Spell #2 And Restart OSACombat ==== ------"
		exit
	end
	if (!Effects::Debuffs.active? "Mystic Impedance") && (!Effects::Debuffs.active? "Silenced") && !stunned? && !webbed? or !bound? && !checkdead && !@attack_spell_opener2.nil? && !GameObj.targets.empty? && (Char.stamina.to_i >= @attack_spell_opener2_stam_min.to_i) && (Char.mana.to_i > @attack_spell_opener2_mana_min) && (GameObj.targets.count >= @attack_spell_opener2_enemy_min) && (GameObj.targets.count <= @attack_spell_opener2_enemy_max)	
		if !Spell[@attack_spell_opener2].affordable?
			mana_leech
			symbol_of_mana
			sigil_of_power
			LNet.send_message(attr = { 'type' => 'channel', 'channel' => $osa_data["$osa_crew"] }, $mana_message)
			wait_until {Spell[@attack_spell_opener2].affordable?}
		end
		if GameObj.loot.find { |loot| loot.name =~ /miniature storm of faintly glowing snowflakes/ }
			if @attack_spell_opener2 == "335"
				return
			end
		end
		if GameObj.loot.find { |loot| loot.name =~ /vine|bramble|widgeonweed|vathor club|swallowwort|smilax|creeper|creepers|briar|ivy|tumbleweed/ }
			if @attack_spell_opener2 == "610"
				return
			end
		end
		if GameObj.loot.find { |loot| loot.name =~ / arm|arms|pincer|pincers|tentacle|tentacles/ }
			if @attack_spell_opener2 == "709"
				return
			end
		end
		if GameObj.loot.find { |loot| loot.name =~ /tempest/ }
			if @attack_spell_opener2 == "710"
				return
			end
		end
		if GameObj.loot.find { |loot| loot.name =~ /void/ }
			if @attack_spell_opener2 == "720"
				return
			end
		end	
		if GameObj.loot.find { |loot| loot.name =~ /web/ }
			if @attack_spell_opener2 == "118"
				return
			end
		end
		if (@attack_spell_opener2 == "1117") or (@attack_spell_opener2 == "1614") or (@attack_spell_opener2 == "217") or (@attack_spell_opener2 == "512") or (@attack_spell_opener2 == "611") or (@attack_spell_opener2 == "603")
			@room_creatures.clear
			GameObj.targets.each do |i|
				@room_creatures.push (i.id)
			end
			if @room_creatures.all? { |e| @empathic_link.include?(e) }
				return
			else
				@empathic_link.clear
				GameObj.targets.each do |i|
					@empathic_link.push (i.id)
				end
				if !@attack_spell_opener2_warding
					stance_offensive
				end
				if @attack_spell_opener2_open_cast
					fput "incant #{@attack_spell_opener2} open"
				else
					if GameObj.target.nil?
						fput "target random"
					end
					fput "incant #{@attack_spell_opener2} target"
				end
				stance_guarded
			end
		elsif (@attack_spell_opener2 == "909")
			@not_prone = GameObj.targets.find_all { |i| i.status !~ /dead|gone/ }
			@not_prone.delete_if { |npc| (npc.status =~ /lying/) }
			if @not_prone.count > 0
				if (!Spell[909].active?) and (Spell[909].available?)
					fput "incant 909 channel"
					wait_rt
					pause 0.1
					if $osa_data["$osa_stomp"]
						fput "stomp"
					end
					if $osa_data["$osa_pound"]
						fput "pound"
					end
					if $osa_data["$osa_tap"]
						fput "tap"
					end
				else
					wait_rt
					pause 0.1
					if $osa_data["$osa_stomp"]
						fput "stomp"
					end
					if $osa_data["$osa_pound"]
						fput "pound"
					end
					if $osa_data["$osa_tap"]
						fput "tap"
					end
				end
			end
		else
			if !@attack_spell_opener2_warding
				stance_offensive
			end
			if @attack_spell_opener2_open_cast
				fput "incant #{@attack_spell_opener2} open"
			else
				get_target
				fput "incant #{@attack_spell_opener2} target"
			end
			stance_guarded
		end
	end
end


############# Attack Openers
def return_from_berserk
	ship_type
	start_script("go2", [@berserk_return]) if !Room.current.id != @berserk_return
	wait_while { running?("go2") }
	if checkname == $osa_data["$osa_commander"]
		GameObj.pcs.each{|pc|;fput "hold ##{pc.id}"}
	else
		fput "join #{$osa_data["$osa_commander"]}"
	end
end

def berserk
	if CMan.available?("Berserk")
		@berserk_return = Room.current.id
		stance_offensive
		fput "berserk"
		waitfor /The redness fades from the world and you begin to breathe harder/
		looter
		stance_defensive
		return_from_berserk
	end
end

def bertrandts_bellow_single
	if Warcry.available?("Bellow")
		stance_offensive
		Warcry.use("Bellow", "##{GameObj.target.id}")
		stance_defensive
	end
end

def bertrandts_bellow_open
	if Warcry.available?("Bellow")
		stance_offensive
		Warcry.use("Bellow", "All")
		stance_defensive
	end
end

def carns_cry_single
	if Warcry.available?("Cry")
		stance_offensive
		Warcry.use("Cry", "##{GameObj.target.id}")
		stance_defensive
	end
end

def carns_cry_open
	if Warcry.available?("Cry")
		stance_offensive
		Warcry.use("Cry", "All")
		stance_defensive
	end
end

def charge
	if Weapon.available?("Charge")
		stance_offensive
		fput "weapon charge"
		stance_defensive
	end
end
		
def cripples
	if Weapon.available?("Cripple")
		stance_offensive
		fput "weapon cripple"
		stance_defensive
	end
end

def crowd_press
	if CMan.available?("Crowd Press")
		stance_offensive
		fput "cman cpress"
		stance_defensive
	end
end

def cutthroat
	hide_time
	if CMan.available?("Cutthroat")
		stance_offensive
		fput "cman cutthroat"
		stance_defensive
	end
end

def dark_wings_turn
	health_monitor
    if (!Effects::Cooldowns.active? "Shadow Barb")	
		wait_castrt
		wait_rt
		fput "turn my #{$osa_data["$osa_energy_wings_noun"]} at target"
    end
end

def dark_wings_knock
	health_monitor
    if (!Effects::Cooldowns.active? "Barbed Sweep")	
		wait_castrt
		wait_rt
		fput "knock my #{$osa_data["$osa_energy_wings_noun"]}"
    end
end

def dark_wings_fold
	health_monitor
    if (!Effects::Cooldowns.active? "Rain of Thorns")	
		wait_castrt
		wait_rt
		fput "fold my #{$osa_data["$osa_energy_wings_noun"]}"
    end
end

def dark_wings_tap
	health_monitor
    if (!Effects::Cooldowns.active? "Shadow Mantle")	
		wait_castrt
		wait_rt
		fput "tap my #{$osa_data["$osa_energy_wings_noun"]}"
    end
end

def dark_wings_pull
	health_monitor
    if (!Effects::Cooldowns.active? "Crawling Shadow")	
		wait_castrt
		wait_rt
		fput "pull my #{$osa_data["$osa_energy_wings_noun"]}"
    end
end

def dark_wings_push
	health_monitor
    if (!Effects::Cooldowns.active? "Carrion Guard")	
		wait_castrt
		wait_rt
		fput "push my #{$osa_data["$osa_energy_wings_noun"]}"
    end
end

def dirt_kick
	if CMan.available?("Dirt Kick")
		stance_offensive
		fput "cman dirtkick"
		stance_defensive
	end
end

def disarm_manuever
	if CMan.available?("Disarm")
		stance_offensive
		fput "cman disarm"
		stance_defensive
	end
end

def dislodge
	if CMan.available?("Dislogde")
		stance_offensive
		fput "cman dislodge"
		stance_defensive
	end
end

def dizzying_swing
	if Weapon.available?("Dizzying Swing")
		stance_offensive
		fput "weapon dizzyingswing"
		stance_defensive
	end
end

def eviscerate
	hide_time
	if CMan.available?("Eviscerate")
		stance_offensive
		fput "cman eviscerate"
		stance_defensive
	end
end

def eyepoke
	if CMan.available?("Eyepoke")
		stance_offensive
		fput "cman eyepoke"
		stance_defensive
	end
end

def feint_manuever
	if CMan.available?("Feint")
		stance_offensive
		fput "cman feint"
		stance_defensive
	end
end

def footstomp
	if CMan.available?("Footstomp")
		stance_offensive
		fput "cman footstomp"
		stance_defensive
	end
end

def gerrelles_growl_single
	if Warcry.available?("Growl")
		stance_offensive
		Warcry.use("Growl", "")
		stance_defensive
	end
end

def gerrelles_growl_open
	if Warcry.available?("Growl")
		stance_offensive
		Warcry.use("Growl", "All")
		stance_defensive
	end
end

def groin_kick
	if CMan.available?("Groin Kick")
		stance_offensive
		fput "cman gkick"
		stance_defensive
	end
end

def hamstring
	if CMan.available?("Hamstring")
		stance_offensive
		fput "cman hamstring"
		stance_defensive
	end
end

def haymaker
	if CMan.available?("Haymaker")
		stance_offensive
		fput "cman haymaker"
		stance_defensive
	end
end

def headbutt
	if CMan.available?("Headbutt")
		stance_offensive
		fput "cman headbutt"
		stance_defensive
	end
end

def kneebash
	if CMan.available?("Kneebash")
		stance_offensive
		fput "cman kneebash"
		stance_defensive
	end
end

def light_wings_turn
	health_monitor
    if (!Effects::Cooldowns.active? "Radiant Pulse")	
		wait_castrt
		wait_rt
		fput "turn my #{$osa_data["$osa_energy_wings_noun"]} at target"
    end
end

def light_wings_knock
	health_monitor
    if (!Effects::Cooldowns.active? "Blast of Brilliance")	
		wait_castrt
		wait_rt
		fput "knock my #{$osa_data["$osa_energy_wings_noun"]}"
    end
end

def light_wings_fold
	health_monitor
    if (!Effects::Cooldowns.active? "Blinding Reprisal")	
		wait_castrt
		wait_rt
		fput "fold my #{$osa_data["$osa_energy_wings_noun"]}"
    end
end

def light_wings_tap
	health_monitor
    if (!Effects::Cooldowns.active? "Luminous Flight")	
		wait_castrt
		wait_rt
		fput "tap my #{$osa_data["$osa_energy_wings_noun"]}"
    end
end

def light_wings_pull
	health_monitor
    if (!Effects::Cooldowns.active? "Prismatic Aegis")	
		wait_castrt
		wait_rt
		fput "pull my #{$osa_data["$osa_energy_wings_noun"]}"
    end
end

def light_wings_push
	health_monitor
    if (!Effects::Cooldowns.active? "Wings of Warding")	
		wait_castrt
		wait_rt
		fput "push my #{$osa_data["$osa_energy_wings_noun"]}"
    end
end

def mighty_blow
	if CMan.available?("Mighty Blow")
		stance_offensive
		fput "cman mblow"
		stance_defensive
	end
end

def mug
	if CMan.available?("Mug")
		stance_offensive
		fput "cman mug"
		stance_defensive
	end
end

def nosetweak
	if CMan.available?("Nosetweak")
		stance_offensive
		fput "cman nosetweak"
		stance_defensive
	end
end

def shield_bash
	if Shield.available?("Shield Bash")
		stance_offensive
		fput "shield bash"
		stance_defensive
	end
end

def shield_charge
	if Shield.available?("Shield Charge")
		stance_offensive
		fput "shield charge"
		stance_defensive
	end
end

def shield_push
	if Shield.available?("Shield Push")
		stance_offensive
		fput "shield push"
		stance_defensive
	end
end

def shield_trample
	if Shield.available?("Shield Trample") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "shield trample"
		stance_defensive
	end
end

def spell_cleave
	if CMan.available?("Spell Cleave") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman scleave"
		stance_defensive
	end
end

def subdue
	hide_time
	if CMan.available?("Subdue") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman subdue"
		stance_defensive
	end
end

def sunder_shield
	if CMan.available?("Sunder Shield") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman sunder"
		stance_defensive
	end
end

def sweep
	if CMan.available?("Sweep") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman sweep"
		stance_defensive
	end
end

def swiftkick
	if CMan.available?("Swiftkick") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman swiftkick"
		stance_defensive
	end
end

def tackle_manuever
	if CMan.available?("Tackle") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman tackle"
		stance_defensive
	end
end

def templeshot
	if CMan.available?("Templeshot") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman templeshot"
		stance_defensive
	end
end

def throatchop
	if CMan.available?("Throatchop") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman throatchop"
		stance_defensive
	end
end

def trip
	if CMan.available?("Trip") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman trip"
		stance_defensive
	end
end

def twin_hammerfists
	if Weapon.available?("Twin Hammerfists") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "weapon twinhammer"
		stance_defensive
	end
end

def vault_kick
	if CMan.available?("Vault Kick") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman vaultkick"
		stance_defensive
	end
end

def voln_sleep
	wait_rt
	fput "Symbol of Sleep"
	wait_rt
end

def att_openers
	if !stunned? && !webbed? && !bound? && !checkdead && !GameObj.targets.empty? && (Char.stamina.to_i >= @setup_attack_stam_min.to_i) && (Char.mana.to_i > @setup_attack_mana_min) && (GameObj.targets.count >= @setup_attack_enemy_min) && (GameObj.targets.count <= @setup_attack_enemy_max)
		if @setup_attack == 0
			return
		end
		get_target
		if @setup_attack == 1
			berserk
		elsif @setup_attack ==  2
			bertrandts_bellow_single
		elsif @setup_attack ==  3
			bertrandts_bellow_open
		elsif @setup_attack ==  4
			bull_rush
		elsif @setup_attack ==  5
			carns_cry_single
		elsif @setup_attack ==  6
			carns_cry_open
		elsif @setup_attack ==  7
			charge
		elsif @setup_attack == 8
			cripples
		elsif @setup_attack == 9
			crowd_press
		elsif @setup_attack ==  10
			cutthroat
		elsif @setup_attack == 11
			dark_wings_turn
		elsif @setup_attack == 12
			dark_wings_knock
		elsif @setup_attack == 13
			dark_wings_fold	
		elsif @setup_attack == 14
			dirt_kick
		elsif @setup_attack == 15
			disarm_manuever
		elsif @setup_attack == 16
			dislodge
		elsif @setup_attack == 17
			dizzying_swing
		elsif @setup_attack ==  18
			eviscerate
		elsif @setup_attack ==  19
			excoriate
		elsif @setup_attack ==  20
			eyepoke
		elsif @setup_attack == 21
			feint_manuever
		elsif @setup_attack ==  22
			footstomp
		elsif @setup_attack ==  23
			gerrelles_growl_single
		elsif @setup_attack ==  24
			gerrelles_growl_open
		elsif @setup_attack == 25
			groin_kick
		elsif @setup_attack == 26
			hamstring
		elsif @setup_attack == 27
			haymaker
		elsif @setup_attack == 28
			headbutt
		elsif @setup_attack ==  29
			kneebash
		elsif @setup_attack == 30
			light_wings_turn
		elsif @setup_attack == 31
			light_wings_knock
		elsif @setup_attack == 32
			light_wings_fold
		elsif @setup_attack ==  33
			mighty_blow
		elsif @setup_attack ==  34
			mug
		elsif @setup_attack ==  35
			nosetweak
		elsif @setup_attack == 36
			shield_bash
		elsif @setup_attack == 37
			shield_charge
		elsif @setup_attack == 38
			shield_push
		elsif @setup_attack ==  39
			shield_throw
		elsif @setup_attack == 40
			shield_trample
		elsif @setup_attack == 41
			spell_cleave
		elsif @setup_attack ==  42
			subdue
		elsif @setup_attack == 43
			sunder_shield
		elsif @setup_attack ==  44
			sweep
		elsif @setup_attack ==  45
			swiftkick
		elsif @setup_attack == 46
			tackle_manuever
		elsif @setup_attack ==  47
			templeshot
		elsif @setup_attack ==  48
			throatchop
		elsif @setup_attack == 49
			trip
		elsif @setup_attack == 50
			twin_hammerfists
		elsif @setup_attack == 51
			vault_kick
		elsif @setup_attack == 52
			voln_sleep
		end
	end
end

def att_openers2
	if !stunned? && !webbed? && !bound? && !checkdead && !GameObj.targets.empty? && (Char.stamina.to_i >= @setup_attack2_stam_min.to_i) && (Char.mana.to_i > @setup_attack2_mana_min) && (GameObj.targets.count >= @setup_attack2_enemy_min) && (GameObj.targets.count <= @setup_attack2_enemy_max)
		if @setup_attack2 == 0
			return
		end
		get_target
		if @setup_attack2 == 1
			berserk
		elsif @setup_attack2 ==  2
			bertrandts_bellow_single
		elsif @setup_attack2 ==  3
			bertrandts_bellow_open
		elsif @setup_attack2 ==  4
			bull_rush
		elsif @setup_attack2 ==  5
			carns_cry_single
		elsif @setup_attack2 ==  6
			carns_cry_open
		elsif @setup_attack2 ==  7
			charge
		elsif @setup_attack2 == 8
			cripples
		elsif @setup_attack2 == 9
			crowd_press
		elsif @setup_attack2 ==  10
			cutthroat
		elsif @setup_attack2 == 11
			dark_wings_turn
		elsif @setup_attack2 == 12
			dark_wings_knock
		elsif @setup_attack2 == 13
			dark_wings_fold	
		elsif @setup_attack2 == 14
			dirt_kick
		elsif @setup_attack2 == 15
			disarm_manuever
		elsif @setup_attack2 == 16
			dislodge
		elsif @setup_attack2 == 17
			dizzying_swing
		elsif @setup_attack2 ==  18
			eviscerate
		elsif @setup_attack2 ==  19
			excoriate
		elsif @setup_attack2 ==  20
			eyepoke
		elsif @setup_attack2 == 21
			feint_manuever
		elsif @setup_attack2 ==  22
			footstomp
		elsif @setup_attack2 ==  23
			gerrelles_growl_single
		elsif @setup_attack2 ==  24
			gerrelles_growl_open
		elsif @setup_attack2 == 25
			groin_kick
		elsif @setup_attack2 == 26
			hamstring
		elsif @setup_attack2 == 27
			haymaker
		elsif @setup_attack2 == 28
			headbutt
		elsif @setup_attack2 ==  29
			kneebash
		elsif @setup_attack2 == 30
			light_wings_turn
		elsif @setup_attack2 == 31
			light_wings_knock
		elsif @setup_attack2 == 32
			light_wings_fold
		elsif @setup_attack2 ==  33
			mighty_blow
		elsif @setup_attack2 ==  34
			mug
		elsif @setup_attack2 ==  35
			nosetweak
		elsif @setup_attack2 == 36
			shield_bash
		elsif @setup_attack2 == 37
			shield_charge
		elsif @setup_attack2 == 38
			shield_push
		elsif @setup_attack2 ==  39
			shield_throw
		elsif @setup_attack2 == 40
			shield_trample
		elsif @setup_attack2 == 41
			spell_cleave
		elsif @setup_attack2 ==  42
			subdue
		elsif @setup_attack2 == 43
			sunder_shield
		elsif @setup_attack2 ==  44
			sweep
		elsif @setup_attack2 ==  45
			swiftkick
		elsif @setup_attack2 == 46
			tackle_manuever
		elsif @setup_attack2 ==  47
			templeshot
		elsif @setup_attack2 ==  48
			throatchop
		elsif @setup_attack2 == 49
			trip
		elsif @setup_attack2 == 50
			twin_hammerfists
		elsif @setup_attack2 == 51
			vault_kick
		elsif @setup_attack2 == 52
			voln_sleep
		end
	end
end

################### Special Attacks

def bearhug
	if Effects::Cooldowns.active? "Bearhug"
		return
	end
	if CMan.available?("Bearhug") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman bearhug target"
		wait_until { !Effects::Buffs.active? "Concentrating" }
		stance_defensive
	end
end

def chastise
	if ((checkstamina >= 10) && (!Effects::Cooldowns.active? "Chastise")) && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		if checkname == "Peggyanne"
			flavor_messaging
		end
		fput "feat chastise"
		wait_rt
		stance_defensive
	end
end

def excoriate
	if ((checkmana >= 10) && (!Effects::Cooldowns.active? "Excoriate")) && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		if checkname == "Peggyanne"
			flavor_messaging
		end
		fput "feat excoriate"
		wait_rt
		stance_defensive
	end
end

def exsanguinate
	if CMan.available?("Exsanguinate") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman exsanguinate"
		wait_rt
		stance_defensive
	end
end

def leap_attack
	if CMan.available?("Leap Attack") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman leapattack"
		wait_rt
		stance_defensive
	end
end

def shield_strike
	if Shield.available?("Shield Strike") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "shield strike"
		wait_rt
		stance_defensive
	end
end

def spin_attack
	if CMan.available?("Spin Attack") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman sattack"
		wait_rt
		stance_defensive
	end
end

def staggering_blow
	if CMan.available?("Staggering Blow") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman sblow"
		wait_rt
		stance_defensive
	end
end
	
def true_strike
	if CMan.available?("True Strike") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		fput "cman truestrike"
		wait_rt
		stance_defensive
	end
end
	
def special_att
	if !stunned? && !webbed? && !bound? && !checkdead && !GameObj.targets.empty? && (Char.stamina.to_i >= @special_attack_stam_min.to_i) && (Char.mana.to_i > @special_attack_mana_min) && (GameObj.targets.count >= @special_attack_enemy_min) && (GameObj.targets.count <= @special_attack_enemy_max)
		if @special_attack == 0
			return
		end
		get_target
		if @special_attack == 1
			bearhug
		elsif @special_attack == 2
			chastise
		elsif @special_attack == 3
			dark_wings_turn
		elsif @special_attack == 4
			dark_wings_knock
		elsif @special_attack == 5
			dark_wings_fold
		elsif @special_attack == 6
			excoriate
		elsif @special_attack == 7
			exsanguinate
		elsif @special_attack == 8
			leap_attack
		elsif @special_attack == 9
			shield_strike
		elsif @special_attack == 10
			spin_attack
		elsif @special_attack == 11
			staggering_blow
		elsif @special_attack == 12
			true_strike
		end
	end
end

def secondspecial_att
	if !stunned? && !webbed? && !bound? && !checkdead && !GameObj.targets.empty? && (Char.stamina.to_i >= @special_attack2_stam_min.to_i) && (Char.mana.to_i > @special_attack2_mana_min) && (GameObj.targets.count >= @special_attack2_enemy_min) && (GameObj.targets.count <= @special_attack2_enemy_max)
		if @special_attack2 == 0
			return
		end
		get_target
		if @special_attack2 == 1
			bearhug
		elsif @special_attack2 == 2
			chastise
		elsif @special_attack2 == 3
			dark_wings_turn
		elsif @special_attack2 == 4
			dark_wings_knock
		elsif @special_attack2 == 5
			dark_wings_fold
		elsif @special_attack2 == 6
			excoriate
		elsif @special_attack2 == 7
			exsanguinate
		elsif @special_attack2 == 8
			leap_attack
		elsif @special_attack2 == 9
			shield_strike
		elsif @special_attack2 == 10
			spin_attack
		elsif @special_attack2 == 11
			staggering_blow
		elsif @special_attack2 == 12
			true_strike
		end
	end
end

################### Assault Attacks
def barrage
	if Weapon.available?("Barrage") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		assault = dothistimeout "weapon barrage", 15, /Barrage what?|Distracted, you hesitate|glides to its inevitable end with one final twirl|You feel a fair amount more durable|With a final snap of your wrist|You complete your assault|to the ready, your assault complete|Upon firing your last (?:arrow|bolt)|With a final, explosive breath|recentering yourself for the fight|You don't seem to be able to move your legs to do that|too injured|already dead|little bit late|could not find/i
		if assault.to_s =~ /Barrage what?|Distracted, you hesitate|glides to its inevitable end with one final twirl|You feel a fair amount more durable|With a final snap of your wrist|You complete your assault|to the ready, your assault complete|Upon firing your last (?:arrow|bolt)|With a final, explosive breath|recentering yourself for the fight|You don't seem to be able to move your legs to do that|too injured|already dead|little bit late|could not find/i
			wait_rt
			stance_defensive
		else
			wait_rt
			stance_defensive
		end
	end
end

def flare_gloves_pound
	health_monitor
    if (!Effects::Cooldowns.active? "FlareGloves Pound")	
		wait_castrt
		wait_rt
		fput "pound my #{$osa_data["$osa_flareglovesnoun"]}"
    end
end

def flurry
	if Weapon.available?("Flurry") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		assault = dothistimeout "weapon flurry", 15, /Flurry what?|Distracted, you hesitate|glides to its inevitable end with one final twirl|You feel a fair amount more durable|With a final snap of your wrist|You complete your assault|to the ready, your assault complete|Upon firing your last (?:arrow|bolt)|With a final, explosive breath|recentering yourself for the fight|You don't seem to be able to move your legs to do that|too injured|already dead|little bit late|could not find/i
		if assault.to_s =~ /Flurry what?|Distracted, you hesitate|glides to its inevitable end with one final twirl|You feel a fair amount more durable|With a final snap of your wrist|You complete your assault|to the ready, your assault complete|Upon firing your last (?:arrow|bolt)|With a final, explosive breath|recentering yourself for the fight|You don't seem to be able to move your legs to do that|too injured|already dead|little bit late|could not find/i
			wait_rt
			stance_defensive
		else
			wait_rt
			stance_defensive
		end
	end
end

def fury
	if Weapon.available?("Fury") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		assault = dothistimeout "weapon fury", 15, /Fury what?|Distracted, you hesitate|glides to its inevitable end with one final twirl|You feel a fair amount more durable|With a final snap of your wrist|You complete your assault|to the ready, your assault complete|Upon firing your last (?:arrow|bolt)|With a final, explosive breath|recentering yourself for the fight|You don't seem to be able to move your legs to do that|too injured|already dead|little bit late|could not find/i
		if assault.to_s =~ /Fury what?|Distracted, you hesitate|glides to its inevitable end with one final twirl|You feel a fair amount more durable|With a final snap of your wrist|You complete your assault|to the ready, your assault complete|Upon firing your last (?:arrow|bolt)|With a final, explosive breath|recentering yourself for the fight|You don't seem to be able to move your legs to do that|too injured|already dead|little bit late|could not find/i
			wait_rt
			stance_defensive
		else
			wait_rt
			stance_defensive
		end
	end
end

def gthrusts
	if Weapon.available?("Guardant Thrusts") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		if checkname == "Peggyanne"
			flavor_messaging
		end
		assault = dothistimeout "weapon gthrusts", 15, /Guardant Thrusts what?|Distracted, you hesitate|glides to its inevitable end with one final twirl|You feel a fair amount more durable|With a final snap of your wrist|You complete your assault|to the ready, your assault complete|Upon firing your last (?:arrow|bolt)|With a final, explosive breath|recentering yourself for the fight|You don't seem to be able to move your legs to do that|too injured|already dead|little bit late|could not find/i
		if assault.to_s =~ /Guardant Thrusts what?|Distracted, you hesitate|glides to its inevitable end with one final twirl|You feel a fair amount more durable|With a final snap of your wrist|You complete your assault|to the ready, your assault complete|Upon firing your last (?:arrow|bolt)|With a final, explosive breath|recentering yourself for the fight|You don't seem to be able to move your legs to do that|too injured|already dead|little bit late|could not find/i
			wait_rt
			stance_defensive
		else
			wait_rt
			stance_defensive
		end
	end
end

def pummel
	if Weapon.available?("Pummel") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		assault = dothistimeout "weapon pummel", 15, /Pummel what?|Distracted, you hesitate|glides to its inevitable end with one final twirl|You feel a fair amount more durable|With a final snap of your wrist|You complete your assault|to the ready, your assault complete|Upon firing your last (?:arrow|bolt)|With a final, explosive breath|recentering yourself for the fight|You don't seem to be able to move your legs to do that|too injured|already dead|little bit late|could not find/i
		if assault.to_s =~ /Pummel what?|Distracted, you hesitate|glides to its inevitable end with one final twirl|You feel a fair amount more durable|With a final snap of your wrist|You complete your assault|to the ready, your assault complete|Upon firing your last (?:arrow|bolt)|With a final, explosive breath|recentering yourself for the fight|You don't seem to be able to move your legs to do that|too injured|already dead|little bit late|could not find/i
			wait_rt
			stance_defensive
		else
			wait_rt
			stance_defensive
		end
	end
end

def thrash
	if Weapon.available?("Thrash") && (!GameObj.target.nil?) && (GameObj.target.status != "dead")
		stance_offensive
		assault = dothistimeout "weapon thrash", 15, /Thrash what?|Distracted, you hesitate|glides to its inevitable end with one final twirl|You feel a fair amount more durable|With a final snap of your wrist|You complete your assault|to the ready, your assault complete|Upon firing your last (?:arrow|bolt)|With a final, explosive breath|recentering yourself for the fight|You don't seem to be able to move your legs to do that|too injured|already dead|little bit late|could not find/i
		if assault.to_s =~ /Thrash what?|Distracted, you hesitate|glides to its inevitable end with one final twirl|You feel a fair amount more durable|With a final snap of your wrist|You complete your assault|to the ready, your assault complete|Upon firing your last (?:arrow|bolt)|With a final, explosive breath|recentering yourself for the fight|You don't seem to be able to move your legs to do that|too injured|already dead|little bit late|could not find/i
			wait_rt
			stance_defensive
		else
			wait_rt
			stance_defensive
		end
	end
end

def assault_att
	if !stunned? && !webbed? && !bound? && !checkdead && !GameObj.targets.empty? && (Char.stamina.to_i >= @assault_stam_min.to_i) && (Char.mana.to_i > @assault_mana_min) && (GameObj.targets.count >= @assault_enemy_min) && (GameObj.targets.count <= @assault_enemy_max)
		if @assault == 0
			return
		end
		get_target
		if @assault == 1
			barrage
		elsif @assault == 2
			flurry
		elsif @assault == 3
			fury
		elsif @assault == 4
			gthrusts
		elsif @assault == 5
			light_wings_turn
		elsif @assault == 6
			pummel
		elsif @assault == 7
			thrash
		end
	end
end

def assault_att2
	if !stunned? && !webbed? && !bound? && !checkdead && !GameObj.targets.empty? && (Char.stamina.to_i >= @assault2_stam_min.to_i) && (Char.mana.to_i > @assault2_mana_min) && (GameObj.targets.count >= @assault2_enemy_min) && (GameObj.targets.count <= @assault2_enemy_max)
		if @assault2 == 0
			return
		end
		get_target
		if @assault2 == 1
			barrage
		elsif @assault2 == 2
			flurry
		elsif @assault2 == 3
			fury
		elsif @assault2 == 4
			gthrusts
		elsif @assault2 == 5
			light_wings_turn
		elsif @assault2 == 6
			pummel
		elsif @assault2 == 7
			thrash
		end
	end
end

################### AOE Attacks	
def bull_rush
	if CMan.available?("Bull Rush")
		stance_offensive
		fput "cman bullrush"
		wait_rt
		stance_defensive
	end
end

def clash
	if Weapon.available?("Clash")
		stance_offensive
		fput "weapon clash"
		wait_rt
		stance_defensive
	end
end

def cyclone
	if Weapon.available?("Cyclone")
		stance_offensive
		fput "weapon cyclone"
		wait_rt
		stance_defensive
	end
end

def pin_down
	if Weapon.available?("Pin Down")
		stance_offensive
		fput "weapon pindown"
		wait_rt
		stance_defensive
	end
end

def pulverize
	if Weapon.available?("Pulverize")
		stance_offensive
		fput "weapon pulverize"
		wait_rt
		stance_defensive
	end
end

def shield_throw
	if Shield.available?("Shield Throw")
		stance_offensive
		fput "shield throw"
		wait_rt
		stance_defensive
	end
end

def whirling_blade
	if Weapon.available?("Whirling Blade")
		stance_offensive
		fput "weapon wblade"
		wait_rt
		stance_defensive
	end
end

def whirlwind
	if Weapon.available?("Whirlwind") && ((!stunned?) && (!webbed?) && (!bound?) && (!checkdead))
		stance_offensive
		fput "weapon whirlwind"
		wait_rt
		stance_defensive
	end
end

def volley
	if Weapon.available?("Volley")
		stance_offensive
		fput "weapon volley"
		wait_rt
		stance_defensive
	end
end

def aoe_att
	if !stunned? && !webbed? && !bound? && !checkdead && !GameObj.targets.empty? && (Char.stamina.to_i >= @aoe_attack_stam_min.to_i) && (Char.mana.to_i > @aoe_attack_mana_min) && (GameObj.targets.count >= @aoe_attack_enemy_min) && (GameObj.targets.count <= @aoe_attack_enemy_max)
		if @aoe_attack == 0
			return
		end
		get_target
		if @aoe_attack == 1
			bull_rush
		elsif @aoe_attack == 2
			clash
		elsif @aoe_attack == 3
			cyclone
		elsif @aoe_attack == 4
			dark_wings_knock
		elsif @aoe_attack == 5
			dark_wings_fold
		elsif @aoe_attack == 6
			pin_down
		elsif @aoe_attack == 7
			flare_gloves_pound
		elsif @aoe_attack == 8
			pulverize
		elsif @aoe_attack == 9
			shield_throw
		elsif @aoe_attack == 10
			shield_trample
		elsif @aoe_attack == 11
			whirling_blade
		elsif @aoe_attack == 12
			whirlwind
		elsif @aoe_attack == 13
			volley
		end
	end
end

def aoe_att2
	if !stunned? && !webbed? && !bound? && !checkdead && !GameObj.targets.empty? && (Char.stamina.to_i >= @aoe_attack2_stam_min.to_i) && (Char.mana.to_i > @aoe_attack2_mana_min) && (GameObj.targets.count >= @aoe_attack2_enemy_min) && (GameObj.targets.count <= @aoe_attack2_enemy_max)
		if @aoe_attack2 == 0
			return
		end
		get_target
		if @aoe_attack2 == 1
			bull_rush
		elsif @aoe_attack2 == 2
			clash
		elsif @aoe_attack2 == 3
			cyclone
		elsif @aoe_attack2 == 4
			dark_wings_knock
		elsif @aoe_attack2 == 5
			dark_wings_fold
		elsif @aoe_attack2 == 6
			pin_down
		elsif @aoe_attack2 == 7
			flare_gloves_pound
		elsif @aoe_attack2 == 8
			pulverize
		elsif @aoe_attack2 == 9
			shield_throw
		elsif @aoe_attack2 == 10
			shield_trample
		elsif @aoe_attack2 == 11
			whirling_blade
		elsif @aoe_attack2 == 12
			whirlwind
		elsif @aoe_attack2 == 13
			volley
		end
	end
end

################# Mstrike Routine	
def mstrike_routine
	if Skills.multiopponentcombat >= 5 && $osa_data["$osa_use_mstrike"]
		if Effects::Cooldowns.active? "Multi-Strike" or ((stunned?) or (webbed?) or (bound?))
			return
		else
			if GameObj.targets.count >= 2 && $osacombat_my_mstrike_focus == 0 && $osacombat_my_mstrike_open >= 1 && $osa_data["$osa_use_mstrike"]
				if percentstamina >= 50
					stance_offensive
					fput "mstrike"
					wait_rt
					stance_defensive
				end
			elsif GameObj.targets.count == 1 && $osacombat_my_mstrike_focus >= 1 && $osacombat_my_mstrike_open >= 1 && $osa_data["$osa_use_mstrike"]
				if percentstamina >= 50
					get_target
					stance_offensive
					fput "mstrike target"
					wait_rt
					stance_defensive
				end
			elsif GameObj.targets.count >= 2 && $osacombat_my_mstrike_focus >= 1 && $osacombat_my_mstrike_open >= 1 && $osa_data["$osa_use_mstrike"]
				if percentstamina >= 50
					stance_offensive
					fput "mstrike"
					wait_rt
					stance_defensive
				end
			end
		end
	else
		return
	end
	wait_rt
end

################# Combat Styles	

def combat	
	prep_reset
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	health_monitor
	wait_rt
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && !@attack_spell_opener.empty?
		creature_type
		can_cast_opener
	end
	health_monitor
	wait_rt
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	health_monitor
	wait_rt
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && !@attack_spell_opener2.empty?
		creature_type
		can_cast_opener2
	end
	health_monitor
	wait_rt
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	health_monitor
	wait_rt
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && @setup_attack != 0
		creature_type
		att_openers
	end
	health_monitor
	wait_rt
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && @setup_attack2 != 0
		creature_type
		att_openers2
	end
	health_monitor
	wait_rt
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && @aoe_attack != 0
		creature_type
		aoe_att
	end
	health_monitor
	wait_rt
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && @aoe_attack2 != 0
		creature_type
		aoe_att2
	end
	health_monitor
	wait_rt
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching
		if $osa_data["$osa_use_kneel"]
			kneel_check
		end
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && @assault != 0
		creature_type
		assault_att
	end
	health_monitor
	wait_rt
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching
		if $osa_data["$osa_use_kneel"]
			kneel_check
		end
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && @assault2 != 0
		creature_type
		assault_att2
	end
	health_monitor
	wait_rt
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching
		mstrike_routine
	end
	health_monitor
	wait_rt
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && @special_attack != 0
		creature_type
		special_att
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && @special_attack2 != 0
		creature_type
		secondspecial_att
	end
	health_monitor
	wait_rt
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching
		if $osa_data["$osa_use_kneel"]
			kneel_check
		end
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching
		if $osa_data["$osa_use_stealth"]
			echo "hiding!!!"
			hide_time
		end
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching
		if $osa_data["$osa_noattack"]
			if $osa_data["$osa_osaarcher"]
				chicken_fire
			end
			if $osa_data["$osa_nouacweapons"]
				uac_round
			end
			if (!$osa_data["$osa_nouacweapons"]) && (!$osa_data["$osa_osaarcher"])
				chicken_attack
			end
		end
	end
	health_monitor
	wait_rt
	prep_reset
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && !@attack_spell.empty?
		creature_type
		can_cast
	end
	health_monitor
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && !@attack_spell2.empty?
		creature_type
		can_cast2
	end
	health_monitor
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && !@attack_spell3.empty?
		creature_type
		can_cast3
	end
	health_monitor
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && !@attack_spell4.empty?
		creature_type
		can_cast4
	end
	health_monitor
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && !@attack_spell5.empty?
		creature_type
		can_cast5
	end
	health_monitor
	check_for_poaching if $osa_data["$osa_check_for_group"]
	if !$poaching && $osa_data["$osa_reactive"]
		reactive
	end
	looter
	check_for_poaching if $osa_data["$osa_check_for_group"]
end

############Combat Checking Start

def groupeffects
	check_dead
	cast_spell_society if !$society_firstcast && (Room.current.title.to_s.downcase.include? "enemy")
	cast_spell_society if $society_firstcast
	cast_spell_mana_focus if $osa_data["$osa_cast_spell_mana_focus"] && (!$mana_focus_first_cast && (Room.current.title.to_s.downcase.include? "enemy"))
	cast_spell_mana_focus if $osa_data["$osa_cast_spell_mana_focus"] && $mana_focus_first_cast
	cast_spell_bravery if $osa_data["$osa_groupbravery"] && (!$bravery_first_cast && (Room.current.title.to_s.downcase.include? "enemy"))
	cast_spell_bravery if $osa_data["$osa_groupbravery"] && $bravery_first_cast
	cast_spell_group_celerity if $osa_data["$osa_cast_spell_group_celerity"] && (!$group_celerity_first_cast && (Room.current.title.to_s.downcase.include? "enemy"))
	cast_spell_group_celerity if $osa_data["$osa_cast_spell_group_celerity"] && $group_celerity_first_cast
	cast_spell_celerity if $osa_data["$osa_cast_spell_self_celerity"] && (!$celerity_first_cast && (Room.current.title.to_s.downcase.include? "enemy"))
	cast_spell_celerity if $osa_data["$osa_cast_spell_self_celerity"] && $celerity_first_cast
	cast_spell_rapid_fire if $osa_data["$osa_spell_rapid_fire"] && (!$rapid_fire_first_cast && (Room.current.title.to_s.downcase.include? "enemy"))
	cast_spell_rapid_fire if $osa_data["$osa_spell_rapid_fire"] && $rapid_fire_first_cast
	cast_spell_zealot if $osa_data["$osa_cast_spell_di_zeal"]
	cast_spell_wall_of_force if $osa_data["$osa_spell_wall_of_force"] && (!$wall_of_force_first_cast && (Room.current.title.to_s.downcase.include? "enemy"))
	cast_spell_wall_of_force if $osa_data["$osa_spell_wall_of_force"] && $wall_of_force_first_cast
	cast_spell_faith_shield if $osa_data["$osa_spell_shield_faith"] && (!$faith_shield_first_cast && (Room.current.title.to_s.downcase.include? "enemy"))
	cast_spell_faith_shield if $osa_data["$osa_spell_shield_faith"] && $faith_shield_first_cast
	cast_spell_heroism if $osa_data["$osa_spell_heroism"] && (!$heroism_first_cast && (Room.current.title.to_s.downcase.include? "enemy"))
	cast_spell_heroism if $osa_data["$osa_spell_heroism"] && $heroism_first_cast
	cast_spell_group_barkskin if $osa_data["$osa_barkskin_spell_group"] && (!$group_barkskin_first_cast && (Room.current.title.to_s.downcase.include? "enemy"))
	cast_spell_group_barkskin if $osa_data["$osa_barkskin_spell_group"] && $group_barkskin_first_cast
	cast_spell_barkskin if $osa_data["$osa_barkskin_spell"] && (!$barkskin_first_cast && (Room.current.title.to_s.downcase.include? "enemy"))
	cast_spell_barkskin if $osa_data["$osa_barkskin_spell"] && $barkskin_first_cast
	cast_spell_beacon_of_courage if $osa_data["$osa_spell_beacon_of_courage"] && (!$beacon_of_courage_first_cast && (Room.current.title.to_s.downcase.include? "enemy"))
	cast_spell_beacon_of_courage if $osa_data["$osa_spell_beacon_of_courage"] && $beacon_of_courage_first_cast
	sing_song_song_of_tonis if $osa_data["$osa_song_song_of_tonis"] && (!$song_of_tonis_first_cast && (Room.current.title.to_s.downcase.include? "enemy"))
	sing_song_song_of_tonis if $osa_data["$osa_song_song_of_tonis"] && $song_of_tonis_first_cast
	cry_warcry_shout if $osa_data["$osa_warcry_shout"] && (!$warcry_shout_first_cry && (Room.current.title.to_s.downcase.include? "enemy"))
	cry_warcry_shout if $osa_data["$osa_warcry_shout"] && $warcry_shout_first_cry
	cry_warcry_holler if $osa_data["$osa_warcry_holler"] && (!$warcry_holler_first_cry && (Room.current.title.to_s.downcase.include? "enemy"))
	cry_warcry_holler if $osa_data["$osa_warcry_holler"] && $warcry_holler_first_cry
	use_shield_steely if $osa_data["$osa_shield_steely"] && (!$osa_shield_steely_first_use && (Room.current.title.to_s.downcase.include? "enemy"))
	use_shield_steely if $osa_data["$osa_shield_steely"] && $osa_shield_steely_first_use	
	use_cman_surge_of_strength_cooldown if $osa_data["$osa_cman_surge_of_strength_cooldown"] && (!$osa_cman_surge_of_strength_cooldown_first_use && (Room.current.title.to_s.downcase.include? "enemy"))
	use_cman_surge_of_strength_cooldown if $osa_data["$osa_cman_surge_of_strength_cooldown"] && $osa_cman_surge_of_strength_cooldown_first_use
	use_cman_surge_of_strength_no_cooldown if $osa_data["$osa_cman_surge_of_strength_no_cooldown"] && (!$osa_cman_surge_of_strength_no_cooldown_first_use && (Room.current.title.to_s.downcase.include? "enemy"))
	use_cman_surge_of_strength_no_cooldown if $osa_data["$osa_cman_surge_of_strength_no_cooldown"] && $osa_cman_surge_of_strength_no_cooldown_first_use
end

def gemstone_effects
	check_dead
	activate_gemstone_arcane_aegis if $osa_data["$osa_gemstone_arcane_aegis"] && (!$osa_gemstone_arcane_aegis_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_arcane_aegis if $osa_data["$osa_gemstone_arcane_aegis"] && $osa_gemstone_arcane_aegis_first_activate	
	activate_gemstone_arcanists_ascendancy if $osa_data["$osa_gemstone_arcanists_ascendancy"] && (!$osa_gemstone_arcanists_ascendancy_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_arcanists_ascendancy if $osa_data["$osa_gemstone_arcanists_ascendancy"] && $osa_gemstone_arcanists_ascendancy_first_activate	
	activate_gemstone_arcanists_blade if $osa_data["$osa_gemstone_arcanists_blade"] && (!$osa_gemstone_arcanists_blade_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_arcanists_blade if $osa_data["$osa_gemstone_arcanists_blade"] && $osa_gemstone_arcanists_blade_first_activate	
	activate_gemstone_arcanists_will if $osa_data["$osa_gemstone_arcanists_will"] && (!$osa_gemstone_arcanists_will_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_arcanists_will if $osa_data["$osa_gemstone_arcanists_will"] && $osa_gemstone_arcanists_will_first_activate
	activate_gemstone_blood_boil if $osa_data["$osa_gemstone_blood_boil"] && (!$osa_gemstone_blood_boil_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_blood_boil if $osa_data["$osa_gemstone_blood_boil"] && $osa_gemstone_blood_boil_first_activate	
	activate_gemstone_blood_siphon if $osa_data["$osa_gemstone_blood_siphon"] && (!$osa_gemstone_blood_siphon_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_blood_siphon if $osa_data["$osa_gemstone_blood_siphon"] && $osa_gemstone_blood_siphon_first_activate	
	activate_gemstone_blood_wellspring if $osa_data["$osa_gemstone_blood_wellspring"] && (!$osa_gemstone_blood_wellspring_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_blood_wellspring if $osa_data["$osa_gemstone_blood_wellspring"] && $osa_gemstone_blood_wellspring_first_activate
	activate_gemstone_evanescent_possession if $osa_data["$osa_gemstone_evanescent_possession"] && (!$osa_gemstone_evanescent_possession_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_evanescent_possession if $osa_data["$osa_gemstone_evanescent_possession"] && $osa_gemstone_evanescent_possession_first_activate	
	activate_gemstone_force_of_will if $osa_data["$osa_gemstone_force_of_will"] && (!$osa_gemstone_force_of_will_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_force_of_will if $osa_data["$osa_gemstone_force_of_will"] && $osa_gemstone_force_of_will_first_activate	
	activate_gemstone_geomancers_spite if $osa_data["$osa_gemstone_geomancers_spite"] && (!$osa_gemstone_geomancers_spite_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_geomancers_spite if $osa_data["$osa_gemstone_geomancers_spite"] && $osa_gemstone_geomancers_spite_first_activate	
	activate_gemstone_mana_shield if $osa_data["$osa_gemstone_mana_shield"] && (!$osa_gemstone_mana_shield_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_mana_shield if $osa_data["$osa_gemstone_mana_shield"] && $osa_gemstone_mana_shield_first_activate	
	activate_gemstone_mana_wellspring if $osa_data["$osa_gemstone_mana_wellspring"] && (!$osa_gemstone_mana_wellspring_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_mana_wellspring if $osa_data["$osa_gemstone_mana_wellspring"] && $osa_gemstone_mana_wellspring_first_activate	
	activate_gemstone_reckless_precision if $osa_data["$osa_gemstone_reckless_precision"] && (!$osa_gemstone_reckless_precision_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_reckless_precision if $osa_data["$osa_gemstone_reckless_precision"] && $osa_gemstone_reckless_precision_first_activate	
	activate_gemstone_spellblades_fury if $osa_data["$osa_gemstone_spellblades_fury"] && (!$osa_gemstone_spellblades_fury_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_spellblades_fury if $osa_data["$osa_gemstone_spellblades_fury"] && $osa_gemstone_spellblades_fury_first_activate	
	activate_gemstone_spirit_wellspring if $osa_data["$osa_gemstone_spirit_wellspring"] && (!$osa_gemstone_spirit_wellspring_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_spirit_wellspring if $osa_data["$osa_gemstone_spirit_wellspring"] && $osa_gemstone_spirit_wellspring_first_activate	
	activate_gemstone_unearthly_chains if $osa_data["$osa_gemstone_unearthly_chains"] && (!$osa_gemstone_unearthly_chains_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_unearthly_chains if $osa_data["$osa_gemstone_unearthly_chains"] && $osa_gemstone_unearthly_chains_first_activate	
	activate_gemstone_witchhunters_ascendancy if $osa_data["$osa_gemstone_witchhunters_ascendancy"] && (!$osa_gemstone_witchhunters_ascendancy_first_activate && (Room.current.title.to_s.downcase.include? "enemy"))
	activate_gemstone_witchhunters_ascendancy if $osa_data["$osa_gemstone_witchhunters_ascendancy"] && $osa_gemstone_witchhunters_ascendancy_first_activate
end

def time_diff_seconds(start,finish)
	(finish - start)
end

def combat_spellup
	health_monitor
	if (Effects::Debuffs.active? "Mystic Impedance") or (Effects::Debuffs.active? "Silenced") or ((stunned?) or (webbed?) or (bound?))
		return
	end
    if running? "ecure"
		wait_until { !running?('ecure') }
	end
	if !checkprep.include? "None"
		fput "release"
	end
	if checkmana < 50
		mana_share
		LNet.send_message(attr = { 'type' => 'channel', 'channel' => $osa_data["$osa_crew"] }, $mana_message)
		pause 1
	end
	wait_rt
    result = dothistimeout "incant #{@combat_spell} #{@combat_cast_type}", 30, /Wait|...wait|Spell Hindrance|(Cast|Sing) Roundtime (.*) Seconds./
        if result.to_s =~ /Wait|...wait/
            combat_spellup
        elsif result.to_s =~ /Spell Hindrance/
            wait_castrt
            combat_spellup
        elsif result.to_s =~ /(Cast|Sing) Roundtime/
            return
        else
            combat_spellup
        end
end

def cast_spell_society
	health_monitor
	Spell["Sign of Warding"].cast if Spell["Sign of Warding"].known? && Spell["Sign of Warding"].affordable? && !Spell["Sign of Warding"].active? && $osa_data["$osa_sign_of_warding"]
	Spell["Sign of Defending"].cast if Spell["Sign of Defending"].known? && Spell["Sign of Defending"].affordable? && !Spell["Sign of Defending"].active? && $osa_data["$osa_sign_of_defending"]
	Spell["Sign of Shields"].cast if Spell["Sign of Shields"].known? && Spell["Sign of Shields"].affordable? && !Spell["Sign of Shields"].active? && $osa_data["$osa_sign_of_shields"]
	Spell["Sign of Striking"].cast if Spell["Sign of Striking"].known? && Spell["Sign of Striking"].affordable? && !Spell["Sign of Striking"].active? && $osa_data["$osa_sign_of_striking"]
	Spell["Sign of Smiting"].cast if Spell["Sign of Smiting"].known? && Spell["Sign of Smiting"].affordable? && !Spell["Sign of Smiting"].active? && $osa_data["$osa_sign_of_smiting"]
	Spell["Sign of Swords"].cast if Spell["Sign of Swords"].known? && Spell["Sign of Swords"].affordable? && !Spell["Sign of Swords"].active? && $osa_data["$osa_sign_of_swords"]
	Spell["Sigil of Minor Bane"].cast if Spell["Sigil of Minor Bane"].known? && Spell["Sigil of Minor Bane"].affordable? && !Spell["Sigil of Minor Bane"].active? && $osa_data["$osa_sigil_of_minor_bane"]
	Spell["Sigil of Offense"].cast if Spell["Sigil of Offense"].known? && Spell["Sigil of Offense"].affordable? && !Spell["Sigil of Offense"].active? && $osa_data["$osa_sigil_of_offense"]
	Spell["Sigil of Major Bane"].cast if Spell["Sigil of Major Bane"].known? && Spell["Sigil of Major Bane"].affordable? && !Spell["Sigil of Major Bane"].active? && $osa_data["$osa_sigil_of_major_bane"]
	Spell["Sigil of Minor Protection"].cast if Spell["Sigil of Minor Protection"].known? && Spell["Sigil of Minor Protection"].affordable? && !Spell["Sigil of Minor Protection"].active? && $osa_data["$osa_sigil_of_minor_protection"]
	Spell["Sigil of Defense"].cast if Spell["Sigil of Defense"].known? && Spell["Sigil of Defense"].affordable? && !Spell["Sigil of Defense"].active? && $osa_data["$osa_sigil_of_defense"]
	Spell["Sigil of Major Protection"].cast if Spell["Sigil of Major Protection"].known? && Spell["Sigil of Major Protection"].affordable? && !Spell["Sigil of Major Protection"].active? && $osa_data["$osa_sigil_of_major_protection"]
	Spell["Sigil of Concentration"].cast if Spell["Sigil of Concentration"].known? && Spell["Sigil of Concentration"].affordable? && !Spell["Sigil of Concentration"].active? && $osa_data["$osa_sigil_of_concentration"]
	Spell["Symbol of Courage"].cast if Spell["Symbol of Courage"].known? && Spell["Symbol of Courage"].affordable? && !Spell["Symbol of Courage"].active? && $osa_data["$osa_symbol_of_courage"]
	Spell["Symbol of Protection"].cast if Spell["Symbol of Protection"].known? && Spell["Symbol of Protection"].affordable? && !Spell["Symbol of Protection"].active? && $osa_data["$osa_symbol_of_protection"]
	Spell["Symbol of Retribution"].cast if Spell["Symbol of Retribution"].known? && Spell["Symbol of Retribution"].affordable? && !Spell["Symbol of Retribution"].active? && $osa_data["$osa_symbol_of_retribution"] && @creature_type == "undead"
	Spell["Symbol of Supremacy"].cast if Spell["Symbol of Supremacy"].known? && Spell["Symbol of Supremacy"].affordable? && !Spell["Symbol of Supremacy"].active? && $osa_data["$osa_symbol_of_supremacy"] && @creature_type == "undead"
	Spell[1607].cast if Spell[1607].available? && (!Effects::Buffs.active? "Rejuvenation") && percentstamina <= 50
end

def cast_spell_mana_focus
	if (!Spell[1018].active? && Spell[418].known?)
		@combat_spell = "418"
		@combat_cast_type = ""
		combat_spellup
		$mana_focus_first_cast = nil
	end
end

def cast_spell_bravery
	if $osa_data["$osa_groupbravery"] && ( $osacombat_group_bravery_start == nil || time_diff_seconds($osacombat_group_bravery_start,Time.now) > 180) && (!$osa_everyone_in_my_group.empty?)
		wait_castrt
		@combat_spell = "211"
		@combat_cast_type = "evoke"
		combat_spellup if Spell[211].affordable?
		$bravery_first_cast = true
		$osacombat_group_bravery_start = Time.now
		wait_castrt
	end
end

def cast_spell_group_celerity 
	if $osa_data["$osa_cast_spell_group_celerity"] && ( $osacombat_group_celerity_start == nil || time_diff_seconds($osacombat_group_celerity_start,Time.now) > 180) && (!$osa_everyone_in_my_group.empty?)
		wait_castrt
		@combat_spell = "506"
		@combat_cast_type = "evoke"
		combat_spellup if Spell[506].affordable?
		$group_celerity_first_cast = true
		$osacombat_group_celerity_start = Time.now
		wait_castrt
	end
end

def cast_spell_celerity 
	if ($osa_data["$osa_cast_spell_self_celerity"] && !$osa_data["$osa_cast_spell_group_celerity"]) && ((!Effects::Cooldowns.active? "Celerity") && !Effects::Buffs.active?("Celerity"))
		wait_castrt
		@combat_spell = "506"
		@combat_cast_type = ""
		combat_spellup if Spell[506].affordable?
		$celerity_first_cast = true
		wait_castrt
	end
end

def cast_spell_rapid_fire
	if $osa_data["$osa_spell_rapid_fire"] && ((!Effects::Cooldowns.active? "Rapid Fire") && !Effects::Buffs.active?("Rapid Fire"))
		wait_castrt
		@combat_spell = "515"
		@combat_cast_type = ""
		combat_spellup if Spell[515].affordable?
		$rapid_fire_first_cast = true
		wait_castrt
		pause 0.2
	end
end

def cast_spell_barkskin
	if $osa_data["$osa_barkskin_spell"] && (!Effects::Cooldowns.active? "Barkskin")
		wait_castrt
		@combat_spell = "605"
		@combat_cast_type = ""
		combat_spellup if Spell[605].affordable?
		$barkskin_first_cast = true
		wait_castrt
	end
end

def cast_spell_group_barkskin
	if $osa_data["$osa_barkskin_spell_group"] && ( $osacombat_group_barkskin_start == nil || time_diff_seconds($osacombat_group_barkskin_start,Time.now) > 60)
		if (!$osa_everyone_in_my_group.empty? && (Effects::Cooldowns.active? "Barkskin")) or (!$osa_everyone_in_my_group.empty? && (!Effects::Cooldowns.active? "Barkskin")) or ($osa_everyone_in_my_group.empty? && (!Effects::Cooldowns.active? "Barkskin"))
			wait_castrt
			@combat_spell = "605"
			@combat_cast_type = "evoke"
			combat_spellup if Spell[605].affordable?
			$group_barkskin_first_cast = true
			$osacombat_group_barkskin_start = Time.now
			wait_castrt
		end
	end
end

def cast_spell_zealot
	health_monitor
    if (!Effects::Cooldowns.active? "Incarnate Zeal") && (GameObj.targets.count >= 1)
		if (Spell[1650].active?)
			wait_castrt
			wait_rt
			fput "incarn zeal"
		else
			if (checkmana >=50) && (!Effects::Cooldowns.active? "Divine Incarnation")
				wait_castrt
				wait_rt
				fput "incarn zeal"
			end
		end
    end
end

def cast_spell_heroism
	if $osa_data["$osa_spell_heroism"] && ( $osacombat_group_heroism_start == nil || time_diff_seconds($osacombat_group_heroism_start,Time.now) > 180) && (!$osa_everyone_in_my_group.empty?)
		wait_castrt
		@combat_spell = "215"
		@combat_cast_type = "evoke"
		combat_spellup if Spell[215].affordable?
		$heroism_first_cast = true
		$osacombat_group_heroism_start = Time.now
		wait_castrt
	end
end
	
def cast_spell_faith_shield
	if $osa_data["$osa_spell_shield_faith"] && (!Effects::Cooldowns.active? "Faith Shield") && (!Spell[1619].active?)
		wait_castrt
		@combat_spell = "1619"
		@combat_cast_type = ""
		combat_spellup if Spell[1619].affordable?
		$faith_shield_first_cast = true
		wait_castrt
	end
end

def use_shield_steely
	if Shield.available?("Steely Resolve") && (GameObj.targets.count > 0)
		wait_rt
		Shield.use("Steely Resolve")
		$osa_shield_steely_first_use = true
	end
end

def use_cman_surge_of_strength_no_cooldown
	health_monitor
    if ($osa_cman_surge_of_strength_no_cooldown_first_use && (!Effects::Buffs.active?("Enh. Strength (+16)") and !Effects::Buffs.active?("Enh. Strength (+20)") and !Effects::Buffs.active?("Enh. Strength (+24)") and !Effects::Buffs.active?("Enh. Strength (+28)") and !Effects::Buffs.active?("Enh. Strength (+32)"))) && ( $osacombat_surgeofstrength_start == nil || time_diff_seconds($osacombat_surgeofstrength_start,Time.now) > 90)
		if (checkstamina >= 60) && (CMan.known? "Surge of Strength") && (Effects::Cooldowns.active? "Surge of Strength")
			wait_rt
			fput "cman surge"
			$osa_cman_surge_of_strength_no_cooldown_first_use = true
			$osacombat_surgeofstrength_start = Time.now
		else 
			if (CMan.affordable? "Surge of Strength") && (CMan.known? "Surge of Strength") && (!Effects::Cooldowns.active? "Surge of Strength")
						wait_rt
				fput "cman surge"
				$osa_cman_surge_of_strength_no_cooldown_first_use = true
				$osacombat_surgeofstrength_start = Time.now
			end
		end
    end
end

def use_cman_surge_of_strength_cooldown
	health_monitor
    if ($osa_cman_surge_of_strength_cooldown_first_use && (!Effects::Buffs.active?("Enh. Strength (+16)") and !Effects::Buffs.active?("Enh. Strength (+20)") and !Effects::Buffs.active?("Enh. Strength (+24)") and !Effects::Buffs.active?("Enh. Strength (+28)") and !Effects::Buffs.active?("Enh. Strength (+32)"))) && ( $osacombat_surgeofstrength_start == nil || time_diff_seconds($osacombat_surgeofstrength_start,Time.now) > 90)
		if (CMan.affordable? "Surge of Strength") && (CMan.known? "Surge of Strength") && (!Effects::Cooldowns.active? "Surge of Strength")
			wait_rt
			fput "cman surge"
			$osa_cman_surge_of_strength_cooldown_first_use = true
			$osacombat_surgeofstrength_start = Time.now
		end
    end
end

def cast_spell_wall_of_force
	if $osa_data["$osa_spell_wall_of_force"] && (!Effects::Cooldowns.active? "Wall of Force") && (!Spell[140].active?)
		wait_castrt
		@combat_spell = "140"
		@combat_cast_type = ""
		combat_spellup if Spell[140].affordable?
		$wall_of_force_first_cast = true
		wait_castrt
	end
end

def cast_spell_beacon_of_courage
	if ($osa_data["$osa_spell_beacon_of_courage"] && !Spell[1699].active?) && (!$osa_everyone_in_my_group.empty?)
		wait_castrt
		@combat_spell = "1608"
		@combat_cast_type = ""
		combat_spellup if Spell[1608].affordable?
		$beacon_of_courage_first_cast = true
		wait_castrt
	end
end

def sing_song_song_of_tonis
	if ($osa_data["$osa_song_song_of_tonis"] && !Spell[1035].active? ) && (!$osa_everyone_in_my_group.empty?)
			wait_castrt
			@combat_spell = "1035"
			@combat_cast_type = ""
			combat_spellup if Spell[1035].affordable?
			$song_of_tonis_first_cast = true
			wait_castrt
		end
end

def cry_warcry_shout
	health_monitor
    if ($osa_data["$osa_warcry_shout"] && !Effects::Buffs.active?("Empowered (+20)")) && (!Effects::Debuffs.active? "Silenced") && ((!stunned?) or (!bound?))
		if (checkstamina > 11 || Spell[9628].active?) or (checkstamina > 24 || !Spell[9628].active? )
			wait_rt
			result = dothistimeout "warcry shout", 3, /let loose an echoing shout/
			if result.to_s =~ /let loose an echoing shout/
				$warcry_shout_first_cry = true
				return
			end
		end
    end
end

def cry_warcry_holler
	health_monitor
	if ($osa_data["$osa_warcry_holler"] && !Effects::Buffs.active?("Enh. Health (+20)")) && (!Effects::Debuffs.active? "Silenced") && ((!stunned?) or (!bound?))
		if (checkstamina > 14 || Spell[9628].active?) or (checkstamina > 29 || !Spell[9628].active? )
			wait_rt
			result = dothistimeout "warcry holler", 3, /a thundering holler|holler your war cry|You do not know/
			if result.to_s =~ /a thundering holler|You do not know/
				$warcry_holler_first_cry = true
				return
			elsif result.to_s =~ /holler your war cry/
				cry_warcry_holler
			end
		end
	end
end

def activate_gemstone_arcane_aegis
	if (!Effects::Cooldowns.active? "Arcane Aegis") && (mana > $osa_data["$osa_gemstone_activate_arcane_aegis_mana_if"].to_i)
		wait_castrt
		fput "gemstone activate arcaneaegis"
		$osa_gemstone_arcane_aegis_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_arcanists_ascendancy
	if (!Effects::Cooldowns.active? "Arcanist\'s Ascendancy") && (GameObj.targets.count > $osa_data["$osa_gemstone_activate_arcanists_ascendancy_enemy_if"].to_i)
		wait_castrt
		fput "gemstone activate arcascend"
		$osa_gemstone_arcanists_ascendancy_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_arcanists_blade
	if (!Effects::Cooldowns.active? "Arcanist\'s Blade") && (GameObj.targets.count > $osa_data["$osa_gemstone_activate_arcanists_blade_enemy_if"].to_i && mana > $osa_data["$osa_gemstone_activate_arcanists_blade_mana_if"].to_i && stamina > $osa_data["$osa_gemstone_activate_arcanists_blade_stamina_if"].to_i)
		wait_castrt
		fput "gemstone activate arcblade"
		$osa_gemstone_arcanists_blade_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_arcanists_will
	if (!Effects::Cooldowns.active? "Arcanist\'s Will") && (GameObj.targets.count > $osa_data["$osa_gemstone_activate_arcanists_will_enemy_if"].to_i && mana > $osa_data["$osa_gemstone_activate_arcanists_will_mana_if"].to_i && stamina > $osa_data["$osa_gemstone_activate_arcanists_will_stamina_if"].to_i)
		wait_castrt
		fput "gemstone activate arcwill"
		$osa_gemstone_arcanists_will_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_blood_boil
	if (!Effects::Cooldowns.active? "Blood Boil") && (GameObj.targets.count > $osa_data["$osa_gemstone_activate_blood_boil_enemy_if"].to_i)
		wait_castrt
		fput "gemstone activate bloodboil"
		$osa_gemstone_blood_boil_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_blood_siphon
	if (!Effects::Cooldowns.active? "Blood Siphon") && (GameObj.targets.count > $osa_data["$osa_gemstone_activate_blood_siphon_enemy_if"].to_i)
		wait_castrt
		fput "gemstone activate bloodsiphon"
		$osa_gemstone_blood_siphon_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_blood_wellspring
	if (!Effects::Cooldowns.active? "Blood Wellspring") && (health < $osa_data["$osa_gemstone_activate_blood_wellspring_health_if"].to_i)
		wait_castrt
		fput "gemstone activate bloodwell"
		$osa_gemstone_blood_wellspring_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_evanescent_possession
	if (!Effects::Cooldowns.active? "Evanescent Possession") && (GameObj.targets.count > $osa_data["$osa_gemstone_activate_evanescent_possession_enemy_if"].to_i)
		wait_castrt
		multifput "gemstone activate epossess #{GameObj.target}", "target next"
		$osa_gemstone_evanescent_possession_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_force_of_will
	if (!Effects::Cooldowns.active? "Force of Will")
		wait_castrt
		fput "gemstone activate forceofwill"
		$osa_gemstone_force_of_will_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_geomancers_spite
	if (!Effects::Cooldowns.active? "Geomancer's Spite") && (GameObj.targets.count > $osa_data["$osa_gemstone_activate_geomancers_spite_enemy_if"].to_i)
		wait_castrt
		fput "gemstone activate geospite"
		$osa_gemstone_geomancers_spite_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_mana_shield
	if (!Effects::Cooldowns.active? "Mana Shield") && (mana > $osa_data["$osa_gemstone_activate_mana_shield_mana_if"].to_i)
		wait_castrt
		fput "gemstone activate manashield"
		$osa_gemstone_mana_shield_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_mana_wellspring
	if (!Effects::Cooldowns.active? "Mana Wellspring") && ($osa_data["$osa_gemstone_activate_mana_wellspring_mana_if"].to_i > mana)
		wait_castrt
		fput "gemstone activate manawellspring"
		$osa_gemstone_mana_wellspring_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_reckless_precision
	if (!Effects::Cooldowns.active? "Reckless Precision") && (GameObj.targets.count < $osa_data["$osa_gemstone_activate_reckless_precision_enemy_if"].to_i) && (GameObj.targets.count > 0)
		wait_castrt
		fput "gemstone activate reckless"
		$osa_gemstone_reckless_precision_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_spellblades_fury
	if (!Effects::Cooldowns.active? "Spellblade\'s Fury") && (GameObj.targets.count > $osa_data["$osa_gemstone_activate_spellblades_fury_enemy_if"].to_i && mana > $osa_data["$osa_gemstone_activate_spellblades_fury_mana_if"].to_i)
		wait_castrt
		fput "gemstone activate spellblade"
		$osa_gemstone_spellblades_fury_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_spirit_wellspring
	if (!Effects::Cooldowns.active? "Spirit Wellspring") && ($osa_data["$osa_gemstone_activate_spirit_wellspring_spirit_if"].to_i > spirit)
		wait_castrt
		fput "gemstone activate spiritwell"
		$osa_gemstone_spirit_wellspring_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_stamina_wellspring
	if (!Effects::Cooldowns.active? "Stamina Wellspring") && ($osa_data["$osa_gemstone_activate_stamina_wellspring_stamina_if"].to_i > stamina)
		wait_castrt
		fput "gemstone activate stamwell"
		$osa_gemstone_stamina_wellspring_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_unearthly_chains
	if (!Effects::Cooldowns.active? "Unearthly Chains") && ($osa_data["$osa_gemstone_activate_unearthly_chains_enemy_if"].to_i < GameObj.targets.count)
		wait_castrt
		#if checkname = "Ithloria"
		#	fput "yell Get Over Here!!!"
		#end
		fput "gemstone activate unearthchains"
		$osa_gemstone_unearthly_chains_first_activate = true
		wait_castrt
	end
end

def activate_gemstone_witchhunters_ascendancy
	if (!Effects::Cooldowns.active? "Witchhunter's Ascendancy") && ($osa_data["$osa_gemstone_activate_witchhunters_ascendancy_enemy_if"].to_i < GameObj.targets.count)
		wait_castrt
		fput "gemstone activate witchhunt"
		$osa_gemstone_witchhunters_ascendancy_first_activate = true
		wait_castrt
	end
end

def return_to_injured_room
	if Room.current.id == @captains_quarters && (Room.current.location == "Ships")
		start_script("go2", [@injured_room])
		wait_while { running?("go2") }
		unpause_script "osacrew"
	end
end

def get_captains_location
	LNet.send_message(attr = { 'type' => 'private', 'to' => $osa_data["$osa_commander"] }, "Captain, I've Been Injured and Will Return Shortly")
	result = matchtimeout 30, /^\[Private\]-GSIV:#{$osa_data["$osa_commander"]}\: \"Ok Crewman\, We Are At (.*) And Will Await Your Arrival"/
		if result.to_s =~ /^\[Private\]-GSIV:#{$osa_data["$osa_commander"]}\: \"Ok Crewman\, We Are At (.*) And Will Await Your Arrival"/
			@captains_location = $1
		else
			echo "Something Went Wrong, Retrying!"
			get_captains_location
	end
end

def wheres_the_captain
	if !checkpcs.include?($osa_data["$osa_commander"]) && (!$osa_data["$osa_commander"].include?(checkname)) && (Room.current.location == "Ships")
		get_captains_location
		fput "group open"
		start_script("go2", [@captains_location])
		wait_while { running?("go2") }
	end
end

def go_to_healer
	if (!checkpcs.include? $osa_data["$osa_medicalofficer"]) and (Room.current.location == "Ships")
		wait_rt
		pause_script "osacrew"
		ship_type
		@injured_room = Room.current.id
		if (Room.current.id != @captains_quarters) && (Room.current.location == "Ships")
			start_script("go2", ["captains_quarters"])
			wait_while { running?("go2") }
		end
	end
	if checkpcs.include? $osa_data["$osa_medicalofficer"]
		if $osa_data["$osa_healing_status"] == "poisoned"
			LNet.send_message(attr = { 'type' => 'channel', 'channel' => $osa_data["$osa_crew"] }, "I Am Poisoned!")
			wait_until {!Effects::Debuffs.active? ("Wall of Thorns Poison 5") and (!Effects::Debuffs.active? "Wall of Thorns Poison 4") and (!Effects::Debuffs.active? "Wall of Thorns Poison 3") and (!Effects::Debuffs.active? "Wall of Thorns Poison 2") and (!Effects::Debuffs.active? "Wall of Thorns Poison 1") and !checkpoison}
			wait_until {!Effects::Debuffs.active? ("Wall of Thorns Poison 1") and (!Effects::Debuffs.active? "Wall of Thorns Poison 2") and (!Effects::Debuffs.active? "Wall of Thorns Poison 3") and (!Effects::Debuffs.active? "Wall of Thorns Poison 4") and (!Effects::Debuffs.active? "Wall of Thorns Poison 5") and !checkpoison}
			self.save_script_data(:$osa_healing_status, "clear")
			return_to_injured_room
			wheres_the_captain
		end
		if $osa_data["$osa_healing_status"] == "diseased"
			LNet.send_message(attr = { 'type' => 'channel', 'channel' => $osa_data["$osa_crew"] }, "I Am Diseased!")
			wait_until {!diseased?}
			self.save_script_data(:$osa_healing_status, "clear")
			return_to_injured_room
			wheres_the_captain
		end
		if $osa_data["$osa_healing_status"] == "injured"
			LNet.send_message(attr = { 'type' => 'channel', 'channel' => $osa_data["$osa_crew"] }, "I Am Injured!")
			wait_until {!XMLData.injuries.any?{|key,value,| value["wound"] > $osa_data["$osa_wound_level"].to_i}}
			self.save_script_data(:$osa_healing_status, "clear")
			return_to_injured_room
			wheres_the_captain
		end
		if $osa_data["$osa_healing_status"] == "popped"
			if Feat.known?("Kroderine Soul")
				LNet.send_message(attr = { 'type' => 'private', 'to' => $osa_data["$osa_medicalofficer"] }, "surge KS")
			else
				LNet.send_message(attr = { 'type' => 'private', 'to' => $osa_data["$osa_medicalofficer"] }, "surge")
			end
			wait_until {!Effects::Debuffs.active? "Overexerted"}
			self.save_script_data(:$osa_healing_status, "clear")
			return_to_injured_room
			wheres_the_captain
		end
	else
		if $osa_data["$osa_healing_status"] == "poisoned"
			respond ""
			respond " -------                                         WARNING                                                  --------"
			respond " -------                  You Appear To Be Poisoned And There Is No Herbal Cure For Poison                --------"
			respond " ------- OSACombat Will Wait Until The Poison Is No Longer Affecting You And Then Return To Your Last Location ---"
			respond " -------                      To Stop Waiting And\\Or Continue With The Poison Type YES                       --------"
			respond ""
			waitfor /A good positive attitude never hurts/
			self.save_script_data(:$osa_healing_status, "ignore")
			return_to_injured_room
			wheres_the_captain
		end
		if $osa_data["$osa_healing_status"] == "diseased"
			respond ""
			respond " -------                                         WARNING                                                  --------"
			respond " -------                  You Appear To Be Poisoned And There Is No Herbal Cure For Disease               --------"
			respond " ------- OSACombat Will Wait Until The Disease Is No Longer Affecting You And Then Return To Your Last Location ---"
			respond " -------                      To Stop Waiting And\\Or Continue With The Disease Type YES                       --------"
			respond ""
			waitfor /A good positive attitude never hurts/
			self.save_script_data(:$osa_healing_status, "ignore")
			return_to_injured_room
			wheres_the_captain
		end
		if $osa_data["$osa_healing_status"] == "injured"
			healing_stance
			if !$osa_data["$osa_safe_room"].nil?
				start_script("go2", [$osa_data["$osa_safe_room"]])
				wait_while { running?("go2") }
			end
			do_client ";eherbs --buy=off --mending=on --skipscars=on --yaba=on --potions=on"
			wait_while { running?("eherbs") }
			if XMLData.injuries.any?{|key,value| value["wound"] > $osa_data["$osa_wound_level"].to_i}
				respond " -------      You Still Have Serious Wounds, It Is Recommended You Seek Medical Attention Immediately -------"
				respond " -------              OSACombat Will Stay Here Where It Is Safe Until You Can Get Help                -------"
				respond " -------                   To Stop Waiting And\\Or Continue With The Wounds Type YES                      -------"
				waitfor /A good positive attitude never hurts/
				self.save_script_data(:$osa_healing_status, "ignore")
			end
			return_to_injured_room
			wheres_the_captain
		end
		if $osa_data["$osa_healing_status"] == "popped"
			healing_stance
			if !$osa_data["$osa_safe_room"].nil?
				start_script("go2", [$osa_data["$osa_safe_room"]])
				wait_while { running?("go2") }
			end
			respond " -------      You Have Overexertion, It Is Recommended You Seek Medical Attention Immediately         -------"
			respond " -------              OSACombat Will Stay Here Where It Is Safe Until You Can Get Help                -------"
			respond " -------                   To Stop Waiting And\\Or Continue With The Overexertion Type YES                      -------"
			waitfor /A good positive attitude never hurts/
			self.save_script_data(:$osa_healing_status, "ignore")
			return_to_injured_room
			wheres_the_captain
		end
	end
end

def check_for_poison
	if (Effects::Debuffs.active? "Wall of Thorns Poison 1")||(Effects::Debuffs.active? "Wall of Thorns Poison 2")||(Effects::Debuffs.active? "Wall of Thorns Poison 3")||(Effects::Debuffs.active? "Wall of Thorns Poison 4")||(Effects::Debuffs.active? "Wall of Thorns Poison 5")||(checkpoison)
		if Spell[114].known? && Spell[114].affordable? && (!Effects::Debuffs.active? "Mystic Impedance") && (!Effects::Debuffs.active? "Silenced")
			Spell[114].cast
			Lich::Util.quiet_command("spell active", /You currently have the following active effects\:/, end_pattern = /No debuffs found\./, include_end = true ,timeout = 0.5, silent = true)
			return
		end
		if $osa_data["$osa_healing_status"] == "ignore"
			return
		else 
			self.save_script_data(:$osa_healing_status, "poisoned")
			go_to_healer
		end
	end
end

def check_for_disease
	if (diseased?)
		if Spell[113].known? && Spell[114].affordable? && (!Effects::Debuffs.active? "Mystic Impedance") && (!Effects::Debuffs.active? "Silenced")
			Spell[113].cast
			Lich::Util.quiet_command("spell active", /You currently have the following active effects\:/, end_pattern = /No debuffs found\./, include_end = true ,timeout = 0.5, silent = true)
			return
		end
		if $osa_data["$osa_healing_status"] == "ignore"
			return
		else 
			self.save_script_data(:$osa_healing_status, "diseased")
			go_to_healer
		end
	end
end

def check_for_injuries
	activate_gemstone_blood_wellspring if $osa_data["$osa_gemstone_blood_wellspring"]
	if (percenthealth < $osa_data["$osa_percent_health"].to_i) && $osa_data["$osa_symbol_of_restore"]
		fput "sym rest" until percenthealth > 90
		wait_rt
		pause 0.5
	end
	if XMLData.injuries.any?{|key,value| value["wound"] > $osa_data["$osa_wound_level"].to_i}
		if $osa_data["$osa_medicalofficer"].include? "#{checkname}"
			wait_while { running?("ecure") }
			wait_rt
			pause 0.5
			start_script "ecure"
			wait_while { running?("ecure") }
		else
			if $osa_data["$osa_healing_status"] == "ignore"
				return
			else
				self.save_script_data(:$osa_healing_status, "injured")
				go_to_healer
			end
		end
	end
end

def check_for_popped
	if Effects::Debuffs.active? "Overexerted"
		if Spell[1107].known? && Spell[1107].affordable? && (!Effects::Debuffs.active? "Mystic Impedance") && (!Effects::Debuffs.active? "Silenced")
			Spell[1107].cast
			Lich::Util.quiet_command("spell active", /You currently have the following active effects\:/, end_pattern = /No debuffs found\./, include_end = true ,timeout = 0.5, silent = true)
			return
		end
		if $osa_data["$osa_healing_status"] == "ignore"
			return
		else
			self.save_script_data(:$osa_healing_status, "popped")
			go_to_healer
		end
	end
end

def check_for_stunned
	if(!checkstunned && !checkdead && GameObj.pcs.find { |p| p.status =~ /stunned/ })
		stunned_players = GameObj.pcs
		if Spell[108].known? && $osa_data["$osa_use_unstun"] && (!Effects::Debuffs.active? "Mystic Impedance") && (!Effects::Debuffs.active? "Silenced")
			stunned_players.each do |p|
				wait_rt
				if p.status =~ /stun/i
					wait_until{ checkmana >= 8 }
					wait_castrt
					fput "prep 108"
					fput "cast " + p.noun
					pause 3
				end
			end
		end
	end
end

def check_dead
	if checkdead
		respond "
			You Have Died My Friend, Please Wait Until You Are Resurrected!
				"
		LNet.send_message(attr = { 'type' => 'channel', 'channel' => $osa_data["$osa_crew"] }, "Call The Bugleman, Crewman #{checkname} Has Died!")
		if Spell[9823].known?
			Spell[9823].cast
		end
		if running? "osacrew"
			stop_script "osacrew"
		end
		exit
	end
end

def target_bad_thing
	if (($potential_bad_thing.noun == "globe") or ($potential_bad_thing.noun == "cyclone") or ($potential_bad_thing.noun == "rift"))
		@list_of_bad_things.push ($potential_bad_thing.id)
		return
	else
		res = Lich::Util.quiet_command("target ##{$potential_bad_thing.id}", /You discern that you are the origin of (.*).|Usage:  TARGET {player|creature|hazard}|You are unable to discern the origin of a(.).|Suspecting that(.*)!/, end_pattern = /You discern that you are the origin of (.*).|You do not have a target.|You are currently targeting(.*).|You are unable to discern the origin of a (.).|You are now targeting(.*)./, include_end = false ,timeout = 3, silent = true)
		if res.to_s =~ /You are unable to discern the origin of a (.)./
			if !@list_of_good_things.include? $potential_bad_thing.id
				@list_of_good_things.push ($potential_bad_thing.id)
			end
		elsif res.to_s =~ /Suspecting that a (.*) is the origin of (.*), you turn your attention towards (.*)!/
			if !@list_of_bad_things.include? $potential_bad_thing.id
				@list_of_bad_things.push ($potential_bad_thing.id)
			end
		elsif res.to_s =~ /You discern that you are the origin of (.*)./
			if !@list_of_good_things.include? $potential_bad_thing.id
				@list_of_good_things.push ($potential_bad_thing.id)
			end
		end
	end
end

def check_for_badstuff
	if !$osa_data["$osa_myweapon"].nil?
		@list_of_bad_things.push ($osa_data["$osa_myweapon"])
		cast_at_bad_thing
		@list_of_bad_things.delete ($osa_data["$osa_myweapon"])
		self.save_script_data(:$osa_myweapon, nil)
	end
	@badstuff = GameObj.loot.find_all { |n| n.noun =~ /globe|rift/}
		@badstuff.each do |b|
			$potential_bad_thing = b
			if @list_of_good_things.include? $potential_bad_thing.id
				$potential_bad_thing = nil
				return
			else
				target_bad_thing
				if @list_of_bad_things.include? $potential_bad_thing.id
					cast_at_bad_thing
					@list_of_bad_things.delete ($potential_bad_thing.id)
				end
			end
			$potential_bad_thing = nil
		end
end

def check_daybringer
	check_weapon = Lich::Util.quiet_command("anal my #{GameObj.right_hand}", /You analyze the |(NIGHT|DAY)BRINGER/, end_pattern = /Target: As brilliant as the sun, radiant beams surge forth from [ATTACKER's] [ITEM] and burn you, leaving a stench of scorched matter in the air!!/, include_end = true ,timeout = 3, silent = true)
	if check_weapon.to_s =~ /NIGHTBRINGER/ 
		$daybringer = false
	elsif check_weapon.to_s =~ /DAYBRINGER/
		$daybringer = true
	end
end

def beseechme
	beseech = dothistimeout "beseech", 3, /You beseech (.*) for some divine assistance.|...wait/
	if beseech.to_s =~ /You beseech (.*) for some divine assistance./
		return
	elsif beseech.to_s =~ /...wait/
		beseechme
	end
end

def check_status
	$status = false
	$need_dispel = false
	$status = true if ((Effects::Debuffs.active? "Stunned") or (Effects::Debuffs.active? "Calm") or (Effects::Debuffs.active? "Frenzy") or (Effects::Debuffs.active? "Curse") or (Effects::Debuffs.active? "Webbed") or (Effects::Debuffs.active? "Bind") or (Effects::Debuffs.active? "Interference") or (Effects::Debuffs.active? "Moonbeam") or (Effects::Debuffs.active? "Stone Fist"))
	$need_dispel = true if ((Effects::Debuffs.active? "Earthen Fury")or (Effects::Debuffs.active? "Condemn"))
	if (($osa_data["$osa_symbol_of_transcendance"]) && (!Spell[9049].active? && !Spell[9812].active?) && (checkrt > 6) && (!standing? or stunned? or webbed?) && (GameObj.npcs.any? { |npc| npc.type !~ /passive/ and npc.status !~ /dead/ }))
		if Spell[9812].known? && Spell[9812].affordable?
			fput "symbol of transcendence"
			fput "symbol of transcendence confirm"
		end
	end
	if (($osa_data["$osa_di_armor"]) && (checkrt > 6) && (!standing? or stunned? or webbed?) && (GameObj.npcs.any? { |npc| npc.type !~ /passive/ and npc.status !~ /dead/ }))
		if Spell[1650].known?
			fput "incarn armor"
		end
	end
	if $status
		if Spell[1635].known? && Spell[1635].affordable?
			wait_castrt
			beseechme
			Lich::Util.quiet_command("spell active", /You currently have the following active effects\:/, end_pattern = /No debuffs found\./, include_end = true ,timeout = 0.5, silent = true)
			check_status
		end
	end
	if ($need_dispel && (!Effects::Debuffs.active? "Mystic Impedance"))
		wait_castrt
		if Spell[119].known? && Spell[119].affordable?
			multifput "prep 119", "channel #{checkname}"
		end
		if Spell[417].known? && Spell[417].affordable?
			multifput "prep 417", "channel #{checkname}"
		end
		Lich::Util.quiet_command("spell active", /You currently have the following active effects\:/, end_pattern = /No debuffs found\./, include_end = true ,timeout = 0.5, silent = true)
		check_status
	end
	stand_check
end

def health_monitor
	check_dead
	check_status
	check_for_injuries
	check_for_poison
	check_for_disease
	check_for_popped
	check_for_stunned
	check_for_badstuff
end

def determine_group_members
	res = Lich::Util.quiet_command("group", /You are leading (.*)|You are not currently in a group.|You are grouped with (.*)./, end_pattern = /GROUP HELP for a list of other options./, include_end = false ,timeout = 3, silent = true)
	if res.to_s.scan(/You are not currently in a group./)
		nil
	else
		grouped = res.to_s.scan(/[A-Z]\w*/).flatten.uniq
		hidden = res.to_s.scan(/[A-Z]\w* who is hidden/).flatten.uniq
		grouped.delete_if { |name| name =~  /Your|You/i }
		grouped.each{|member| $osa_everyone_in_my_group.push(member) if !$osa_everyone_in_my_group.include? (member) }
		hidden.each{|member| $osa_everyone_hidden.push(member.gsub(' who is hidden', '')) if !$osa_everyone_hidden.include? (member) }
		$osa_everyone_in_my_group = ($osa_everyone_in_my_group.uniq - $osa_everyone_hidden.uniq)
		$osa_everyone_hidden = $osa_everyone_hidden.uniq
	end
end


def check_for_poaching
	if $osa_pc_hiding_room != Room.current.id
		$osa_pc_hiding_room = nil
	end
	$pcs_present = (checkpcs - $osa_everyone_in_my_group)
	if $pcs_present.count > 0
		$poaching = true
	else
		$poaching = false
	end
	if $osa_everyone_hidden.count < 1 && (($osa_pc_hiding) && $osa_pc_hiding_room == Room.current.id)
		$poaching = true
	else
		if !$poaching
			$poaching = false
		end
	end
end

def energy_shield
	checkshield = Lich::Util.quiet_command("anal my pavis", /You analyze the/, end_pattern = /Target: As brilliant as the sun, radiant beams surge forth from [ATTACKER's] [ITEM] and burn you, leaving a stench of scorched matter in the air!/, include_end = true ,timeout = 3, silent = true)
	if checkshield.to_s =~ /\(Store Energy\)(\W+)Currently\:(\s+)(.*)(\s+)PUSH/
		if $3.delete('^a-zA-Z') == "ON"
			$drained_flares = true
		else
			$drained_flares = false
		end
	end
	if checkshield.to_s =~ /at the cost of energy\)(\W+)Currently\:(\s+)(.*)(\s+)PUNCH/
		if $3.delete('^a-zA-Z') == "ON"
			$surged_flares = true
		else 
			$surged_flares = false
		end
	end
	if checkshield.to_s =~ /Energy Stored\: ([0-9,]+)\/500/
		$energy_stored = $1
	end
	set_shield
end

def set_shield
	if ($energy_stored.to_i <= 20) && (($surged_flares && !$drained_flares) or (!$surged_flares && !$drained_flares))
		wait_rt
		pause 0.1
		if $surged_flares 
			fput "push my pavis"
			wait_rt
			pause 0.1
		end
		fput "pull my pavis"
		wait_rt
		pause 0.1
	end
	if ($energy_stored.to_i >= 500) && ((!$surged_flares && $drained_flares) or (!$surged_flares && !$drained_flares))
		wait_rt
		pause 0.1
		if $drained_flares
			fput "pull my pavis"
			wait_rt
			pause 0.1
		end
		fput "push my pavis"
		wait_rt
		pause 0.1
	end
end

def is_it_daytime
	$est_time = TZInfo::Timezone.get('America/New_York').now
	if $est_time.hour >= 6 && $est_time.hour < 18
	  $daytime = true
	else
	  $daytime = false
	end
end

def daybringer_light
	is_it_daytime
	check_light = Lich::Util.quiet_command("anal my #{GameObj.right_hand}", /You analyze the |(NIGHT|DAY)BRINGER/, end_pattern = /Target: As brilliant as the sun, radiant beams surge forth from [ATTACKER's] [ITEM] and burn you, leaving a stench of scorched matter in the air!/, include_end = true ,timeout = 3, silent = true)
	if check_light.to_s =~ /\(Charge with 111, 609, 205 \(Light, Cast\), 135\)(\W+)Status\:(\s+)(.*)(\s+)Cauterize/
		if $3.delete('^a-zA-Z') == "Ready"
			$ready_to_charge = true
		else
			$ready_to_charge = false
		end
	end
	if check_light.to_s =~ /Stored: ([0-9,]+)\/250/
		$stored_light = $1
	end
	if ($stored_light.to_i <= 210) && $ready_to_charge
		pause 0.5
		if !$daytime
			Spell[111].cast GameObj.right_hand
		elsif $daytime && Room.current.outside?
			fput "raise my spear"
			pause 3
		end
	end
end

def daybringer_darkness
	is_it_daytime
	check_darkness = Lich::Util.quiet_command("anal my #{GameObj.right_hand}", /You analyze the |(NIGHT|DAY)BRINGER/, end_pattern = /Target: As brilliant as the sun, radiant beams surge forth from [ATTACKER's] [ITEM] and burn you, leaving a stench of scorched matter in the air!/, include_end = true ,timeout = 3, silent = true)
	if check_darkness.to_s =~ /\(Charge with 712, 205 \(Darkness, Evoke\), 705, 907, 1709, 711\)(\W+)Status\:(\s+)(.*)(\s+)Cauterize/
		if $3.delete('^a-zA-Z') == "Ready"
			$ready_to_charge = true
		else
			$ready_to_charge = false
		end
	end
	if check_darkness.to_s =~ /Stored: ([0-9,]+)\/250/
		$stored_darkness = $1
	end
	if ($stored_darkness.to_i <= 210) && $ready_to_charge
		pause 0.5
		if !$daytime
			fput "raise my spear"
			pause 3
		elsif $daytime && Room.current.outside?
			fput "turn my spear"
			pause 2.0
			Spell[111].cast GameObj.right_hand
			fput "turn my spear"
		end
	end
end

def checkfordead
	@deadnpcs = GameObj.npcs.find_all { |i| i.status =~ /dead|gone/ }
    @deadnpcs.delete_if { |npc| (npc.name =~ /animated/ && npc.name !~ /animated slush/) }
    @deadnpcs.delete_if { |npc| npc.noun =~ /child|traveller|scribe|merchant|dignitary|official|magistrate/i && npc.name !~ /ethereal|celestial|unworldly/i }
    @deadnpcs.delete_if { |npc| npc.noun =~ /^(?:arm|appendage|claw|limb|pincer|tentacle)s?$|^(?:palpus|palpi)$/i }
end	

# ===== helpers =====
# One helper to BUILD them all!
def self.ui(parent, type, **o)
	@OSA_COM_ENTRY ||= {}
	$osa_data ||= {}
	@_ui_sizegroups ||= Hash.new { |h, k| h[k] = {} }  # { group_sym => { col_int => Gtk::SizeGroup } }
	get_key = ->(v) { v.nil? ? nil : v.to_s }
	get_val = ->(key) { key && $osa_data.key?(key) ? $osa_data[key] : nil }
	set_widget_width = lambda do |widget, width|
		return widget unless widget && width
		widget.set_size_request(width, -1)
		widget
	end
	case type
	when :row
		row = Gtk::Box.new(:horizontal, o.fetch(:spacing, 12))
		row.set_halign(o[:halign]) if o[:halign]
		row.set_hexpand(o.fetch(:hexpand, true))
		parent.pack_start(row, false, false, o.fetch(:pad, 0)) if parent
		return row
	when :vrow
		col = Gtk::Box.new(:vertical, o.fetch(:spacing, 8))
		col.set_border_width(o[:border] || 0)
		parent.pack_start(col, false, false, o.fetch(:pad, 0)) if parent
		return col
	when :header
		outer = Gtk::Box.new(:vertical, o.fetch(:spacing, 4))
		label = Gtk::Label.new
		label.set_xalign(0.0)
		label.use_markup = true
		text = o.fetch(:text).to_s
		safe =
			if GLib.respond_to?(:markup_escape_text)
				GLib.markup_escape_text(text)
			else
				text.gsub("&", "&amp;").gsub("<", "&lt;").gsub(">", "&gt;")
			end
		label.label = "<b>#{safe}</b>"
		sep = Gtk::Separator.new(:horizontal)
		outer.pack_start(label, false, false, 0)
		outer.pack_start(sep, false, false, 0)
		parent.pack_start(outer, false, false, o.fetch(:pad, 6)) if parent
		return outer
	when :blank
		spacer = Gtk::Box.new(:vertical, 0)
		spacer.set_size_request(-1, o.fetch(:height, 8))
		parent.pack_start(spacer, false, false, 0) if parent
		return spacer
	when :sep
		s = Gtk::Box.new(:horizontal, 0)
		s.set_size_request(o.fetch(:width, 10), -1)
		parent.pack_start(s, false, false, 0) if parent
		return s
	when :label
		lab = Gtk::Label.new(o.fetch(:text, ""))
		lab.set_xalign(o.fetch(:xalign, 0.0))
		lab.set_tooltip_text(o[:tip]) if o[:tip] && !o[:tip].to_s.empty?
		set_widget_width.call(lab, o[:width])
		parent.pack_start(lab, false, false, o.fetch(:pad, 0)) if parent
		return lab
	when :entry
		key = get_key.call(o[:var])
		box = Gtk::Box.new(:horizontal, o.fetch(:spacing, 6))
		lab = Gtk::Label.new(o.fetch(:label))
		lab.set_xalign(0.0)
		lab.set_tooltip_text(o[:tip]) if o[:tip] && !o[:tip].to_s.empty?
		set_widget_width.call(lab, o[:label_width]) if o[:label_width]
		ent = Gtk::Entry.new
		if o[:width_chars]
			ent.width_chars = o[:width_chars]
			ent.max_width_chars = o[:max_width_chars] || o[:width_chars]
		else
			set_widget_width.call(ent, o[:entry_width] || o[:width])
		end
		ent.hexpand = false
		ent.halign = :start
		raw = get_val.call(key)
		ent.text = (raw.nil? || raw.to_s.empty?) ? o.fetch(:default, "").to_s : raw.to_s
		@OSA_COM_ENTRY[key] = ent if key
		box.pack_start(lab, false, false, 0)
		box.pack_start(ent, false, false, 0)
		set_widget_width.call(box, o[:box_width] || o[:width]) if (o[:box_width] || o[:width])
		parent.pack_start(box, false, false, o.fetch(:pad, 0)) if parent
		return box
	when :check
		key = get_key.call(o[:var])
		cb = Gtk::CheckButton.new(o.fetch(:label))
		cb.tooltip_text = o[:tip] if o[:tip] && !o[:tip].to_s.empty?
		raw = get_val.call(key)
		cb.active = raw.nil? ? !!o.fetch(:default, false) : !!raw
		@OSA_COM_ENTRY[key] = cb if key
		cb.set_halign(:start)
		cb.set_hexpand(false)
		widget = cb
		if o[:cell_width]
			wrapper = Gtk::Box.new(:horizontal, 0)
			wrapper.set_size_request(o[:cell_width], -1)
			wrapper.set_halign(:start)
			wrapper.pack_start(cb, false, false, 0)
			widget = wrapper
		end
		if o[:group] && o[:col]
			g = o[:group].to_sym
			c = o[:col].to_i
			@_ui_sizegroups[g][c] ||= Gtk::SizeGroup.new(:horizontal)
			@_ui_sizegroups[g][c].add_widget(widget)
		end
		parent.pack_start(widget, false, false, o.fetch(:pad, 0)) if parent
		return widget
	when :check_box
		key = get_key.call(o[:var])
		cb = Gtk::CheckButton.new
		cb.tooltip_text = o[:tip] if o[:tip] && !o[:tip].to_s.empty?
		raw = get_val.call(key)
		cb.active = raw.nil? ? !!o.fetch(:default, false) : !!raw
		@OSA_COM_ENTRY[key] = cb if key
		cb.set_halign(:start)
		cb.set_hexpand(false)
		parent.pack_start(cb, false, false, o.fetch(:pad, 0)) if parent
		return cb
	when :spell
		r = ui(parent, :row, spacing: o.fetch(:spacing, 10))
		ui(r, :entry,
			label: o[:spell_label],
			tip: o[:spell_tip],
			var: o[:spell_var],
			width_chars: 4,
			entry_width: o.fetch(:spell_width, 50))
		ui(r, :entry,
			label: "Min Stam:",
			var: o[:stam_min_var],
			width_chars: 4,
			default: "0",
			entry_width: o.fetch(:stam_width, 50))
		ui(r, :entry,
			label: "Min Mana:",
			var: o[:mana_min_var],
			width_chars: 4,
			default: "0",
			entry_width: o.fetch(:mana_width, 50))
		ui(r, :entry,
			label: "Min Enemy:",
			var: o[:enemy_min_var],
			width_chars: 4,
			default: "1",
			entry_width: o.fetch(:enemy_min_width, 50))
		ui(r, :entry,
			label: "Max Enemy:",
			var: o[:enemy_max_var],
			width_chars: 4,
			default: "10",
			entry_width: o.fetch(:enemy_max_width, 50))
		ui(r, :check, label: "Warding", var: o[:ward_var])
		ui(r, :check, label: "Channel", var: o[:chan_var])
		ui(r, :check, label: "Evoke", var: o[:evoke_var])
		ui(r, :check, label: "Open", var: o[:open_var])
	when :attack
		r = ui(parent, :row, spacing: o.fetch(:spacing, 10))
		ui(r, :dropdown,
			label: o.fetch(:attack_label, "Attack:"),
			tip: o.fetch(:attack_tip, ""),
			var: o.fetch(:attack_var),
			options: o.fetch(:options),
			default_index: o.fetch(:default_index, 0),
			combo_width: o.fetch(:attack_width, 520))
		ui(r, :entry,
			label: o.fetch(:stam_label, "Min Stam:"),
			tip: o.fetch(:stam_tip, ""),
			var: o.fetch(:stam_min_var),
			default: o.fetch(:stam_default, "0"),
			width_chars: o.fetch(:stam_chars, 4),
			entry_width: o.fetch(:stam_width, 50))
		ui(r, :entry,
			label: o.fetch(:mana_label, "Min Mana:"),
			tip: o.fetch(:mana_tip, ""),
			var: o.fetch(:mana_min_var),
			default: o.fetch(:mana_default, "0"),
			width_chars: o.fetch(:mana_chars, 4),
			entry_width: o.fetch(:mana_width, 50))
		ui(r, :entry,
			label: o.fetch(:enemy_min_label, "Min Enemy:"),
			tip: o.fetch(:enemy_min_tip, ""),
			var: o.fetch(:enemy_min_var),
			default: o.fetch(:enemy_min_default, "1"),
			width_chars: o.fetch(:enemy_min_chars, 4),
			entry_width: o.fetch(:enemy_min_width, 50))
		ui(r, :entry,
			label: o.fetch(:enemy_max_label, "Max Enemy:"),
			tip: o.fetch(:enemy_max_tip, ""),
			var: o.fetch(:enemy_max_var),
			default: o.fetch(:enemy_max_default, "10"),
			width_chars: o.fetch(:enemy_max_chars, 4),
			entry_width: o.fetch(:enemy_max_width, 50))
			return r
	when :ability
		r = ui(parent, :row, spacing: o.fetch(:spacing, 10))
		label_w = o.fetch(:label_width, 175) # adjust once to taste
		ui(r, :label, text: o.fetch(:label), tip: o[:tip].to_s, width: label_w, xalign: 0.0)
		ui(r, :check_box,
			var: o.fetch(:var),
			tip: o[:tip].to_s,
			default: o.fetch(:default, false))
		ui(r, :sep, width: o.fetch(:sep_width, 12))
			fields = o.fetch(:fields, [])
			fields.each do |f|
				ui(r, :entry,
				label: f.fetch(:label),
				tip:   f[:tip].to_s,
				var:   f.fetch(:var),
				default: f.fetch(:default, ""),
				width_chars: f[:chars] || o[:chars] || 4,
				max_width_chars: f[:max_chars] || f[:chars] || o[:chars] || 4,
				entry_width: f[:entry_width] || o[:entry_width] || 90,
				label_width: f[:label_width] || o[:label_width])
			end
		return r
  when :dropdown
		key = get_key.call(o[:var])
		opts =
			case o[:options]
			when String then o[:options].split(/\s*,\s*/)
			when Array  then o[:options]
		else
			raise ArgumentError, "dropdown options must be String or Array"
		end
		box = Gtk::Box.new(:horizontal, o.fetch(:spacing, 6))
		lab = Gtk::Label.new(o.fetch(:label))
		lab.set_xalign(0.0)
		lab.set_tooltip_text(o[:tip]) if o[:tip] && !o[:tip].to_s.empty?
		set_widget_width.call(lab, o[:label_width]) if o[:label_width]
		combo = Gtk::ComboBoxText.new
		opts.each { |x| combo.append_text(x.to_s) }
			raw = get_val.call(key)
			idx = if raw.nil? || raw.to_s.strip.empty?
            o.fetch(:default_index, 0).to_i
		else
            raw.to_i
		end
		idx = 0 if idx < 0
		idx = opts.length - 1 if idx >= opts.length
		combo.set_active(idx)
		set_widget_width.call(combo, o[:combo_width] || o[:width])
		@OSA_COM_ENTRY[key] = combo if key
		if o[:group] && o[:col]
			g = o[:group].to_s
			c = o[:col].to_i
			@_ui_sizegroups[g][c] ||= Gtk::SizeGroup.new(:horizontal)
			@_ui_sizegroups[g][c].add_widget(combo)
		end
		box.pack_start(lab, false, false, 0)
		box.pack_start(combo, false, false, 0)
		parent.pack_start(box, false, false, o.fetch(:pad, 0)) if parent
			return box
		else
			raise ArgumentError, "unknown ui type: #{type.inspect}"
		end
end

def self.save_settings!
	$osa_data ||= {}
	@OSA_COM_ENTRY.each do |var, widget|
		value =
		case widget
			when Gtk::CheckButton then widget.active?
			when Gtk::Entry       then widget.text
			when Gtk::ComboBoxText then widget.active
		else 
			next
		end
		$osa_data[var.to_s] = value
	end
	path = @osa_yaml_file || Settings[Char.name]["osa_vars_yaml_file"]
	File.open(path, File::RDWR | File::CREAT) do |file|
		file.flock(File::LOCK_EX)
		file.rewind
		YAML.dump($osa_data, file)
		file.flush
		file.truncate(file.pos)
	end
	toast("Settings saved")
end

# ===== population =====

def self.populate_general(rows)
	ui(rows, :header, text: "Combat Settings")
	row = ui(rows, :row)
	ui(row, :entry, label: "Mana Leech Threshold:", tip: 'Will use "Mana Leech" when your mana percentage drops below this number. Default setting is 50.', var: '$osa_percentleech', default: "50", width_chars: 4, label_width: 180)
	row = ui(rows, :row)
	ui(row, :entry, label: "Wound Threshold:", tip: 'When you recieve any wounds above the level indicated, you will seek healing from your "Medical Officer" (if present) or default to your herbkit via "Eherbs" script. 0 will seek healing from ALL wounds. 3 will not seek healing from any wounds. Default setting is 0', var: '$osa_wound_level', width_chars: 4, default: "0", label_width: 180)
	row = ui(rows, :row)
	ui(row, :entry, label: "Symbol of Restore Threshold:", tip: 'Will use "Symbol of Restore" when your health percentage drops below this number. Default setting is 65.', var: '$osa_percent_health', width_chars: 4, default: "65", label_width: 180)
	row = ui(rows, :row)
	ui(row, :entry, label: "Safe Room:", tip: "Will run to this room before the seeking healing process. Defaults to your current room.", var: '$osa_safe_room', width_chars: 8, default: "", label_width: 180)
	row = ui(rows, :row)
	ui(row, :entry, label: "UAC Hand Wraps:", tip: "The noun of your UAC hand wraps. Used in Blessing routines.", var: '$osa_uachands', width_chars: 8, default: "", label_width: 180)
	row = ui(rows, :row)
	ui(row, :entry, label: "UAC Foot Wraps:", tip: "The noun of your UAC foot wraps. Used in Blessing routines.", var: '$osa_uacfeet', width_chars: 8, default: "", label_width: 180)
	row = ui(rows, :row)
	ui(row, :entry, label: "Flare Gloves:", tip: 'The noun of your "Right to Flare Arms" gloves. Used for "Pound" action.', var: '$osa_flareglovesnoun', width_chars: 8, default: "", label_width: 180)
	row = ui(rows, :row)
	ui(row, :entry, label: "Energy Wing Pin:", tip: 'The noun of your "Pinions and Pulse" pin.', var: '$osa_energy_wings_noun', width_chars: 8, default: "", label_width: 180)
	row = ui(rows, :row)
	ui(row, :entry, label: "Paladin Infuse Spell:", tip: "Enter the spell number for what spell infused in your weapon.", var: '$osa_infusespell', width_chars: 8, default: "", label_width: 180)
	if Char.name == "Peggyanne"
		row = ui(rows, :row)
		ui(row, :entry, label: "Percent Chance For Personalized Attack Messaging:", tip: "", var: '$osa_cheeseball', default: "", width_chars: 4, label_width: 180)
	end
	row = ui(rows, :row)
	ui(row, :entry, label: "Creature Exclusion List:", tip: "Enter creature nouns separated by a comma and space. EX: kobold, hobgoblin, goblin", var: '$osa_exclusion', width_chars: 100, default: "", label_width: 180)
	row = ui(rows, :row)
	ui(row, :dropdown, label: "Stealth Disabler:", tip: "If a hidden pirate is detected in your room you will use the following method to attempt to remove them from hiding. Also works for Kiramon Stalkers in The Hive. Requires OSACrew for monitoring.", var: '$osa_stealth_disabler', options: "Search (Default), Dispel Invisibility, Searing Light, Light, Censure, Divine Wrath, Elemental Wave, Major Elemental Wave, Cone of Elements, Sunburst, Nature's Fury, Grasp of the Grave, Implosion, Tremors, Call Wind, Aura of the Arkati, Judgement, Eviscerate, Carn's Cry, Symbol of Sleep", label_width: 180, combo_width: 220, default_index: 0)
	ui(rows, :blank, height: 8)
	add_checks = lambda do |defs, cols: 4, group: :general_checks, spacing: 18|
		defs.each_slice(cols).with_index do |slice, _row_i|
			r = ui(rows, :row, spacing: spacing)
			slice.each_with_index do |d, col|
				ui(r, :check,
				label: d[:label],
				tip: d[:tip].to_s,
				var: d[:var],
				default: d.fetch(:default, false),
				group: group,
				col: col)
			end
		end
	end
	add_checks.call([
    { label: "Scripted Combat", tip: "Click to enable OSACrew to start OSACombat Automatically when an enemy ship is detected.", var: '$osa_osacombat'},
    { label: "Enable Mana Leech", tip: 'Click to enable automatic use of "Mana Leech" spell. Requires minimum mana stetting above.', var: '$osa_use_mana_leech' },
    { label: "Use Stomp", tip: 'Click to use "Stomp" when using 909 as a spell opener.', var: '$osa_stomp' },
    { label: "Use Pound", tip: 'Click to use "Pound" when using 909 as a spell opener.', var: '$osa_pound' }], cols: 4)
	add_checks.call([
    { label: "Use Tap", tip: 'Click to use "Tap" when using 909 as a spell opener.', var: '$osa_tap'},
    { label: "Enable Attack Command", tip: 'Click to use "Attack", "Fire" or "Jab" when you have exhausted your other combat commands.', var: '$osa_noattack' },
    { label: "Enable Stance Dancing", tip: "Click to enable switching your stance in between attacks. This is defined in the Living and Undead tab.", var: '$osa_stance_dance' },
    { label: "Enable Fire Command", tip: 'Click to use "Fire" when you have exhausted your other combat commands.', var: '$osa_osaarcher' }], cols: 4)
	add_checks.call([
    { label: "Enable Kneeling", tip: 'Click to use "Kneel" before using archery based attacks.', var: '$osa_use_kneel'},
    { label: "Enable Mstrike", tip: 'Click to enable use of "Mstrike" command in your combat routine.', var: '$osa_use_mstrike' },
    { label: "Enable Stalking and Hiding (Ambush)", tip: 'Click to enable use of "Hide" before attacks able to be used from hiding.', var: '$osa_use_stealth' },
    { label: "Enable Stalking and Hiding (Waylay)", tip: 'Click to enable use of "Hide" and "Waylay" in place of "Attack" command in your combat routine', var: '$osa_use_waylay' }], cols: 4)
	add_checks.call([
    { label: "Enable UAC W/ Weapon(s)", tip: 'Click to enable the use of any handheld UAC weapons. This will use "Gird" and "Sheath" commands.', var: '$osa_uacweapons' },
    { label: "Enable UAC W/O Weapon(s)", tip: 'Click to disable use of "Gird" and "Sheath" commands and use barehanded UAC attacks.', var: '$osa_nouacweapons' },
    { label: "Enable Brief Combat", tip: 'Click to enable use of "Flag Combatbrief" and "Flag Combatnonumbers"', var: '$osa_usebriefcombat' },
    { label: "Enable Reactive Attacks", tip: 'Click to enable automatic use of reactive attacks. This requires OSACrew to handle monitoring.', var: '$osa_use_reactive' }], cols: 4)
	add_checks.call([
    { label: "Enable Anti-Poaching", tip: 'Click to enable automatic group status monitoring to aviod attacking when non-group PCs are present. This requires OSACrew to handle monitoring.', var: '$osa_check_for_group'},
    { label: "Enable Unstun", tip: 'Click to enable automatic use of the "Unstun" spell on PCs who are present and stunned. ', var: '$osa_use_unstun' },
    { label: "Enable Looting", tip: 'Click to enable automatic use of looting. Requires "Eloot" script.', var: '$osa_osalooter' },
    { label: "Disable Looting When Gemstone Is Found.", tip: 'Click to enable automatic disabling of Looting when you have found your weekly gemstone or when you have found all three for the month. Requires "Killtracker" script.', var: '$osa_usekilltracker' }], cols: 4)
	add_checks.call([
    { label: "Enable Skinning Only", tip: 'Click to disable looting. This will only send the command, "Eloot Skin".', var: '$osa_skin_only'},
    { label: "Bless Caster", tip: 'Click to enable casting "Bless" spell or "Symbol of Bless" on others when the commandeder calls for blessing the crew.', var: '$osa_givebless' },
    { label: "Need Bless", tip: 'Click to indicate need for a blessing when the commander calls for one', var: '$osa_needbless'}], cols: 4)
end


def self.populate_support(rows)
	ui(rows, :header, text: "Buffs:")
	ui(rows, :blank, height: 6)
	add_checks = lambda do |defs, cols: 4, group: :general_checks, spacing: 18|
		defs.each_slice(cols).with_index do |slice, _row_i|
			r = ui(rows, :row, spacing: spacing)
			slice.each_with_index do |d, col|
				ui(r, :check,
				label: d[:label],
				tip: d[:tip].to_s,
				var: d[:var],
				default: d.fetch(:default, false),
				group: group,
				col: col)
			end
		end
	end
	add_checks.call([
    { label: "Seanette's Shout", tip: 'Seanette\'s Shout is a supporting war cry that invigorates the warrior and their party and encourages them to strengthen their efforts for 25 stamina. The warrior and all party members are Empowered for a bonus of 20 to all AS attacks.', var: '$osa_warcry_shout' },
    { label: "Horland's Holler", tip: 'Horland\'s Holler is a room taunt that lasts for a duration based on Influence bonus. Any attacks made in the room have a chance to be redirected back to the warrior. Success of a redirect is based on Multi Opponent Combat training and the Influence bonus of the warrior. In addition, Holler provides the Warrior and Warrior\s party with a short term Boost Health (20). The success of the taunt is based on the Standard success resolution system, and attackers gain a bonus for every attempt made.', var: '$osa_warcry_holler' },
    { label: "Surge of Strength (Use Cooldown)", tip: 'Surge of Strength is a commonly used Combat Maneuver due to the strength increase that it provides, increasing a character\'s attack strength and increasing carrying capacity, effectively reducing encumbrance and, therefore, possibly roundtime when attacking. Each bonus point will increase unencumbered carrying capacity 1% of the character\'s body weight with a maximum bonus of 16% at Rank 5. E.g., a character that weighs 200 lbs. with Rank 5 will have an increased carrying capacity of 32 lbs. (200 * .16). Because its effects are treated as an enhancive, it is subject to normal enhancive limits; thus additional ranks of Surge of Strength may net no further bonuses depending on a character\'s existing Strength enhancives (including spells such as Holy Weapon (1625)).', var: '$osa_cman_surge_of_strength_cooldown'}], cols: 3)
	add_checks.call([
    { label: "Surge of Strength (Ignore Cooldown)", tip: 'Surge of Strength is a commonly used Combat Maneuver due to the strength increase that it provides, increasing a character\'s attack strength and increasing carrying capacity, effectively reducing encumbrance and, therefore, possibly roundtime when attacking. Each bonus point will increase unencumbered carrying capacity 1% of the character\'s body weight with a maximum bonus of 16% at Rank 5. E.g., a character that weighs 200 lbs. with Rank 5 will have an increased carrying capacity of 32 lbs. (200 * .16). Because its effects are treated as an enhancive, it is subject to normal enhancive limits; thus additional ranks of Surge of Strength may net no further bonuses depending on a character\'s existing Strength enhancives (including spells such as Holy Weapon (1625)).', var: '$osa_cman_surge_of_strength_no_cooldown' },
    { label: "Wall of Force (140)", tip: 'Wall of Force creates a temporary wall of force that strongly resists attacks. The wall will follow the subject and position itself to fend off attacks while letting outgoing attacks pass without penalty. This spell bestows a +100 to the target\'s Defensive Strength (DS). Wall of Force has a 270 second cooldown per target, beginning when the spell is cast. It is exempt from spell-removing mechanics.', var: '$osa_wallofforce' },
    { label: "Group Bravery (211)", tip: 'Bravery provides a base bonus of +15 to both physical attack strength, and bolt attack strength. The caster also gains 3 phantom levels against sheer fear attacks. Note: This requires 25 ranks of Spiritual Lore, Blessings.', var: '$osa_groupbravery'}], cols: 3)
	add_checks.call([
    { label: "Group Heroism (215)", tip: 'Heroism provides a base bonus of +25 to both physical attack strength, and bolt attack strength and +1 regeneration to both mana (MP) and health point (HP) every minute. The caster also gains 3 phantom levels against sheer fear attacks and an increase to the user\'s defense against a standard maneuver roll if the maneuver is able to be evaded. Note: This requires 35 ranks of Spiritual Lore, Blessings.', var: '$osa_spell_heroism' },
    { label: "Sanctify Right Hand (330)", tip: 'This will apply Holy Fire flares and non-corporeal undead anchoring to the item in your right hand. This enhancement, does not apply any of the other 330 benefits, and lasts for 4 hours. At 90 and 180 ranks of Spiritual Lore, Religion clerics gain an extra charge of a Holy Fire flare that is guaranteed to trigger on their next attack.', var: '$osa_sanctrighthand' },
    { label: "Sanctify Left Hand (330)", tip: 'This will apply Holy Fire flares and non-corporeal undead anchoring to the item in your left hand. This enhancement, does not apply any of the other 330 benefits, and lasts for 4 hours. At 90 and 180 ranks of Spiritual Lore, Religion clerics gain an extra charge of a Holy Fire flare that is guaranteed to trigger on their next attack.', var: '$osa_sanctlefthand'}], cols: 3)
	add_checks.call([
    { label: "Mana Focus (Currently Broken, Do Not Use)", tip: '', var: '$osa_cast_spell_mana_focus' },
    { label: "Celerity (506)", tip: 'Celerity reduces the stamina cost, possibly to zero, for all Quickstrike actions that reduce combat roundtimes (see QUICKSTRIKE for a full listing). It has a non-stackable 60 second duration. If not natively self-cast, there is a four minute period starting at the time of first application during which Celerity may not be re-applied to the same target. There is no such delay when the spell is natively self-cast. All offensive combat actions automatically apply the lowest RT possible whether or not the Quickstrike ability is explicitly invoked. Users of Celerity need not use Quickstrike to gain the maximum zero-stamina RT reduction, or may use Quickstrike to gain additional RT reduction at a lesser stamina cost than would otherwise be the case.', var: '$osa_cast_spell_self_celerity' },
    { label: "Group Celerity (506)", tip: 'Celerity reduces the stamina cost, possibly to zero, for all Quickstrike actions that reduce combat roundtimes (see QUICKSTRIKE for a full listing). It has a non-stackable 60 second duration. If not natively self-cast, there is a four minute period starting at the time of first application during which Celerity may not be re-applied to the same target. There is no such delay when the spell is natively self-cast. All offensive combat actions automatically apply the lowest RT possible whether or not the Quickstrike ability is explicitly invoked. Users of Celerity need not use Quickstrike to gain the maximum zero-stamina RT reduction, or may use Quickstrike to gain additional RT reduction at a lesser stamina cost than would otherwise be the case. Note: This requires 50 ranks of Elemental Lore, Air.', var: '$osa_cast_spell_group_celerity'}], cols: 3)
	add_checks.call([
    { label: "Rapid Fire (515)", tip: 'While Rapid Fire is active, it will reduce the cast roundtime of all subsequent spells to 1 second. Once the effect ends, there is a short recovery period (i.e. cooldown) of 90 seconds before the spell can be used again without an extra penalty. If the spell is recast during the recovery period, all subsequent spells cast cost an additional 5 mana. Training in Elemental Mana Control will reduce the recovery period.', var: '$osa_rapidfire' },
    { label: "Barkskin (605)", tip: 'Barkskin allows the Ranger to surround themselves with a thick layer of bark, which will absorb the next instance of a physical attack, SMRv2 maneuver, bolt spell, or warding spell that would have otherwise successfully struck them. On attacks that would have only moderately been successful, the bark has a 50 + (Spiritual Lore, Blessings ranks / 2) % chance of enduring. Moderate success is defined as a successful endroll threshold of no more than 20 + (Survival skill / 10). Barkskin has a five minute character-specific cooldown after successfully absorbing an effect during which that character may not gain Barkskin again.', var: '$osa_barkskin_spell' },
    { label: "Group Barkskin (605)", tip: 'Barkskin allows the Ranger to surround themselves with a thick layer of bark, which will absorb the next instance of a physical attack, SMRv2 maneuver, bolt spell, or warding spell that would have otherwise successfully struck them. On attacks that would have only moderately been successful, the bark has a 50 + (Spiritual Lore, Blessings ranks / 2) % chance of enduring. Moderate success is defined as a successful endroll threshold of no more than 20 + (Survival skill / 10). Barkskin has a five minute character-specific cooldown after successfully absorbing an effect during which that character may not gain Barkskin again. Note: This requires 50 ranks of Spiritual Lore, Blessings.', var: '$osa_barkskin_spell_group'}], cols: 3)
	add_checks.call([
    { label: "Song of Tonis (1035)", tip: 'While singing this song, a Bard magically imparts all members of his or her party with additional speed, making all of their actions a bit quicker, and giving them an increased chance to dodge incoming attacks. Specifically, Song of Tonis increases the defensive equivalent of the group\'s Dodging skill by +20 ranks as well as adding a -1 second haste effect.', var: '$osa_song_song_of_tonis' },
    { label: "Mind Over Body (1213)", tip: 'Mind over Body is a group focus spell which decreases stamina activation costs for the caster and group members. The base reduction is 20% and can be further increased with training in Mental Lore, Telepathy. The reduced cost from this spell applies to anything involving stamina usage: GoS sigils, combat maneuvers, warrior and rogue guild skills, etc. The spell will terminate when the caster dies or is sufficiently stunned. Group members who leave the group and the immediate room of the caster will lose the spell effect within approximately 60 seconds. A caster can maintain only one focus spell at a time.', var: '$osa_mob' },
    { label: "Focus Barrier (1216)", tip: 'Focus Barrier is a group focus spell that provides the caster and member\'s of his group a +30 Defensive Strength (DS) bonus. The spell will terminate when the caster dies or is sufficiently stunned. Group members who leave the group and the immediate room of the caster will lose the spell effect within approximately 60 seconds. A caster can maintain only one focus spell at a time', var: '$osa_focus'}], cols: 3)
	add_checks.call([
    { label: "Beacon of Courage (1608)", tip: 'The Beacon of Courage effect will redirect attacks made on the paladin\'s party members to the paladin. Any creature attacking a party member while this effect is active will be subject to hidden warding rolls and failing will redirect attacks for as long as the Beacon of Courage effect lasts. The effect also allows the Paladin to ignore Force on Force mechanics for at least one additional target, the number of targets increasing based on Spiritual Lore, Blessings.', var: '$osa_spell_beacon_of_courage' },
    { label: "Faith Shield (1619)", tip: 'Provides a base benefit of +50 to Spiritual Target Defense (TD) for 30 seconds. The duration is extended +1 second for every two Paladin Base spell ranks known above rank 19. The maximum duration is 70 seconds at 99 Paladin Base spell ranks. Faith Shield has a 210 second cooldown.', var: '$osa_spell_shield_faith' },
    { label: "Divine Incarnation: Armor (1650) Emergency Use", tip: 'This causes a holy armor to surround the paladin. This grants a 50% resistance to all forms of attack for 30 seconds.Training in Spiritual Lore, Blessings increases the resistance effect of Armor. Divine Incarnation does not need to be active in order to invoke an "emergency" usage of Armor.', var: '$osa_di_armor'}], cols: 3)
	add_checks.call([
    { label: "Divine Incarnation: Zeal (1650)", tip: 'Zeal will cause a divine aura to surround the paladin and trigger deity specific flares upon the next 5 successful attacks made during the next 60 seconds. If time allows, additional flares may be triggered at a cost of 1 divine energy each. Training in Spiritual Lore, Summoning increases the duration of Zeal.', var: '$osa_cast_spell_di_zeal' },
    { label: "Steely Resolve", tip: 'For 60 seconds, you gain +15 Block DS per rank and a +15% chance per rank to block incoming attacks. There a 5 minute recovery period after using this ability, where it cannot be re-invoked.', var: '$osa_shield_steely'}], cols: 2)
	ui(rows, :blank, height: 10)
	ui(rows, :header, text: "Society:")
	ui(rows, :blank, height: 6)
	head = ui(rows, :row, spacing: 40)
	ui(head, :label, text: "Council of Light", xalign: 0.0, width: 220)
	ui(head, :label, text: "Guardians of Sunfist", xalign: 0.0, width: 155)
	ui(head, :label, text: "Order of Voln", xalign: 0.0, width: 220)
	ui(rows, :blank, height: 6)
	add_checks.call([
    { label: "Sign of Warding", tip: "+5 to DS. (Cost: 1 mana)", var: '$osa_sign_of_warding' },
    { label: "Sigil of Minor Bane", tip: "Adds +5 AS. Also grants heavy damage weighting to melee, ranged and bolt attacks against hated foes. (Cost: 3 mana, 3 stamina)", var: '$osa_sigil_of_minor_bane' },
    { label: "Symbol of Courage", tip: "Increases member's Attack Strength +1 per rank (Max bonus +26). Duration of 10 seconds per rank (stackable). Fear based attack protection.", var: '$osa_symbol_of_courage'}], cols: 3)
	add_checks.call([
    { label: "Sign of Defending", tip: "+10 to DS. (Cost: 2 mana)", var: '$osa_sign_of_defending' },
    { label: "Sigil of Offense", tip: "Provides a bonus to AS equal to current rank. (Cost: 5 mana, 5 stamina)", var: '$osa_sigil_of_offense' },
    { label: "Symbol of Protection", tip: "Increases member's Defensive Strength +1 per rank (Max bonus +26). Duration of 20 seconds per rank. Protection also adds a TD boost of 1/2 total ranks. (Max bonus +13) (stackable).", var: '$osa_symbol_of_protection'}], cols: 3)
	add_checks.call([
    { label: "Sign of Deflection (Not Implemented Yet)", tip: "Adds +20 to Bolt DS. (Cost: 3 mana)", var: '$osa_sign_of_deflection' },
    { label: "Sigil of Major Bane", tip: "Adds +10 AS. Also grants heavy crit weighting to melee, ranged and bolt attacks against hated foes. (Cost: 10 mana, 10 stamina)", var: '$osa_sigil_of_major_bane' },
    { label: "Symbol of Disruption", tip: "Casts an aura around user and group members. Any noncorporeal undead struck will sustain penalties to AS/DS,CS/TD,UDF, CMAN. Duration: 10 seconds per rank - (stackable).", var: '$osa_symbol_of_disruption'}], cols: 3)
	add_checks.call([
    { label: "Sign of Shields", tip: "Adds +20 to DS. (Cost: 1 spirit)", var: '$osa_sign_of_shields' },
    { label: "Sigil of Minor Protection", tip: "Provides +5 DS. Also grants heavy damage padding against attacks from hated foes. (Cost: 5 mana, 10 stamina)", var: '$osa_sigil_of_minor_protection' },
    { label: "Symbol of Mana", tip: "Restores 50 mana. Initially, no deed cost. 5 minute cooldown period.", var: '$osa_symbol_of_mana'}], cols: 3)
	add_checks.call([
    { label: "Sign of Striking", tip: "+5 to AS. (Cost: 1 mana)", var: '$osa_sign_of_striking' },
    { label: "Sigil of Defense", tip: "Provides a bonus to DS equal to current rank. (Cost: 5 mana, 5 stamina)", var: '$osa_sigil_of_defense' },
    { label: "Symbol of Retribution", tip: "Direct attack against undead when member is deceased. When used while living (self-cast version) will reactively flare if struck by an undead creature. Uses the standard success resolution system.", var: '$osa_symbol_of_retribution'}], cols: 3)
	add_checks.call([
    { label: "Sign of Smiting", tip: "+10 to AS. (Cost: 2 mana)", var: '$osa_sign_of_smiting' },
    { label: "Sigil of Major Protection", tip: "Adds +10 DS. Also grants heavy critical padding against attacks from hated foes. (Cost: 10 mana, 15 stamina)", var: '$osa_sigil_of_major_protection' },
    { label: "Symbol of Supremacy", tip: "Bonus of +1 per two Voln ranks to AS/CS,CMAN, UAF against undead creatures. Duration: 10 seconds per rank - (stackable).", var: '$osa_symbol_of_supremacy'}], cols: 3)
	add_checks.call([
    { label: "Sign of Swords", tip: "Adds +20 to AS. (Cost: 1 spirit)", var: '$osa_sign_of_swords' },
    { label: "Sigil of Concentration", tip: "+5 mana per pulse. (Cost: 30 stamina)", var: '$osa_sigil_of_concentration' },
    { label: "Symbol of Restoration", tip: "Returns up to half of a members health point loss. Minimum +10/Maximum +50 HP recovery per use.", var: '$osa_symbol_of_restore'}], cols: 3)
	add_checks.call([
    { label: "Sign of Dissipation (Not Implemented Yet)", tip: "Adds +15 to TD. (Cost: 1 spirit)", var: '$osa_sign_of_dissipation' },
    { label: "Sigil of Power", tip: "Converts 50 stamina into 25 mana.", var: '$osa_sigil_of_power' },
    { label: "Symbol of Transcendence", tip: "For 30 seconds member will take damage as if in an incorporeal state. 3 minute cooldown period / 10 minutes if used in emergency.", var: '$osa_symbol_of_transcendance'}], cols: 3)
	add_checks.call([
    { label: "Sign of Wracking (Not Implemented Yet)", tip: "Fully regenerates all mana. (Cost: 5 spirit)", var: '$osa_sign_of_wracking'}], cols: 1)
	ui(rows, :blank, height: 8)
end

def self.populate_living(rows)
	ui(rows, :header, text: "Combat Settings:")
	ui(ui(rows, :row), :dropdown, label: "Attacking Stance", tip: "", var: '$osa_attack_stance', options: "Offensive,Advance,Forward,Neutral,Guarded,Defensive", combo_width: 256)
	ui(ui(rows, :row), :dropdown, label: "Defending Stance", tip: "", var: '$osa_defending_stance', options: "Defensive,Guarded,Neutral,Forward,Advance,Offensive", combo_width: 251)
	ui(rows, :blank, height: 8)
	ui(rows, :attack, attack_label: "Setup Attack:", attack_var: '$osa_setup_attack', options: "None,Berserk,Bertrandt's Bellow (Single Target),Bertrandt's Bellow,Bull Rush, Carn's Cry (Single Target),Carn's Cry (Open),Charge (Polearm),Cripple(Edged),Crowd Press,Cutthroat,Dark Energy Wings\: Shadow Barb,Dark Energy Wings\: Barbed Sweep,Dark Energy Wings\: Rain of Thorns,Dirtkick,Disarm Weapon,Dislodge,Dizzying Swing (Blunt),Eviscerate,Excoriate,Eyepoke,Feint,Footstomp,Garrelle's Growl (Single Target),Garrelle's Growl (Open),Groin Kick,Hamstring,Haymaker,Headbutt,Kneebash,Light Energy Wings\: Radiant Pulse,Light Energy Wings\: Blast of Brilliance,Light Energy Wings\: Blinding Reprisal, Mighty Blow,Mug,Nosetweak,Shield Bash,Shield Charge,Shield Push,Shield Throw,Shield Trample,Spell Cleave,Subdue,Sunder Shield,Sweep,Swiftkick,Tackle,Templeshot,Throatchop,Trip,Twin Hammerfists (Brawling),Vault Kick,Voln Sleep", group: :attack_rows, col: 0, attack_width: 275, stam_min_var:  '$osa_setup_attack_stam_min', mana_min_var:  '$osa_setup_attack_mana_min', enemy_min_var: '$osa_setup_attack_enemy_min', enemy_max_var: '$osa_setup_attack_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :attack, attack_label: "Setup Attack:", attack_var: '$osa_setup_attack2', options: "None,Berserk,Bertrandt's Bellow (Single Target),Bertrandt's Bellow,Bull Rush, Carn's Cry (Single Target),Carn's Cry (Open),Charge (Polearm),Cripple(Edged),Crowd Press,Cutthroat,Dark Energy Wings\: Shadow Barb,Dark Energy Wings\: Barbed Sweep,Dark Energy Wings\: Rain of Thorns,Dirtkick,Disarm Weapon,Dislodge,Dizzying Swing (Blunt),Eviscerate,Excoriate,Eyepoke,Feint,Footstomp,Garrelle's Growl (Single Target),Garrelle's Growl (Open),Groin Kick,Hamstring,Haymaker,Headbutt,Kneebash,Light Energy Wings\: Radiant Pulse,Light Energy Wings\: Blast of Brilliance,Light Energy Wings\: Blinding Reprisal,Mighty Blow,Mug,Nosetweak,Shield Bash,Shield Charge,Shield Push,Shield Throw,Shield Trample,Spell Cleave,Subdue,Sunder Shield,Sweep,Swiftkick,Tackle,Templeshot,Throatchop,Trip,Twin Hammerfists (Brawling),Vault Kick,Voln Sleep", group: :attack_rows, col: 0, attack_width: 275, stam_min_var:  '$osa_setup_attack2_stam_min', mana_min_var:  '$osa_setup_attack2_mana_min', enemy_min_var: '$osa_setup_attack2_enemy_min', enemy_max_var: '$osa_setup_attack2_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :attack, attack_label: "Special Attack:", attack_var: '$osa_special_attack', options: "None,Bearhug,Chastise,Dark Energy Wings\: Shadow Barb,Dark Energy Wings\: Barbed Sweep,Dark Energy Wings\: Rain of Thorns,Excoriate,Exsanguinate,Leap Attack,Light Energy Wings\: Radiant Pulse,Light Energy Wings\: Blast of Brilliance,Light Energy Wings\: Blinding Reprisal,Shield Strike,Spin Attack,Staggering Blow,True Strike", group: :attack_rows, col: 0, attack_width: 267, stam_min_var:  '$osa_special_attack_stam_min', mana_min_var:  '$osa_special_attack_mana_min', enemy_min_var: '$osa_special_attack_enemy_min', enemy_max_var: '$osa_special_attack_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :attack, attack_label: "Special Attack:", attack_var: '$osa_special_attack2', options: "None,Bearhug,Chastise,Dark Energy Wings\: Shadow Barb,Dark Energy Wings\: Barbed Sweep,Dark Energy Wings\: Rain of Thorns,Excoriate,Exsanguinate,Leap Attack,Light Energy Wings\: Radiant Pulse,Light Energy Wings\: Blast of Brilliance,Light Energy Wings\: Blinding Reprisal,Shield Strike,Spin Attack,Staggering Blow,True Strike", group: :attack_rows, col: 0, attack_width: 267, stam_min_var:  '$osa_special_attack2_stam_min', mana_min_var:  '$osa_special_attack2_mana_min', enemy_min_var: '$osa_special_attack2_enemy_min', enemy_max_var: '$osa_special_attack2_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :attack, attack_label: "AOE Attack:", attack_var: '$osa_aoe_attack', options: "None,Bull Rush,Clash (Brawling),Cyclone (Polearm),Dark Energy Wings\: Barbed Sweep,Dark Energy Wings\: Rain of Thorns,Pin Down (Ranged),Pound (Flare Gloves),Pulverize (Blunt),Light Energy Wings\: Radiant Pulse,Light Energy Wings\: Blast of Brilliance,Light Energy Wings\: Blinding Reprisal,Shield Throw,Shield Trample,Whirling Blade (Edged),Whirlwind (Two-Handed),Volley (Ranged)", group: :attack_rows, col: 0, attack_width: 283, stam_min_var:  '$osa_aoe_attack_stam_min', mana_min_var:  '$osa_aoe_attack_mana_min', enemy_min_var: '$osa_aoe_attack_enemy_min', enemy_max_var: '$osa_aoe_attack_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :attack, attack_label: "AOE Attack:", attack_var: '$osa_aoe_attack2', options: "None,Bull Rush,Clash (Brawling),Cyclone (Polearm),Dark Energy Wings\: Barbed Sweep,Dark Energy Wings\: Rain of Thorns,Pin Down (Ranged),Pound (Flare Gloves),Pulverize (Blunt),Light Energy Wings\: Radiant Pulse,Light Energy Wings\: Blast of Brilliance,Light Energy Wings\: Blinding Reprisal,Shield Throw,Shield Trample,Whirling Blade (Edged),Whirlwind (Two-Handed),Volley (Ranged)", group: :attack_rows, col: 0, attack_width: 283, stam_min_var:  '$osa_aoe_attack2_stam_min', mana_min_var:  '$osa_aoe_attack2_mana_min', enemy_min_var: '$osa_aoe_attack2_enemy_min', enemy_max_var: '$osa_aoe_attack2_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :attack, attack_label: "Assault:", attack_var: '$osa_assault', options: "None,Barrage (Ranged),Dark Energy Wings\: Shadow Barb,Flurry (Edged),Fury (Brawling),Guardant Thrusts (Polearm),Light Energy Wings\: Radiant Pulse,Pummel (Blunt),Thrash (Two-Handed)", group: :attack_rows, col: 0, attack_width: 303, stam_min_var:  '$osa_assault_stam_min', mana_min_var:  '$osa_assault_mana_min', enemy_min_var: '$osa_assault_enemy_min', enemy_max_var: '$osa_assault_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :attack, attack_label: "Assault:", attack_var: '$osa_assault2', options: "None,Barrage (Ranged),Dark Energy Wings\: Shadow Barb,Flurry (Edged),Fury (Brawling),Guardant Thrusts (Polearm),Light Energy Wings\: Radiant Pulse,Pummel (Blunt),Thrash (Two-Handed)", group: :attack_rows, col: 0, attack_width: 303, stam_min_var:  '$osa_assault2_stam_min', mana_min_var:  '$osa_assault2_mana_min', enemy_min_var: '$osa_assault2_enemy_min', enemy_max_var: '$osa_assault2_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :blank, height: 10)
	ui(rows, :header, text: "Spell Settings:")
	spell_tip = "These are spells that specifically affect the room or mobs in the room. The script will track affected targets and prevent recasting if any affected mob or room effect is still present. Currently supported spells are: Aura of the Arkati, Cold Snap, Empathic Link, Energy Maelstrom, Grasp of the Grave, Implosion, Mass Interference, Moonbeam, Tangleweed, Tremors, Web, and Wild Entropy. Please enter the spell number."
	ui(rows, :spell, spell_label: "Spell Opener:", spell_tip: spell_tip, spell_var: '$osa_spell_opener', stam_min_var: '$osa_spell_opener_stam_min', mana_min_var: '$osa_spell_opener_man_min', enemy_min_var: '$osa_spell_opener_enemy_min', enemy_max_var: '$osa_spell_opener_enemy_max', ward_var: '$osa_spell_opener_warding', chan_var: '$osa_spell_opener_channel', evoke_var: '$osa_spell_opener_evoke', open_var: '$osa_spell_opener_open_cast')
	ui(rows, :spell, spell_label: "Spell Opener:", spell_tip: spell_tip, spell_var: '$osa_spell_opener2', stam_min_var: '$osa_spell_opener2_stam_min', mana_min_var: '$osa_spell_opener2_man_min', enemy_min_var: '$osa_spell_opener2_enemy_min', enemy_max_var: '$osa_spell_opener2_enemy_max', ward_var: '$osa_spell_opener2_warding', chan_var: '$osa_spell_opener2_channel', evoke_var: '$osa_spell_opener2_evoke', open_var: '$osa_spell_opener_open_cast2')
	ui(rows, :spell, spell_label: "Attack Spell:", spell_tip: "", spell_var: '$osa_attack_spell', stam_min_var: '$osa_spell_stam_min', mana_min_var: '$osa_spell_man_min', enemy_min_var: '$osa_spell_enemy_min', enemy_spell_max_var: '$osa_spell_enemy_max', ward_var: '$osa_spell_warding', chan_var: '$osa_spell_channel', evoke_var: '$osa_spellevoke', open_var: '$osa_spell_open_cast')
	ui(rows, :spell, spell_label: "Attack Spell:", spell_tip: "", spell_var: '$osa_attack_spell2', stam_min_var: '$osa_spell2_stam_min', mana_min_var: '$osa_spell2_man_min', enemy_min_var: '$osa_spell2_enemy_min', enemy_max_var: '$osa_spell2_enemy2_max', ward_var: '$osa_spell2_warding', chan_var: '$osa_spell2_channel', evoke_var: '$osa_spell2_evoke', open_var: '$osa_spell2_open_cast')
	ui(rows, :spell, spell_label: "Attack Spell:", spell_tip: "", spell_var: '$osa_attack_spell3', stam_min_var: '$osa_spell3_stam_min', mana_min_var: '$osa_spell3_man_min', enemy_min_var: '$osa_spell3_enemy_min', enemy_max_var: '$osa_spell3_enemy_max', ward_var: '$osa_spell3_warding', chan_var: '$osa_spell3_channel', evoke_var: '$osa_spell3_evoke', open_var: '$osa_spell3_open_cast')
	ui(rows, :spell, spell_label: "Attack Spell:", spell_tip: "", spell_var: '$osa_attack_spell4', stam_min_var: '$osa_spell4_stam_min', mana_min_var: '$osa_spell4_man_min', enemy_min_var: '$osa_spell4_enemy_min', enemy_max_var: '$osa_spell4_enemy_max', ward_var: '$osa_spell4_warding', chan_var: '$osa_spell4_channel', evoke_var: '$osa_spell4_evoke', open_var: '$osa_spell4_open_cast')
	ui(rows, :spell, spell_label: "Attack Spell:", spell_tip: "", spell_var: '$osa_attack_spell5', stam_min_var: '$osa_spell5_stam_min', mana_min_var: '$osa_spell5_man_min', enemy_min_var: '$osa_spell5_enemy_min', enemy_max_var: '$osa_spell5_enemy_max', ward_var: '$osa_spell5_warding', chan_var: '$osa_spell5_channel', evoke_var: '$osa_spell5_evoke', open_var: '$osa_spell5_open_cast')
end

def self.populate_undead(rows)
	ui(rows, :header, text: "Combat Settings:")
	ui(ui(rows, :row), :dropdown, label: "Attacking Stance", tip: "", var: '$osa_undead_attack_stance', options: "Offensive,Advance,Forward,Neutral,Guarded,Defensive", combo_width: 256)
	ui(ui(rows, :row), :dropdown, label: "Defending Stance", tip: "", var: '$osa_undead_defending_stance', options: "Defensive,Guarded,Neutral,Forward,Advance,Offensive", combo_width: 251)
	ui(rows, :blank, height: 8)
	ui(rows, :attack, attack_label: "Setup Attack:", attack_var:   '$osa_undead_setup_attack', options:      "None,Berserk,Bertrandt's Bellow (Single Target),Bertrandt's Bellow,Bull Rush, Carn's Cry (Single Target),Carn's Cry (Open),Charge (Polearm),Cripple(Edged),Crowd Press,Cutthroat,Dark Energy Wings\: Shadow Barb,Dark Energy Wings\: Barbed Sweep,Dark Energy Wings\: Rain of Thorns,Dirtkick,Disarm Weapon,Dislodge,Dizzying Swing (Blunt),Eviscerate,Excoriate,Eyepoke,Feint,Footstomp,Garrelle's Growl (Single Target),Garrelle's Growl (Open),Groin Kick,Hamstring,Haymaker,Headbutt,Kneebash,Light Energy Wings\: Radiant Pulse,Light Energy Wings\: Blast of Brilliance,Light Energy Wings\: Blinding Reprisal, Mighty Blow,Mug,Nosetweak,Shield Bash,Shield Charge,Shield Push,Shield Throw,Shield Trample,Spell Cleave,Subdue,Sunder Shield,Sweep,Swiftkick,Tackle,Templeshot,Throatchop,Trip,Twin Hammerfists (Brawling),Vault Kick,Voln Sleep", attack_width: 275, stam_min_var:  '$osa_undead_setup_attack_stam_min', mana_min_var:  '$osa_undead_setup_attack_mana_min', enemy_min_var: '$osa_undead_setup_attack_enemy_min', enemy_max_var: '$osa_undead_setup_attack_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :attack, attack_label: "Setup Attack:", attack_var:   '$osa_undead_setup_attack2', options:      "None,Berserk,Bertrandt's Bellow (Single Target),Bertrandt's Bellow,Bull Rush, Carn's Cry (Single Target),Carn's Cry (Open),Charge (Polearm),Cripple(Edged),Crowd Press,Cutthroat,Dark Energy Wings\: Shadow Barb,Dark Energy Wings\: Barbed Sweep,Dark Energy Wings\: Rain of Thorns,Dirtkick,Disarm Weapon,Dislodge,Dizzying Swing (Blunt),Eviscerate,Excoriate,Eyepoke,Feint,Footstomp,Garrelle's Growl (Single Target),Garrelle's Growl (Open),Groin Kick,Hamstring,Haymaker,Headbutt,Kneebash,Light Energy Wings\: Radiant Pulse,Light Energy Wings\: Blast of Brilliance,Light Energy Wings\: Blinding Reprisal, Mighty Blow,Mug,Nosetweak,Shield Bash,Shield Charge,Shield Push,Shield Throw,Shield Trample,Spell Cleave,Subdue,Sunder Shield,Sweep,Swiftkick,Tackle,Templeshot,Throatchop,Trip,Twin Hammerfists (Brawling),Vault Kick,Voln Sleep", attack_width: 275, stam_min_var:  '$osa_undead_setup_attack2_stam_min', mana_min_var:  '$osa_undead_setup_attack2_mana_min', enemy_min_var: '$osa_undead_setup_attack2_enemy_min', enemy_max_var: '$osa_undead_setup_attack2_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :attack, attack_label: "Special Attack:", attack_var:   '$osa_undead_special_attack', options:      "None,Bearhug,Chastise,Dark Energy Wings\: Shadow Barb,Dark Energy Wings\: Barbed Sweep,Dark Energy Wings\: Rain of Thorns,Excoriate,Exsanguinate,Leap Attack,Light Energy Wings\: Radiant Pulse,Light Energy Wings\: Blast of Brilliance,Light Energy Wings\: Blinding Reprisal,Shield Strike,Spin Attack,Staggering Blow,True Strike", attack_width: 267, stam_min_var:  '$osa_undead_special_attack_stam_min', mana_min_var:  '$osa_undead_special_attack_mana_min', enemy_min_var: '$osa_undead_special_attack_enemy_min', enemy_max_var: '$osa_undead_special_attack_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :attack, attack_label: "Special Attack:", attack_var:   '$osa_undead_special_attack2', options:      "None,Bearhug,Chastise,Dark Energy Wings\: Shadow Barb,Dark Energy Wings\: Barbed Sweep,Dark Energy Wings\: Rain of Thorns,Excoriate,Exsanguinate,Leap Attack,Light Energy Wings\: Radiant Pulse,Light Energy Wings\: Blast of Brilliance,Light Energy Wings\: Blinding Reprisal,Shield Strike,Spin Attack,Staggering Blow,True Strike", attack_width: 267, stam_min_var:  '$osa_undead_special_attack2_stam_min', mana_min_var:  '$osa_undead_special_attack2_mana_min', enemy_min_var: '$osa_undead_special_attack2_enemy_min', enemy_max_var: '$osa_undead_special_attack2_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :attack, attack_label: "AOE Attack:", attack_var:   '$osa_undead_aoe_attack', options:      "None,Bull Rush,Clash (Brawling),Cyclone (Polearm),Dark Energy Wings\: Barbed Sweep,Dark Energy Wings\: Rain of Thorns,Pin Down (Ranged),Pound (Flare Gloves),Pulverize (Blunt),Light Energy Wings\: Radiant Pulse,Light Energy Wings\: Blast of Brilliance,Light Energy Wings\: Blinding Reprisal,Shield Throw,Shield Trample,Whirling Blade (Edged),Whirlwind (Two-Handed),Volley (Ranged)", attack_width: 283, stam_min_var:  '$osa_undead_aoe_attack_stam_min', mana_min_var:  '$osa_undead_aoe_attack_mana_min', enemy_min_var: '$osa_undead_aoe_attack_enemy_min', enemy_max_var: '$osa_undead_aoe_attack_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :attack, attack_label: "AOE Attack:", attack_var:   '$osa_undead_aoe_attack2', options:      "None,Bull Rush,Clash (Brawling),Cyclone (Polearm),Dark Energy Wings\: Barbed Sweep,Dark Energy Wings\: Rain of Thorns,Pin Down (Ranged),Pound (Flare Gloves),Pulverize (Blunt),Light Energy Wings\: Radiant Pulse,Light Energy Wings\: Blast of Brilliance,Light Energy Wings\: Blinding Reprisal,Shield Throw,Shield Trample,Whirling Blade (Edged),Whirlwind (Two-Handed),Volley (Ranged)", attack_width: 283, stam_min_var:  '$osa_undead_aoe_attack2_stam_min', mana_min_var:  '$osa_undead_aoe_attack2_mana_min', enemy_min_var: '$osa_undead_aoe_attack2_enemy_min', enemy_max_var: '$osa_undead_aoe_attack2_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :attack, attack_label: "Assault:", attack_var:   '$osa_undead_assault', options:      "None,Barrage (Ranged),Dark Energy Wings\: Shadow Barb,Flurry (Edged),Fury (Brawling),Guardant Thrusts (Polearm),Light Energy Wings\: Radiant Pulse,Pummel (Blunt),Thrash (Two-Handed)", attack_width: 303, stam_min_var:  '$osa_undead_assault_stam_min', mana_min_var:  '$osa_undead_assault_mana_min', enemy_min_var: '$osa_undead_assault_enemy_min', enemy_max_var: '$osa_undead_assault_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :attack, attack_label: "Assault:", attack_var:   '$osa_undead_assault2', options:      "None,Barrage (Ranged),Dark Energy Wings\: Shadow Barb,Flurry (Edged),Fury (Brawling),Guardant Thrusts (Polearm),Light Energy Wings\: Radiant Pulse,Pummel (Blunt),Thrash (Two-Handed)", attack_width: 303, stam_min_var:  '$osa_undead_assault2_stam_min', mana_min_var:  '$osa_undead_assault2_mana_min', enemy_min_var: '$osa_undead_assault2_enemy_min', enemy_max_var: '$osa_undead_assault2_enemy_max', stam_chars: 4, mana_chars: 4, enemy_min_chars: 4, enemy_max_chars: 4)
	ui(rows, :blank, height: 10)
	ui(rows, :header, text: "Spell Settings:")
	spell_tip = "These are spells that specifically affect the room or mobs in the room. The script will track affected targets and prevent recasting if any affected mob or room effect is still present. Currently supported spells are: Aura of the Arkati, Cold Snap, Empathic Link, Energy Maelstrom, Grasp of the Grave, Implosion, Mass Interference, Moonbeam, Tangleweed, Tremors, Web, and Wild Entropy. Please enter the spell number."
	ui(rows, :spell, spell_label: "Spell Opener:", spell_tip: spell_tip, spell_var: '$osa_undead_spell_opener', stam_min_var: '$osa_undead_spell_opener_stam_min', mana_min_var: '$osa_undead_spell_opener_man_min', enemy_min_var: '$osa_undead_spell_opener_enemy_min', enemy_max_var: '$osa_undead_spell_opener_enemy_max', ward_var: '$osa_undead_spell_opener_warding', chan_var: '$osa_undead_spell_open_channel', evoke_var: '$osa_undead_spell_opener_evoke', open_var: '$osa_undead_spell_opener_open_cast')
	ui(rows, :spell, spell_label: "Spell Opener:", spell_tip: spell_tip, spell_var: '$osa_undead_spell_opener2', stam_min_var: '$osa_undead_spell_opener2_stam_min', mana_min_var: '$osa_undead_spell_opener2_man_min', enemy_min_var: '$osa_undead_spell_opener2_enemy_min', enemy_max_var: '$osa_undead_spell_opener2_enemy_max', ward_var: '$osa_undead_spell_opener2_warding', chan_var: '$osa_undead_spell_opener2_channel', evoke_var: '$osa_undead_spell_opener2_evoke', open_var: '$osa_undead_spell_opener2_open_cast')
	ui(rows, :spell, spell_label: "Attack Spell:", spell_tip: "", spell_var: '$osa_undead_spell_type', stam_min_var: '$osa_undead_spell_stam_min', mana_min_var: '$osa_undead_spell_man_min', enemy_min_var: '$osa_undead_enemy_min', enemy_max_var: '$osa_undead_enemy_max', ward_var: '$osa_undead_spell_warding', chan_var: '$osa_undead_spell_channel', evoke_var: '$osa_undead_spell_evoke', open_var: '$osa_undead_spell_open_cast')
	ui(rows, :spell, spell_label: "Attack Spell:", spell_tip: "", spell_var: '$osa_undead_spell2_type', stam_min_var: '$osa_undead_spell2_stam_min', mana_min_var: '$osa_undead_spell2_man_min', enemy_min_var: '$osa_undead_spell2_enemy_min', enemy_max_var: '$osa_undead_spell2_enemy_max', ward_var: '$osa_undead_spell2_warding', chan_var: '$osa_undead_spell2_channel', evoke_var: '$osa_undead_spell2_evoke', open_var: '$osa_undead_spell2_open_cast')
	ui(rows, :spell, spell_label: "Attack Spell:", spell_tip: "", spell_var: '$osa_undead_spell3_type', stam_min_var: '$osa_undead_spell3_stam_min', mana_min_var: '$osa_undead_spell3_man_min', enemy_min_var: '$osa_undead_spell3_enemy_min', enemy_max_var: '$osa_undead_spell3_enemy_max', ward_var: '$osa_undead_spell3_warding', chan_var: '$osa_undead_spell3_channel', evoke_var: '$osa_undead_spell3_evoke', open_var: '$osa_undead_spell3_open_cast')
	ui(rows, :spell, spell_label: "Attack Spell:", spell_tip: "", spell_var: '$osa_undead_spell4_type', stam_min_var: '$osa_undead_spell4_stam_min', mana_min_var: '$osa_undead_spell4_man_min', enemy_min_var: '$osa_undead_spell4_enemy_min', enemy_max_var: '$osa_undead_spell4_enemy_max', ward_var: '$osa_undead_spell4_warding', chan_var: '$osa_undead_spell4_channel', evoke_var: '$osa_undead_spell4_evoke', open_var: '$osa_undead_spell4_open_cast')
	ui(rows, :spell, spell_label: "Attack Spell:", spell_tip: "", spell_var: '$osa_undead_spell5_type', stam_min_var: '$osa_undead_spell5_stam_min', mana_min_var: '$osa_undead_spell5_man_min', enemy_min_var: '$osa_undead_spell5_enemy_min', enemy_max_var: '$osa_undead_spell5_enemy_max', ward_var: '$osa_undead_spell5_warding', chan_var: '$osa_undead_spell5_channel', evoke_var: '$osa_undead_spell5_evoke', open_var: '$osa_undead_spell5_open_cast')
end

def self.populate_gemstones1(rows)
	ui(rows, :header, text: "Gemstone Settings:")
	ui(rows, :ability, label: "Arcane Aegis", tip: "You have a standard flare chance when taking damage to gain 2d20 Critical Padding. For every point of damage absorbed by the shield, 1 point of mana is drained. This property can also be activated to apply to all damage taken for 60 seconds. You gain 2d20 Critical Padding for 60 seconds. For every point of damage absorbed by the shield, 1 point of mana is drained. Cooldown: 3 mins.", var: '$osa_gemstone_arcane_aegis', fields: [{ label: "Mana Threshold:", tip: "Only activates Arcane Aegis if your mana points are above this amount. Default setting is 40.", var: '$osa_gemstone_activate_arcane_aegis_mana_if', default: "40", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Arcanist's Ascendancy", tip: "You enter a heightened state for 30 seconds. During this state, you gain Casting Strength and Magical SMR Strength equal to 30% of the Defensive Strength of spells on all creatures in the room, up to a maximum of 60. Additionally, all of your magical attacks have guaranteed dispel flares. Cooldown: 3 min.", var: '$osa_gemstone_arcanists_ascendancy', fields: [{ label: "Enemy Threshold:", tip: "Only activates Arcanist's Ascendancy if the enemy count is above this amount. Default setting is 1.", var: '$osa_gemstone_activate_arcanists_ascendancy_enemy_if', default: "1", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Arcanist's Blade", tip: "You enter a heightened state for 30 seconds. You gain 5/10/15/20/25 Attack Strength and 3/6/9/12/15% Damage Factor, but each attack costs 5 mana and 5 stamina. Upon activation you gain Mana Sever, preventing you from receiving mana from your fellow adventurers for 2 minutes.", var: '$osa_gemstone_arcanists_blade', default: false, fields: [{ label: "Enemy Threshold:", tip: "Only activates Arcanist's Blade if the enemy count is above this amount. Default setting is 1.", var: '$osa_gemstone_activate_arcanists_blade_enemy_if', default: "1", entry_width: 90, chars: 4 }, { label: "Mana Threshold:", tip: "Only activates Arcanist's Blade if your mana points are above this amount. Default setting is 50.", var: '$osa_gemstone_activate_arcanists_blade_mana_if', default: "50", entry_width: 90, chars: 4 }, { label: "Stamina Threshold:", tip: "Only activates Arcanist's Blade if your stamina points are above this amount. Default setting is 50.", var: '$osa_gemstone_activate_arcanists_blade_stamina_if', default: "50", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Arcanist's Will", tip: "You enter a heightened state for 30 seconds. You gain 3/6/9/12/15 Casting Strength and your successful warding spells receive an endroll bonus of 2/4/6/8/10, but each attack costs 5 mana and 5 stamina. Upon activation you gain Mana Sever, preventing you from receiving mana from your fellow adventurers for 2 minutes.", var: '$osa_gemstone_arcanists_will', default: false, fields: [{ label: "Enemy Threshold:", tip: "Only activates Arcanist's Will if the enemy count is above this amount. Default setting is 1.", var: '$osa_gemstone_activate_arcanists_will_enemy_if', default: "1", entry_width: 90, chars: 4 }, { label: "Mana Threshold:", tip: "Only activates Arcanist's Will if your mana points are above this amount. Default setting is 50.", var: '$osa_gemstone_activate_arcanists_will_mana_if', default: "50", entry_width: 90, chars: 4 }, { label: "Stamina Threshold:", tip: "Only activates Arcanist's Will if your stamina points are above this amount. Default setting is 50.", var: '$osa_gemstone_activate_arcanists_will_stamina_if', default: "50", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Blood Boil", tip: "Your attacks have a standard flare chance to boil the targets blood, dealing 20% of target's current health, up to 100, per tick for 5 ticks (2 second interval). This effect cannot occur on the same target more than once per minute. Activate to cause this ability to trigger on your next attack. Activation Cooldown: 1 min.", var: '$osa_gemstone_blood_boil', default: false, fields: [{ label: "Enemy Threshold:", tip: "Only activates Blood Boil if the enemy count is above this amount. Default setting is 1.", var: '$osa_gemstone_activate_blood_boil_enemy_if', default: "1", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Blood Siphon", tip: "A vampiric aura surrounds you, siphoning blood from nearby enemy creatures with blood for 60 seconds. Every 10 seconds, up to 5 nearby enemy creatures are subject to an SMR test. On a failure, they take 10-20 hit point damage. 5/10/15/20/25% of the damage dealt is restored to you as health. Cooldown: 15 minutes.", var: '$osa_gemstone_blood_siphon', default: false, fields: [{ label: "Enemy Threshold:", tip: "Only activates Blood Siphon if the enemy count is above this amount. Default setting is 1.", var: '$osa_gemstone_activate_blood_siphon_enemy_if', default: "1", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Blood Wellspring", tip: "You instantly regain all of your health. Cooldown: 60/40/20 mins.", var: '$osa_gemstone_blood_wellspring', default: false, fields: [{ label: "Health Threshold:", tip: "Only activates Blood Wellspring if your health points are below this amount. Default setting is 50.", var: '$osa_gemstone_activate_blood_wellspring_health_if', default: "50", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Evanescent Possession", tip: "You invoke a friendly spirit to possess a foe. An enemy creature must make an SSR test. On a failure, it becomes afflicted with Sympathy for you. When the effect ends, the creature takes a standard disruption flare as it rejects the spirit. Cooldown: 5 mins.", var: '$osa_gemstone_evanescent_possession', default: false, fields: [{ label: "Enemy Threshold:", tip: "Only activates Evanescent Possession if the enemy count is above this amount. Default setting is 1.", var: '$osa_gemstone_activate_evanescent_possession_enemy_if', default: "1", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Geomancer's Spite", tip: "You twist the ground to entrap your foes. Nearby enemies must make an SMR test. On a failure, your opponents take grapple damage and are immobilized. Cooldown: 3 mins.", var: '$osa_gemstone_geomancers_spite', default: false, fields: [{ label: "Enemy Threshold:", tip: "Only activates Geomancer's Spite if the enemy count is above this amount. Default setting is 1.", var: '$osa_gemstone_activate_geomancers_spite_enemy_if', default: "1", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Mana Shield", tip: "You have a standard flare chance when taking damage to gain 2d20 Damage Padding. For every point of damage absorbed by the shield, 1 point of mana is drained. This property can also be activated to apply to all damage taken for 60 seconds. You gain 2d20 Damage Padding for 60 seconds. For every point of damage absorbed by the shield, 1 point of mana is drained. Cooldown: 3 mins.", var: '$osa_gemstone_mana_shield', default: false, fields: [{ label: "Mana Threshold:", tip: "Only activates Mana Shield if your mana points are above this amount. Default setting is 40.", var: '$osa_gemstone_activate_mana_shield_mana_if', default: "40", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Mana Wellspring", tip: "You instantly regain all of your mana. Cooldown: 60/40/20 mins.", var: '$osa_gemstone_mana_wellspring', default: false, fields: [{ label: "Mana Threshold:", tip: "Only activates Mana Wellspring if your mana points are below this amount. Default setting is 50", var: '$osa_gemstone_activate_mana_wellspring_mana_if', default: "50", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Reckless Precision", tip: "For 30 seconds, you lose 50 DS. During this time, your attacks are 5% less likely to be evaded, blocked, and parried, your aimed attacks are 25% less likely to miss their mark, and the Damage Factor of your attacks is increased by 5%. Cooldown: 90 sec.", var: '$osa_gemstone_reckless_precision', default: false, fields: [{ label: "Enemy Threshold:", tip: "Only activates Reckless Precision if the enemy count is below this amount. Default setting is 6", var: '$osa_gemstone_activate_reckless_precision_enemy_if', default: "6", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Spellblade's Fury", tip: "You expend 30 mana to enter a heightened state for 1 minute. Your Attack Strength is increased by 3/6/9/12/15% of your Spell Aim ranks, but each attack costs 10 mana. Upon activation you gain Mana Sever, preventing you from receiving mana from your fellow adventurers for 1 minute. Cooldown: 3 min.", var: '$osa_gemstone_spellblades_fury', default: false, fields: [{ label: "Enemy Threshold:", tip: "Only activates Spellblade's Fury if the enemy count is above this amount. Default setting is 3.", var: '$osa_gemstone_activate_spellblades_fury_enemy_if', default: "3", entry_width: 90, chars: 4 }, { label: "Mana Threshold:", tip: "Only activates Spellblade's Fury if your mana points are above this amount. Default setting is 120.", var: '$osa_gemstone_activate_spellblades_fury_mana_if', default: "120", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Spirit Wellspring", tip: "You instantly regain all of your spirit. Cooldown: 60/40/20 mins.", var: '$osa_gemstone_spirit_wellspring', default: false, fields: [{ label: "Spirit Threshold:", tip: "Only activates Spirit Wellspring if your spirit points are below this amount. Default setting is 8.", var: '$osa_gemstone_activate_spirit_wellspring_spirit_if', default: "8", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Stamina Wellspring", tip: "You instantly regain all of your stamina. Cooldown: 60/40/20 mins.", var: '$osa_gemstone_stamina_wellspring', default: false, fields: [{ label: "Stamina Threshold:", tip: "Only activates Stamina Wellspring if your stamina points are below this amount. Default setting is 50", var: '$osa_gemstone_activate_stamina_wellspring_stamina_if', default: "50", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Unearthly Chains", tip: "You summon a ghostly vortex that sprouts ethereal chains. Enemy creatures in your room and adjacent rooms must make an SMR test. On a failure, enemies are pulled into your room if they are not currently there, immobilized, and take disruption damage. Cooldown: 3 mins.", var: '$osa_gemstone_unearthly_chains', default: false, fields: [{ label: "Enemy Threshold:", tip: "Only activates Unearthly Chains if the enemy count is above this amount. Default setting is 2.", var: '$osa_gemstone_activate_unearthly_chains_enemy_if', default: "2", entry_width: 90, chars: 4 }])
	ui(rows, :ability, label: "Witchhunter's Ascendancy", tip: "You enter a heightened state for 30 seconds. During this state, you gain Attack Strength equal to 50% of the Defensive Strength of spells on all creatures in the room, up to a maximum of 100. Additionally, all of your attacks have guaranteed dispel flares. Cooldown: 3 min.", var: '$osa_gemstone_witchhunters_ascendancy', default: false, fields: [{ label: "Enemy Threshold:", tip: "Only activates Witchhunter's Ascendancy if the enemy count is above this amount. Default setting is 3", var: '$osa_gemstone_activate_witchhunters_ascendancy_enemy_if', default: "3", entry_width: 90, chars: 4 }])
end

def self.combatsetup
	if @OSA_COM_WINDOW
		begin
		@OSA_COM_WINDOW.present
		return
		rescue
		@OSA_COM_WINDOW = nil
		end
	end
	GLib::Idle.add do
		begin
			build_combatsetup_window
			rescue => e
			puts "--- OsaCombat GUI error: #{e.class}: #{e.message}"
			puts e.backtrace.join("\n")
		end
		false
	end
	nil
end

def self.save_settings!
	file_path = File.join(DATA_DIR, XMLData.game, Char.name, "osa_vars.yaml")
	File.open(file_path, "w") do |file|
		file.flock(File::LOCK_EX)
		file.write($osa_data.to_yaml)
		file.flock(File::LOCK_UN)
	end
	respond "--- OSACombat: Settings saved to #{file_path}"
end

def self.build_combatsetup_window
	@OSA_COM_WINDOW = Gtk::Window.new
	@OSA_COM_WINDOW.set_default_size(1155, 900)
	@OSA_COM_WINDOW.title = TITLE
	@OSA_COM_WINDOW.set_border_width(10)
	@OSA_COM_WINDOW.keep_above = true
	@OSA_COM_WINDOW.signal_connect("destroy") do
		@OSA_COM_WINDOW = nil
	end
	main_box = Gtk::Box.new(:vertical, 0)
	main_box.set_border_width(5)
	@OSA_COM_WINDOW.add(main_box)
	notebook = Gtk::Notebook.new
	notebook.set_show_border(true)
	notebook.set_scrollable(true)
	main_box.pack_start(notebook, true, true, 0)
	@OSA_COM_ENTRY = {}
	tab_names = ["General", "Support", "Living", "Undead", "Gemstones"]
	tab_names.each.with_index(1) do |name, idx|
		page_box = Gtk::Box.new(:vertical, 0)
		scroller = Gtk::ScrolledWindow.new
		scroller.set_policy(Gtk::POLICY_NEVER, Gtk::POLICY_AUTOMATIC)
		scroller.hexpand = true
		scroller.vexpand = true
		rows = Gtk::Box.new(:vertical, 8)
		rows.set_border_width(6)
		scroller.add(rows)
		page_box.pack_start(scroller, true, true, 0)
		notebook.append_page(page_box, Gtk::Label.new(name))
		instance_variable_set("@OSA_COM_ROWS#{idx}", rows)
	end
	populate_general(@OSA_COM_ROWS1)
	populate_support(@OSA_COM_ROWS2)
	populate_living(@OSA_COM_ROWS3)
	populate_undead(@OSA_COM_ROWS4)
	populate_gemstones1(@OSA_COM_ROWS5) 
	button_row = Gtk::Box.new(:horizontal, 12)
	button_row.set_halign(:end)
	save_btn  = Gtk::Button.new(label: "Save")
	close_btn = Gtk::Button.new(label: "Close")
	save_btn.signal_connect("clicked") do
		@OSA_COM_ENTRY.each do |var_name, widget|
			if widget.is_a?(Gtk::CheckButton)
				$osa_data[var_name] = widget.active?
			elsif widget.is_a?(Gtk::Entry)
				$osa_data[var_name] = widget.text
			elsif widget.is_a?(Gtk::ComboBoxText)
				$osa_data[var_name] = widget.active 
			end
		end
		self.save_settings!
	end
	close_btn.signal_connect("clicked") do 
		Gtk.queue do
			@OSA_COM_WINDOW.hide
			@OSA_COM_WINDOW.destroy
		end
	end
	button_row.pack_start(save_btn, false, false, 0)
	button_row.pack_start(close_btn, false, false, 0)
	main_box.pack_start(button_row, false, false, 6)
	@OSA_COM_WINDOW.show_all
end

def self.save_script_data(key, value, push: false, path: nil)
	full_path = path || File.join(DATA_DIR, XMLData.game, Char.name, "osa_vars.yaml")
	FileUtils.mkdir_p(File.dirname(full_path))
	File.open(full_path, File::RDWR | File::CREAT, 0o644) do |file|
		file.flock(File::LOCK_EX)
		raw = file.read.to_s
		data =
			begin
			if raw.strip.empty?
				{}
			else
				YAML.safe_load(raw, permitted_classes: [Time, Symbol], aliases: true) || {}
			end
			rescue StandardError
			{} # fallback if YAML is corrupt
			end
		data = {} unless data.is_a?(Hash)
		data = data.transform_keys(&:to_s)
		k = key.to_s
		if push
			data[k] = [] unless data[k].is_a?(Array)
			data[k] << value
		else
			data[k] = value
		end
		file.rewind
		YAML.dump(data, file)
		file.flush
		file.truncate(file.pos)
		$osa_data = data
	end
end

def self.load_osa_yaml
	Settings.load
	dir = File.join(DATA_DIR, XMLData.game, Char.name)
	FileUtils.mkdir_p(dir) unless Dir.exist?(dir)
	@osa_yaml_file = File.join(dir, "osa_vars.yaml")
	data = {}
	File.open(@osa_yaml_file, File::RDWR | File::CREAT, 0o644) do |file|
		file.flock(File::LOCK_EX)
		raw = file.read
		if raw && !raw.strip.empty?
			data = YAML.safe_load(raw, permitted_classes: [Time, Symbol], aliases: true) || {}
		else
			data = {}
			file.rewind
			file.write(YAML.dump(data))
			file.flush
			file.truncate(file.pos)
		end
	end
	data = data.transform_keys(&:to_s)
	$osa_data = data
	Settings[Char.name]["osa_vars_yaml_file"] = @osa_yaml_file
	Settings.save
	@osa_yaml_file
end

TITLE = "OSACombat: v. (#{version})"
toggle_upstream
require "yaml"
require "gtk3"
require "fileutils"
self.load_osa_yaml

if Room.current.location == "Ships"
	$mana_focus_first_cast = false
	$bravery_first_cast = false
	$group_celerity_first_cast = false
	$celerity_first_cast = false
	$rapid_fire_first_cast = false
	$heroism_first_cast = false
	$group_barkskin_first_cast = false
	$barkskin_first_cast = false
	$song_of_tonis_first_cast = false
	$beacon_of_courage_first_cast = false
	$warcry_shout_first_cry = false
	$warcry_holler_first_cry = false
	$society_firstcast = false
	$wall_of_force_first_cast = false
	$faith_shield_first_cast = false
	$osa_shield_steely_first_use = false
	$osa_cman_surge_of_strength_cooldown_first_use = false
	$osa_cman_surge_of_strength_no_cooldown_first_use = false
	$osa_gemstone_witchhunters_ascendancy_first_activate = false
	$osa_gemstone_unearthly_chains_first_activate = false
	$osa_gemstone_spirit_wellspring_first_activate = false
	$osa_gemstone_spellblades_fury_first_activate = false
	$osa_gemstone_reckless_precision_first_activate = false
	$osa_gemstone_mana_wellspring_first_activate = false
	$osa_gemstone_mana_shield_first_activate = false
	$osa_gemstone_geomancers_spite_first_activate = false
	$osa_gemstone_force_of_will_first_activate = false
	$osa_gemstone_evanescent_possession_first_activate = false
	$osa_gemstone_blood_wellspring_first_activate = false
	$osa_gemstone_blood_siphon_first_activate = false
	$osa_gemstone_blood_boil_first_activate = false
	$osa_gemstone_arcanists_will_first_activate = false
	$osa_gemstone_arcanists_blade_first_activate = false
	$osa_gemstone_arcanists_ascendancy_first_activate = false
	$osa_gemstone_arcane_aegis_first_activate = false
else
	$mana_focus_first_cast = true
	$bravery_first_cast = true
	$group_celerity_first_cast = true
	$celerity_first_cast = true
	$rapid_fire_first_cast = true
	$heroism_first_cast = true
	$group_barkskin_first_cast = true
	$barkskin_first_cast = true
	$song_of_tonis_first_cast = true
	$beacon_of_courage_first_cast = true
	$warcry_shout_first_cry = true
	$warcry_holler_first_use = true
	$society_firstcast = true
	$wall_of_force_first_cast = true
	$faith_shield_first_cast = true
	$osa_shield_steely_first_use = true
	$osa_cman_surge_of_strength_cooldown_first_use = true
	$osa_cman_surge_of_strength_no_cooldown_first_use = true
	$osa_gemstone_witchhunters_ascendancy_first_activate = true
	$osa_gemstone_unearthly_chains_first_activate = true
	$osa_gemstone_spirit_wellspring_first_activate = true
	$osa_gemstone_spellblades_fury_first_activate = true
	$osa_gemstone_reckless_precision_first_activate = true
	$osa_gemstone_mana_wellspring_first_activate = true
	$osa_gemstone_mana_shield_first_activate = true
	$osa_gemstone_geomancers_spite_first_activate = true
	$osa_gemstone_force_of_will_first_activate = true
	$osa_gemstone_evanescent_possession_first_activate = true
	$osa_gemstone_blood_wellspring_first_activate = true
	$osa_gemstone_blood_siphon_first_activate = true
	$osa_gemstone_blood_boil_first_activate = true
	$osa_gemstone_arcanists_will_first_activate = true
	$osa_gemstone_arcanists_blade_first_activate = true
	$osa_gemstone_arcanists_ascendancy_first_activate = true
	$osa_gemstone_arcane_aegis_first_activate = true
end

$poaching = false
$osa_pc_hiding_room = nil
$osa_pc_hiding = false
$osa_everyone_in_my_group = Array.new
$osa_everyone_in_my_group.clear
$osa_everyone_hidden = Array.new
$osa_everyone_hidden.clear
@list_of_bad_things = Array.new
@list_of_good_things = Array.new
if @room_creatures.nil?
	@room_creatures = Array.new
end
if @empathic_link.nil?
	@empathic_link = Array.new
end
if @empathic_link2.nil?
	@empathic_link2 = Array.new
end
if script.vars[1] == '?'
	osacombat_help_display
	exit
elsif script.vars[1] == 'living'
	self.save_script_data(:$osa_enemy_type, "living")
	respond ""
	respond "Setting Creature Type to Living"
	respond ""
elsif script.vars[1] == 'undead'
	self.save_script_data(:$osa_enemy_type, "undead")
	respond ""
	respond "Setting Creature Type to Undead"
	respond ""
elsif (script.vars[1] =~ /setup/i)
	self.combatsetup()
	exit
elsif (Script.current.vars[1] =~ /profile/i)
	self.profile(Script.current.vars)
	exit
elsif script.vars[1] == 'help'
	osacombat_help_display
	exit
elsif script.vars[1] == 'version'
	respond ""
	respond "OSACombat Version #{version}"
	respond ""
	exit
end

if $osa_data["$osa_usebriefcombat"]
	multifput "flag combatbrief on", "flag combatnonumbers on", "flag combatselffull off"
end
determine_group_members
mana_share
if $osa_data["$osa_mob"]
	Spell[1213].cast if (Spell[1213].known?) && (Spell[1213].affordable?)
end
if $osa_data["$osa_focus"]
	Spell[1216].cast if (Spell[1216].known?) && (Spell[1216].affordable?)
end
fput "store both"
if $osa_data["$osa_nouacweapons"]
		nil
else
	fput "gird"
end
if (Spell[330].known?) && (Spell[330].affordable?)
	pause 1
	if $osa_data["$osa_sanctrighthand"] && !GameObj.right_hand.id.nil?
		pause 0.2
		multifput "prep 330", "evoke ##{GameObj.right_hand.id}"
		wait_castrt
	end
	if $osa_data["$osa_sanctlefthand"] && !GameObj.left_hand.id.nil?
		pause 0.2
		multifput "prep 330", "evoke ##{GameObj.left_hand.id}"
		wait_castrt
	end
end
if checkname == "Peggyanne"
	wait_rt
	pause 0.1
	energy_shield
end
$osacombat_auto_stow = nil
$osacombat_my_mstrike_focus = nil        #These are variables for Mstrike.  Not needed in GUI as they are autoset in mstrike def below.  Can remove or try to autoset this in osacrew.vars so settings are saved.  But this will check settings on open each time.
$osacombat_my_mstrike_open = nil
$osacombat_uac_current_attack = 0
$osacombat_retaliate = 0
mstrike_setup
if (Spell[1625].known?) and (Stats.level >= 29) and !GameObj.right_hand.id.nil?
	pause 0.5
	fput "beseech ##{GameObj.right_hand.id} conserve"
end
if Spell[630].known?
	fput "tell comp return"
	pause 0.5
	fput "tell comp behave offensive"
end
if $osa_data["$osa_spellopen"].empty?
	echo "
	------==== No Opener Spell Designated ==== ------
	"
end
if $osa_data["$osa_undeadspellopen"].empty?
	echo "
	------==== No Undead Opener Spell Designated ==== ------
	"
end

before_dying {
	if !checkdead
		wait_while { running?("eloot") }
		if (Spell[1625].known?) and (Stats.level >= 29) and !GameObj.right_hand.id.nil?
			infuse_weapon
		end
		if Spell[1604].known? and !GameObj.left_hand.id.nil?
			pause 0.2
			infuse_shield
		end
		if Spell[630].known?
			fput "tell comp behave defensive"
		end
		if checkname == "Peggyanne"
				wait_rt
				pause 0.1
				energy_shield
		end
		fput "store both"
		if $osa_data["$osa_usebriefcombat"]
			multifput "flag combatbrief off", "flag combatnonumbers off", "flag combatselffull on"
		end
	end}
	
Thread.new{
	loop{
		command = upstream_get
			if command =~/^\<c\>;osacombat_project setup/i
				self.combatsetup()
				nil
			elsif command =~/^(\<c\>;osacombat help|\<c\>;osacombat ?)/i
				osacombat_help_display
				nil
			end
	}
}

creature_type
loop {
	stance_defensive
	health_monitor
	groupeffects
	gemstone_effects
	mana_leech
	looter
	check_dead
	if GameObj.targets.count > 0 && !checkdead
		creature_type
		reactive
		combat
	end
	sleep 0.1
}
