=begin

Undergrowth of Bittermere Woods Script

This script is for completing the various tasks administered by the old witch.
https://gswiki.play.net/Undergrowth_of_Bittermere_Woods

It will automate 1 task and looting at the completion of the task must be done manually.

tags: lightweaver's ocarina, undergrowth of bittermore woods, witch's hut

=end

# Define task area UIDs for unique starting points
task_areas = [
  8086575, # Witch's Garden, Morel Trace
  8086564, # Witch's Garden, Shadowfern Way
  8086554, # Witch's Garden, Verdant Way
  8086544, # Witch's Garden, Crimson Loop
  8086535  # Witch's Garden, Hag's Hollow
]

# Initialize a counter for tracking which area to start in
@task_area_counter = 0

# Method to start the task in the current area based on the counter
def start_task_in_next_area(task_areas)
  current_area = task_areas[@task_area_counter % task_areas.size]
  Script.run("go2", "u#{current_area} typeahead=0")
  echo "Starting task in area with UID #{current_area} (Counter: #{@task_area_counter})"

  # Confirm arrival in the current area
  until Room.current.uid.first == current_area
    waitrt?
    pause 1
  end
  echo "Arrived in task area #{current_area}."
  
  # Increment counter for the next iteration
  @task_area_counter += 1
end

#* Decorating the Gourd task
def gourd
  fput "go mousehole" if Room.current.uid.first == 8086509
  fput "stow stone cube" if GameObj.right_hand.noun =~ /(?:cube)/
  pause 1
  5.times do
	if Room.current.uid.first == 8086509
		break
	end
    Script.run("go2","u8086582 typeahead=0")

    if GameObj.right_hand.noun !~ /(?:brush)/
      fput "get brush from small basket"
    end

    fput "dip my brush into paint on palette"
    fput "dip my brush into paint on palette"
    waitrt?
    pause 1

    if GameObj.left_hand.noun !~ /(?:gourd)/
      fput "get gourd"
    end
    
    fput "paint my gourd"
    waitrt?
    pause 1
    move 'west'
    waitrt?
    pause 1
    move 'north'
    waitrt?
    pause 1
    fput "put my gourd in collection box"
  end
end

#* Wards of the Old Ones task
def torch(task_areas)
  fput "go mousehole" if Room.current.uid.first == 8086509
  fput "stow stone cube" if GameObj.right_hand.noun =~ /(?:cube)/
  pause 1
  5.times do |i|
	if Room.current.uid.first == 8086509
		break
	end
    Script.run("go2","u8086512 typeahead=0")

    if GameObj.right_hand.noun !~ /(?:candle)/
      fput "get candle from white crate"
    end

	start_task_in_next_area(task_areas)

    until GameObj.loot.any? { |loot| loot.name =~ /extinguished torch/i }
      waitrt?
      pause 1
      walk
    end

    waitrt?
    pause 1
    fput "light extinguished torch with my candle"
  end
end

#* Tallows Tails task
def candle
  fput "go mousehole" if Room.current.uid.first == 8086509
  fput "stow stone cube" if GameObj.right_hand.noun =~ /(?:cube)/
  pause 1
  5.times do
	if Room.current.uid.first == 8086509
		break
	end
    Script.run("go2","u8086581 typeahead=0")

    if GameObj.right_hand.noun !~ /(?:cube)/
      fput "get wax cube from metal bucket"
    end

    if GameObj.left_hand.noun !~ /(?:vial)/
      fput "get vial from display rack"
    end
    
    fput "put my wax cube into double pot"
    fput "pour my vial into double pot"
    fput "pour my vial into double pot"
    waitrt?
    pause 1
    fput "push double pot"
    waitrt?
    pause 1
    
    Script.run("go2","u8086512 typeahead=0")
    
    if Room.current.uid.first == 8086512
      fput "put my candle in white crate"
    else
      Script.run("go2","u8086512 typeahead=0")
      fput "put my candle in white crate"
    end
  end
end

# Gourd Guard Task
def guard(task_areas)
  fput "go mousehole" if Room.current.uid.first == 8086509
  fput "stow stone cube" if GameObj.right_hand.noun =~ /(?:cube)/
  pause 1
  
  5.times do |i|
    start_task_in_next_area(task_areas)

    Script.run("go2", "u8086580 typeahead=0") unless GameObj.right_hand.noun =~ /(?:gourd)/
    fput "get gourd from collection box" unless GameObj.right_hand.noun =~ /(?:gourd)/
    fput "go opening" unless GameObj.right_hand.noun !~ /(?:gourd)/

    loop do
      walk
      waitrt?
      pause 1

      fput "get rotten gourd"
	if Room.current.uid.first == 8086509
		break
	end
      line = get
      if line =~ /You remove and destroy the rotten gourd/
        echo "Rotten gourd removed and destroyed."
        Script.run("go2", "u8086580 typeahead=0")
        fput "get gourd from collection box"
        fput "go opening"
        break
      else
        echo "No rotten gourd detected. Continuing to walk."
      end
      waitrt?
      pause 1
    end
  end
end

#* Eyes of the Unliving task
def eye(task_areas)
  fput "stow stone cube" if GameObj.right_hand.noun =~ /(?:cube)/
  pause 1
  
  5.times do |i|
    start_task_in_next_area(task_areas)
    
    loop do
      fput "peer my wooden spyglass"
      waitrt?
      pause 1

      # Loop to capture lines to detect wisp presence
      detected_wisp = false
      attempts = 0
      until detected_wisp || attempts >= 5
        line = get
        attempts += 1

        # Check if wisp is detected
        if line =~ /spot a glowing light that appears to be|You already spotted/i
          echo "Wisp detected! Attempting to capture with lantern."
          fput "wave my lantern"
          detected_wisp = true
        elsif line =~ /Unfortunately|You recently checked here for/i
          echo "No wisp detected this time. Continuing to walk."
		  walk
		  waitrt?
		  pause 1
          break
        end
      end

      # If a wisp was captured, return to the witch and continue to next iteration
      if detected_wisp
        Script.run("go2","u8086509 typeahead=0")
        fput "give witch"
		fput "go mousehole"
		walk
		waitrt?
		pause 1
        break
      end
    end
  end
end

# Harvesting the Fiddleheads Task
def fiddlehead(task_areas)
  fput "go mousehole" if Room.current.uid.first == 8086509
  fput "stow stone cube" if GameObj.right_hand.noun =~ /(?:cube)/
  pause 1

  5.times do
    # Start task in the next area based on the counter
    start_task_in_next_area(task_areas)

    loop do
      fput "sense"
      waitrt?
      pause 1

      # Loop to capture lines for frond detection or absence messages
      found_frond = false
      attempts = 0
      until found_frond || attempts >= 5
        line = get
        attempts += 1

        # Check if a mature frond is detected
        if line =~ /You sense the existence of a mature frond on the fiddlehead fern|You already located a fern that was ready for harvesting/i
          waitrt?
          pause 1
          fput "climb fern"
          pause 0.25
          fput "get fern" if checkroom("Top of the Fiddlehead Fern")
          pause 0.25
          fput "climb fern" if checkroom("Top of the Fiddlehead Fern")
          pause 0.25
          found_frond = true
        elsif line =~ /You are not able to locate any fiddlehead ferns|you don't sense that it's ready for harvesting|Try another location/i
          echo "No mature frond detected. Moving to a new area to search."
          walk
          waitrt?
          pause 1
          break
        end
      end

      # If a frond was collected, break the loop to move to the next area
      if found_frond
	  Script.run("go2", "u8086514 typeahead=0")
      fput "give nymph" if Room.current.uid.first == 8086514
	if Room.current.uid.first == 8086509
		break
	end
		walk
		waitrt?
		pause 1
        break
    end
  end
end
end

#* Mulching the Mushrooms task
def mushroom(task_areas)
  fput "go mousehole" if Room.current.uid.first == 8086509
  fput "stow stone cube" if GameObj.right_hand.noun =~ /(?:cube)/
  pause 1
  
  Script.run("go2","u8086583 typeahead=0") if GameObj.right_hand.noun !~ /(?:bag)/
if Room.current.uid.first == 8086583
until GameObj.right_hand.noun =~ /(?:bag)/
  fput "get large bag"
end
else
Script.run("go2","u8086583 typeahead=0")
until GameObj.right_hand.noun =~ /(?:bag)/
  fput "get large bag"
end
end
  start_task_in_next_area(task_areas)
  5.times do |i|
	if Room.current.uid.first == 8086509
		break
	end 
    
loop do
      fput "tap shriveled mushroom"
      line = get
      if line =~ /You tap a shriveled mushroom/
        fput "observe"
        waitrt?
        pause 1
        fput "sprinkle my bag"
        waitrt?
        pause 1
		break
      else
        echo "No shriveled mushroom detected. Continuing to walk."
      end
      walk
      waitrt?
      pause 1
end
  end
end

def get_current_task
  fput "help"
  previous_line = nil

  until (line = get).include?("***This is your current task***")
    previous_line = line.match(/^[\*\s]+(.*?):/) ? line : previous_line
  end

  # Capture the task name from the line preceding the current task marker
  task_name = previous_line.match(/^[\*\s]+(.*?):/)[1].strip if previous_line
  task_name
end

# Check if the player is in the witch's room to begin task setup
if Room.current.uid.first == 8086509
  echo "Room UID matches 8086509, proceeding with task setup."
  fput "stow all" if righthand?
  fput "stow all" if lefthand?
  fput "get my stone cube" 
  pause 0.25
  fput "ask witch about pay"
  fput "ask witch about pay"
  pause 0.25
  fput "stow stone cube"
end

pause 1

task = get_current_task

# Execute the correct task based on the identified current task
case task
when "Eyes of the Unliving"
  fput "get glass lantern" unless GameObj.right_hand.noun =~ /(?:lantern)/
  pause 0.25
  fput "go mousehole" if Room.current.uid.first == 8086509
  pause 0.25  
  fput "get spyglass from basket" unless GameObj.left_hand.noun =~ /(?:spyglass)/
  pause 0.25
  eye(task_areas)
when "Wards of the Old Ones"
  torch(task_areas)
when "Tallows Tails"
  candle
when "Decorating the Gourd"
  gourd
when "Gourd Guard"
  guard(task_areas)
when "Harvesting the Fiddleheads"
  fiddlehead(task_areas)
when "Mulching the Mushrooms"
  mushroom(task_areas)
else
  echo "Task not recognized. Please check the task name."
end