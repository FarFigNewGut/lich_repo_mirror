=begin

Undergrowth of Bittermere Woods Script

Consider this in beta and won't work perfectly or even very well.

tags: lightweaver's ocarina, undergrowth of bittermore woods, witch's hut

=end

#* Decorating the Gourd: Decorate five fresh gourds which can be found in the painting workshop below the witch's cottage.  Each gourd must then be deposited in the appropriate collection box located nearby.  To paint on the gourds, you'll need a gourd, a brush, and some paint.  All necessary tools are located on the workbench.  DIPping the BRUSH bristles in your desired color of PAINT ON THE PALETTE will do the trick.
def gourd
fput "stow stone cube" if GameObj.right_hand.noun =~ /(?:cube)/
5.times do
	if Room.current.uid.first == 8086509
		break
	end
	Script.run("go2","u8086582 typeahead=0")

	if GameObj.right_hand.noun !~ /(?:brush)/
		fput "get brush from small basket"
	end

	fput "dip my brush into paint on palette"
	fput "dip my brush into paint on palette"
	waitrt?
	pause 1

	if GameObj.left_hand.noun !~ /(?:gourd)/
		fput "get gourd"
	end
	
	fput "paint my gourd"
	waitrt?
	pause 1
	move 'west'
	waitrt?
	pause 1
	move 'north'
	waitrt?
	pause 1
	fput "put my gourd in collection box"
end
end

#* Wards of the Old Ones: Torches surround the perimeter of the witch's garden.  On occasion, these torches are extinguished and must be reignited.  Find an appropriate light source to relight five of these extinguished torches.
def torch
fput "stow stone cube" if GameObj.right_hand.noun =~ /(?:cube)/
5.times do
	if Room.current.uid.first == 8086509
		break
	end
	Script.run("go2","u8086512 typeahead=0")

	if GameObj.right_hand.noun !~ /(?:candle)/
		fput "get candle from white crate"
	end

	until GameObj.loot.any? { |loot| loot.name =~ /extinguished torch/i }
		waitrt?
		pause 1
		walk
	end

	waitrt?
	pause 1
	fput "light extinguished torch with my candle"
end
end

#* Tallows Tails: Head to the candle making workshop below the witch's cottage and make five candles.  Drop a cube of wax in the pot to melt it, color your candle with some dye (you have lots of color combinations to play with), and then pour out the wax into the canister.  Each candle must be deposited in the white birch crate located near the witch's cottage.
def candle
fput "stow stone cube" if GameObj.right_hand.noun =~ /(?:cube)/
5.times do
	if Room.current.uid.first == 8086509
		break
	end
	Script.run("go2","u8086581 typeahead=0")

	if GameObj.right_hand.noun !~ /(?:cube)/
		fput "get wax cube from metal bucket"
	end

	if GameObj.left_hand.noun !~ /(?:vial)/
		fput "get vial from display rack"
	end
	
	fput "put my wax cube into double pot"
	fput "pour my vial into double pot"
	fput "pour my vial into double pot"
	waitrt?
	pause 1
	fput "push double pot"
	waitrt?
	pause 1
	
	Script.run("go2","u8086512 typeahead=0")
	
	if Room.current.uid.first == 8086512
		fput "put my candle in white crate"
	else
		Script.run("go2","u8086512 typeahead=0")
		fput "put my candle in white crate"
	end
end
end

#* Eyes of the Unliving: The witch needs will-o'-wisps to help illuminate her cabin.  You will need a lantern and a spyglass to complete this task.  The lantern is in the witch's cottage, and the spyglass is out in the witch's garden.  PEER through the spyglass to see through the veil that conceals the wisps and then capture five of these light sources.  Return them one at a time to the witch.
def eye
fput "stow stone cube" if GameObj.right_hand.noun =~ /(?:cube)/
fput "get glass lantern"
	Script.run("go2","u8086511 typeahead=0")
	
	fput "get spyglass from basket"
5.times do	
loop do
  walk
  waitrt?
  pause 1
  fput "peer my wooden spyglass"
  line = get

  # Check if a wisp is detected in the spyglass
  if line =~ /you spot a glowing light that appears to be a will-o'-wisp/
    echo "Wisp detected! Attempting to capture with lantern."
    fput "wave my lantern"
    waitrt?
    pause 1
	Script.run("go2","u8086509 typeahead=0")
	fput "give witch"
	break
  else
    echo "No wisp detected. Continuing to walk."
  end
end
end

end

#* Gourd Guard: Replace five rotten gourds located around the perimeter of the witch's garden with newly decorated gourds which can be retrieved from the gourd collection box located near the witch's cottage.
def guard
fput "stow stone cube" if GameObj.right_hand.noun =~ /(?:cube)/
Script.run("go2","u8086580 typeahead=0")
5.times do
	Script.run("go2","u8086580 typeahead=0")
	fput "get gourd from collection box"
	waitrt?
	pause 1
	fput "go opening"
	loop do
		walk
		waitrt?
		pause 1
		fput "get rotten gourd"
		line = get
		if line =~ /You remove and destroy the rotten gourd/
			echo "Rotten gourd removed and destroyed."
			break
		else
			echo "No rotten gourd detected. Continuing to walk."
		end
		waitrt?
		pause 1
	end
end

end

#* Harvesting the Fiddleheads: Use SENSE throughout the witch's garden to locate fiddlehead ferns that are ready for harvesting.  You will need to reach the fronds that are at the top of the ferns.  Once you harvest one, take it to the nymph near the witch's cabin, who is collecting them for soup preparation.  You will need to collect five fresh fronds.  Finding fiddlehead ferns that are ready for harvest may take some looking around!
def fiddlehead
fput "stow stone cube" if GameObj.right_hand.noun =~ /(?:cube)/
	Script.run("go2","u8086514 typeahead=0") if Room.current.uid.first == 8086509
5.times do
	loop do
	if Room.current.uid.first == 8086509
		break
	end
		fput "sense"
			waitrt?
			pause 1
		line = get
		if line =~ /You sense the existence of a mature frond on the fiddlehead fern|You already/
			fput "climb fern"
			pause 0.25
			fput "get fern" if checkroom "Top of the Fiddlehead Fern"
			pause 0.25
			fput "climb fern" if checkroom "Top of the Fiddlehead Fern"
			pause 0.25
			Script.run("go2","u8086514 typeahead=0")
			if Room.current.uid.first == 8086512
				fput "give nymph"
				break
			else
				Script.run("go2","u8086514 typeahead=0")
				fput "give nymph"
				break
			end
		else
			waitrt?
			pause 1
			walk
			waitrt?
			pause 1
		end
	end
end

end

#* Mulching the Mushrooms: You must find some mulch near the witch's cottage and OBSERVE the areas around the mushrooms in the garden.  You are tasked with mulching five that are in need of some gardening care.  Finding those in need may take some looking around!
def mushroom
fput "stow stone cube" if GameObj.right_hand.noun =~ /(?:cube)/
	Script.run("go2","u8086583 typeahead=0") if GameObj.right_hand.noun !~ /(?:bag)/
	
	fput "get large bag" if GameObj.right_hand.noun !~ /(?:bag)/
	
	Script.run("go2","u8086512 typeahead=0") if GameObj.right_hand.noun =~ /(?:bag)/
	
	until Room.current.uid.first == 8086509
		fput "tap shriveled mushroom"
		line = get
		if line =~ /You tap a shriveled mushroom/
			fput "observe"
			waitrt?
			pause 1
			fput "sprinkle my bag"
			waitrt?
			pause 1
		else
			echo "No shriveled mushroom detected. Continuing to walk."
		end
		walk
		waitrt?
		pause 1
	end
end

def get_current_task
  fput "help"
  previous_line = nil

  until (line = get).include?("***This is your current task***")
    previous_line = line.match(/^[\*\s]+(.*?):/) ? line : previous_line
  end

  # Capture the task name from the line preceding the current task marker
  task_name = previous_line.match(/^[\*\s]+(.*?):/)[1].strip if previous_line
  task_name
end

# Check if the player is in the witch's room to begin task setup
if Room.current.uid.first == 8086509
  echo "Room UID matches 8086509, proceeding with task setup."
  fput "stow all" if righthand?
  fput "get my stone cube" 
  fput "ask witch about pay"
  fput "ask witch about pay"
  fput "stow stone cube"
  fput "go mousehole"
  pause 1
else
  echo "Room UID did not match 8086509. Current UID: #{Room.current.uid.first}"
  task = get_current_task
  # Execute the correct task based on the identified current task
	case task
	when "Eyes of the Unliving"
	  eye
	when "Wards of the Old Ones"
	  torch
	when "Tallows Tails"
	  candle
	when "Decorating the Gourd"
	  gourd
	when "Gourd Guard"
	  guard
	when "Harvesting the Fiddleheads"
	  fiddlehead
	when "Mulching the Mushrooms"
	  mushroom
	else
	  echo "Task not recognized. Please check the task name."
	end
end

