=begin

  Background script to monitor for various feeder and similar announcements to then
  feed to LichDiscordHook(discordhook.lic)

        author: elanthia-online
          game: Gemstone
          tags: feeder, discord, gemstone, lock, key
       version: 1.0.0

  Version Control:
  Major_change.feature_addition.bugfix
  v1.0.0 (2025-10-09)
    - initial release

=end
=begin
*** A glint of light draws your attention to your latest find! ***
*** A prismatic display of color arcs across the sky over <place>, heralding the discovery of a legendary treasure! ***
*** A refracted display of prismatic color tints the air around you, heralding the distant discovery of a legendary treasure! ***
*** A swirl of glimmering motes surrounds you before rising into the sky, indicating your discovery of a rare treasure! ***

*** A trio of candle-like flames surrounded by lightining materialize in the air around you, announcing the distant discover of an epic treasure! ***
*** An arc of fire and lightning sweeps across the sky over Icemule Trace, heralding the discovery of an epic treasure! ***
*** An arc of fire and lightning sweeps around you before rising away, announcing your discovery of an epic treasure! ***
A prismatic display of color tints the air around you and arcs away, heralding your discovery of a legendary treasure!
=end

unless File.exist?(File.join(SCRIPT_DIR, "discordhook.lic"))
  echo("Requires the discordhook.lic script downloaded and ran prior to launching this script")
  exit
end

module FeederFrenzy
  @feeder_regex = Regexp.union(
    /^\*\*\* A glint of light draws your attention to your latest find! \*\*\*/,

    # legendary feeder/treasure find
    /^\*\*\* A prismatic display of color arcs across the sky over .+, heralding the discovery of a legendary treasure! \*\*\*/,
    /^\*\*\* A refracted display of prismatic color tints the air around you, heralding the distant discovery of a legendary treasure! \*\*\*/,
    /^\*\*\* A prismatic display of color tints the air around you and arcs away, heralding your discovery of a legendary treasure! \*\*\*/,
    /^A prismatic display of color tints the air around you and arcs away, heralding your discovery of a legendary treasure!/,

    # epic feeder/treasure find
    /^\*\*\* A trio of candle-like flames surrounded by lightining materialize in the air around you, announcing the distant discovery? of an epic treasure! \*\*\*/,
    /^\*\*\* An arc of fire and lightning sweeps across the sky over .+, heralding the discovery of an epic treasure! \*\*\*/,
    /^\*\*\* An arc of fire and lightning sweeps around you before rising away, announcing your discovery of an epic treasure! \*\*\*/,

    # rare feeder/treasure find
    /^\*\*\* A swirl of glimmering motes surrounds you before rising into the sky, indicating your discovery of a rare treasure! \*\*\*/,
    /^\*\*\* An array of glimmering motes grace the air around you, indicating the distant discovery of a rare treasure! \*\*\*/,
    /(?:rare|epic|legendary) treasure! \*\*\*/,
  )
  @cache_regex = Regexp.union(
    /^A bandit can be heard snarling, "One of our caches was plundered for [\w\,]+ bloodscrip!  Argh!!!"/,
    /^You search around and find a cache of [\w\,]+ bloodscrip, which you pocket!/,
  )
  @lockandkey_regex = Regexp.union(
    /^A (?:radiant|vibrant) (?:blood red|forest green|frosty white|rainbow-hued|royal blue) (?:key|lock) appears on the ground!/,
  )

  @gemstone_regex = Regexp.union(
    /^\*\* A glint of light catches your eye, and you notice .* at your feet! \*\*/,
  )

  def self.description
    "#{XMLData.room_title.sub(']', " - #{Room.current.id}]")} (u#{XMLData.room_id})\n" +
    "Objects: #{GameObj.loot.map { |item| item.name }.join(', ')}\n\n" +
    "NPCs: #{GameObj.npcs.map { |npc| npc.name }.join(', ')}\n" +
    "Also here: #{GameObj.pcs.map { |pc| pc.noun }.join(', ')}\n" +
    "#{XMLData.room_exits_string}\n" +
    reget(10).join
  end

  def self.parse(line)
    case line.strip
    when @feeder_regex
      LichDiscordHook.msg("\nFEEDER FOUND!\n```#{line}```", description: self.description)
      return :ok
    when @cache_regex
      LichDiscordHook.msg("\nDR Sewer Cache FOUND!\n```#{line}```", description: self.description)
      return :ok
    when @lockandkey_regex
      LichDiscordHook.msg("\nLock & Key FOUND!\n```#{line}```", description: self.description)
      return :ok
    when @gemstone_regex
      LichDiscordHook.msg("\nGemstone FOUND!\n```#{line}```", description: self.description)
      return :ok
    when /Your passcode is to: /
      LichDiscordHook.msg("\nRogue Guild Invitation!\n```#{reget(15).join("\n")}```", description: self.description)
      return :ok
    end
    return :noop
  end

  def self.main
    while line = get
      self.parse(line)
    end
  end
end

sleep(1) until(defined?(LichDiscordHook))
FeederFrenzy.main unless Script.current.vars.include?("--test")

if Script.current.vars.include?("--gemstonefail")
  result = FeederFrenzy.parse(%[ ** A glint of light catches your eye, and you notice a marquise-cut sapphire jewel rippled by copper at your feet! **])
  echo result
  fail "failed to parse gemstone drop!" unless result.eql?(:ok)
elsif Script.current.vars.include?("--gemstonefail")
  result = FeederFrenzy.parse(%[*** A glint of light catches your eye, and you notice a marquise-cut sapphire jewel rippled by copper at your feet! ***])
  echo result
  fail "failed to parse gemstone drop!" unless result.eql?(:ok)
end