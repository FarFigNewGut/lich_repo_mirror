=begin
This script calculate the next liab full moon. At some point maybe it'll do other stuff too.
All credit for figuring out how all of this works and providing math to Gillien.

# Name: astrolabe
# Author: Azanoth
# Tags: liabo, rol, moon
# Version: 0.1
=end

day_in_seconds = 24 * 60 * 60
hour_in_seconds = 60 * 60
minute_in_seconds = 60

known_full_start = Time.utc(2021, 5, 8, 22, 32, 0).to_i
full_orbit_seconds = 7.449 * 24 * 60 * 60
full_moon_seconds = full_orbit_seconds / 12
time_format = "%m/%d %A %I:%M %p %Z"

now = Time.now.to_i
next_full_start = known_full_start

loop {
    next_full_start = next_full_start + full_orbit_seconds
    break if next_full_start > now
}

time_until_tokens = []
time_until_int = next_full_start - now

[
    [day_in_seconds, 'Days'],
    [hour_in_seconds, 'Hours'],
    [minute_in_seconds, 'Minutes'],
    [1, 'Seconds'],
].each do |chunk|
    if time_until_int >= chunk[0]
        count = (time_until_int / chunk[0]).floor
        unit = count == 1 ? chunk[1].sub(/s$/, '') : chunk[1]
        time_until_tokens.push("#{count} #{unit}")
        time_until_int = time_until_int - count * chunk[0]
    end
end

def message(text)
    string = ''
    if $fake_stormfront
      string.concat("\034GSL\r\n ")
    else
      string.concat("<pushBold\/>")
    end
    if (text.index('\n'))
      text.split('\n').each { |line| string.concat("     #{line}") }
    else
      string.concat('    ' + text)
    end
    if $fake_stormfront
      string.concat("\034GSM\r\n ")
    else
      string.concat("<popBold\/>")
    end
    _respond string
  end

message ''
message 'Connecting to the stars... Message received!'
message ''
message ''
message ''
message "From: The Executive Assistant to Cosmologist Extraordinaire Gillien Luddy"
message '----'
message 'To: All You Moonheads Out There'
message '----'
message 'Subject: Liabo Astronomy Report - Next Full Moon'
message '----'
message 'Body:'
message "  The next full moon is at #{Time.at(next_full_start).strftime time_format}."
message '  '
message "  That's #{time_until_tokens.join ', '} from now! I hope you catch it."
message '  '
message "  At #{Time.at(next_full_start + full_moon_seconds).strftime time_format} you may find your brooch waning."
message ""
message "  See You Space Cowboy."
message "----"
