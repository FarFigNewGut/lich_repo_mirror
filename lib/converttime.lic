# author: Mara
# converttime.lic v1.1
# updated to treat midnight for gld training as 12am EST
# Converts elven time (Eastern / ET) to local time live.
# ;converttime
STDOUT.sync = true

HAVE_TZINFO = begin; require 'tzinfo'; true; rescue LoadError; false; end
require 'time'
require 'date'

SRC_TZ_NAME = 'America/New_York'
PAT_A = /It is (\d{1,2}):(\d{2})(?::(\d{2}))?(?:\s*(am|pm))?\s*by the elven time standard/i
PAT_B = /\b(?:until|until:)\s*([A-Za-z]{3})\s+([A-Za-z]{3})\s+(\d{1,2})\s+(\d{2}):(\d{2}):(\d{2})\s*(ET|EST|EDT)?\s+(\d{4})/i
PAT_GUILD_MIDNIGHT = /Most guild training points awards will be doubled as a result until midnight\./i
MONTHS = {"jan"=>1,"feb"=>2,"mar"=>3,"apr"=>4,"may"=>5,"jun"=>6,"jul"=>7,"aug"=>8,"sep"=>9,"oct"=>10,"nov"=>11,"dec"=>12}

def echo_line(msg)
  _respond "<pushBold/>##################################################<popBold/>"
  _respond "<pushBold/>#  #{msg.ljust(74)}<popBold/>"
  _respond "<pushBold/>##################################################<popBold/>"
end

def convert_from_src(year, month, day, hour, min, sec)
  utc_time = if HAVE_TZINFO
    begin
      TZInfo::Timezone.get(SRC_TZ_NAME).local_to_utc(Time.new(year, month, day, hour, min, sec))
    rescue
      Time.new(year, month, day, hour, min, sec, "-05:00").getutc
    end
  else
    Time.new(year, month, day, hour, min, sec, "-05:00").getutc
  end
  local = utc_time.getlocal
  [local.strftime("%H:%M"), local.strftime("%-I:%M %P")]
end

loop do
  line = get
  unless line
    sleep 0.1
    next
  end

  if m = PAT_A.match(line)
    h, min, sec = m[1].to_i, m[2].to_i, (m[3] || "0").to_i
    if m[4]
      a = m[4].downcase
      h = a == 'am' && h == 12 ? 0 : (a == 'pm' && h < 12 ? h + 12 : h)
    end
    
    year, month, day = if HAVE_TZINFO
      src_now = TZInfo::Timezone.get(SRC_TZ_NAME).to_local(Time.now.utc)
      [src_now.year, src_now.month, src_now.day]
    else
      now = Time.now.getutc - 18000
      [now.year, now.month, now.day]
    end

    f24, f12 = convert_from_src(year, month, day, h, min, sec)
    echo_line("Elven time converted to local: #{f24} (#{f12})")
  elsif m = PAT_B.match(line)
    month = MONTHS[m[2].downcase[0,3]]
    f24, f12 = convert_from_src(m[8].to_i, month, m[3].to_i, m[4].to_i, m[5].to_i, m[6].to_i)
    echo_line("Elven timestamp converted to local: #{f24} (#{f12})")
  elsif PAT_GUILD_MIDNIGHT.match(line)
    # "Until midnight" = midnight Eastern (end of current day ET) = 00:00 next day ET
    year, month, day = if HAVE_TZINFO
      src_now = TZInfo::Timezone.get(SRC_TZ_NAME).to_local(Time.now.utc)
      [src_now.year, src_now.month, src_now.day]
    else
      now = Time.now.getutc - 18000
      [now.year, now.month, now.day]
    end
    next_day = Date.new(year, month, day) + 1
    f24, f12 = convert_from_src(next_day.year, next_day.month, next_day.day, 0, 0, 0)
    echo_line("Guild 2x until midnight ET â†’ local: #{f24} (#{f12})")
  end
end
