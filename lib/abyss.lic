#Arena of the Abyss

	if $frontend == 'stormfront'
		fam_window_begin = "<pushStream id=\"loot\" ifClosedStyle=\"watching\"/>"
		fam_window_end   = "<popStream/>\r\n"
	else
		fam_window_begin = "\034GSe\r\n"
		fam_window_end   = "\034GSf\r\n"
	end

def spells
	waitrt?
	waitcastrt?
	if Spell[515].affordable?
		Spell[515].cast
	end
	waitcastrt?
	if Spell[506].affordable?
		Spell[506].cast
	end
end

def immolate
	waitrt?
	waitcastrt?
	Spell[519].cast if Spell[519].affordable?
	waitcastrt?
end

def stand
	waitrt?
	if not standing?
		fput 'stance offensive'
		fput "stand" until standing?
	end
end

def haste
	waitrt?
	waitcastrt?
	Spell[506].cast if Spell[506].affordable? unless Spell[506].active?
end

def stomp
	waitrt?
	if Spell[909].active?
		if checkmana(5)
			fput 'stomp' if Spell[909].active?
		end
	else
		if checkmana(9)
			fput 'incant 909'
			waitcastrt?
			fput 'stomp'
		end
	end
end

def attack(target)
	attack_stance = "offensive"
	defense_stance = "defensive"
	waitrt?
	stand
	haste
	fput "stance #{attack_stance}" if checkstance != attack_stance
	result = dothistimeout('attack', 2, /You thrust|You do not currently have a target.|You currently have no valid target.|Be at peace my child, there is no need to fight here.|...wait 1 seconds.|Wait 1 second./)
	if result =~ /You thrust/
		sleep 0.1
		waitrt?
		waitcastrt?
		attack(target)
	elsif result =~ /You do not currently have a target.|You currently have no valid target.|You do not currently have a target.|Be at peace my child, there is no need to fight here./
		waitrt?
	elsif result =~ /...wait 1 seconds.|Wait 1 second./
		waitrt?
		attack(target)
	elsif result =~ /Please rephrase that command./
	end
end

def start_attack_sequence
	while GameObj.targets.any? {|target| target.status !~ /dead|gone/ }
		GameObj.targets
		.reject {|target| target.status =~ /dead|gone/}
		.sample
		.tap { |target|
				waitrt?
				if Char.name == 'Alastir'
					if not standing?
						stand
					end
					immolate
					haste
					attack(target)
				else
					Script.run "bigshot", "quick"
					wait_while { running? 'bigshot' }		
					if Char.prof == 'Sorcerer'
						fput 'stop 709'
					end
				end
			}
	end
end

def arena_controller
	loop do
		line = get
		if line =~ /We have another living one, Brave Soul #{Char.name}, hailing from beyond this valence!/
			fput 'beg'
		elsif line =~ /A crimson bolt of lightning strikes the arena and (.*) appears!/
			$abyss_fight_counter += 1
			start_attack_sequence
		elsif line =~ /#{Char.name} is triumphant, vanquishing all those that opposed (?:her|him)./
			$abyss_fight_counter = 0
			fput 'store all'
		elsif line =~ /A massive tenebrous oculoth floats in and regurgitates (.*) into your right hand./
			result = dothistimeout("put right in my #{Vars.lootsack}", 5, /You put/)
			if result =~ /You put/
				break
			end
		end
	end
end

def enter
	#Check for entry key
	result = dothistimeout("get my stone cube from my #{Vars.questsack}", 5, /You remove|You reach|You discreetly remove|Get what\?/)
	if result =~ /You remove|You reach|You discreetly remove/
		fput 'pay'
		$abyss_start_time = Time.now
		fput "put my stone cube in my #{Vars.questsack}"
		fput 'gird'
	end
end

loop do
	if Room.current.id == 28556
	
		if $frontend == 'stormfront'
			fam_window_begin = "<pushStream id=\"loot\" ifClosedStyle=\"watching\"/>"
			fam_window_end   = "<popStream/>\r\n"
		else
			fam_window_begin = "\034GSe\r\n"
			fam_window_end   = "\034GSf\r\n"
		end
	
		$abyss_total_time = Time.now - $abyss_start_time
		puts("#{fam_window_begin}Total Time: #{Time.at($abyss_total_time).strftime("%M:%S")}!\r\n#{fam_window_end}")
		
		if $abyss_pause == true
			Script.pause('abyss')
		else
			spells
			Script.run('go2',"28549")
		end
	elsif Room.current.id != 28549
		echo 'You should start this script at room 28549'
		Script.pause('abyss')
	else
		spells
		enter
		arena_controller
	end
end