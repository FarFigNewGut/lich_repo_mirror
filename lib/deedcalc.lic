=begin
  deedcalc.lic: figure out how much deeds cost and acquire them!

  Will calculate deed costs in silver based on current deeds and GS3 level.
  Can also automatically acquire deeds by buying and offering rubies.

            author: elanthia-online
              game: Gemstone
              tags: deeds
          required: Lich >= 5.12.9
           version: 1.1.0

  Improvements:
  Major_change.feature_addition.bugfix
  v1.1.0  (2026-02-09)
    - Added --get option to actually acquire deeds
    - Accounts for ruby value (3x purchase price: 13,500 vs 4,500)
    - Caps at 200 maximum deeds
    - Calculates exact silver needed based on deed costs
  v1.0.0  (2026-02-06)
    - initial release

=end

require 'terminal-table'

module DeedCost
  MAX_DEEDS = 200 unless defined?(MAX_DEEDS)
  RUBY_PURCHASE_COST = 4_500
  RUBY_DEED_VALUE = 13_500  # 3x the purchase cost
  
  def self.calculate(deeds, gs3_level)
    ((deeds * deeds) * 20) + (gs3_level * 100) + 101
  end
  
  def self.current_gs3_level
    exp = Experience.exp
    
    case exp
    when 0..49_999
      # First 50k: +1 level per 10k
      exp / 10_000
    when 50_000..149_999
      # Next 100k: +1 level per 20k
      5 + ((exp - 50_000) / 20_000)
    when 150_000..299_999
      # Next 150k: +1 level per 30k
      10 + ((exp - 150_000) / 30_000)
    when 300_000..499_999
      # Next 200k: +1 level per 40k
      15 + ((exp - 300_000) / 40_000)
    else
      # 500k+: +1 level per 50k
      20 + ((exp - 500_000) / 50_000)
    end
  end
  
  def self.format_silver(amount)
    amount.to_s.reverse.gsub(/(\d{3})(?=\d)/, '\\1,').reverse
  end
  
  def self.display_chart(gs3_level, deed_range = 0..200, columns = 5)
    # Cap the range at MAX_DEEDS
    start_deed = [deed_range.first, 0].max
    end_deed = [deed_range.last, MAX_DEEDS].min
    
    deeds_array = (start_deed..end_deed).to_a
    rows = []
    
    # Split into chunks for multi-column display
    deeds_array.each_slice(columns).each do |chunk|
      row = []
      chunk.each do |deed_number|
        # Calculate cost using current deeds (deed_number - 1)
        cost = calculate(deed_number - 1, gs3_level)
        row << deed_number
        row << format_silver(cost)
      end
      # Pad the last row with empty cells if needed
      while row.length < (columns * 2)
        row << ''
        row << ''
      end
      rows << row
    end
    
    # Build column headers
    headings = []
    columns.times { headings += ['Deed', 'Silver'] }
    
    table = Terminal::Table.new do |t|
      t.title = "Deed Cost Chart (GS3 Level #{gs3_level}, Range: #{start_deed}..#{end_deed})"
      t.headings = headings
      t.rows = rows
    end
    
    respond table
  end
  
  def self.show_current
    fput('experience') # refresh Infomon tracking
    
    gs3_level = current_gs3_level
    current_deeds = Experience.deeds
    
    # Show chart from NEXT deed to max
    next_deed = current_deeds + 1
    display_chart(gs3_level, next_deed..MAX_DEEDS)
  end
  
  def self.calculate_deed_acquisition_cost(current_deeds, num_deeds_wanted, gs3_level)
    # Cap at MAX_DEEDS
    deeds_available = MAX_DEEDS - current_deeds
    actual_deeds_to_get = [num_deeds_wanted, deeds_available].min
    
    if actual_deeds_to_get <= 0
      return {
        deeds_to_get: 0,
        total_deed_cost: 0,
        rubies_needed: 0,
        rubies_per_deed: [],
        silver_to_withdraw: 0,
        already_maxed: current_deeds >= MAX_DEEDS
      }
    end
    
    # Calculate cost and rubies needed for each individual deed
    total_deed_cost = 0
    rubies_per_deed = []
    
    (current_deeds...(current_deeds + actual_deeds_to_get)).each do |deed_num|
      deed_cost = calculate(deed_num, gs3_level)
      total_deed_cost += deed_cost
      
      # Calculate rubies needed for this specific deed (each ruby worth 13,500 toward deed cost)
      rubies_for_this_deed = (deed_cost.to_f / RUBY_DEED_VALUE).ceil
      rubies_per_deed << rubies_for_this_deed
    end
    
    # Total rubies needed
    total_rubies = rubies_per_deed.sum
    
    # Calculate silver to withdraw (each ruby costs 4,500)
    silver_to_withdraw = total_rubies * RUBY_PURCHASE_COST
    
    {
      deeds_to_get: actual_deeds_to_get,
      total_deed_cost: total_deed_cost,
      rubies_needed: total_rubies,
      rubies_per_deed: rubies_per_deed,
      silver_to_withdraw: silver_to_withdraw,
      already_maxed: false
    }
  end
  
  def self.acquire_deeds(num_deeds = 10)
    fput('experience') # refresh Infomon tracking
    StowList.check unless StowList.valid?
    
    current_deeds = Experience.deeds
    gs3_level = current_gs3_level
    
    echo "="*60
    echo "Deed Acquisition Process"
    echo "="*60
    echo "Current deeds: #{current_deeds}/#{MAX_DEEDS}"
    echo "GS3 Level: #{gs3_level}"
    
    costs = calculate_deed_acquisition_cost(current_deeds, num_deeds, gs3_level)
    
    if costs[:already_maxed]
      echo "You already have the maximum number of deeds (#{MAX_DEEDS})!"
      return
    end
    
    if costs[:deeds_to_get] == 0
      echo "Cannot acquire any more deeds (already at maximum)."
      return
    end
    
    if costs[:deeds_to_get] < num_deeds
      echo "Note: Capping at #{costs[:deeds_to_get]} deeds (would exceed #{MAX_DEEDS} maximum)"
    end
    
    echo ""
    echo "Deeds to acquire: #{costs[:deeds_to_get]}"
    echo "Total deed cost: #{format_silver(costs[:total_deed_cost])} silver"
    echo "Rubies per deed: #{costs[:rubies_per_deed].join(', ')}"
    echo "Total rubies needed: #{costs[:rubies_needed]} (@ #{format_silver(RUBY_DEED_VALUE)} value each)"
    echo "Silver to withdraw: #{format_silver(costs[:silver_to_withdraw])} (@ #{format_silver(RUBY_PURCHASE_COST)} per ruby)"
    echo "="*60
    
    # Clear hands
    empty_hands
    
    # Go to bank
    echo "Going to bank..."
    Script.run('go2', 'bank _disable_confirm_')
    fput "withdraw #{costs[:silver_to_withdraw]}"
    
    # Buy rubies
    echo "Buying #{costs[:rubies_needed]} rubies..."
    Script.run('go2', '9269 _disable_confirm_')
    fput "open ##{StowList.default.id}"
    costs[:rubies_needed].times do
      fput "order 14"
      fput "buy"
      fput "put ruby in ##{StowList.default.id}"
    end
    
    # Go to temple and offer rubies
    echo "Going to temple to offer rubies..."
    Script.run('go2', '4044 _disable_confirm_')
    fput "open ##{StowList.default.id}"
    
    costs[:rubies_per_deed].each_with_index do |rubies_for_deed, deed_index|
      echo "Acquiring deed #{deed_index + 1}/#{costs[:deeds_to_get]} (#{rubies_for_deed} rubies)..."
      fput "go tapestry"
      fput "ring chime with mallet"
      fput "ring chime with mallet"
      fput "kneel"
      
      # Drop all rubies needed for this deed
      rubies_for_deed.times do
        fput "get my ruby from ##{StowList.default.id}"
        fput "drop my ruby"
      end
      
      # Ring chime to complete the deed
      fput "ring chime with mallet"
      fput "out"
    end
    
    # Restore hands
    fill_hands

    # Return to Landing bank
    Script.run('go2', '400 _disable_confirm_')
    
    echo "="*60
    echo "Done! You should now have #{current_deeds + costs[:deeds_to_get]} deeds."
    echo "="*60
  end
  
  def self.show_help
    echo "="*60
    echo "DeedCost - Calculate and display deed costs"
    echo "="*60
    echo ""
    echo "Usage:"
    echo "  ;deedcalc                    - Show current deed info and chart to max"
    echo "  ;deedcalc --level=X          - Show chart for GS3 level X"
    echo "  ;deedcalc --range=X..Y       - Show chart for deed range X to Y"
    echo "  ;deedcalc --level=X --range=Y..Z - Combine options"
    echo "  ;deedcalc --get              - Acquire 10 deeds (or up to max 200)"
    echo "  ;deedcalc --get=X            - Acquire X deeds (or up to max 200)"
    echo "  ;deedcalc --help             - Show this help message"
    echo ""
    echo "Examples:"
    echo "  ;deedcalc --level=5"
    echo "  ;deedcalc --level=4 --range=10..100"
    echo "  ;deedcalc --range=0..50"
    echo "  ;deedcalc --get              - Get 10 deeds"
    echo "  ;deedcalc --get=5            - Get 5 deeds"
    echo ""
    echo "Deed Acquisition:"
    echo "  Rubies cost: #{format_silver(RUBY_PURCHASE_COST)} silver each"
    echo "  Ruby value toward deeds: #{format_silver(RUBY_DEED_VALUE)} silver (3x purchase cost)"
    echo "  Maximum deeds: #{MAX_DEEDS}"
    echo "  The script will automatically:"
    echo "    - Calculate exact silver needed based on your current deeds"
    echo "    - Cap at #{MAX_DEEDS} total deeds (won't go over)"
    echo "    - Withdraw the right amount from bank"
    echo "    - Buy the needed rubies"
    echo "    - Offer them at the temple"
    echo ""
    echo "GS3 Level Formula (Legacy Experience Level):"
    echo "  First 50k exp: +1 level per 10k"
    echo "  Next 100k: +1 level per 20k"
    echo "  Next 150k: +1 level per 30k"
    echo "  Next 200k: +1 level per 40k"
    echo "  Afterwards: +1 level per 50k"
    echo ""
    echo "Note: Deed costs use the old GS3 level formula, not GS4 levels"
    echo ""
  end
  
  def self.parse_args(args)
    options = {}
    
    args.each do |arg|
      case arg
      when /--level=(\d+)/
        options[:level] = $1.to_i
      when /--range=(\d+)\.\.(\d+)/
        options[:range] = ($1.to_i..$2.to_i)
      when /--get=(\d+)/
        options[:get] = $1.to_i
      when '--get'
        options[:get] = 10  # Default to 10 deeds
      when '--help', 'help'
        options[:help] = true
      end
    end
    
    options
  end
end

# Main script execution
args = script.vars[1..-1] || []

if args.empty? || args.first.nil?
  DeedCost.show_current
else
  options = DeedCost.parse_args(args)
  
  if options[:help]
    DeedCost.show_help
  elsif options[:get]
    DeedCost.acquire_deeds(options[:get])
  else
    level = options[:level] || DeedCost.current_gs3_level
    range = options[:range] || (0..DeedCost::MAX_DEEDS)
    
    DeedCost.display_chart(level, range)
  end
end
