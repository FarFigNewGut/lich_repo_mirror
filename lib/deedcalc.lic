=begin
  deedcalc.lic: figure out how much deeds cost!

  Will calculate deed costs in silver based on current deeds and GS3 level.

            author: elanthia-online
              game: Gemstone
              tags: deeds
          required: Lich >= 5.12.9
           version: 1.0.0

  Improvements:
  Major_change.feature_addition.bugfix
  v1.0.0  (2026-02-06)
    - initial release

=end

require 'terminal-table'

module DeedCost
  MAX_DEEDS = 200 unless defined?(MAX_DEEDS)
  
  def self.calculate(deeds, gs3_level)
    ((deeds * deeds) * 20) + (gs3_level * 100) + 101
  end
  
  def self.current_gs3_level
    exp = Experience.exp
    
    case exp
    when 0..49_999
      # First 50k: +1 level per 10k
      exp / 10_000
    when 50_000..149_999
      # Next 100k: +1 level per 20k
      5 + ((exp - 50_000) / 20_000)
    when 150_000..299_999
      # Next 150k: +1 level per 30k
      10 + ((exp - 150_000) / 30_000)
    when 300_000..499_999
      # Next 200k: +1 level per 40k
      15 + ((exp - 300_000) / 40_000)
    else
      # 500k+: +1 level per 50k
      20 + ((exp - 500_000) / 50_000)
    end
  end
  
  def self.format_silver(amount)
    amount.to_s.reverse.gsub(/(\d{3})(?=\d)/, '\\1,').reverse
  end
  
  def self.display_chart(gs3_level, deed_range = 0..200, columns = 5)
    # Cap the range at MAX_DEEDS
    start_deed = [deed_range.first, 0].max
    end_deed = [deed_range.last, MAX_DEEDS].min
    
    deeds_array = (start_deed..end_deed).to_a
    rows = []
    
    # Split into chunks for multi-column display
    deeds_array.each_slice(columns).each do |chunk|
      row = []
      chunk.each do |deed_number|
        # Calculate cost using current deeds (deed_number - 1)
        cost = calculate(deed_number - 1, gs3_level)
        row << deed_number
        row << format_silver(cost)
      end
      # Pad the last row with empty cells if needed
      while row.length < (columns * 2)
        row << ''
        row << ''
      end
      rows << row
    end
    
    # Build column headers
    headings = []
    columns.times { headings += ['Deed', 'Silver'] }
    
    table = Terminal::Table.new do |t|
      t.title = "Deed Cost Chart (GS3 Level #{gs3_level}, Range: #{start_deed}..#{end_deed})"
      t.headings = headings
      t.rows = rows
    end
    
    respond table
  end
  
  def self.show_current
    fput('experience') # refresh Infomon tracking
    
    gs3_level = current_gs3_level
    current_deeds = Experience.deeds
    
    # Show chart from NEXT deed to max
    next_deed = current_deeds + 1
    display_chart(gs3_level, next_deed..MAX_DEEDS)
  end
  
  def self.show_help
    echo "="*60
    echo "DeedCost - Calculate and display deed costs"
    echo "="*60
    echo ""
    echo "Usage:"
    echo "  ;deedcost                    - Show current deed info and chart to max"
    echo "  ;deedcost --level=X          - Show chart for GS3 level X"
    echo "  ;deedcost --range=X..Y       - Show chart for deed range X to Y"
    echo "  ;deedcost --level=X --range=Y..Z - Combine options"
    echo "  ;deedcost --help             - Show this help message"
    echo ""
    echo "Examples:"
    echo "  ;deedcost --level=5"
    echo "  ;deedcost --level=4 --range=10..100"
    echo "  ;deedcost --range=0..50"
    echo ""
    echo "GS3 Level Formula (Legacy Experience Level):"
    echo "  First 50k exp: +1 level per 10k"
    echo "  Next 100k: +1 level per 20k"
    echo "  Next 150k: +1 level per 30k"
    echo "  Next 200k: +1 level per 40k"
    echo "  Afterwards: +1 level per 50k"
    echo ""
    echo "Note: Deed costs use the old GS3 level formula, not GS4 levels"
    echo "      Maximum deeds: #{MAX_DEEDS}"
    echo ""
  end
  
  def self.parse_args(args)
    options = {}
    
    args.each do |arg|
      case arg
      when /--level=(\d+)/
        options[:level] = $1.to_i
      when /--range=(\d+)\.\.(\d+)/
        options[:range] = ($1.to_i..$2.to_i)
      when '--help', 'help'
        options[:help] = true
      end
    end
    
    options
  end
end

# Main script execution
args = script.vars[1..-1] || []

if args.empty? || args.first.nil?
  DeedCost.show_current
else
  options = DeedCost.parse_args(args)
  
  if options[:help]
    DeedCost.show_help
  else
    level = options[:level] || DeedCost.current_gs3_level
    range = options[:range] || (0..DeedCost::MAX_DEEDS)
    
    DeedCost.display_chart(level, range)
  end
end