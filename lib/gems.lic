
=begin
Sets your active (equipped) gems. (Deactivates all active gems, then activates ONLY the ones you specify.)

Example: ;gems 1 4 6 15 20

Use with aliases or macro keys to switch between different gem profiles.

You can also do ";gems none" or ";gems clear" to unequip all gems without equipping any new ones.

author: Brute
=end

input = script.vars[0].to_s.strip.downcase

if input == "help"
	echo "Sets your active (equipped) gems. (Deactivates all active gems, then activates ONLY the ones you specify.)"
	echo "Example: ;gems 1 4 6 15 20"
	echo "Use with aliases or macro keys to switch between different gem profiles."
	echo "You can also do \";gems none\" or \";gems clear\" to only deactivate (unquip) all gems without equipping any new ones."
	exit
end

parts = input.split

unless parts.any? && parts.all? { |part| part =~ /\A\d+\z/ } || input =~ /none|clear/
	echo "You must provide at least one gem number to activate (equip), i.e. ;gems 1 4 6 15 20"
	exit
end

new_gems = parts.map(&:to_i)

if input =~ /none|clear/
	echo "Unequipping all active gems... Please wait..." 
else
	echo "Changing active gems to #{new_gems.join(', ')}... Please wait..."
end

gem_list_text = Lich::Util.quiet_command_xml("gem list all", /Gemstone/)

equipped_gem_ids = gem_list_text.grep(/Gemstone \d+: .*?\(equipped\)/).map do |line|
	line[/Gemstone (\d+):/, 1].to_i
end

equipped_gem_ids.each do |index|
	Lich::Util.quiet_command_xml("gem unequip #{index}", /Focusing briefly, you release your attunement|You don't currently have|That is not a valid Gemstone number/)
end

if input !~ /none|clear/
	new_gems.each do |index|
		Lich::Util.quiet_command_xml("gem equip #{index}", /Focusing briefly, you prepare your/)
	end
end

fput "gem list all"
echo "Done!"