############################################
# REAP.lic
# This script will check to see if you have
# less than 5 Shadow Essence and if you do,
# access all targets in the room looking for
# a suceptiable sacrifice target and then
# attempt to sacrifice it.
#
#
#
# Author = Hexbane
############################################

MAX_ESSENCE = 5

GOOD_PATTERNS = [
  /susceptible to manipulation/i,
  /enticingly frail/i
].freeze

BAD_PATTERNS = [
  /bond .* is indomitable/i,
  /bond .* is stalwart and formidable/i,
  /You think .* is suitable for animation/i,
  /bond .* is firmly bound/i
].freeze

ASSESS_LINE   = /You sense that the bond between/i
RESOURCE_LINE = /Accumulated Shadow essence:\s*(\d+)/i

# 709 Grasp of the Grave arms
ARM_TRASH_PATTERNS = [
  /\b(?:putrid|deformed|desiccated|skeletal)\s+arm\b/i,
  /\bpair of\s+(?:putrid|deformed|desiccated|skeletal)\s+arms\b/i
].freeze

############################################
# Helpers
############################################

def info(msg)
  Lich::Messaging.msg("info", msg)
end

def current_essence(timeout: 3.0)
  fput "resource"
  start = Time.now

  while (Time.now - start) < timeout
    line = get
    next unless line
    if (m = line.match(RESOURCE_LINE))
      return m[1].to_i
    end
  end

  nil
end

def alive_npc?(obj)
  return false unless obj
  return false unless obj.id
  name = obj.name.to_s.strip
  return false if name.empty?

  # Skip conjured 709 arms
  return false if ARM_TRASH_PATTERNS.any? { |r| name =~ r }

  # Skip dead creatures
  if obj.respond_to?(:dead?)
    return !obj.dead?
  end

  if obj.respond_to?(:status)
    return false if obj.status.to_s.downcase.include?("dead")
  end

  true
end

def find_obj_by_id(id)
  GameObj.targets.find { |o| o.id == id }
end

def assess_target(id, name_for_log = nil, timeout: 3.0)
  obj = find_obj_by_id(id)
  return :gone unless alive_npc?(obj)

  info("[REAP] Assessing #{name_for_log || "##{id}"}...")

  fput "assess ##{id}"

  start = Time.now
  while (Time.now - start) < timeout
    line = get
    next unless line

    return :good if GOOD_PATTERNS.any? { |r| line =~ r }

    if line =~ ASSESS_LINE
      return :bad if BAD_PATTERNS.any? { |r| line =~ r }
      return :unknown
    end
  end

  :timeout
end

############################################
# Main
############################################

info("[REAP] Starting...")

ess = current_essence
if ess && ess >= MAX_ESSENCE
  info("[REAP] Shadow essence is full (#{ess}/#{MAX_ESSENCE}). Exiting.")
  exit
end

targets = GameObj.targets.select { |o| alive_npc?(o) }

if targets.empty?
  info("[REAP] No valid living creatures detected.")
  exit
end

targets.each do |t|
  next unless alive_npc?(find_obj_by_id(t.id))

  result = assess_target(t.id, t.name)

  if result == :good
    info("[REAP] FOUND viable target: #{t.name} (##{t.id}).")
    fput "sacrifice ##{t.id}"
    info("[REAP] Done.")
    exit
  end

  sleep 0.10
end

info("[REAP] No susceptible/frail/animatable targets found.")
