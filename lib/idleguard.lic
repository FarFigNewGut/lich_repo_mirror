=begin
  ---------------------------------------------------------------
						idleguard.lic
   Keeps your GemStone IV session alive by issuing a periodic 
   TIME command and quietly suppressing its output.

   Author:   Witfog
   Version:  1.0.0
   Platform: Lich (Ruby)
   Purpose:  Prevents idle disconnects without spamming output.
   Tags: disconnect protect, idle keepalive, timeout

   Features:
     - Periodic TIME checks every ~5 minutes and quietly filters the response.
     - Clean exit & hook removal on script stop.
     - Lightweight and non-intrusive.

   Usage:
     ;idleguard

   Tip:
     - Station your guard permanently:
       ;autostart add idleguard
       ;autostart add --global idleguard

  ---------------------------------------------------------------
   Version History:
  ---------------------------------------------------------------
   v1.0.0 - 2025-11-10
     - Initial public release.
  ---------------------------------------------------------------
=end

toggle_unique
i_stand_alone
hide_me
silence_me

setpriority(-2)
debug = false

require 'securerandom'

# Unique hook name for this script instance
HOOK_NAME = "#{script.name}_#{SecureRandom.uuid}"
@guard_active = false

action = proc do |server_string|
	if @guard_active

		if server_string =~ /^Today is /
			Lich::Messaging.msg("info", "#{HOOK_NAME} - #{server_string}") if debug
			@guard_active = false
			nil
		else
			server_string		
		end
	else
		server_string
	end
end

DownstreamHook.add(HOOK_NAME, action)

def guard_me
	@guard_active = true

	fput("time")
	sleep(3)
end

# Main
begin
	Lich::Messaging.msg("info", "#{script.name} is guarding your idles!")
	loop do
		guard_me
		sleep(295)
	end
ensure
	begin
		Lich::Messaging.msg("info", "#{script.name}'s watch has ended.")
		DownstreamHook.remove(HOOK_NAME)
	rescue StandardError
	end
end
