=begin

  This script echoes every line to the familiar window, unless it
  has been seen more than five times before.

  It dynamically loads the most recent Lich
  map JSON file (map-*.json) and preloads all room descriptions
  into `room_descriptions`, so they are ignored immediately.

  It also ignores:
  - **Flare Patterns** (Everything from Flaretracker_2)
  - **Spell Messaging** (start/end spell messages from effect-list.xml)
  - **Weapon Techniques** (from PSM3 constants)
  - **Common Game Messages** (e.g., exits, player actions, etc.)
  - **Aggressive NPC Names**
  - **Gem Types**
  - **Skin Types**
  - **Herb Types**

  The script tracks and counts normalized (whitespace-stripped and numberless) lines.
  Any line that has been echoed more than 5 times is suppressed thereafter.

  Optional Arguments:
  - `;spamfilter reset` or `clear` - wipes the count cache
  - `;spamfilter #` - changes the repeat suppression threshold to a different number.  5 if you want to suppress a line after one appearance.

  Modified by: Phocosoen (ChatGPT)
		Original Authors: Alastir | Tillmen

=end

require 'json'
require 'rexml/document'

no_kill_all

module Spamfilter
def self.load_spell_messages_from_xml
  path = 'C:/Lich5/data/effect-list.xml'

  unless File.exist?(path)
    echo "[spamfilter: effect-list.xml not found at #{path}]"
    return []
  end

#  echo "[spamfilter: Loading spell messages from effect-list.xml...]"

  messages = []
  xml = REXML::Document.new(File.read(path))

  xml.elements.each('list/spell/message') do |msg|
    if msg.attributes['type'] =~ /^(start|end)$/i
      pattern = msg.text.strip
      pattern.gsub!(/\byour group\b/i, '.*?')
      pattern.gsub!(/\byou\b/i, '.*?')
      pattern.gsub!(/\s+/, ' ')
      pattern = pattern.strip

      begin
        messages << Regexp.new(pattern)
      rescue RegexpError => e
        echo "[spamfilter: Skipped invalid regex: #{pattern.inspect} - #{e.message}]"
      end
    end
  end

  echo "[spamfilter: Loaded #{messages.size} spell message patterns from effect-list.xml.]"
  messages
end

  @no_dmg_flare_patterns = {
  # Non-damaging flares
  Xazkruvrixis: /Your xazkruvrixis .*? emits an ominous black-green glow/,
  Wither_LoreBenefit: /A nebulous haze shimmers into view around .*?\, plunging inward in a dizzying spiral to envelop .*? completely/,
  Warding_Flare: /You hear a deafening wail as a ghostly white vapor surrounds you, swirling around your/,
  WThorns640_Poison: /One of the vines surrounding you lashes out at/,
  WThorns640_Block: /The thorny barrier surrounding you blocks the attack from/,
  VolnArmor_DSFlare: /Your .*? hums with spiritual force, filling you with a sense of divine vigilance and a preternatural awareness of/,
  VialFlare: /spits .*? vial out and onto the ground where it lands with a crystalline \*TINKLE\*./,
  Untrammel209_LoreBenefit: /you shifts abruptly, taking on an opalescent sheen that resists the web/,
  TwistedArmor_Augmentation: /The scintillating glow emanating from .*? on your .*? shimmers and intensifies as a pulse of energy surges around you, briefly coalescing into/,
  TrollHeart: /The .*? inside the necklace beats madly for a second as it pumps lifegiving blood back into your bloodstream, revitalizing you with its regenerative blood/,
  TBlood1125_StunBreak: /Though you are stunned and reeling, you become aware of your pounding heart.  With each beat, it grows louder and louder, faster and faster, until, with a sudden surge of strength, you throw off your stunned state!/,
  TBlood1125_LoreBenefit: /The scar on your .*? glows faintly white before fading altogether/,
  TBlood1125_Healing: /The bruises around your|The cuts on your .*? close and the bruises fade/,
  TotemAnimalistic: /flows from it and over your exposed skin, imbuing a sudden rush of power from/,
  TotemBestial: /the semitransparent figure moving to try to shield you from the attack/,
  TotemShifting: /the motes encasing your arm in incandescence as a rush of power sinks into you to strengthen your attack/,
  TotemFeral: /your vision briefly obscured with a bloody haze as a rush of strength surges into your limbs/,
  Tome_Spellwarden: /As you stare at the words, you feel the weight of tactical knowledge build in you, allowing you to better protect yourself/,
  TWard503_LoreBenefit: /The glowing specks of .*? surrounding you intensify/,
  Terror_Flare: /Your .*? releases a distorted black shadow at|A wave of wicked power surges forth from your/,
  TReversion540: /Your surroundings melt away as the air around you shivers with a large flux of mana. Abruptly, time wrenches violently to give you a second chance. This time, you're better prepared/,
  TVerdict1603_Zealot: /Your surroundings take on a violet sheen as you burn with zealous fervor/,
  SteelSkin_Flare: /You exhale in pain as your skin rapidly hardens into a shimmering barrier/,
  Sprite_DefensiveFlares: /The .*? sprite on your shoulder projects a .*? barrier in front of you/,
  Spritely_Maneuvering: /The .*? sprite on your shoulder projects a .*? barrier, shielding you/,
  Spritely_Intervention: /You feel yourself being pulled upright as an .*? barrier appears in front of you/,
  SStrike117_LoreBenefit: /The invisible force draws back to guide you once more/,
  Spore_Symbiosis: /Energy flows through you as .*? coax power from the symbiotic environs/,
  Spore_Environment: /As though invigorated by the subterranean surroundings, the agglomeration of .*? bloats, then releases a flurry of .*? spores/,
  Spore_Dispersion: /The dusty haze also entwines around .*? in a corkscrew of .*? spores|A dusty haze carries countless glowing spores to .*?/,
  SWardingII107_LoreBenefit: /Starburst patterns of pale blue light sweep forward from your chest and infuses the deep blue glow with its energy/,
  SWard319: /The evanescent shield shrouding you flares to life/,
  Somnis: /For a split second, the striations of your .*? expand into a sinuous pearlescent mist that rushes towards the/,
  SigilStaff_DoubleCast: /twining into an echo of your last spell/,
  Sigil_of_Binding: /A bolt of energy leaps from your .*? within bands of concentric geometry/,
  ShieldCape_Block: /forms a shield in front of you that turns solid enough to block .*? incoming blow/,
  SerendipitousHex_GS: /your forearms as your spell reforms into a hex/,
  Rusalkan: /Exploding in a tumbling current of frothy foam, a wave of sea water suddenly materializes at the call of your/,
  RangerTrinket_Resistance: /pulses briefly, deflecting some/,
  RangerTrinket_ManaAbsorb: /The .*? essence is drawn toward your/,
  RFire515_NoCooldown: /Moisture beads on the surface of your skin then evaporates away, taking with it your recent elemental fatigue/,
  RFire515_Channel: /Seeing an opportunity, you accelerate time and empower your spell/,
  Parasitic_BloodMatch: /A cascade of needle-like appendages puncture your flesh beneath your .*? as you are suddenly healed\!/,
  Parasitic_Bulwark: /Your .*? glisten as a sudden rush of blood spills across its surface, creating a magical bulwark against/,
  Parasitic_Defense: /Several .*? reinforce your .*? to defend you against the incoming attack/,
  NightshroudCloak_Hide: /a cyclone of shadows emerge from your .*?.  The shadows swirl around in an attempt to conceal you/,
  NTouch625_ArcaneReflex: /Vital energy infuses you, hastening your arcane reflexes/,
  NTouch625_PhysicalProwess: /The vitality of nature bestows you with a burst of strength/,
  MinorFire906_Ignite: /Some of the flames from the stream of fire linger around .*?/,
  MechanizedArm_Block: /Just as .*? attacks, your arm suddenly swings out and intercepts it!/,
  ManaArmor_ManaShield: /latticework springs up from the surface of your .*? and shields you from some of the damage/,
  ManaArmor_ManaFlares: /radiates from your .*? and you feel .*? mana surge into you\!| returning to you with an audible \*WHOOSH\*/,
  MArmor520_Water: /The raw elemental energy surrounding you takes on a watery look as it/,
  MArmor520_Earth: /The energy surrounding you condenses into hard stone/,
  LuckTalisman_Offensive: /You hear the soft tinkle of rolling dice, followed by the sound of coins dropping/,
  LuckTalisman_Defensive: /You hear the soft tinkle of rolling dice, followed by a faint lucky feeling/,
  LowSteel_HorrificVision: /you, but freezes momentarily before madly clawing/,
  Lathonian: /your .*? suddenly begins to glow with a polychromatic light/,
  KroderineChains: /Your kroderine chains rapidly consume the magical power of the attack/,
  Kroderine: /Your .*? cast. The magic of the spell is instantly devoured by the/,
  GlovesofTonis: /A forceful squall suddenly shoots through your .*?, drawing your movements along their intended path/,
  Ghezyte: /Cords of plasma-veined grey mist seep from your/,
  ForestArmor_WindGust: /A spiraling funnel of air bursts from your/,
  ForestArmor_LeafSwirl: /Diamond-shaped leaves sprout from your/,
  ForestArmor_MudSling: /A thick clump of mud catapults from your/,
  ForestArmor_WoodlandEmpathy: /you suddenly have a clearer understanding of nature/,
  FReward115: /The dull golden nimbus surrounding you flares into life as it glows brightly for a moment/,
  FReproach312_WisdomBonus: /The .*? sphere begins to move in an ever-increasingly fast circle above your head until it shatters into a shower of brilliant energy/,
  Ethereal_Armor: /ethereal chains encase your body against/,
  EonakArm_Block: /your arm suddenly swings out and intercepts it/,
  Ensorcell_Health: /You feel healed/,
  Ensorcell_Mana: /You feel empowered/,
  Ensorcell_Spirit: /You feel rejuvenated/,
  Ensorcell_Stamina: /You feel reinvigorated/,
  Ensorcell_AS_CS: /You feel energized/,
  Elven_SpellBarrier: /Strands of translucent mana swirl about you, creating a protective barrier/,
  Elven_SpellAlacrity: /Your .*? flares with a pale light/,
  ElementalDefenderRing: /The .*? on your .*? flares brightly as it absorbs the .*?/,
  ETargeting425_LoreBenefit: /elemental energy energizes you/,
  EDeflection507_LoreBenefit: /A shimmering field of energy flashes around you, reflecting/,
  EDefenseIII414_LoreBenefit: /A heavy barrier of stone momentarily forms around you/,
  EBias508_LoreBenefit: /Your magical awareness grows more acute for an instant/,
  EBarrier430_LoreBenefit: /Your skin hardens for a moment and softens/,
  Dramatic_Drapery_Wondorous: /Branching filaments of power snap outward from your/,
  Dramatic_Drapery_Masquerade: /distorts the air around you, confounding an/,
  Dragonclaw1209_Flare: /As you strike, a deep golden light surrounds your/,
  Death_Flare: /Your .*? emits an ominous black-green glow/,
  CursedArmor_Calm: /as your vision burns with hypnotic resolve/,
  CursedArmor_DS_TD: /Dark tendrils lash out from your .*? and form a crimson-runed shroud of darkness around you/,
  CursedArmor_AS_CS: /Dark tendrils lash out from your .*? and invigorate your resolve/,
  Bubble: /high-pitched sound and causes your skin and muscles to/,
  Breeze612_Tailwind: /A favorable tailwind springs up behind you/,
  Breeze612_Offensive: /is buffeted by a burst of wind and pushed back|is buffeted by a sudden gust of wind/,
  Brace1214_Parry: /Using the bone plates surrounding your forearms, you parry the attack/,
  Brace1214_Disarm: /strikes one of the bony protrusions on your forearms and it is wrenched out of/,
  BootsofTonis: /you, a swirling whirlwind bursts into life around your form. Time seems to slow to a crawl as the turbulent winds guide your movements, allowing you to avoid the assault/,
  BShatter1106_LoreBenefit: /The internal skeletal structure of .*? implodes inward upon itself/,
  Blink1215: /You find yourself moved several feet from your original position/,
  Blink: /Your .*? suddenly light(s)? up with hundreds of tiny blue sparks/,
  Benediction307_LoreBenefit: /Pearly light flares up suddenly from within you, lending strength and focus to your attack/,
  Barkskin605: /The layer of bark on you hardens and absorbs/,
  Banshee: /emits a deafening wail as a bright red glow erupts from its surface, surrounding you/,
  BalanceFrenzy_Flare: /The .*? flashes a shade of scarlet|The .*? flashes a shade of viridian/,
  BalanceFrenzy_DoubleFlare: /The .*? is suddenly engulfed in scarlet light|The .*? is suddenly engulfed in viridian light/,
  ASpear1408_Dispel: /With an opaline flare, the nacreous spear passes through .*? , disrupting the veil of wards surrounding/,
  Animalistic_InstinctFlares: /up from the point of impact, spreading over the chest of your/,
  Aganjira: /Mana cascades across your .*?, causing the fabric to shiver against your skin as it draws the scattered power into it and transforms it into mana/,
  Adamantine: /the incredibly hard surface of your adamantine/,
  Acuity_Flare: /Your .*? glows intensely with a verdant light\!|form before shifting its focus toward you, setting your .*? aflame for a brief momen/
}

  @dmg_flare_patterns = {
  # Damaging flares
  Acid_Flare: /\*\* Your .*? release(s)? a spray of acid|Luminescent green droplets dribble from your .*? and puddle mid-air, creating a large globule of sizzling liquid that bursts over|Without warning, an ominous cloud forms overhead and churns violently, raining blistering droplets of acid down upon .*? until the fog is sucked into your|Dripping ectoplasma, off-white ghosts rise out of your .*? and sail through the air, passing in and out of .*? before dissipating with a low moan/,
  Air_Flare: /\*\* Your .*? unleashes a blast of air|Your ears pop as the air pressure suddenly drops, and a fierce tornado coalesces around .*?, spinning .*? violently in the air for a brief moment before the winds die down/,
  Air_LoreFlare: /A fierce whirlwind erupt(s)? around .*? encircling .*? in a suffocating cyclone/,
  Air_LoreFlareDoT: /The cyclone whirls around .*? anew/,
  Air_GEF: /\*\* A howling gale of steaming air rushes from .*?/,
  Animalistic_FuryFlares: /slender tendrils rising up to coalesce into the ethereal form of/,
  Balefire_DemonAttack: /shudders slightly as chaotic energy is drawn from its form and fused with the attack/,
  BallSpell_Splash: /A burst of .*? from your .*? flies off and hits/,
  Blessing_LoreFlare: /A reassuring feeling of mental acuity settles over you|Your mind clears as a wave of energy washes over you|Your resolve feels bolstered as the energy courses through you|The pulse leaves you feeling spiritually emboldened|A stirring force ignites within you\, augmenting your spirit|A resonant force ripples through you\, amplifying your spirit|A surge of spiritual power rushes through your veins/,
  Briar: /Vines of vicious briars whip out from your/,
  ChainSpear: /The .*? head of your .*? catches across .*?/,
  ChronomageDagger: /Taking a chance you hurl .*? at .*? again and suddenly everything returns to normal speed as time catches up with itself/,
  CloakofShadows_Retribution: /A dark shadowy tendril rises up from your skin/,
  Cold_Flare: /\*\* Your .*? glow(s)? intensely with a cold blue light|A thin stream of icy cold liquid shoots forth from your|Trailing snowflakes in their wake, bright purple and azure ghosts rise out of your .*? and sail through the air, passing in and out of .*? before dissipating with a low moan/,
  Cold_GEF: /\*\* A vortex of razor-sharp ice gusts from .*? and coalesce(s)? around a .*?\! \*\*/,
#  Coraesine_Old: /Coraesine_Old/,
  Coraesine_Pure: /A massive vortex of shrapnel-laden air coalesces around|You feel the .*? respond to your will, and suddenly it flares up with a blazing white-grey aura\! Vicious winds curl around you in a spiraling vortex, increasing your momentum as you let loose a lightning-quick strike/,
  CoraesineRelic: /\*\* The coraesine relic on your/,
  Daybringer_Script: /\*\* A torrent of .*?\-colored plasma bursts forth from your .*? at/,
  Nightbringer_Script: /\*\* coil of *?\-colored energy lashes out from your .*? at/,
  DayNightbringer_AnomalyFlare: /\*\* A .*?\-colored beam of light erupts from the .*? light at/,
  Demonology_LoreFlare: /Shadowy claws of pure essence burst from .*?\, tearing at the air surrounding/,
  Demonology_LoreFlareDoT: /Shadowy tendrils coil around .*?\, swiftly siphoning away ambient energy/,
  Disintegration_Flare: /\*\* Your .*? release(s)? a shimmering beam of disintegration|Momentarily illuminated by a nefarious veil of light that emanates from your/,
  Dispel_Disruption: /\*\* Your .*? glow(s)? brightly for a moment, consuming the magical energies around .*?\!|Afterimages of your .*? manifest around/,
  Dispel_FluxCrit: /fluxes chaotically/,
  Disruption_Flare: /\*\* Your .*? release(s)? a quivering wave of disruption|An unnatural shift in atmospheric pressure causes intense and harsh bursts of air that yield a violent, resonant attack on/,
  Earth_LoreFlare: /Chunks of earth violently orbit .*? pelting .*? with heavy debris/,
  Earth_LoreFlareDoT: /The ground trembles violently, pelting .*? again/,
  Earth_GEF: /\*\* A violent explosion of frenetic energy rumbles from .*?/,
  Energy_Weapon: /A beam of .*? energy emits from the tip of your .*? and collides with .*?/,
  Fire_Flare: /\*\* Your .*? flare(s)? with a burst of flame|Emerging from your .*?, a massive ball of flames coalesces and launches straight toward|Flames form like deep scarlet-orange ribbons around your|Searing heat ripples the air as bright orange and green ghosts rise out of your .*? and sail through the air, passing in and out of .*? before dissipating with a low moan/,
  Fire_LoreFlare: /A blazing inferno erupts around .*? scorching everything in its wake/,
  Fire_LoreFlareDoT: /The inferno blazing around .*? ignites anew/,
  Fire_GEF: /\*\* Burning orbs of pure flame burst from .*?/,
  Firewheel: /Your .*? emits a fist-sized ball of lightning-suffused flames/,
  GlobusElanthias: /Rising from the .*? that is wedged into your .*?/,
  GlobusNaidem: /Lashing out from your .*?, .*? extends one hand and rakes a claw across .*? flesh|Boils on .*? skin grow overly full and eventually burst, causing pus to leak from the new wound/,
  Grapple_Flare: /Your .*? release(s)? a twisted tendril of force|Catapulting from your .*?, a thick, braided rope twists and twines around|Twisting and cavorting in the air, distorted purple-tinged ghosts rise out of your .*? and sail through the air, passing in and out of .*? before dissipating with a low moan/,
  GreaterBlackOra: /A low moaning emanates from your .*? as the shadows swirl off and surround .*?, assaulting it with flashes of greenish-black essence|As you attack .*?, the shadows surrounding your .*? swirl off and strike|As you land your blow, the shadows surrounding .*? begin to swirl like a miniature vortex. The greenish-black essence batters .*?|As you strike .*?, the shadows surrounding .*? swirl off and strike|As your .*? connects with .*?, a low hiss is heard and the shadows strike with greenish-black essence fangs|Dancing bursts of greenish-black essence pulse from your .*? as the shadows lengthen and extend to assault .*?|The shadows surrounding your .*? lash out with a crack of greenish-black essence/,
  GreaterRhimar: /A suffusion of frost flashes down the length of .*? as a tongue of snow and ice lashes at .*?|From somewhere nearby, a snowball comes whizzing towards .*?, splattering as it connects/,
  GuidingLight_2ndFlare: /Your .*? spray(s)? with a burst of plasma energy/,
  HolyFire: /Your .*? bursts alight with leaping tongues of holy fire/,
  HolyWater: /Your .*? spray(s)? forth a shower of pure water/,
  Ice_GEF: /\*\* A vortex of razor-sharp ice gust(s)? from .*?/,
  Impact_Flare: /\*\* Your .*? release(s)? a blast of vibrating energy|A thunderous boom emanates from your .*? as earthen rubble and debris surges upward|Releasing sonic-like detonations with their screams, dull grey and black ghosts rise out of your .*? and sail through the air, passing in and out of .*? before dissipating with a low moan/,
  Knockout: /Your .*? bounce off the head of .*?, causing .*? to reassess the situation for a moment while standing still|A solid strike from your .*? to the temple causes .*? to stumble|You land a vicious blow to the head of .*?|your .*? bounce off the head of .*? causing it to|bringing your .*? down across the head of .*? with a sickening thud|You feint left, then right, then crack .*? across the head|crack(s)? the .*? on the back of the head|Your .*? thump .*? in the head.  .*? stumbles around for a moment desperate to keep .*? balance but in the end .*? fails miserably, and collapses to the floor in a heap, looking dazed|then reverse direction and crack|Your .*? plow right into the forehead of/,
  Lightning_GEF: /\*\* A vicious torrent of crackling lightning surges from .*?/,
  Lightning_Flare: /Your .*? emit(s)? a searing bolt of lightning|Gathering around your .*?, a pulsating light grows in intensity until a shocking eruption of energized power scorches|Filling the air with static electricity, bright white and orange ghosts rise out of your .*? and sail through the air, passing in and out of .*? before dissipating with a low moan/,
  LowSteel: /Your lowsteel .*? unleashes a blast of psychic energy/,
  LowSteel_DoT: /convulses in horrified agony/,
  Manipulation_LoreFlare: /Loose debris tears itself upward around .*?\, spinning wildly before rocketing towards/,
  Manipulation_LoreFlareDoT: /Debris continues to batter .*? from every angle\, slamming into .*? with relentless force/,
  Magma_Flare: /\*\* Your .*? expel(s)? a glob of molten magma|Your .*? a blood red hue, and tall mounds of crimson and carmine liquid bubble up from beneath|Your .*? vibrates violently and a swarm of phantoms appears and unleashes a horrific assault on .*?, threads of black energy rippling through the air back to you/,
  Mana_Flare: /Your .*? pulses with a white-blue light\!/,
  Mechanical_Flare: /Your .*? releases a small spring-loaded/,
  MechanicalQuiver: /The tip of the spiraled arrow suddenly shatters and bursts .*?/,
  MindWrack_Flare: /Your .*? unleashes a blast of psychic energy/,
  MinorAcid904_Melt: /Acid continues to eat away at .*?/,
  MinorFire906_Burn: /The flames around .*? continue to burn/,
  MinorShock901_StunShock: /Tiny arcs of lightning briefly dance across .*? skin/,
  MinorWater903_Soak: /The water completely drenches .*?/,
  NebularWeapon: /Cold as the great void, the silvery power of starlight channels through your/,
  Necromancy_LoreFlare: /\*\* A sickly green aura radiates from/,
  Necromancy_LoreFlareDoT: /Small pieces of flesh rot off a/,
  Nerve: /Several thin, fibrous .*? filaments erupt from your/,
  Pestilence716_Reactive: /You exhale a virulent green mist toward/,
  Pestilence716_DoT: /Pus-filled sores erupt|Boils rupture all over|skin hardens into a black rot and begins to crumble|wails as painful boils form and erupt|begins hemorrhaging from multiple orifices/,
  Plasma_Flare: /\*\* Your .*? pulse(s)? with a burst of plasma energy|Splashing magma everywhere, charred red ghosts rise out of your .*? and sail through the air, passing in and out of .*? before dissipating with a low moan/,
  Parasitic_BloodFlares: /You wince as .*? draws upon your blood as it strikes/,
  Religion_LoreFlare: /Divine flames kindle around .*? leaping forth to engulf/,
  Religion_LoreFlareDoT: /The sacred inferno surrounding .*? ignites anew/,
  ShieldCape_BroochFlare: /attached to the left shoulder of your .*? suddenly explodes with a brilliant flash/,
  ShadowDeathWeapon: /Ravenous tendrils of shadow burst forth from .*?, draining the very life from .*?/,
  SigilStaff_Dispel: /Tendrils of .*?? energy lash out from your .*?? toward .*?? and cage/,
  Smite302_Infusion: /With a sudden burst of divine insight, you're able to amplify the power of your/,
  Smite302_InstantDeath: /A minuscule blue-white star slowly ascends from the floor directly under the|A triad of ebony orbs conjoined by crackling ribbons of violet energy suddenly appear out of nowhere/,
  SolarWeapon: /Searing hot, the golden power of the sun is channeled through your/,
  SonicWeapon_1stFlare: /Your .*? unleashes a blast of sonic energy at/,
  SonicWeapon_2ndFlare: /With a loud snap, a blast of energy bursts from your .*?/,
  Spikes: /\*\* A spike on your .*? jabs into .*?\! \*\*/,
  SpiritGauntlet: /Your bolt of energy suddenly bursts, scattering into particles|The diffuse golden particles swirl and collapse in on themselves, centered on/,
  Spore_Flare: /Nebulous .*? tendrils curl from your .*?, enswathing .*? in a shroud spangled with .*? spores/,
  Spore_Burst: /The .*? spores churning around simultaneously burst into an explosion of coruscating/,
  SSlayer_240: /Abruptly, you sense the attention of your spirit slayer focus upon an .*?/,
  Steam_Flare: /\*\* Your .*? erupt(s)? with a plume of steam|Causing the air to sizzle and shimmer, hissing translucent ghosts rise out of your .*? and sail through the air, passing in and out of .*? before dissipating with a low moan/,
  Steam_GEF: /\*\* A howling gale of steaming air rushes from/,
  Summoning_LoreFlare: /A radiant mist surrounds .*? unfurling into a whip of plasma/,
  Summoning_LoreFlareDoT: /The whip of plasma continues to wreathe/,
  Telepathy_LoreFlare: /Rippling and half-seen, strands of psychic power unravel from the/,
  Telepathy_LoreFlareDoT: /Locked in mental durance, .*? is assailed by some unseen attack\!/,
  Tome_Spellglider: /your .*? unleashes a dazzling arcane projectile/,
  Tome_Spellweaver: /Arcane energy streaks toward .*? and collides in a volatile clash of mana and matter/,
  Tome_Spellvault: /is buffeted by the corruscating arcane energy/,
  Transformation_LoreFlare: /Dozens of needle-like tendrils explode from your forearms, striking toward .*? with murderous intent|The sound of snapping bone fills the air as jagged spikes tear free from your wrists, driving deep into|Sharp tendril-like appendages erupt from your shoulders, lashing forward to skewer|Bone explodes around your fists, solidifying to form colossal gauntlets that hammer down on|A visceral snap accompanies the eruption of jagged spikes from your wrists as you drive your palm into|The sound of ripping flesh is drowned out by your roar as wicked blades erupt from your knuckles, raking through|A searing heat floods your hands as razor-sharp claws explode from your knuckles, cleaving through/,
  TwinWeapon_Detonation: /Tendrils .*? energy lash out from your/,
  Twisted_Flare: /\*\* A scintillating .*? glow shimmers and oscillates across your/,
  Unbalance_Flare: /\*\* Your .*? unleashes an invisible burst of force|With a loud \*\*BOOM\*\* from your|Cackling and cajoling herald a wavering energy wrought in the ethereal shape of ghosts that rise out of your .*? and sail through the air, passing in and out of .*? before dissipating with a low moan/,
  Vacuum_Flare: /your .*? seems to fold(s)? inward and draws its surroundings closer|your .*? seems to fold inward upon itself drawing everything it touches along with it|Thin strands of black matter surge forth from your .*? toward|Drawing the air from the area, ebon and orange ghosts rise out of your .*? and sail through the air, passing in and out of .*? before dissipating with a low moan/,
  Valence_LashofLoraetyr: /Several archaic sigils flash briefly along your .*? and you begin to grow translucent, shifting in and out of view as gnarled ethereal vines erupt from your body and lash out at .*?, each one solidifying before they strike/,
  Valence_SliceofShientyr: /A coil of spectral .*? energy burst(s)? out of thin air|A coil of ghostly .*? energy burst(s)? out of thin air|A coil of eerie .*? energy burst(s)? out of thin air|A coil of celestial .*? energy burst(s)? out of thin air/,
  Vethinye: /it entwines you in night blue wisps of ephemera/,
  VibrationChant_Shatter: /You focus your voice on .*? with perfect resonance, causing it to shatter into thousands of tiny pieces/,
  Void_GEF: /\*\* A nebulous dome of .*? discharge(s)? from .*?/,
  Water_Flare: /Your .*? shoot(s)? a blast of water|Funneling upward, a spout of water streams from your .*? and begins to spin rapidly as it moves forward, ravaging/,
  WildfireOil: /A swirl of alchemical fire, scintillating blue and orange in hue, erupts from your/,
  WebbingCaughtFire: /The webbing around .*? catches fire/,
  WEntropy603_Dot: /Patches of discolored rot spread further, eating away at/,
  FAura1706: /The flaming aura surrounding you lashes out at .*?\!/,
  Fervor1618: /Your .*? surges with power as .*? coalesces around it/,
  ELink1117_Overload: /An overload of mental energies pulse through your link/,
  ELink1117_Propagation: /Ripples of wavering energy coalesce around/,
  MArmor520_Fire: /The fiery torrent of energy surrounding you flares toward/,
  BS_Reckoning: /With a deafening crack of thunder, a frayed bolt of violet-hazed lightning spears the .*?|Peals of laughter, bright and sharp, echo in your ears, transfixing the .*?|Falling like a hammer from the sky, a golden light strikes the .*? with resounding force\!|Tangled briars rise to catch the .*? on their thorns\!|Subtly tinted mists daub themselves upon the .*? , leeching away color\!|Cast in radiant outline, a massive silver fist closes tight around the .*?|Brazen and implacable, the light of judgment crashes down upon the .*?|A chill crystallizes the air, and the .*? is engulfed by a blazing, ice-bright vortex\!|Spinning rings of gem-bright color coalesce around the .*? and flare to brilliance\!|Warmth blooms at the .*?'s heart, quickly kindling into burning flame\!|Heat gathers and blossoms, bathing the .*? in the blistering brilliance of the sun\!|Darkness gathers around the .*? \, speared through by pinpoints of white fire\!|The very air rips past the .*? in a gold-streaked blur, chased by an echo of wings\!|Striking swift and vicious, unseen claws rake at the .*? , and hidden teeth bite\!|Cruel, glittering flames born of darkness erupt around the .*?|Crackling and luminous, gold and silver threads of pure magic slice at the .*? with alacrity\!|Smoke drifts in languid coils, entangling the .*? in its smothering embrace\!|Glistening and dark, a soul-sucking maw manifests behind the .*? as attenuated fangs descend\!|Hissing darkness, acrid and caustic, assaults the .*? in a flurry of lashing tentacles\!|Laid open by sorrow made manifest, the .*? keens in pain\!|Night falls, bearing the .*? down beneath a crushing wave of fear\!|Harsh battle cries frenzied with bloodlust split the air and tear into the .*?|With a sonorous knell, a frigid wind overtakes the .*?|A bewildering frenzy of silver spins around the .*? in dizzying assault, moon-bright and night-dark by turns\!|A haze of golden motes envelops the .*? within its cloying embrace\!|A sinuous shimmer of violet scales slices across the .*? , bleeding crimson in its wake\!|Threads of glistening silk wind around the .*? and pull taut\!|Slithering whispers encircle the .*? in aqueous trails of silvery mist\!|With a vengeful hiss, a phantasmal arc of star-bright silver slices into the .*?|A ferocious downdraft assaults the .*? with the thunder of countless wings\!|Verdant vines enfold the .*? in their leafy embrace\!|A smothering veil of violet-sparked ash billows over the .*? , searing where it touches\!|The .*? is beset by a brilliant flurry of flashing blades\!|A liquid surge of silvery power breaks against the .*? , scattering in salty spray\!|Striking out of the darkness, unseen daggers stab at the .*? from behind\!|Motes of color swirl up around the .*? in a frenetic dance, bursting with sudden and percussive force\!|Flickering yellow and red, rebellious sparks billow up around the .*? in a blistering brume\!|Purifying white fire envelops the .*? , casting him in blackened silhouette\!|Rippling twilight envelops the .*? in banded hues of dusk and dawn\!/,
  BS_HallowedReprisal: /Fiery red barbs uncoil from the shadows nearby and lash out at/,
  BS_DivineBulwark: /.*? shield springs into being between you and your attacker to temper the blow\!/,
  FatalAfflares: /A torrent of thick crimson blood rains down upon .*?, quelling .*? form\!|Pouring from your .*?, a sinister veil of mist shrouds .*? in suffocating tendrils of obscurity\!|light project from your .*? eyes toward .*? in a brilliant blast, knocking .*?|Mighty hooves drum the .*? as a tide of spectral buffalo thunders forth, trampling .*? in its chaotic path|Spiraled rakka horns burst from the .*? and propel maliciously upward along .*? form|Scythe-shaped rolton horns burst from the .*? and slice wickedly upward, cutting along .*? form|Crimson and gold wings sprout from your .*? and flutter toward .*? before growing to a magnificent size to envelop .*? in a mighty stranglehold|Intense .*? flames radiate from your .*? and surround .*? in a powerful rage|Your .*? with primal force as bone fragments rain down upon .*?|Threads of .*? energy project outward from your .*? and slice through .*?|Crackling with fiery might, your .*? a searing volley of fireballs that soar like meteors toward .*? and explode on contact|Your .*? a series of pulsating, blinding lights that scorch and sear .*?, a pungent odor of burning flesh lingering in the air|Strands of viscous white webbing covered with hundreds of black widow spiderlings spurt forth from your .*? and envelop .*? in a strangling constraint|With a bloodthirsty howl, a snarled and hideous jackal lunges forth from your .*? and rips ruthlessly at .*? with its powerful fangs|An ominous buzzing emanates from your .*? as a calamitous swarm of giant hornets besieges .*? with their torturous stingers|Materializing above, two enormous, clenched fists slam down forcefully upon .*? with brutal strength|Thorny vines and mold-infested roots emerge from the .*? beneath .*?, winding viciously around .*? with destructive results|Cracked and splintered bones propel rapidly from your .*? and strike .*? in a merciless onslaught|A thick, yellowish fog engulfs .*?, causing tiny pustules to form and burst into thousands of flesh-hungry botflies|Slick viridian snakes wriggle from the end of your .*? and slither along the .*? to .*?, where they unleash a brutal, venomous assault|Hundreds of razor-sharp daggers discharge from your .*? in a virulent barrage to mutilate .*?|Materializing in thin air, a thick, rusty iron collar forms around .*? and clamps shut, constricting all air flow|Waves of luminous energy pour from your .*? and assault .*? with a ruthless barrage of arduous strikes|An intense rush of energy spews from your .*? and engulfs .*? with an unrelenting dynamic attack|Your .*? a blizzard's wrath\!  Ice shards and snowflakes converge to engulf .*? in a relentless storm of freezing fury|Your .*? with airy energy, sculpting zephyrs into a symphony of cyclonic tempests that whips violently around .*?|Bursting from your .*?, a thick, flour-like cloud forms above .*? and splits open to drop a barrage of petrified biscuits onto .*? that disintegrates after impact|Giant claws unfurl from your .*? and scratch viciously at .*?, mauling .*? with unbridled furor|Luminescent motes of .*? eject from your .*? and propel toward .*? with increasing speed, finally bursting in a blinding flash|Your .*? rhythmically as a cacophony of ear splitting sounds assaults .*? from all directions|Dust particles swirl intensely and coalesce to form an elongated, open-mouthed macabre face that discharges a deafening, ear piercing wail directly at .*?|Reaching outward from your .*?, a ghastly pair of spectral hands grabs and claws ferociously at .*?|A miniscule orb of light floats from your .*?, hovering mid-air and gradually expanding to become a ghostly likeness of you\!  With a savage howl, the shadowy image unleashes a mighty attack on .*?|For a brief moment, your .*? in and out of existence, an enormous spectral skull appearing long enough to open its immense mouth and chomp down upon .*?|Flailing and spinning wildly, a whirlwind of tiny whips bursts from your .*? and violates .*? with a brutal slashing assault|Thin blades of grass fall from your .*? as a spectral doe appears in front of .*?, hind legs kicking and flailing in a protective whirlwind attack|a slit-pupiled eye bursts from your .*? and issues a chilling, intimidating stare directly at .*?|Black sparks emanate from your .*? as a silver-edged black sword appears and begins to repeatedly slash at .*?|Sparks of deep blue shimmer into existence from your .*? as an emerald trident appears and begins to repeatedly stab at .*?|With a loud cracking noise, tiny eggs spill forth from your .*? onto the .*? and erupt, birthing miniature roltons that begin to gnash viciously at .*? with their curved incisors before disappearing|With a loud cracking noise, tiny eggs spill forth from your .*? onto the .*? and erupt, birthing a cluster of rattlesnakes that repeatedly lash out and bite .*? with razor-sharp fangs|Gangly black tentacles sprout upward from the .*? and wrap around .*?, constricting .*? with brutal force|As brilliant as the sun, radiant beams surge forth from your .*? and burn .*?, leaving a stench of scorched matter in the air|A cacophony of sound blares from your .*?, surrounding .*? in a barrage of confounding noise|With a loud cracking noise, translucent eggs spill forth from your .*? onto the .*? and erupt, birthing albino tomb spiders that begin to devour .*? viciously with their glistening fangs before disappearing|Green sparks seep from your .*? and diverge through the air as a grey sickle appears and begins to hack and slash viciously at .*?|Thick, smoky wisps of jade ooze sinuously from your .*? and entwine around .*? in a strangling embrace/,
  QuintonManse: /Your .*? pulse(s)? with a deep purple and black hue, growing in intensity as energy is sucked from|With organized chaos, a massive stampede of spectral horses charges .*?, trampling .*? with unremitting fury|Breaking up through the .*?, bony claws grasp at .*?, stabbing .*? ruthlessly with disgusting, grimy nails|Two silver rods propel forth from your .*? and skewer .*? straight through the head, grey matter dripping from .*? cavernous puncture wounds|Your .*? catapult(s)? rapidly toward .*? as it delivers a grisly attack before earnestly returning to your possession|A thick black haze surrounds .*? as hundreds of skeletal hands form within the fog, ripping and clawing at .*? viciously|Leafy green tendrils swirl along the .*? toward .*? and rise upward, evolving into an overwhelming agglomeration of rancid pumpkins that pummel .*? mercilessly|A series of cacophonous caws and screeches fills the air as a murder of crows appears out of nowhere, swarming .*? and pecking .*? relentlessly|Oozing from your .*?, a black viscous substance is harbinger to a wormlike entity that lunges at .*? with a wide gaping maw and razor-sharp teeth|Blasting forth from your .*?, sizzling, red hot embers consume .*? in a fiery attack|The sound of gnawing teeth heralds the arrival of a ghastly ghoul that chomps and grinds rotten teeth against .*? body in a savage assault|Beams of radiant argent light from your .*? culminate in the image of a howling wolf behind .*? that pounces upon and tears at .*? savagely/,
  CA_ArachnesBite: /Afflicted by your .*? reels as the crimson-swirled poison does its work/,
  CA_FoolsDeathwort: /Afflicted by your .*? reels as the violet-tinted poison does its work/,
  CA_OphidiansKiss: /Afflicted by your .*? reels as the indigo-tinted poison does its work/,
  CA_RavagersRevenge: /Afflicted by your .*? reels as the maroon-swirled poison does its work/,
  CA_ShatterlimbPoison: /Afflicted by your .*? reels as the murky blue poison does its work/,
  CA_MajorPoison_Dot: /wavers with infirmity and pales slightly|suffers visibly from the poison afflicting|A spasm of pain overtakes|study of agonized misery|sweats copiously and groans in pain/
}

@flare_patterns = @no_dmg_flare_patterns.merge(@dmg_flare_patterns).values

@armor_regexes ||= begin
  regexes = Armor.class_variable_get(:@@armor_techniques).values.map { |v| v[:regex] }.compact
  echo "[spamfilter: Loaded #{regexes.size} PSM3 armor technique filters.]"
  regexes
end

@shield_regexes ||= begin
  regexes = Shield.class_variable_get(:@@shield_techniques).values.map { |v| v[:regex] }.compact
  echo "[spamfilter: Loaded #{regexes.size} PSM3 shield technique filters.]"
  regexes
end

@weapon_regexes ||= Weapon.class_variable_get(:@@weapon_techniques).values.map { |v| v[:regex] }.compact

@common_game_messages = [
		/"The .* is already open."/,
		/CS: [-+]?\d+ - TD: [-+]?\d+ \+ CvA: [-+]?\d+ \+ d100: [-+]?\d+ == [-+]?\d+$/,
		/Necrotic energy from .* overflows into/,
		/We'll get someone on that right away/,
		/followed./,
		/Your recent adventures echo powerfully in your mind./,
		/\(.*\)/,
		/\(.*\/.*\)/,
		/\(marked\)/,
		/\(registered\)/,
		/\.\.\. \d+ points? of damage!?$/,
		/\.\.\. and cause \d+ point(?:s)? of damage!?$/,
		/\.\.\. and hits? for \d+ point(?:s)? of damage!?$/,
		/\.\.\.\.\|/,
		/\[.*\]/,
		/\w+ (?:aske|says), ".*"/,
		/\w+ MY hand/,
		/\w+ looks a (?:little|lot) better./,
		/\w+ looks better./,
		/\{.*\}/,
		/\|.*\|/,
		/(?:It|He|She) carried .* on (?:it|him|her)[.!?]?$/i,
		/^(?:It|He|She) didn't carry any silver\.$/i,
		/^(?:It|He|She) had \d+ silvers on (?:it|him|her)\.$/i,
		/^(?:It|He|She) had nothing (?:else )?of (?:value|interest)\.$/i,
		/^1d100: \d+ \+ Modifiers: \d+ == \d+$/,
		/^Also here\:/,
		/^As you place/,
		/^Cast roundtime \d+ second(s)?./i,
		/^Cast roundtime changed to \d+ second./i,
		/^Health: \d+\/\d+\s+Mana: \d+\/\d+\s+Stamina: \d+\/\d+\s+Spirit: \d+\/\d+$/,
		/^Looted .* item(s)?./,
		/^Obvious exits\:/,
		/^Obvious paths\:/,
		/^PTPs\/MTPs: \d+\/\d+\s+ATPs: \d+$/,
		/^Roundtime \d+ second(s)?./i,
		/^Roundtime changed to \d+ second./i,
		/^There is nothing in the/,
		/^This .* has the Liquid Extractor unlock/,
		/^Try as you might/,
		/^Wait \d+ second(s)?./,
		/^You are carrying a total of \d{1,3}(?:,\d{3})* silver\.$/,
		/^You can tell that/,
		/^You gather the remaining \d+ coins\.$/,
		/^You get no sense/,
		/^You have been experiencing the Wisdom of the Ages for \d+ months./,
		/^You might be able to/,
		/^[\w\s'’-]+ just arrived\./,
		/^[\w\s'’-]+ just left\./,
		/^[\w\s'’-]+ just went \w+\./,
		/^[\w\s'’-]+ just went through (?:a|an|the|some) \w+\./,
		/^\w+ (?:accept(?:s)?|add(?:s)?|adjust(?:s)?|analyze|arrive(?:s)?|ask(?:s)?|begin(?:s)?|blend(?:s)?|carefully|close(?:s)?|cock(?:s)?|concentrate(?:s)?|discard(?:s)?|drag(?:s)?|draw(?:s)?|drop(?:s)?|feel|gesture(?:s)?|get(?:s)?|grab(?:s)?|invoke(?:s)?|join(?:s)?|just|kneel(?:s)?|magic|make(?:s)?|may|mind|move(?:s)?|notice(?:s)?|offer(?:s)?|open(?:s)?|pick(?:s)?|put(?:s)?|remove(?:s)?|retrieve(?:s)?|search(?:es)?|seem(?:s)?|sheathe(?:s)?|sit(?:s)?|skillfully|sling(?:s)?|slip(?:s)?|snatch(?:es)?|speak(?:s)?|spell|summon(?:s)?|stand(?:s)?|start(?:s)?|step(?:s)?|take(?:s)?|tilt(?:s)?|utter(?:s)?|will)/,
		/^\w+ (?:agree(?:s)?|answer(?:s)?|applaud(?:s)?|approve(?:s)?|arrest(?:s)?|babble(?:s)?|bark(?:s)?|beam(?:s)?|beg(?:s)?|belch(?:es)?|beseech(?:es)?|bite(?:s)?|blanch(?:es)?|bleat(?:s)?|blink(?:s)?|blush(?:es)?|bounce(?:s)?|bow(?:s)?|breathe(?:s)?|bristle(?:s)?|brush(?:es)?|cackle(?:s)?|chant(?:s)?|cheer(?:s)?|chortle(?:s)?|chuckle(?:s)?|clutch(?:es)?|come(?:s)?|consid(?:e)?r(?:s)?|cough(?:s)?|crack(?:s)?|cringe(?:s)?|cry(?:s)?|curse(?:s)?|curtsy(?:s)?|dance(?:s)?|daydream(?:s)?|dismiss(?:es)?|drool(?:s)?|duck(?:s)?|eat(?:s)?|encumbrance(?:s)?|exhale(?:s)?|fall(?:s)?|feed(?:s)?|flail(?:s)?|flap(?:s)?|flick(?:s)?|flirt(?:s)?|flutter(?:s)?|fly(?:s)?|fold(?:s)?|fret(?:s)?|frown(?:s)?|gag(?:s)?|gasp(?:s)?|gawk(?:s)?|giggle(?:s)?|glance(?:s)?|glare(?:s)?|glower(?:s)?|gnash(?:es)?|gobble(?:s)?|grieve(?:s)?|grimace(?:s)?|grin(?:s)?|groan(?:s)?|grovel(?:s)?|growl(?:s)?|grumble(?:s)?|grunt(?:s)?|guard(?:s)?|gulp(?:s)?|hiccup(?:s)?|hiss(?:es)?|hoot(?:s)?|howl(?:s)?|hum(?:s)?|ignore(?:s)?|inspect(?:s)?|jeer(?:s)?|jump(?:s)?|knock(?:s)?|laugh(?:s)?|lean(?:s)?|leap(?:s)?|leer(?:s)?|lick(?:s)?|limp(?:s)?|listen(?:s)?|look(?:s)?|lower(?:s)?|march(?:es)?|moan(?:s)?|mumble(?:s)?|murmur(?:s)?|mutter(?:s)?|nod(?:s)?|nuzzle(?:s)?|observe(?:s)?|pace(?:s)?|panic(?:s)?|pant(?:s)?|pat(?:s)?|pedal(?:s)?|pinch(?:es)?|poke(?:s)?|ponder(?:s)?|pose(?:s)?|pound(?:s)?|pout(?:s)?|prance(?:s)?|pray(?:s)?|preen(?:s)?|procrastinate(?:s)?|prod(?:s)?|pucker(?:s)?|puff(?:s)?|punch(?:es)?|punish(?:es)?|purr(?:s)?|puzzle(?:s)?|raspberry(?:s)?|redeem(?:s)?|roar(?:s)?|rock(?:s)?|salute(?:s)?|sashay(?:s)?|scoff(?:s)?|scold(?:s)?|scowl(?:s)?|scratch(?:es)?|scream(?:s)?|shiver(?:s)?|shout(?:s)?|shriek(?:s)?|shrug(?:s)?|shudder(?:s)?|shuffle(?:s)?|shun(?:s)?|shush(?:es)?|sigh(?:s)?|simper(?:s)?|skip(?:s)?|sleep(?:s)?|smell(?:s)?|smile(?:s)?|smirk(?:s)?|smooch(?:es)?|snap(?:s)?|snarl(?:s)?|sneer(?:s)?|sneeze(?:s)?|snicker(?:s)?|snore(?:s)?|snort(?:s)?|sob(?:s)?|spin(?:s)?|squeal(?:s)?|squint(?:s)?|squirm(?:s)?|stare(?:s)?|steeple(?:s)?|stomp(?:s)?|stretch(?:es)?|stride(?:s)?|strut(?:s)?|stumble(?:s)?|sulk(?:s)?|surrender(?:s)?|sway(?:s)?|swear(?:s)?|sweat(?:s)?|swoon(?:s)?|tap(?:s)?|tinker(?:s)?|tremble(?:s)?|trudge(?:s)?|tuck(?:s)?|turn(?:s)?|twiddle(?:s)?|twitch(?:es)?|wink(?:s)?)/,
		/^\w+ (?:ask(?:s)?|exclaim(?:s)?|say(?:s)?|yell(?:s)?)\, ".*[.!?]"$/,
		/^\w+ disk arrives, following .* dutifully./,
		/^\w+(?: \w+)* .+\.{3}$/,
		/again within 30 seconds to confirm./,
		/ago for d+ silvers./,
		/carefully records the transaction and says/,
		/disk arrives in the room/,
		/elven time standard./,
		/flags down a nearby urchin and exchanges a few words/,
		/glances at it briefly, then hands you \d+ silver coins./,
		/here's your .* back."/,
		/in the locker, and it quickly disappears./,
		/renews his songs./,
		/but I'll offer you 35,000 silver/,
		/silvery fossil charm/,
		/wound gradually fades, forming on/,
	 /^In the/,
	 /^Today is/,
	 /^\[.*?\]\-[A-z]+\:|^\[server\]\: "/,
  /AS: [-+]?\d+ vs DS: [-+]?\d+ with AvD: [-+]?\d+ \+ d100 roll: [-+]?\d+ = [-+]?\d+$/,
  /^\[[A-Za-z\s]+\]/,  # catches [Invoker] and similar tags at line start
		/manage(?:s|ing)? to (?:block|evade|parry)/,
		/^Total items:/,
		/You are carrying .* valued at a total of \d+ silver./,
		/(?:block(?:s)?|evade(?:s)?|parry(?:s)?) the attack/,
		/Total: \d+/,
		/Bank: \d+/,
		/Planar: \d+/,
		/Spiritual: \d+/,
		/Elemental: \d+/,
		/Chaos: \d+/,
		/Order: \d+/,
		/crumbles and decays away./,
		/(?:falls|knocked|slumps) to the ground./,
		/scribbles out .* promissory note/,
		/freezes in utter terror!/,
		/hand close with almost a life of their own/,
		/^Blood sprays from/,
		/^Fresh blood dripds down/,
		/^Blood continues to stream from/,
		/oozes fresh blood./,
		/drips as it continues to bleed./,
		/leans to one side and dodges the attack!/,
		/finds its mark, slicing deep into/,
		/^You have been awarded/,
		/gracefully avoids the attack!/,
		/dodge(?:s)? the attack!/,
		/dodges just in the nick of time!/,
		/acute sense of vulnerability/,
		/^Your .* won't fit/,
		/^You do not have any/,
		/^(?:An|A) .* floats in, following you./,
		/^With extreme effort,/,
		/^Trickles of blood course from/,
		/^Blood weeps from/,
		/bleeding slows to a trickle and finally stops./,
		/^Fresh blood drips down/,
		/you see a gigas artifact fragment lying nearby./,
		/^Lying flat on (?:his|her|its) back/,
		/barely manages to fend off the attack/,
		/^You twinge slightly as your Empathic Link to/,
		/about a minute ago for/,
		/you feel a moment of personal pride at keeping the area clean/,
		/"[^"]*pawnshop[^"]*junkshop[^"]*"|\"[^"]*junkshop[^"]*pawnshop[^"]*"/i,
		/^You gather the remaining d+ coins/,
		/then hands you d+ silver coins./,
		/ago for d+ silvers./,

		
]

@aggressive_npcs = [
  /(?:seasoned |grizzled |battle\-scarred |ancient |veteran |huge |ghostly |adroit |afflicted |apt |barbed |belligerent |blurry |canny |combative |dazzling |deft |drab |dreary |enraged |ethereal |flashy |flickering |flexile |flinty |frenzied |ghastly |ghostly |gleaming |glittering |glorious |glowing |gory |grotesque |hardy |illustrious |indistinct |keen |lanky |lustrous |muculent |nebulous |oozing |pestilent |putrid |radiant |raging |ready |resolute |rune-covered |robust |scintillating |shadowy |shielded |shifting |shimmering |shining |sickly green |sinuous |slime covered |slimy |sparkling |spindly |spiny |stalwart |stately |steadfast |stout |tattooed |tenebrous |tough |twinkling |unflinching |unyielding |wavering |wispy |spectral )?(Shopkeeper|Innkeeper|Bartender|Patrol Leader|Bandit Lord|Bandit Lady|Gypsy Queen|Gypsy King|Guard Captain|Wall Captain|Drill Sergeant|Stable Hostler|Dungeon Master|Master Torturer|The Emperor|The Empress|ethereal (?:traveller|commoner|townswoman|villager|denizen|peasant|townsman)|bloodthirsty vorpal bunny|bloodthirsty vorpal rabbit|black rolton|black\-winged daggerbeak|carrion worm|fanged rodent|fire ant|giant ant|giant rat|kobold|lesser ghoul|mountain rolton|rolton|skeleton|slimy little grub|spotted gnarp|young grass snake|zombie rolton|Mistydeep siren|big ugly kobold|brown gak|cave gnome|fanged goblin|ghost|goblin|lesser frost shade|lesser shade|moaning phantom|pale crab|phantom|rabid squirrel|sea nymph|spotted gak|thyril|Bresnahanini rolton|cave gnoll|cave nipper|dark vysan|fire salamander|greater ghoul|greater ice spider|hobgoblin|ice skeleton|kobold shepherd|mountain snowcat|relnak|spotted velnalin|striped gak|striped relnak|troglodyte|velnalin|white vysan|black urgh|cobra|fanged viper|mongrel kobold|revenant|ridge orc|spotted leaper|urgh|water moccasin|whiptail|bobcat|coyote|dark apparition|mist wraith|mongrel hobgoblin|night golem|water witch|cockatrice|firephantom|leaper|lesser mummy|lesser orc|monkey|snowy cockatrice|spectral fisherman|spotted lynx|blood eagle|greater kappa|hobgoblin shaman|lesser burrow orc|lesser red orc|shelfae soldier|albino tomb spider|bone golem|crystal crab|greater burrow orc|greater orc|greater spider|mottled thrak|thrak|brown spinner|crocodile|death dirge|manticore|snow spectre|cave worm|giant marmot|gnoll worker|great boar|rabid guard dog|raider orc|werebear|Neartofar orc|shelfae chieftain|wall guardian|crystal golem|dark orc|darkwoode|deranged sentry|gnoll thief|great stag|plumed cockatrice|tawny brindlecat|agresh troll scout|black boar|brown boar|forest troll|giant weasel|great brown bear|grey orc|silverback orc|shadowy spectre|specter|swamp troll|arctic puma|black leopard|gnoll ranger|humpbacked puma|large ogre|luminous arachnid|neartofar troll|panther|puma|ridgeback boar|tomb wight|wolfshade|wraith|agresh bear|agresh troll warrior|banded rattlesnake|black bear|cave troll|fire guardian|fire rat|ghost wolf|ghoul master|hill troll|mongrel troll|mongrel wolfhound|mountain ogre|phosphorescent worm|plains orc warrior|red bear|wind witch|black panther|dark shambler|forest ogre|giant veaba|gnoll guard|krolvin mercenary|mountain goat|mountain troll|plains ogre|plains orc scout|spiked cavern urchin|bighorn sheep|cave lizard|elder ghoul master|fire cat|ghostly warrior|greenwing hornet|mountain lion|nedum vereri|plains lion|plains orc shaman|rotting krolvin pirate|shelfae warlord|thunder troll|war troll|krolvin warrior|agresh troll chieftain|arch wight|gnoll priest|major spider|massive grahnk|ogre warrior|steel golem|striped warcat|wood wight|ancient ghoul master|arachne servant|cave bear|plains orc chieftain|cougar|crested basilisk|dark panther|warthog|arachne acolyte|centaur ranger|crazed zombie|fenghai|niirsha|nonomino|rotting woodsman|zombie|arctic wolverine|burly reiver|giant albino scorpion|ice hound|night hound|reiver|roa'ter wormling|tree viper|veteran reiver|wolverine|carceris|gnoll jarl|krolvin warfarer|sacristan spirit|spectral monk|arachne priest|arachne priestess|jungle troll|tree spirit|grutik savage|cyclops|frenzied monk|lesser stone gargoyle|monastic lich|snow leopard|troll chieftain|darken|dobrem|fire ogre|giant hawk\-owl|ki\-lin|martial eagle|moaning spirit|grutik shaman|arctic manticore|ice troll|pra'eda|scaly burgee|elder tree spirit|giant albino tomb spider|hisskra warrior|hooded figure|hunter troll|jungle troll chieftain|lesser wood sprite|mammoth arachnid|tegursh sentry|ash hag|krynch|skeletal ice troll|wild hound|caribou|ghostly mara|giant fog beetle|rotting corpse|rotting farmhand|ghostly pooka|hisskra shaman|maw spore|mezic|moor hound|sand beetle|skeletal giant|three\-toed tegu|cold guardian|colossus vulture|hisskra chieftain|lava troll|moor witch|rock troll zombie|skeletal soldier|spectral warrior|tundra giant|barghest|bog troll|moor eagle|shimmering fungus|spectral shade|spectral woodsman|troll wraith|water wyrd|arctic titan|dust beetle|fire giant|krolvin slaver|snow crone|spectral lord|undertaker bat|Sheruvian initiate|huge mein golem|lesser moor wight|magru|shadow mare|skeletal warhorse|tusked ursian|frost giant|grizzly bear|krolvin corsair|mud wasp|shadow steed|vesperti|wood sprite|greater bog troll|greater moor wight|stone gargoyle|storm giant|vourkha|forest bendith|kiramon worker|(?:red|yellow|green|blue|orange|purple|young) myklian|spectral miner|Sheruvian monk|bog wraith|lesser ice giant|roa'ter|skeletal lord|baesrukha|dark vortece|frozen corpse|minor glacei|phantasma|shan cleric|shan ranger|shan warrior|shan wizard|siren lizard|swamp hag|dreadnought raptor|night mare|wasp nest|bog wight|firethorn shoot|forest trali shaman|gaunt spectral servant|mastodonic leopard|polar bear|ice wraith|lesser vruul|cinder wasp|forest trali|greater ice giant|kiramon defender|lesser faeroth|rotting chimera|bog spectre|major glacei|dybbuk|horned vor'taz|red\-scaled thrak|sand devil|warrior shade|waern|banshee|flesh golem|greater faeroth|seeker|snow madrinol|tomb troll|wooly mammoth|ice golem|lesser ice elemental|sabre\-tooth tiger|stone sentinel|animated slush|ethereal mage apprentice|skayl|tomb troll necromancer|eidolon|nightmare steed|stone troll|decaying Citadel guardsman|glacial morph|lava golem|massive pyrothag|rotting Citadel arbalester|stone giant|black forest viper|massive black boar|black forest ogre|putrefied Citadel herald|wind wraith|Illoke mystic|phantasmal bestial swordsman|stone mastiff|Sheruvian harbinger|massive troll king|soul golem|fire sprite|grifflet|emaciated hierophant|red tsark|Illoke shaman|muscular supplicant|yeti|lesser griffin|hunch\-backed dogmatist|krag yeti|fire mage|krag dweller|storm griffin|lesser minotaur|greater vruul|moulis|naisirc|minotaur warrior|shrickhen|farlook|raving lunatic|dhu goleras|minotaur magi|seraceris|Vvrael witch|Csetairi|caedera|gnarled being|bent being|stooped being|twisted being|lesser construct|Vvrael warlock|greater krynch|gremlock|lich qyn'arj|Illoke elder|aivren|festering taint|n'ecare|greater earth elemental|Illoke jarl|Ithzir scout|Ithzir initiate|lost soul|Ithzir janissary|Ithzir herald|vaespilon|triton dissembler|Ithzir adept|greater construct|siren|triton executioner|fallen crusader|fallen avenger|Ithzir seer|spectral triton defender|triton combatant|glistening cerebralite|triton radical|war griffin|triton magus|enormous rift crawler|ethereal triton sentry|darkly inked fetish master|greater water elemental|csetairi|Vvrael destroyer|soul siphon|wizened orc hag|colossal titan|ravenous krolvin berserker|gnoll miner|vvrael warlock|monstrous crimson worm|chieftain|triton sentry|triton defender|minotaur magus|moulis stalk|moulis stalk|moulis bud|moulis scraping|bunny stalk|bunny bud|bunny scraping|hanging tree viper|nasty little (?:red|yellow|green|orange|black|blue) gremlin|(?:white |black |tan |roan )?centaur|(fire|lightning|lava|steam|air|ice|water|earth) elemental|(?:seasoned |grizzled |battle\-scarred |weathered |veteran |hulking |haggard )?Grimswarm (?:giant|troll|orc) (?:blackguard|bodyguard|warmonger|spellbinder|sentinel|healer|empath|sniper|crusader|warlock|soldier|sorcerer|sorceress|ranger|warrior|elementalist|mage|wizard|raider|acolyte|guard|paladin|battlemage|archer|skirmisher|scout|shaman|warchief|pillager|marauder|cleric|initiate|dissembler|barbarian|fighter|scourge|champion|huntmaster|warmage|hunter|destroyer|witch|wrathbringer|adept|zealot|huntmistress)|(?:seasoned )?(?:dwarven|elven|halfling|erithian|human|giantman|half\-krolvin|gnomish|half\-elven) (?:thief|rogue|bandit|mugger|outlaw|highwayman|marauder|brigand|thug|robber)|winged viper|Ilvari pixie|Ilvari sprite|direbear|monstrous direwolf|treekin warrior|treekin druid|treekin sapling|warped tree spirit|bay centaur|Ithzir champion|ancient triton defender|ancient triton sentry|trali shaman|battle-scarred fierce krolvin huntmaster|battle-scarred fierce krolvin watcher|battle-scarred hulking krolvin champion|battle-scarred hulking krolvin destroyer|battle-scarred hulking krolvin huntmistress|battle-scarred hulking krolvin warden|battle-scarred hulking krolvin warlord|battle-scarred savage krolvin deadeye|battle-scarred savage krolvin executioner|battle-scarred savage krolvin guide|battle-scarred krolvin assassin|battle-scarred krolvin battlemaster|battle-scarred krolvin beguiler|battle-scarred krolvin blackguard|battle-scarred krolvin challenger|battle-scarred krolvin champion|battle-scarred krolvin defiler|battle-scarred krolvin executioner|battle-scarred krolvin guide|battle-scarred krolvin huntmaster|battle-scarred krolvin huntmistress|battle-scarred krolvin invoker|battle-scarred krolvin justicar|battle-scarred krolvin marksman|battle-scarred krolvin scout|battle-scarred krolvin triggerman|battle-scarred krolvin warden|battle-scarred krolvin warlord|battle-scarred krolvin warmage|battle-scarred krolvin watcher|burly krolvin conjurer|dirty krolvin scout|dirty krolvin enforcer|dirty krolvin paladin|dirty krolvin magus|dwarven pillager|dwarven pirate|dwarven raider|dwarven scout|dwarven waylayer|elven pillager|elven pirate|elven raider|elven scout|elven waylayer|erithian pillager|erithian pirate|erithian raider|erithian scout|erithian waylayer|ferocious krolvin adept|ferocious krolvin avenger|ferocious krolvin beguiler|ferocious krolvin confessor|ferocious krolvin corrupter|ferocious krolvin deadeye|ferocious krolvin executioner|ferocious krolvin knave|ferocious krolvin scout|fierce krolvin assassin|fierce krolvin battlemaster|fierce krolvin challenger|fierce krolvin defiler|fierce krolvin huntmaster|fierce krolvin huntmistress|fierce krolvin invoker|fierce krolvin justicar|fierce krolvin marksman|fierce krolvin scout|fierce krolvin warmage|fierce krolvin watcher|frenzied krolvin assassin|frenzied krolvin battlemaster|frenzied krolvin challenger|frenzied krolvin defiler|frenzied krolvin huntmaster|frenzied krolvin huntmistress|frenzied krolvin invoker|frenzied krolvin justicar|frenzied krolvin marksman|frenzied krolvin scout|frenzied krolvin warmage|frenzied krolvin watcher|giantman pillager|giantman pirate|giantman raider|giantman scout|giantman waylayer|gnomish pillager|gnomish pirate|gnomish raider|gnomish scout|gnomish waylayer|grizzled fierce krolvin marksman|grizzled fierce krolvin watcher|grizzled dirty krolvin scout|grizzled dirty krolvin enforcer|grizzled dirty krolvin paladin|grizzled dirty krolvin magus|grizzled hulking krolvin huntmaster|grizzled hulking krolvin obliterator|grizzled hulking krolvin triggerman|grizzled hulking krolvin warden|grizzled savage krolvin beguiler|grizzled savage krolvin guide|grizzled krolvin archmage|grizzled krolvin assassin|grizzled krolvin battlemaster|grizzled krolvin challenger|grizzled krolvin defiler|grizzled krolvin guide|grizzled krolvin huntmaster|grizzled krolvin huntmistress|grizzled krolvin invoker|grizzled krolvin justicar|grizzled krolvin marksman|grizzled krolvin obliterator|grizzled krolvin scout|grizzled krolvin veteran|grizzled krolvin warden|grizzled krolvin warmage|grizzled krolvin watcher|half-elven pillager|half-elven pirate|half-elven raider|half-elven scout|half-elven waylayer|half-krolvin pillager|half-krolvin pirate|half-krolvin raider|half-krolvin scout|half-krolvin waylayer|halfling pillager|halfling pirate|halfling raider|halfling scout|halfling waylayer|hulking krolvin archmage|hulking krolvin destroyer|hulking krolvin obliterator|hulking krolvin paragon|hulking krolvin scout|hulking krolvin templar|hulking krolvin tormentor|hulking krolvin triggerman|hulking krolvin warlord|human pillager|human pirate|human raider|human scout|human waylayer|imposing krolvin warmonger|massive krolvin battlechanter|massive krolvin harrower|massive krolvin huntmaster|massive krolvin huntmistress|massive krolvin plaguebringer|massive krolvin precept|massive krolvin rover|massive krolvin scout|massive krolvin sharpshooter|massive krolvin soldier|massive krolvin warbringer|massive krolvin wrathbringer|menacing krolvin archmage|menacing krolvin destroyer|menacing krolvin huntmaster|menacing krolvin huntmistress|menacing krolvin obliterator|menacing krolvin paragon|menacing krolvin scout|menacing krolvin templar|menacing krolvin tormentor|menacing krolvin triggerman|menacing krolvin warlord|puny krolvin page|raging krolvin battlechanter|raging krolvin harrower|raging krolvin huntmaster|raging krolvin huntmistress|raging krolvin plaguebringer|raging krolvin precept|raging krolvin rover|raging krolvin scout|raging krolvin sharpshooter|raging krolvin soldier|raging krolvin warbringer|raging krolvin wrathbringer|repulsive krolvin assassin|repulsive krolvin battlemaster|repulsive krolvin challenger|repulsive krolvin defiler|repulsive krolvin huntmaster|repulsive krolvin huntmistress|repulsive krolvin invoker|repulsive krolvin justicar|repulsive krolvin marksman|repulsive krolvin scout|repulsive krolvin warmage|repulsive krolvin watcher|ruthless krolvin adept|ruthless krolvin avenger|ruthless krolvin beguiler|ruthless krolvin confessor|ruthless krolvin corrupter|ruthless krolvin deadeye|ruthless krolvin executioner|ruthless krolvin knave|ruthless krolvin scout|savage krolvin adept|savage krolvin avenger|savage krolvin beguiler|savage krolvin confessor|savage krolvin corrupter|savage krolvin deadeye|savage krolvin executioner|savage krolvin guide|savage krolvin knave|savage krolvin scout|seasoned fierce krolvin challenger|seasoned fierce krolvin watcher|seasoned hulking krolvin triggerman|seasoned hulking krolvin warden|seasoned savage krolvin guide|seasoned krolvin assassin|seasoned krolvin avenger|seasoned krolvin battlemaster|seasoned krolvin challenger|seasoned krolvin defiler|seasoned krolvin destroyer|seasoned krolvin executioner|seasoned krolvin guide|seasoned krolvin huntmaster|seasoned krolvin huntmistress|seasoned krolvin invoker|seasoned krolvin justicar|seasoned krolvin knave|seasoned krolvin marksman|seasoned krolvin paragon|seasoned krolvin scout|seasoned krolvin templar|seasoned krolvin tracker|seasoned krolvin warden|seasoned krolvin warmage|seasoned krolvin watcher|snarling krolvin conjurer|snarling krolvin warmonger|sneering krolvin scout|sneering krolvin enforcer|sneering krolvin paladin|sneering krolvin magus|stinking krolvin scout|stinking krolvin enforcer|stinking krolvin paladin|stinking krolvin magus|The Krolvin Captain|The Pirate Captain|towering krolvin archmage|towering krolvin blackguard|towering krolvin destroyer|towering krolvin huntmaster|towering krolvin obliterator|towering krolvin paragon|towering krolvin scout|towering krolvin templar|towering krolvin tormentor|towering krolvin triggerman|towering krolvin warlord|vile krolvin battlechanter|vile krolvin harrower|vile krolvin huntmaster|vile krolvin huntmistress|vile krolvin plaguebringer|vile krolvin precept|vile krolvin rover|vile krolvin scout|vile krolvin sharpshooter|vile krolvin soldier|vile krolvin warbringer|weathered fierce krolvin battlemaster|weathered fierce krolvin defiler|weathered fierce krolvin justicar|weathered fierce krolvin watcher|vile krolvin wrathbringer|weathered hulking krolvin archmage|weathered hulking krolvin destroyer|weathered hulking krolvin huntmistress|weathered hulking krolvin warden|weathered savage krolvin guide|weathered savage krolvin knave|weathered krolvin archmage|weathered krolvin assassin|weathered krolvin battlemaster|weathered krolvin challenger|weathered krolvin deadeye|weathered krolvin defiler|weathered krolvin guide|weathered krolvin huntmaster|weathered krolvin huntmaster|weathered krolvin huntmistress|weathered krolvin invoker|weathered krolvin justicar|weathered krolvin marksman|weathered krolvin scout|weathered krolvin templar|weathered krolvin warden|weathered krolvin warmage|weathered krolvin watcher|ethereal brigand|ethereal pirate|ghostly giantman pirate|ghostly giantman raider|ghostly half-elven pirate|ghostly half-elven scout|ghostly half-elven waylayer|ghostly half-krolvin scout|ghostly human pillager|The Ethereal Captain|unworldly brigand|unworldly pirate|barbed cavern urchin|coconut crab|crazed canine|ebon swine|hobgoblin acolyte|imposing elk|luminous worm|muddy hog|muscular brindlecat|ogre sentry|shelfae assailant|shelfae guard|speckled cave lizard|spectacled bear|wharf rat|ancient ghoul horror|contorted ghoul master|ethereal battlemaster|fanged nebulous figure|fiery-eyed eidolon|hunchbacked arch wight|inky-wisped gaunt figure|massive-armed hulking dybbuk|mindless abomination|multi-headed rotting chimera|phantasmal combatant|rotting dwarven guard|sore-covered zombie|spectral dwarven miner|seething pestilent vision|horrific magna vereri|voluptuous magna vereri|athletic dark-eyed incubus|supple Ivasian inciter|ash guardian|blazing red phoenix|firebird|enormous mosquito|huge jungle toad|jungle feyling|large ring-tailed lemur|bristly black tapir|hulking forest ape|cloud sprite meddler|cloud sprite bully|azure-scaled cold wyrm|behemothic gorefrost golem|bloody halfling cannibal|brawny gigas shield-maiden|cinereous chthonian sybil|(?:colossal )?boreal undansormr|flayed gigas disciple|grim gigas skald|heavily armored battle mastodon|immense gold-bristled hinterboar|niveous giant warg|quivering sanguine ooze|quivering sanguine oozeling|savage fork-tongued wendigo|snowy warg packmother|squamous reptilian mutant|stunted halfling bloodspeaker|tattooed gigas berserker|(?:eyeless )?black valravn|(?:shining )?winged disir|(?:withered )?shadow-cloaked draugr|(?:roiling )?crimson angargeist|triton assassin|triton brawler|triton fanatic|triton warden|triton warlock|triton psionicist|triton protector|shan bard|shan bardess|shan empath|shan rogue|shan shaman|shan sorcerer|shan sorceress|blackened decaying tumbleweed|dark frosty plant|large thorned shrub|shriveled icy creeper|writhing frost-glazed vine|writhing icy bush|ashen patrician vampire|cadaverous tatterdemalion ghast|horned basalt grotesque|infernal death knight|smouldering skeletal dreadsteed|flickering mist-wreathed banshee|gaudy phantasmic conjurer|bony Tenthsworn occultist|desiccated half-krolvin strigoi|gaunt feral selkie|grisly corpse hulk|cook's assistant|lesser fetid corpse|greater fetid corpse|luminous spectre|spectral black warhorse|steam dervish|greater skayl|bloated kiramon broodtender|chitinous kiramon myrmidon|corpulent kresh ravager|disfigured hive thrall|iridescent kiramon shardmind|sleek black kiramon stalker|translucent kiramon strandweaver|water hound|vapor hound|storm hound|lightning fiend|crazed zombie fiend|titan stormcaller|tempest tyrant|Veiki herald|timeworn phantasma|gruesome flesh monster|sanguine barghest|ancient ghoul diabolist|oily black tentacle|a winged Marluvian harbinger|swirling spectre|Agresh bear|Agresh troll chieftain|Agresh troll scout|Agresh troll warrior|Arachne acolyte|Arachne priest|Arachne priestess|Arachne servant|frostborne lich|Grutik savage|Grutik shaman|infernal lich|murky soul siphon|Neartofar troll|necrotic snake|spectre|wild dog|brindle wild hound|(?:black|mangy|spotted|mongrel) wild dog|red centaur|soldier ant|lithe veiled sentinel|pale scaled shaper|deathsworn fanatic|white sidewinder|sand-hued desert sidewinder|shambling lurk|patchwork flesh monstrosity|ancient flesh monstrosity|ethereal commoner|ethereal denizen|ethereal peasant|ethereal townsman|ethereal townswoman|ethereal traveller|ethereal villager|ethereal barbarian|ethereal knight|ethereal pillager|ethereal raider|ethereal scout|ethereal soldier|ethereal waylayer|ethereal zealot|ethereal guard|ethereal guardsman|ethereal guardswoman|ethereal inmate|ethereal lunatic|ethereal madman|ethereal madwoman|ethereal prisoner|ethereal squire|ethereal swordsman|ethereal swordswoman|ghostly bandit|ghostly highwayman|ghostly highwaywoman|ghostly marauder|ghostly waylayer|unworldly barbarian|unworldly knight|unworldly pillager|unworldly raider|unworldly scout|unworldly soldier|unworldly waylayer|unworldly zealot|unworldly guest|unworldly maid|unworldly noble|unworldly royal guard|unworldly royal knight|unworldly servant|unworldly slave|unworldly steward|unworldly visitor|celestial dancer|celestial juggler|celestial nomad|celestial traveller|Butler|Cook|Knight Captain|Foreign Dignitary|Royal Prince|Royal Princess|Royal Jester|Royal Emperor|Royal Empress|berserk Royal Emperor|berserk Royal Empress|Sapper Lord|Sapper Lady|Raid Leader|Dark Knight|Massive Butcher|Slender Mercenary|Darkly Hooded Figure|Crimson Count|Kennel Master|Royal Inquisitor|Towering Crusader|Hulking Berserker|Jester Ser Rets|Dame Venti|Corrupted Knight Owrym|Arch Priest Dlitse|Dame Elle Zo|Thane Wedge|Dark Astrologer Scionae|speedy sapper)/,
]

@gem_types = [
/(swirled lightning glass shard|fossilized bessho lizard spur|crystallized black thorn|crystallized blue berry|shimmering nodule of marcasite|shimmertine shard|shard of dragonmist crystal|petrified aivren egg|shard of tigerfang crystal|milky quartz eye|obsidian eye|blackened feystone core|shard of pale grey shadowglass|dark grey dreamstone fragment|sphere of carmine\-hued crystal|rock crystal|flake of coarse dark shale|kaleidoscopic oblong saewehna|cloud-shaped smoky grey smoldereye|splinter of pale dragonmist crystal|wickedly curved diamond fang|quartz crystal|(?:round amber|mist blue|hazy red|smooth green) sea glass disk|fossilized thrak tooth|tangerine wulfenite crystal|black-cored emerald orb|square of shale rock|small copper nugget|cloudy alexandrite shard|flame-banded gold chameleon agate|thin shard of iridescent fire agate|gently sloped green moss agate|round of gnat-filled amber|slice of gold-blended ametrine|fragment of lilac-toned amethyst|brilliant teal-laced azurite|scintillating scarlet red blazestar|inky-cored vivid carmine bloodjewel|cluster of gingery golden chrysoberyl|clouded maize-colored citrine|pale metallic silver mistvein diamond|square-cut deep pink diamond|sharply cut salorisa pink diamond|large blood red diamond|flawless argent-white diamond|pale-edged powder blue dreamstone|smooth black umber-suffused dreamstone|heart-shaped aqua green emerald|black-rayed celadon star emerald|multi-faceted sky blue feystone|six-pointed rich sanguine garnet|beryl green crystal-filled geode|pristine smoky violet glimaerstone|teardrop of mauve petrified haon|dainty orb of primrose yellow heliodor|cushion-cut ember orange hyacinth|bronze-tinged lambent yellow jacinth|slim bar of woodland green jade|pyrite-capped vibrant blue lapis lazuli|small disk of velvety green malachite|silver-washed celestial blue moonstone|cyan-haloed creamy ivory moonstone|pearlescent raven black opal|pellucid blue-green ora-bloom|oversized shadowy purple pearl|glimmering magnolia white pearl|tiny prism of wintry blue peridot|trilliant-cut yellow-green peridot|triangular pastel rainbow quartz|hazy shard of faint pink rose quartz|cube of sheer blossom pink rosespar|wheel-incised incarnadine ruby|coin-sized seafoam white sandsilver|silver-swept blue mistvein sapphire|honey-tinted indigo water sapphire|dark-veined apple green turquoise|heart of smooth black glaes|branch of petrified driftwood|grooved burnt orange sea star|misty silver crystalline spiral|piece of petrified wyrmwood|wedge of ocher and ebony ambergris|cabochon of milky azure aquamarine|thin blade of verdant sea glass|triangular charcoal shark tooth|burnished sepia moonsnail shell|pale-spotted rosy sea urchin shell|purple-banded razor clam shell|rainbow-hued oval abalone shell|rust-speckled ivory slipper shell|wine-tinged calico scallop shell|rough-edged matte white soulstone|blue lace agate|blue-violet chunk of kornerupine|bluish black razern-bloom|carved basalt teardrop|chunk of pale marble|chunk of ruddy bauxite|cylindrical red beryl|deep red-violet garnet|deep violet duskjewel|dull griseous mournstone|faceted wyrm's-heart sapphire|fossilized undandsormr egg|fossilized undansormr egg|frosted pale violet amethyst|gold-banded onyx|gold-green auroral emerald|green alexandrite stone|green and pink zoisite|grey-streaked malachite stone|inky black nightstone|lambent gold warg's eye quartz|lustrous vermilion firedrop|misty grey deathstone|mottled green jasper|nival everfrost shard|pastel-hued winterbite pearl|petrified warg fang|piece of blood amber|piece of clear oligoclase|piece of coppery titanite|piece of dusky blue sapphire|piece of polished ivory|rainbowed ammolite shard|rough cinnabar shard|royal blue boreal topaz|rutilated twilight tourmaline|saffron-hued danburite stone|shard of raven's wing obsidian|shard of streaked blue spectrolite|silver-hite palladium nugget|silvery nimbus opal|small flaxen citrine|some dark ivory aranthium-bloom|stark white snowstone|teal chrome diopside|twilight blue azurite crystal|vibrant titian heliodor|vinous gigasblood ruby|virescent nephrite shard|vivid cobalt blue spinel|cabochon torchlight carnelian|chatoyant cerulean chrysoberyl|copper-chased azurite chunk|blue-green glacial core|pinch of electrum dust|fragment of pale blue glacialite|swirling quicksilver globe|clear azure hoarstone|stygian lichstone|jagged nephrite shard|niveous snowdrop|disk of petrified spruce|piece of petrified maoral|piece of petrified thanot|piece of rosespar|fragment of pale green-blue aquamarine|lilac-crested molten gold ametrine|pear-shaped greenish-yellow citrine|fiery viridian soulstone|dull white soulstone|cinnabar crystal|silvery galena|oblong blue goldstone|dull grey crystal|pink salt crystal|twisted iron spiral|round of milky amber|smoky amethyst|hexagonal cobalt blue beryl|chunk of bronzite|marbled green chrysoprase|cluster of sky blue crystal|ice blue diamond|nebulous emerald|lustrous black garnet|ethereal blue gem|teardrop of dark green heliotrope|spear of lavender-grey iolite|piece of jet-flecked ivory|piece of black jade|piece of blue jade|pebble of orbicular jasper|cone of mahogany obsidian|heart of blue onyx|cloud opal|iridescent wood opal|jelly opal|shard of pink petalite|luminous prehnite|snow quartz|haloed Reim ruby|pallid sapphire|chunk of pale blue ice stone|chunk of pearly grey ice stone|chunk of snowy white ice stone|slice of ribbon stone|dark blue tempest stone|faint gold tempest stone|pale grey tempest stone|ebon-cored vortex stone|silver-cored vortex stone|sliver of bright green viridine)/,
/(mithril\-bloom|faenor\-bloom|rhimar\-bloom|ora\-bloom|vultite\-bloom|thunderstone|doomstone|riftshard|geode|rosepar|firestone|bloodjewel|pearl|corestone|sard|sphene|jasper|marble|eostone|maoral|agate|amber|amethyst|blazestar|carbuncle|chalcedony|coral|despanal|diamond|emerald|feystone|garnet|gem|mica|thanot|glimaerstone|heliodor|hyacinth|jacinth|moonstone|onyx|quartz|ruby|sapphire|spinel|topaz|tourmaline|turquoise|zircon|peridot|starstone|dreamstone|deathstone|sunstone|sandsilver|bluerock|diopside|ivory|jade|bloodstone|cordierite|sardonyx|opal|stone|lapis|obsidian|beryl|azurite|spherine|wyrdshard|riftstone|aetherstone|pyrite|hematite|saewehna|wraithaline|smoldereye|mekret|roestone|auboraline|wraithaline|waterweb|gypsum|feldspar|nephrite|pumice|rivertear|tanzanite|idocrase|cinderstone|sandruby|bismuth|fluorite|chrysoprase|prehnite|heliotrope|viridine|crescent|nugget)/,
]

@skin_types = [
/(?:bundle of )?(agresh bear claw|aivren gizzard|ant larva|antlers|ant pincer|arctic manticore mane|arctic titan toe|basilisk crest|bat wing|bear claw|bear hide|bear paw|bighorn sheepskin|black boar hide|black leopard paw|black urgh hide|blood red eagle feather|boar tusk|bobcat claw|brown bear skin|brown gak hide|brown spinner leg|caedera skin|cave nipper skin|centaur hide|cerebralite tentacle|chimera stinger|cobra skin|cockatrice feather|cockatrice plume|cougar tail|coyote tail|cracked troll jawbone|crocodile snout|crooked crone finger|crooked witch nose|curved gold-flecked claw|cyclops eye|daggerbeak wing|decaying troll eye|dirge skin|dobrem snout|eagle talon|elongated triton spine|faceted crystal crab shell|faeroth fang|fenghai fur|fire ant pincer|fire cat claw|fire giant mane|fire rat tail|fog beetle carapace|frozen scalp|gak hide|gak pelt|ghoul finger|ghoul master claw|ghoul nail|ghoul scraping|giant scalp|giant skin|giant toe|glistening black eye|gnome scalp|goat hoof|goblin fang|goblin skin|golem bone|greasy troll scalp|griffin pelt|grifflet pelt|grizzly bear hide|hisskra crest|hisskra skin|hisskra tooth|hobgoblin scalp|hobgoblin shaman ear|hornet stinger|ice hound ear|ice troll scalp|iridescent triton hide|jagged rift crawler tooth|kappa fin|kiramon mandible|kiramon tongue|kobold ear|kobold skin|krynch shinbone|leaper hide|leopard skin|lynx pelt|madrinol skin|mammoth arachnid mandible|mammoth tusk|mangy kobold scalp|manticore tail|marmot pelt|martial eagle talon|massive troll king hide|minotaur hide|minotaur hoof|minotaur horn|mist wraith eye|mongrel hobgoblin snout|monkey paw|moor hound paw|mottled faeroth crest|mountain lion skin|multicolored siren lizard skin|multi-faceted tomb spider eye|mummy's shroud|myklian scale|night golem finger|night hound hide|ogre nose|ogre tooth|ogre tusk|orange shelfae scale|orc beard|orc claw|orc ear|orc hide|orc knuckle|orc scalp|pair of caribou antlers|pair of (?:spike|forked|three\-tined) antlers|pale crab pincer|pale white feather|panther pelt|plains lion skin|polar bear skin|pulsating firethorn|puma hide|puma paw|pyrothag hide|raptor feathers|rat pelt|rattlesnake rattle|red orc scalp|relnak sail|rimed lich finger bone|roa'ter skin|rodent fang|rolton ear|rolton horn|rolton pelt|rotted canine|rotting rolton pelt|ruff of vulture feathers|salamander skin|scaly burgee shell|scorched lich finger bone|scorpion stinger|scraggly orc scalp|scrap of troll skin|seeker eye|sheer white spider mandible|shelfae crest|shelfae scale|shimmering wasp wing|silverback orc knuckle|silver mane|silver-tipped horseshoe|silvery hoof|silvery tail|skeletal giant bone|skeletal warhorse jaw|skeleton bone|skeleton skull|snake fang|snake skin|snowcat pelt|snowy cockatrice tailfeather|spectre nail|spectre skin|spider leg|spotted gnarp horn|spotted leaper pelt|spotted leopard pelt|squirrel tail|stone-grey lizard tail|stone heart|striped relnak sail|swamp troll scalp|tawny brindlecat hide|tegursh claw|tegu tailspike|thrak hide|thrak tail|tiger incisor|trali hide|trali scalp|tree viper fang|troll beard|troll ear|troll eye|troll eyeball|troll fang|troll heart|troll hide|troll knuckle|troll scalp|troll skin|troll thumb|troll toe|troll tongue|tsark skin|tufted hawk-owl ear|tundra giant tooth|urgh hide|ursian tusk|veaba claw|velnalin hide|velnalin horn|vesperti claw|viper fang|viper skin|vor'taz horn|vruul skin|waern fur|warcat whisker|war griffin talon|warthog snout|wasp stinger|water moccasin skin|weasel pelt|werebear paw|whiptail stinger|white puma hide|(?:wide )?rack of (three|four|five|six)\-tined antlers|wight claw|wight mane|wight scalp|wight skin|wight skull|wolverine pelt|wolverine tail|worm skin|wraith talon|yellowed boar tusk|yellowed canine|zombie scalp|direbear fang|heavy grey tusk|red eye|mossy beard|(?:some )?blood-stained bark|pure white feather|ruffed white griffin pelt|soft grifflet pelt|dark panther pelt|pra'eda canine|hag nose|long fiery red spine|faintly glowing worm skin|two-tip rattlesnake rattle|three-tip rattlesnake rattle|four-tip rattlesnake rattle|five-tip rattlesnake rattle|wide rack of seven-tined antlers|barbed cerebralite tentacle|griffin talon|leathery bat wings|lich finger bone|leathery bat wing|Agresh bear claw|hobgoblin acolyte ear|soft red firebird feather|ruff of raptor feathers|centaur ranger hide|cyan jungle toad hide|green jungle toad hide|lemur tail|diaphanous mosquito wing|bristly tapir snout|tapir snout|dark brown forest ape pelt|forest ape pelt|gold-flecked claw|red firebird feather|triton spine|triton hide|brindlecat hide|hobgoblin snout|acolyte ear|black eye|(?:niveous )?warg pelt|(?:golden )?hinterboar mane|(?:inky black )?valravn plume|(?:handful of )?undansormr scales|(?:woolly )?mastodon trunk|(?:curved )?black claw|(?:darkened )?triton hide|(?:thick )?triton spine|bleached thorn|blood-stained leaf|desiccated stem|frosted branch|shriveled cutting|thorn-ridden appendage|(?:flame-scarred )?dreadsteed skull|(?:glittering )?kresh foreclaw|(?:some glossy )?kiramon chitin|(?:mottled )?kiramon poison gland|(?:pallid )?strandweaver spinneret|(?:thin )?broodtender tendril|fungal cap|sidewinder scale|ruffed black griffin pelt|soft blue griffin feather|ruffed tawny griffin pelt|pale troll tongue|scraggly swamp troll scalp|brown boar hide|moor eagle talon|mountain snowcat pelt)(?:s)?/,
]

@herb_types = [
/(some acantha leaf|some spicy acantha leaf|tincture of acantha|tincture of yabathilium|yabathilium fruit|iceberry tart|some acantha leaf tea|grey mushroom potion|flagon of Olak's Ol'style ale|barrel of Olak's Ol'style ale|flagon of Bloody Krolvin ale|barrel of Bloody Krolvin ale|some aloeas stem|some withered aloeas stem|tincture of aloeas|feverfew potion|sticky lichen tea|flagon of Dark Swampwater ale|barrel of Dark Swampwater ale|rose-marrow potion|crystalline rose-marrow elixir|tincture of rose-marrow|elk horn potion|some feverfew tea|rusty red ale|flagon of Semak's Smooth ale|barrel of Semak's Smooth ale|brostheras potion|crystalline brostheras elixir|tincture of brostheras|some polar bear fat soup|pennyroyal potion|stone soot brew|flagon of Reaper's Red ale|barrel of Reaper's Red ale|some haphip root|some dirty haphip root|tincture of haphip|sparrowhawk pie|pennyroyal tea|dull crimson ale|flagon of Agrak's Amber ale|barrel of Agrak's Amber ale|some pothinir grass|some bright green pothinir grass|tincture of pothinir|musk ox tart|ginkgo nut potion|roasted ratweed tea|flagon of Aged Schooner ale|barrel of Aged Schooner ale|some basal moss|tincture of moss|sticky ball of basal moss|tincture of basal|some tundra grass|some ginkgo nut tea|chunky black ale|flagon of Mama Dwarf's ale|barrel of Mama Dwarf's ale|wingstem potion|crystalline wingstem elixir|tincture of wingstem|earthworm potion|wyrmwood root potion|dirty crevice brew|flagon of Wort's Winter ale|barrel of Wort's Winter ale|talneo potion|crystalline talneo elixir|tincture of talneo|rock lizard potion|wyrmwood root tea|brown weedroot ale|flagon of Gert's Homemade ale|barrel of Gert's Homemade ale|bur-clover potion|crystalline bur-clover elixir|tincture of bur-clover|starfish potion|daggit root potion|dirty rat fur potion|flagon of Volcano Vision ale|barrel of Volcano Vision ale|some ephlox moss|gooey ball of ephlox moss|tincture of ephlox|some frog's bone porridge|sweetfern potion|crushed cavegrass tea|flagon of Golden Goose ale|barrel of Golden Goose ale|some ambrominas leaf|some sugary ambrominas leaf|tincture of ambrominas|Dabbings Family special tart|some sweetfern tea|bubbling brown ale|flagon of Lost Dogwater ale|barrel of Lost Dogwater ale|some calamia fruit|some ripe calamia fruit|tincture of calamia|some walrus blubber|manroot potion|stalactite brew|flagon of Mad Mutt Frothy ale|barrel of Mad Mutt Frothy ale|some (?:prickly )?cactacae spine|tincture of cactacae|some elk fat gel|manroot tea|spotted toadstool ale|flagon of Bearded Ladies' ale|barrel of Bearded Ladies' ale|(?:some|small) sovyn clove|sovyn clove|tincture of sovyn|some rock ptarmigan feathers|angelica root potion|grainy black potion|flagon of Captn' Pegleg's ale|barrel of Captn' Pegleg's ale|bolmara potion|crystalline bolmara elixir|tincture of bolmara|snowflake elixir|red lichen potion|glowing mold tea|flagon of Kenar's Dropjaw ale|barrel of Kenar's Dropjaw ale|some wolifrew lichen|some dry wolifrew lichen|tincture of wolifrew|Leaftoe's lichen tart|some red lichen tea|thick foggy ale|flagon of Orc's Head ale|barrel of Orc's Head ale|some woth flower|some fragrant woth flower|tincture of woth|flower-shaped tart|valerian root potion|stalagmite brew|flagon of Dacra's Dream ale|barrel of Dacra's Dream ale|some torban leaf|some fresh torban leaf|tincture of torban|Ma Leaftoe's spiced torban tart|valerian root tea|dark frothing ale|flagon of Miner's Muddy ale|barrel of Miner's Muddy ale|slice of Ma Leaftoe's Special|slice of pickled walrus blubber|slice of sparrowhawk pie|tiny cup of polar bear fat soup|gelatinous elk fat tart|tiny flower-shaped tart|tiny ram's bladder tart|tiny musk ox tart|small egg and tundra grass tart|candied ptarmigan feather|bunch of acantha leaf|bunch of wolifrew lichen|bunch of torban leaf|bunch of woth flower|bunch of ambrominas leaf|bunch of ephlox moss|bunch of cactacae spine|bunch of calamia fruit|bunch of aloeas stem|bunch of haphip root|bunch of basal moss|bunch of pothinir grass|bunch of sovyn clove|large bolmara potion|large rose-marrow potion|large brostheras potion|large talneo potion|large wingstem potion|large bur-clover potion|rice paper-wrapped tkaro root|tkaro root|some syrup-glazed ambrominas leaf|ambrominas leaf|some spherical pieces of cothinar flower|cothinar flower|tiny emerald glass bottle filled with bur-clover elixir|bur-clover elixir|cumin-rubbed piece of sovyn clove|some caramelized piece of calamia fruit|calamia fruit|twine-tied ball of ephlox moss|ephlox moss|some wood-smoked pieces of cactacae spine|cactacae spine|tiny onyx glass bottle filled with wingstem elixir|wingstem elixir|some pepper-spiced pothinir grass|pothinir grass|rounded blue glass bottle filled with talneo elixir|talneo elixir|leaf-wrapped ball of basal moss|basal moss|tiny clay bottle filled with brostheras elixir|brostheras elixir|some anise-infused aloeas stem|aloeas stem|some shredded strands of haphip root|haphip root|tiny brown glass bottle filled with rose-marrow elixir|rose-marrow elixir|some cube-shaped pieces of woth flower|woth flower|tiny scarlet glass bottle filled with bolmara elixir|bolmara elixir|some turmeric-stained torban leaf|torban leaf|some dense chunks of wolifrew lichen|wolifrew lichen|some paprika-sprinkled acantha leaf|acantha leaf|tincture of tkaro|tiny brick of seaweed and acantha)/,
]
				
  CharSettings['count'] ||= {}
  @room_descriptions = []
  @room_titles = []

  def self.compact
    echo "[spamfilter: Before compacting: #{CharSettings['count'].count} entries.]"
    CharSettings['count'].delete_if { |_, value| value < 5 }
    echo "[spamfilter: After compacting: #{CharSettings['count'].count} entries.]"
  end

  def self.room_load
    Map.list.each do |room|
      room.description.each do |desc|
        @room_descriptions.push(desc.strip.gsub(/\s+/, ' '))
      end
      room.title.each do |title|
        @room_titles.push(title.strip.gsub(/\s+/, ' '))
      end
    end
    @room_descriptions.uniq!
    @room_titles.uniq!
  end

		# Handle reset/clear command or numeric increment value
		def self.configure_increment
				if Script.current.vars[0] =~ /^(reset|clear|wipe)$/i
						CharSettings['count'] = {}
						@increment = 1
				elsif Script.current.vars[0] =~ /^\d+$/
						@increment = Script.current.vars[0].to_i
				else
						@increment = 1
				end
		end

  def self.main
    # Compact method to remove low-count entries from CharSettings['count']
    self.compact
    self.room_load
				self.configure_increment

    @spell_message_regexes = Spamfilter.load_spell_messages_from_xml
				echo "[spamfilter: Loaded #{@flare_patterns.size} flare patterns (damaging and non-damaging).]"
				echo "[spamfilter: Loaded #{@weapon_regexes.size} PSM3 weapon technique filters.]"

#@spell_message_regexes.first(6).each_with_index do |pattern, i|
#  echo "[spamfilter: Spell pattern #{i + 1}]: #{pattern.inspect}"
#end

    # Start main loop
    while (line = get)
      next if line =~ Infomon::Parser::Pattern::All
      line.strip!
      normalized_line = line.gsub(/\s+/, ' ') # Normalize spaces for comparison

      # Ignore room titles (lines enclosed in square brackets)
      next if normalized_line.match?(/^\[.*?\]$/)

      # Remove any "You also see ..." lines before checking room descriptions
      filtered_line = normalized_line.gsub(/You also see .*/, '').strip

      # Ignore room descriptions **only if it's an exact match (excluding "You also see ..." lines)**
      next if @room_descriptions.include?(filtered_line)
      next if @room_titles.include?(filtered_line.gsub(/ \(\d+\)/, ''))

      next if regex = CritRanks.parse(line).keys.any?
						next if @weapon_regexes.any? { |rx| line =~ rx }
      
      # Ignore common game messages
      next if @common_game_messages.any? { |pattern| line.match?(pattern) }
						
						next if @aggressive_npcs.any? { |pattern| line.match?(pattern) }
						next if @gem_types.any? { |pattern| line.match?(pattern) }
						next if @skin_types.any? { |pattern| line.match?(pattern) }
						next if @herb_types.any? { |pattern| line.match?(pattern) }

      # Ignore flare messaging
      next if @flare_patterns.any? { |pattern| line.match?(pattern) }
						
						# Ignore spell messaging
						next if @spell_message_regexes.any? { |pattern| line =~ pattern }

      # Normalize the line by removing numbers
      mod_line = line.gsub(/[0-9\s]+/, '')

						# Apply increment
						CharSettings['count'][mod_line] = CharSettings['count'][mod_line].to_i + @increment
						
						# Echo to familiar window unless seen more than 5 times
						unless CharSettings['count'][mod_line] > 5
								Lich::Messaging.stream_window(line, "familiar")
						end
    end
  end
end

if CharSettings['count'].empty?
  fput "flag logon off"
  fput "flag logoff off"
  fput "flag disconnect off"
  fput "flag noambientmsg on"
end

Spamfilter.main
