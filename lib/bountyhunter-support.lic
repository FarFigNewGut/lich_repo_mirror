=begin

Author: Alastir

Variables used:
#{Vars.teleporter} - Your teleporter device (amulet/ring/etc.)

=end


def activate_teleporter
		result = dothistimeout "rub my #{Vars.teleporter}", 15, /Suddenly, your (.*) spouts thick clouds of fog./
		if result =~ /Suddenly, your (.*) spouts thick clouds of fog./
		end
end

def teleport
	echo 'This is calling teleport'
	if Char.name =~ /Alastir/
		pause_script('go2') if Script.running?('go2')
		#That doesn't seem to do much.
		#The amulet begins to glow, giving off a greenish phosphorescence.
			multifput 'get veil amulet from my harness','wear my veil amulet'
			fput "twist my #{Vars.teleporter} to 2" #Old Ta'Faendryl, Treetop
			activate_teleporter
			multifput 'remove my veil amulet','put my veil amulet in my harness'
		kill_script('go2')
	elsif Char.name =~ /Devereux/
	elsif Char.name =~ /Erykk/
	elsif Char.name =~ /Rylohk/
	elsif Char.name =~ /Sivalis/
	end
end

def announce

	if $frontend == 'stormfront'
		fam_window_begin = "<pushStream id=\"death\" ifClosedStyle=\"watching\"/>"
		fam_window_end   = "<popStream/>\r\n"
	end

	puts("#{fam_window_begin} ** Bounty creature spawned at #{Room.current.id} **\r\n #{fam_window_end}")
	bounty_room = Room.current.id
	if Room.current.id != "#{bounty_room}"
		start_script ('go2'), ['bounty_room']
	end
end

def dispel
	pause_script ('explorer')
	waitrt?
	waitcastrt?
	if Char.prof == 'Bard' or 'Wizard'
		if checkmana(17)
			multifput 'prepare 417','channel'
		end
	elsif Char.prof == 'Cleric'
		if checkmana(19)
			multifput 'prepare 119','channel'
		end
	end
	unpause_script ('explorer')
end

def disarmed

	if $frontend == 'stormfront'
		fam_window_begin = "<pushStream id=\"death\" ifClosedStyle=\"watching\"/>"
		fam_window_end   = "<popStream/>\r\n"
	end

	puts("#{fam_window_begin} *!* DISARMED at #{Room.current.id} *!*\r\n #{fam_window_end}")
	pause_script ('explorer')
	waitrt?
	waitcastrt?
	if Char.prof =~ /Bard|Wizard/
		waitrt?
		Spell[410].cast if Spell[410].affordable?
		fput 'kneel'
			loop {
				recover_result = dothistimeout 'recover item', 5, /You spy (.*) and recover it!/
				if recover_result =~ /You spy (.*) and recover it!/
					waitrt?
					break
				end
				}
	elsif Char.prof == 'Cleric'
		waitrt?
		Spell[213].cast if Spell[213].affordable?
		fput 'kneel'
			loop {
				recover_result = dothistimeout 'recover item', 5, /You spy (.*) and recover it!/
				if recover_result =~ /You spy (.*) and recover it!/
					waitrt?
					break
				end
				}
	elsif Char.prof == 'Warrior'
		start = Time.now.to_i
		while true
			if Time.now.to_i - start > 10
				break
			end

			line = get
			if line =~ /rises out of the shadows and flies back to your waiting hand!/
				break
			end

			sleep 0.25
		end
	end
	unpause_script ('explorer')
end

def regird
	pause_script('explorer') if Script.running?('explorer')
	empty_hands
	fput 'gird'
	unpause_script('explorer') if Script.running?('explorer')
end



#MAIN LOOP

loop {
	line = get
	if line =~ /Out of the corner of your eye, you see (.*) approaching.  (?:She|He|It) must be the creature that you've been tasked to kill!/
		announce
	elsif line =~ /The spirits distract your every action.|You suddenly feel angered beyond all reason, causing you to scream out in rage!|A dizzying array of golden runes surround and suffuse you before being absorbed into your body./
		dispel
	elsif line =~ /#{Vars.weapon} is knocked from your grasp and out of sight!|is knocked from your grasp and out of sight!/
		disarmed
	elsif line =~ /You cannot attack with/
		regird
	elsif line =~ /You approach the shimmering magical barrier/
				  #You approach the shimmering magical barrier. 
		teleport
	elsif line =~ /Be at peace my child, there is no need to fight here.|Be at peace my child, there is no need for spells of war in here.|The searing pain in your throat makes that impossible.|The pall of silence settles more heavily over you./
		walk
	elsif line =~ /You can't think clearly enough to prepare a spell!/
		if Spell[9716].known? and !Spell[9716].active? and checkstamina(30)
			fput 'sigil of determination'
		end
	elsif line =~ /pulses brightly as (?:she|he) absorbs the magic!/
		walk
	elsif line =~ /You cannot do that while mounted./
		fput 'dismount'
	end
	}