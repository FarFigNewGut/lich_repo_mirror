# ;miuduration ### [verb]
# Echo expected MIU cast duration for a spell in an item. ### = spell number, verb optional.
# With verb: echo duration for that activator (tap|rub|wave|raise|eat|drink).
# Without verb: echo a table for all activator verbs. Uses Lich spell data + your MIU ranks.

VERBS = {
  'tap' => 'tap', 'rub' => 'rub', 'wave' => 'wave', 'raise' => 'raise',
  'eat' => 'eat', 'drink' => 'drink', 'bite' => 'eat', 'gobble' => 'eat'
}
ACTIVATOR_LIST = [['Tap', 'tap'], ['Rub', 'rub'], ['Wave', 'wave'], ['Raise', 'raise'], ['Eat', 'eat'], ['Drink', 'drink']]

def fmt_duration(minutes)
  return nil if minutes.nil? || minutes < 0
  m = minutes.to_i
  frac = (minutes - m) * 60
  s = frac.round
  if s >= 60 then m += 1; s = 0 end
  s > 0 ? "#{m} min #{s} sec" : "#{m} min"
end

vars = script.vars.to_a
# Allow ;miuduration 202  or ;miuduration 202 tap  or ;MIUduration 202 tap
spell_num = (vars[0].to_s =~ /^\d+$/ ? vars[0] : vars[1]).to_s
verb_arg  = (vars[0].to_s =~ /^\d+$/ ? vars[1] : vars[2]).to_s.strip.downcase
verb_arg  = nil if verb_arg.empty?
verb_arg  = VERBS[verb_arg] || verb_arg if verb_arg && VERBS.key?(verb_arg)

if spell_num.empty? || spell_num.to_i == 0
  echo "Usage: ;miuduration <spell#> [verb]   e.g. ;miuduration 202 tap"
  exit
end

spell = Spell[spell_num.to_i]
if spell.nil?
  echo "Unknown spell: #{spell_num}"
  exit
end

if verb_arg
  # Single verb
  dur_min = spell.time_per(activator: verb_arg) rescue nil
  if dur_min.nil?
    echo "Could not compute duration for #{spell.name} (#{spell_num}) with verb '#{verb_arg}'."
  else
    echo "MIU duration #{spell.name} (#{spell_num}) [#{verb_arg}]: #{fmt_duration(dur_min)} (#{dur_min.round(2)} min)"
  end
else
  # Table for all verbs
  echo " "
  echo "MIU duration: #{spell.name} (#{spell_num})"
  echo "----------------------------------------"
  echo sprintf("%-6s  %s", "Verb", "Duration")
  echo "----------------------------------------"
  ACTIVATOR_LIST.each do |label, act|
    dur_min = spell.time_per(activator: act) rescue nil
    echo sprintf("%-6s  %s", label, dur_min.nil? ? "â€”" : fmt_duration(dur_min))
  end
  echo "----------------------------------------"
  echo " "
end
