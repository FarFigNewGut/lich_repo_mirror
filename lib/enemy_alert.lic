# ;enemy_alert
# GemStone 4: Background script that highlights whenever a new enemy target enters the room.
# Run with: ;enemy_alert   Stop with: ;k enemy_alert

DEAD_STATUS = /dead|gone/

def living_target_ids
  Array(GameObj.targets)
    .reject { |n| n.status.to_s =~ DEAD_STATUS }
    .map(&:id)
    .to_set
end

def target_name_by_id(id)
  t = Array(GameObj.targets).find { |n| n.id == id }
  t ? "#{t.name} (##{id})" : "##{id}"
end

known_ids = Set.new
current_room = nil

loop do
  room = Room.current&.id
  if room != current_room
    current_room = room
    known_ids.clear
  end

  current_ids = living_target_ids
  new_ids = current_ids - known_ids

  new_ids.each do |id|
    _respond "<pushBold/>*** NEW TARGET: #{target_name_by_id(id)} ***<popBold/>"
  end

  known_ids = (known_ids + new_ids) & current_ids
  sleep 0.3
end
