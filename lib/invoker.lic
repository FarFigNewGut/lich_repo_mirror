=begin
  A script to remind you to visit the Invoker

  Usage: Runs continuously and notifies you when the invoker has returned.

    author: Nesmeor
    name: invoker
    tags: utility, spellup
    version: 1.1

    Changelog:
      1.1 (4/24/2021):
        Added colorized text for stormfront UI
=end

current_hour = nil

go2 = proc { | room |
  if room.nil?
    room = "288"
  end
  next if Room.current.id.to_s == room.to_s
  wait_while { running?("go2") }
  start_script("go2", [room.to_s, "_disable_confirm_"])
  wait_while { running?("go2") }
}

check_time = proc {
  # Is it between 00 & 15 minutes?
  time = Time.now.strftime('%M')
  time.to_s =~ /0[0-9]|1[0-5]/
}

help = proc {
    respond "Runs continuously and notifies you when the invoker has returned."
    respond "By default this is set to Town Square, Small Park (288)"
    respond "You can change it using invoker location=<location_number>"
    exit
}

# Command line handling
if script.vars[1] == "help"
  help.call
  exit
elsif script.vars[0] =~ /^location?=(.+)$/
  location = $1
  Vars["invoker_location"] = location
  exit
end

# Do this forever
while true
  # Check the current time to see if the invoker is present
  invoker_present = check_time.call
  if invoker_present
    # Capture the current hour to avoid trying multiple times
    new_hour = Time.now.hour
    # Make sure we haven't seen the invoker already
    if current_hour != new_hour
      if $frontend == 'stormfront'
        puts '<preset id="whisper">The invoker is now available. YES to visit them, SHAKE to skip this time.</preset>'
      else
        echo 'The invoker is now available. YES to visit them, SHAKE to skip this time.'
      end
      while line = get
        if line =~ /positive attitude/
          # Capture current location
          current_room = Room.current.id
          # Go to the park
          go2.call(Vars["invoker_location"])
          # Pausing, because sometimes things move to fast for the next check to succeed
          pause 1
          # Ask for spells
          fput "ask invoker about spells"
          # Update the current hour
          current_hour = new_hour
          # Return to previous location
          go2.call(current_room)
          break
        elsif line =~ /Shake what\?/
          echo "Skipping invoker this hour."
          current_hour = new_hour
          break
        end
      end
    else
      # We've already seen the invoker, wait a while before checking again.
      # pause '30m'
    end
  end
  pause '1m'
end
