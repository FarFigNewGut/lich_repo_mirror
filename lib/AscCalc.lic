=begin

  Parses your Ascension skill allocations and reports the ATP and EXP cost per skill.

  original author: Kaetel
       maintainer: Kaetel
             game: gs
             name: AscCalc
             tags: ascension,utility
          version: 1.0.2

  v1.0.2 (2025-03-27)
    - Added handling for milestone ATPs to break down actual exp cost
    - Added unallocated ATPs
  v1.0.1 (2024-09-21)
    - Fixed caluclations for Trancend Destiny ATPs and Experience
  v1.0.0 (2024-09-19)
    - Initial release
=end

module AscCalc
  ASC_START_RX = /.+ your Ascension Abilities are as follows:/
  ASC_LINE_RX = /\s+([A-z\-\s]+)\s+\<d cmd.+\s+(\d+)\/\d+\s+.+/
  ASC_UNUSED_RX = /Available Ascension Abilities Points: (\d+)/

  MILESTONE_START_RX = /.+, your Ascension Milestones are as follows:/
  MILESTONE_LINE_RX = /\s+\d+\. .+ (Yes|No)/
  
  CUSTOM_COST_MAP = {
    'Transcend Destiny' => ->(ranks) {
      (1..ranks).to_a.map(&->(rank) {
        cost += [rank * 10, 50].min
      }).sum
    }
  }

  def self.run()
    @@unused = 0
    @@costTotal = 0
    @@costSubtotal = 0
    @@ranksTotal = 0
    @@milestonesTotal = 0
    @@report = []

    Lich::Util.quiet_command_xml('ASC INFO', ASC_START_RX)
      .each(&->(line) {self.ingest(line)})

    Lich::Util.quiet_command_xml('ASC MILESTONE', MILESTONE_START_RX)
      .each(&->(line) {self.ingestMilestone(line)})

    @@costTotal = @@costSubtotal - @@milestonesTotal + @@unused

    @@report << ['------', '', '', '']
    @@report << [
      'Subtotal',
      '',
      @@costSubtotal,
      ''
    ]
    @@report << ['- Milestones', '', @@milestonesTotal, '']
    @@report << ['+ Unallocated', '', @@unused, '']
    @@report << [
      'Total',
      @@ranksTotal,
      @@costTotal,
      (@@costTotal * 50_000).with_commas
    ]

    reportTable = Terminal::Table.new(
      headings: ['Skill', 'Ranks', 'ATPs', 'EXP'],
      rows: @@report
    )

    Lich::Messaging.mono(reportTable.to_s)
  end

  def self.calcCost(skill, ranks)
    cost = 0
    
    if (CUSTOM_COST_MAP.key?(skill))
      return CUSTOM_COST_MAP[skill].call(ranks)
    end

    tier = ranks / 5
    depth = ranks % 5
        
    cost += (1..tier).to_a.map(&->(t) {5 * t}).sum

    if (depth > 0)
      cost += (depth * (tier + 1))
    end

    cost
  end

  def self.ingest(line)
    if (line =~ ASC_LINE_RX)
      skill = $1.strip
      ranks = $2.to_i
      cost = self.calcCost(skill, ranks)

      @@report << [
        skill,
        ranks,
        cost,
        (cost * 50_000).with_commas
      ]
      
      @@ranksTotal += ranks
      @@costSubtotal += cost
    elsif (line =~ ASC_UNUSED_RX)
      @@unused = $1.to_i
    end
  end

  def self.ingestMilestone(line)
    if (line =~ MILESTONE_LINE_RX)
      if ($1.downcase.eql?('yes'))
        @@milestonesTotal += 1
      end
    end
  end

  self.run()
end
