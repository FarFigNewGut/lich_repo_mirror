#dr_dig.lic
=begin

Author: Alastir

Vars.lootsack
Vars.questsack
Vars.lootchar

Supporting scripts:
duskruin_adventurer
duskruin_archaeologist
moonshardbundle

=end

if $frontend == 'stormfront'
	fam_window_begin = "<pushStream id=\"loot\" ifClosedStyle=\"watching\"/>"
	fam_window_end   = "<popStream/>\r\n"
else
	fam_window_begin = "\034GSe\r\n"
	fam_window_end   = "\034GSf\r\n"
end

Script.start('dr_dig_watch')

def get_pickaxe
	result = dothistimeout 'get my pickaxe', 5, /You remove|You discreetly|You already|Reaching over your shoulder|Get what?/
	if result =~ /You remove|You discreetly|You already|Reaching over your shoulder/
	elsif result =~ /Get what?/
		exit
	end
end

def stow_pickaxe
	waitrt?
	result = dothistimeout "put my pickaxe in my #{Vars.questsack}", 5, /You put|You discreetly tuck|Reaching over your shoulder|Get what?|won't fit /
	if result =~ /You put|You discreetly tuck/
	elsif result =~ /Get what?/
		Script.pause
	elsif result =~ /won't fit/
		Script.pause
	end
end	

def found_box
	result = dothistimeout "open my #{GameObj.left_hand.noun}", 5, /You open the lid|You lift the lid/
	if result =~ /You open the lid|You lift the lid/
		process_box
	end
end

def process_box
	if $frontend == 'stormfront'
		fam_window_begin = "<pushStream id=\"loot\" ifClosedStyle=\"watching\"/>"
		fam_window_end   = "<popStream/>\r\n"
	else
		fam_window_begin = "\034GSe\r\n"
		fam_window_end   = "\034GSf\r\n"
	end

	waitrt?
	result = dothistimeout "look in ##{GameObj.left_hand.id}", 5, /In the|Inside the (.*) (?:casket|coffin|sarcophagus) rests/
	if result =~ /In the/
		GameObj.left_hand.contents.each { |item|
			fput "get ##{item.id}"
			puts("#{fam_window_begin}Found: #{item.name}\r\n#{fam_window_end}")
			if Char.name =~ /Rieti|Rimini|Rindisi/
				pass_loot
			else
				if item.noun =~ /balenite|coin|hide|jade|leaf|plumille|rhimar|ring|wyrwood/
					fput "put #{item.noun} in bin"
				else
					fput "put #{item.noun} in my #{Vars.lootsack}"
				end
			end
		}
	end
end

def found_sealed
	waitrt?	
	result = dothistimeout "pry my #{GameObj.left_hand.noun}", 5, /You begin pulling at|With the lid loosened|The (.*) is already opened./
	if result =~ /You begin pulling at/
		found_sealed
	elsif result =~ /With the lid loosened|The (.*) is already opened./
		process_sealed
		process_sealed
	end	
	waitrt?
end

def process_sealed
	if $frontend == 'stormfront'
		fam_window_begin = "<pushStream id=\"loot\" ifClosedStyle=\"watching\"/>"
		fam_window_end   = "<popStream/>\r\n"
	else
		fam_window_begin = "\034GSe\r\n"
		fam_window_end   = "\034GSf\r\n"
	end

	waitrt?
	result = dothistimeout "look in ##{GameObj.left_hand.id}", 5, /On the skeleton you see (.*)\.  The stench|The skeleton has been picked clean of belongings./
	#One Prize
	if result =~ /On the skeleton you see (.*)\.  The stench/
		prize = $1.split.last
		echo "#{prize}"
		waitrt?
		fput "get #{prize} from ##{GameObj.left_hand.id}"
		fput 'glance'
		prize = GameObj.right_hand.name
		puts("#{fam_window_begin}Found: #{prize}\r\n#{fam_window_end}")
		if Char.name =~ /Rieti|Rimini|Rindisi/
			pass_loot
		else
			if GameObj.right_hand.noun =~ /balenite|coin|hide|jade|leaf|plumille|rhimar|ring|wyrwood/
				fput "put #{prize.noun} in bin"
			else
				fput "put #{prize.noun} in my #{Vars.lootsack}"
			end
		end
	elsif result =~ /The skeleton has been picked clean of belongings./
	
#	elsif result =~ /On the skeleton you see (.*) and (.*)\.  The stench/
#		prize_one = $1.split.last
#		prize_two = $2.split.last
#		echo "#{prize_one}"
#		echo "#{prize_two}"
#		waitrt?
#		fput "get #{prize_one} from ##{GameObj.left_hand.id}"
#		fput 'glance'
#		prize_one = GameObj.right_hand.name
#		puts("#{fam_window_begin}Found: #{prize_one}\r\n#{fam_window_end}")
#		if Char.name =~ /Rieti|Rimini|Rindisi/
#			pass_loot
#		else
#			fput "put #{GameObj.right_hand.noun} in my #{Vars.lootsack}"
#		end
#		process_sealed
#		waitrt?
#		fput "get #{prize_two} from ##{GameObj.left_hand.id}"
#		fput 'glance'
#		prize_two = GameObj.right_hand.name
#			puts("#{fam_window_begin}Found: #{prize_two}\r\n#{fam_window_end}")
#		if Char.name =~ /Rieti|Rimini|Rindisi/
#			pass_loot
#		else
#			fput "put #{GameObj.right_hand.noun} in my #{Vars.lootsack}"
#		end
	else
		Script.pause
	end
end

def pass_loot
	result = dothistimeout "give #{Vars.lootchar}", 5, /has accepted|already has an outstanding offer.|What is it you're trying to give?/
	if result =~ /has accepted/
	elsif result =~ /already has an outstanding offer./
		sleep 1
		pass_loot
	elsif result =~ /What is it you're trying to give?/
		Script.pause
	end
end

def empty_loot
	fput "empty my #{GameObj.left_hand.noun} in my #{Vars.lootsack}"
end

def trash_box
	result = dothistimeout "put my #{GameObj.left_hand.noun} in bin", 5, /As you place|There appears to be an item or items attached to the container you are throwing away that is either scripted or of significant value./
	if result =~ /As you place/
	elsif result =~ /There appears to be an item or items attached to the container you are throwing away that is either scripted or of significant value./
		Script.pause
	end
	get_pickaxe
end

def dig
	if $frontend == 'stormfront'
		fam_window_begin = "<pushStream id=\"thoughts\" ifClosedStyle=\"watching\"/>"
		fam_window_end   = "<popStream/>\r\n"
	else
		fam_window_begin = "\034GSe\r\n"
		fam_window_end   = "\034GSf\r\n"
	end

	result = dothistimeout 'dig', 5, /You reach down and pull (?:an ornate|an elegant|a ruby\-set|a bejeweled|an opal-set|a gem\-flecked|a gem\-studded|a diamond\-set|a saewehna\-set|a feystone\-set|a despanel\-set|an emerald\-set|a sapphire\-set|a sunstone\-set|a blazestar\-set|a firestone\-set|a gem\-encrusted|a jewel\-studded|a malachite\-set|a moonstone\-set|a opal\-encrusted|a firestone\-inset|a gold\-lined|a silver\-lined)|You reach down and pull a (?:battered|corroded|damaged|dented|grimy|marred|rotted|rusted|stained|warped)|You reach down and pull a sealed|You need your left hand free to help grasp|Perhaps you need a shovel or something similar in your right hand to dig in the ground?/
	if result =~ /You reach down and pull (?:an ornate|an elegant|a ruby\-set|a bejeweled|an opal-set|a gem\-flecked|a gem\-studded|a diamond\-set|a saewehna\-set|a feystone\-set|a despanel\-set|an emerald\-set|a sapphire\-set|a sunstone\-set|a blazestar\-set|a firestone\-set|a gem\-encrusted|a jewel\-studded|a malachite\-set|a moonstone\-set|a opal\-encrusted|a firestone\-inset|a gold\-lined|a silver\-lined)/
		loop {
			echo 'Found a winner!'
			echo 'Found a winner!'
			echo 'Found a winner!'
			echo 'Found a winner!'
			echo 'Found a winner!'
			sleep 30
			}
	elsif result =~ /You reach down and pull a (?:battered|corroded|damaged|dented|grimy|marred|rotted|rusted|stained|warped)/
		#puts("#{fam_window_begin}Found: #{GameObj.left_hand.name}\r\n#{fam_window_end}")
		waitrt?
		stow_pickaxe
		found_box
		trash_box
	elsif result =~ /You reach down and pull a sealed/
		waitrt?
		stow_pickaxe
		found_sealed
		trash_box
	elsif result =~ /You need your left hand free to help grasp/
		stow_pickaxe
		if GameObj.left_hand.noun =~ /casket|coffin|sarcophagus/
			found_sealed
		else
			Script.pause
		end
	elsif result =~ /Perhaps you need a shovel or something similar in your right hand to dig in the ground?/
		if GameObj.left_hand.noun == 'pickaxe'
			fput 'swap'
		else
			fput "get my pickaxe from my #{Vars.questsack}"
		end
	else
		waitrt?
	end
end

##### MAIN LOOP

get_pickaxe

loop {
	dig
	}