=begin
A crude script to simply give all silvers on you to your demon, intended for use while hunting.
Will also foce your demon to follow you as part of the check to find your demon.
Very under tested beta release.

planned features:
  Chose amount to give, rather than always default to all
  Have the demon give money back to you
    - maybe automatically when in the bank?

  maintainer: Dalazashel
      author: Dalazashel
        game: Gemstone
        tags: sorc, demon
    required: Lich > 5.0.1
     version: 0.0.1

  changelog:
    
    v0.0.1(2023-07-20)
      Initial release  
=end

def getDemonId(currentDemonId)
  if currentDemonId != -1 # check existing
    myDemon = GameObj.npcs.find{ |npc| npc.id == currentDemonId }
    return myDemon.id if !myDemon.nil? # return if exists
  end
  # find actual ID
  status_tags
  put "tell md to follow"
  startTime = Time.now
  loop { 
    line = get?
    # echo line
    if line =~ /Your <pushBold\/><a exist="(\d+)" noun="\w+">[\w\- ]+<\/a><popBold\/> is/
      return $1
    end
    break if Time.now - startTime > 3
    sleep(0.1)
  }
  return nil

end


silver = Lich::Util.silver_count
if silver == 0
  respond "  No silver on you. "
  exit
end

# using a global var as this will stay in memory between executions as the ID will typically not change.
# ugly name to be sure of no clashes
$getSilverDemonId == $getSilverDemonId || -1
$getSilverDemonId  = getDemonId($getSilverDemonId)
if $getSilverDemonId.nil?
  respond " Could not find demon for some reason."
  respond " If you really have one, and it is in the same room as you, the debug message below might help the authour figure out why not."
  respond " Share the full script execution with him via Disord"
  respond GameObj.npcs.inspect
  exit
end
put "give ##{$getSilverDemonId } #{silver}"

