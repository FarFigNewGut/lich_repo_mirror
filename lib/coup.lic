=begin

coup.lic is part 1/2 of
Coup de Grace script, compatible with Bigshot
Uses gracemon script to track Empowerment buff

Attempts to execute the provided target, or current target if none is provided.
Breaks if already empowered, or if target is not incapacitated, or if stamina is below maneuver cost.

send feedback to stayrange on PC

Usage: ;coup
OR ;coup target

Bigshot command example: script coup target(s29)

    author: Gwrawr (stayrange)
        name: coup
        tags: coup de grace, square, warrior, rogue, monk, cman
        version: 1.1
    credit to Nihiladrem for much of the bigshot interface

    #TODO Maintain ledger of mob HP in gracemon
    #TODO Match versions of coup, gracemon
                                                       
=end

#get part 2
Script.run "repo", "download gracemon.lic" unless Script.exists? "gracemon"
#VERSIONMATCH

#exit if empowered
if running? "gracemon"
    exit
end

#bigshot can't know about gracemon, or bigshot will keep waiting for it to end
pause_script "bigshot" if running? "bigshot"

#set target if given a target and target is not set, or if no target is yet set
#thanks Nihiladrem!
unless (variable[0].nil?) || GameObj.npcs["##{XMLData.current_target_id}".to_i].nil?
	target = variable[0]
	if ("##{XMLData.current_target_id}") != target
		fput "target #{target}"
	end
end

#some things change (sorry olaf)
exit if GameObj.npcs["##{XMLData.current_target_id}".to_i].status =~ /dead/
exit unless GameObj.npcs["##{XMLData.current_target_id}".to_i].status =~ /stunned|lying down|webbed/
exit if stamina < 20

#execute maneuver
waitrt?
waitcastrt?
fput "cman coup"

#collect lines until result from "cman coup"
lines = []
loop do
    line = get
    lines << line
    case line
    when /Roundtime|Your muscles|too injured|Coup de Grace what|no valid target|aware of your intentions|injured enough to be susceptible|already dead|That would most likely be a bad idea/
        break
    when GameObj.npcs["##{XMLData.current_target_id}".to_i].status =~ /dead/
        break
    end
end

#keep it secret, keep it safe
for line in lines
    Script.start "gracemon" if line =~ /heady flush/
end

#who?
unpause_script "bigshot" if running? "bigshot"
exit