=begin
  MiniBAR!!!
  It makes you a MINIBAR!
  Combines XPSF, health, mana, stamina, spirit, experience, mind, stance, encumbrance and wound data into one bar!
  
  Based on UberBar... heavily.

  author: Nesmeor
  name: minibar
  tags: utility, sidebar, stormfront
  version: 0.0.1

  Changelog:
  0.0.1 - (05/15/2021)
    - Initial version

=end

if $SAFE > 0
  echo "error: This script needs to be trusted to work. (;trust #{script.name.downcase})"
  exit
end

if $frontend != "stormfront"
  respond ""
  respond " Thank you for your interest in MiniBar"
  respond " This version is specific to the Stormfront frontend"
  respond " Closing now"
  respond ""
  exit
end

wait_while { XMLData.next_level_text !~ /(experience|until next level)/ or !XMLData.next_level_value.integer? }
''
no_kill_all
no_pause_all
hide_me
debug = false

xpnFirstTime = 0
nowTime = Time.now - 1
xpnNLT = xpnCur = xpnOld = xpnCap = xpnValue = xpnText = xpnHour = xpnLast = xpnTotal = 0
oldRM = oldHP = oldMP = oldST = oldSP = oldXP = oldMD = oldSN = oldEN = oldIN = nil
capped = false
firstpulse = true
capped = true if Char.level == 100
buffx = 3
buffy = 3
sizebx = 186
sizerx = 90
sizey = 15

before_dying {
  puts("<closeDialog id='MiniBar'/>")
}

ublinebars  = "\"<image id='ubbars'   name='PanelBackground'    justify='4' anchor_top='top'   top='#{buffy}' left='0' height='0' width='0'/>\""
ublineheal  = "\"<skin id='ubheal' name='healthBar' controls='health'     anchor_top='ubbars'      top='#{buffy}' left='#{buffx+1}' width='0' height='#{sizey}'/><progressBar id='health'    value='\#{percenthealth}' text='\#{checkhealth}/\#{maxhealth}'  customText='t' anchor_top='ubbars' top='#{buffy}' left='#{buffx+1}' width='#{sizerx}' height='#{sizey}'/>\""
ublinemana  = "\"<skin id='ubmana' name='manaBar' controls='mana'         anchor_top='ubheal'     top='#{buffy}' left='#{buffx}' width='0' height='#{sizey}'/><progressBar id='mana'    value='\#{percentmana}'   text='\#{checkmana}/\#{maxmana}'  customText='t'  anchor_top='health' top='#{buffy}' left='#{buffx+1}' width='#{sizerx}' height='#{sizey}'/>\""
ublinestam  = "\"<skin id='ubstam' name='staminaBar' controls='stamina'   anchor_top='ubmana'     top='#{buffy}' left='#{buffx+1}' width='0' height='#{sizey}'/><progressBar id='stamina' value='\#{percentstamina}'  text='\#{checkstamina}/\#{maxstamina}'  customText='t' anchor_top='mana'   top='#{buffy}' left='#{buffx+1}' width='#{sizerx}' height='#{sizey}'/>\""
ublinespir  = "\"<skin id='ubspir' name='spiritBar' controls='spirit'     anchor_top='ubstam'     top='#{buffy}' left='#{buffx+1}' width='0' height='#{sizey}'/><progressBar id='spirit'    value='\#{percentspirit}' text='\#{checkspirit}/\#{maxspirit}'  customText='t' anchor_top='stamina'  top='#{buffy}' left='#{buffx+1}' width='#{sizerx}' height='#{sizey}'/>\""

ublinenext  = "\"<progressBar id='ubnext'	value='\#{xpnValue}'			text='\#{xpnText}' anchor_left='health' justify='4' anchor_top='top'	top='#{buffy+2}' left='#{buffx}' width='#{sizebx/2}' height='#{sizey}'/>\""
ublinemind  = "\"<progressBar id='ubmind'	value='\#{XMLData.mind_value}'		text='Mind: \#{XMLData.mind_value}%' customText='t'	anchor_left='mana' anchor_top='ubnext'	top='#{buffy}' left='#{buffx}' width='#{sizebx/2}' height='#{sizey}'/>\""
ublinestan  = "\"<progressBar id='ubstnc'	value='\#{XMLData.stance_value}'	text='Stance: \#{XMLData.stance_text[0...3]}'			anchor_left='stamina' anchor_top='ubmind'	top='#{buffy}' left='#{buffx}' width='#{sizebx/2}' height='#{sizey}'/>\""
ublineencm  = "\"<progressBar id='ubencm'	value='\#{XMLData.encumbrance_value}'	text='\#{XMLData.encumbrance_text}'	anchor_left='spirit'	anchor_top='ubstnc'	top='#{buffy}' left='#{buffx}' width='#{sizebx/2}' height='#{sizey}'/>\""

ublinehourl = "\"<label id='ubhour'   value='Avg/Hr:'     justify='4'  anchor_top='ubspir'  top='#{buffy}' left='#{buffx}' height='#{sizey}' width='#{sizerx/2}'/>\""
ublinelastl = "\"<label id='ublast'   value='Pulse:'      justify='4' anchor_left='ubhourv' anchor_top='ubencm' top='#{buffy}' left='#{buffx}' height='#{sizey}' width='#{sizerx/2}'/>\""
ublinehourv = "\"<label id='ubhourv'    value='\#{xpnHour}'   justify='6' anchor_left='ubhour'  anchor_top='ubspir'  top='#{buffy}' left='0' height='#{sizey}' width='#{sizerx/2}'/>\""
ublinelastv = "\"<label id='ublastv'    value='\#{xpnLast}'   justify='6' anchor_left='ublast'  anchor_top='ubencm'  top='#{buffy}' left='0' height='#{sizey}' width='#{sizerx/2}'/>\""


openLines = [
  "<closeDialog id='MiniBar'/>",
  "<openDialog type='dynamic' id='MiniBar' title='#{Char.name}\'s Minibar' target='MiniBar' location='main' height='190' width='190' resident='true'>",
  "<dialogData id='MiniBar'>",
]
tosend = openLines.join
openLines = [eval(ublinehourl), eval(ublinelastl), eval(ublinehourv), eval(ublinelastv), eval(ublinebars), eval(ublineheal), eval(ublinemana), eval(ublinestam), eval(ublinespir), eval(ublinenext), eval(ublinemind), eval(ublinestan), eval(ublineencm)]
tosend += openLines.join
tosend += "</dialogData></openDialog>"

puts(tosend)

loop {
  wait_while { oldHP == checkhealth and oldMP == checkmana and oldST == checkstamina and oldSP == checkspirit and oldXP == XMLData.next_level_text and oldMD == XMLData.mind_text and oldSN == XMLData.stance_text and oldEN == XMLData.encumbrance_text and oldIN == XMLData.injuries.to_s and (oldRM == Room.current.id or Time.now - nowTime < 1) }
  nowTime = Time.now
  doLines = "<dialogData id='MiniBar'>"
  
  if oldHP != checkhealth		then echo "updated health" if debug	; oldHP = checkhealth			; doLines += eval(ublineheal) end
  if oldMP != checkmana			then echo "updated mana" if debug	; oldMP = checkmana			; doLines += eval(ublinemana) end
  if oldST != checkstamina		then echo "updated stamina" if debug	; oldST = checkstamina			; doLines += eval(ublinestam) end
  if oldSP != checkspirit		then echo "updated spirit" if debug	; oldSP = checkspirit			; doLines += eval(ublinespir) end
  if oldMD != XMLData.mind_text		then echo "updated mind" if debug	; oldMD = XMLData.mind_text		; doLines += eval(ublinemind) end
  if oldSN != XMLData.stance_text	then echo "updated stance" if debug	; oldSN = XMLData.stance_text		; doLines += eval(ublinestan) end
  if oldEN != XMLData.encumbrance_text	then echo "updated encumbr" if debug	; oldEN = XMLData.encumbrance_text	; doLines += eval(ublineencm) end
  if oldXP != XMLData.next_level_text	then echo "updated next_level" if debug ; 
    xpnNLT = XMLData.next_level_text
    if xpnNLT =~ /( experience| until next level)/
      xpnCur = xpnNLT.delete(' experience').delete(' until next level').to_i
      xpnLast = xpnOld - xpnCur
      xpnLast *= -1 if xpnLast < 0
      xpnLast = 0 if xpnLast > 2499
    else
      xpnCur = 0
      xpnLast = 0
    end
    if firstpulse
      xpnFirstTime = Time.now - 1
      xpnTotal = 0
      xpnLast = 0
      firstpulse = false
    end
    if capped
      xpnCap = (xpnCur / 2500 + 1) * 2500 - xpnCur
      xpnValue = 100 - (xpnCap / 25)
      xpnText = "#{xpnCap} until TP"
    else
      xpnValue = XMLData.next_level_value.to_i
      xpnText = sprintf("L:%2s N:%6s", Char.level, xpnCur)
    end
    xpnTotal += xpnLast
    xpnHour = ((1.00 * xpnTotal) / ((nowTime - xpnFirstTime)/3600.00)).to_i
    xpnOld = xpnCur
    oldXP = XMLData.next_level_text
    doLines += eval(ublinehourv) + eval(ublinelastv) + eval(ublinenext)
end
  if oldIN != XMLData.injuries.to_s
    echo "updated injuries" if debug
    oldIN = XMLData.injuries.to_s
  end
  doLines += "</dialogData>"
  puts(doLines) if doLines != "<dialogData id='MiniBar'></dialogData>"
}
