=begin
  Original Author: Damiza Nihshyde

  YAML SETTINGS
  limited_treasures_buy_list:
   - wings
   - dragon
   - dragons
  
  Add the nouns of the items you want to purchase to the list and hope for the best!
  EQUALITY FOR EVERYONE!   ....at least for the lichers.
  
  Discord: kirinartistry
  Support me through Paypal:  kirinartistry@gmail.com
=end

custom_require.call(%w[common common-travel])

class ShopLimitedTreasures
  def initialize
    @settings = get_settings
    @keeplist = @settings.limited_treasures_buy_list

    if @keeplist.nil? || @keeplist.empty?
      DRC.message("Error: The limited treasures buy list is not set or is empty.")
      return
    end

    # Only match whole words!
    @keeplist_regex = Regexp.new(@keeplist.map { |item| "\\b#{Regexp.escape(item)}\\b" }.join("|"))

    loop do
      trigger = waitfor('disables its defense mechanisms',
                        'revealing its opening',
                        /Gortik .* curtained doorway\./,
                        /Gortik .* through a curtained door\./)
      next if trigger.strip == 'Gortik came through a curtained door.'
      break
    end

    fput("go curtain door")
    check_stands
  end

  def check_stands
    ["stand", "second stand", "third stand"].each do |stand|
      result = DRC.bput("shop #{stand}", 
        /(a|an|some) (.*?) (#{@keeplist_regex}) (.*?)(for \d+ (copper|bronze|silver|gold|platinum) Kronars)/, 
        /see some details/)

      found_item = false
      result.each_line do |line|
        if line.match?(@keeplist_regex)
          line.match(/(#{@keeplist_regex})/)
          item_name = $1.strip
          fput("buy #{item_name} on #{stand}")
          fput("stow")
          found_item = true
        end
      end
    end
  end
end

ShopLimitedTreasures.new